(globalThis.webpackChunkgraphic=globalThis.webpackChunkgraphic||[]).push([[412],{26399:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var r=i(65748),s=i(34269);const n=new class{constructor(){this._effectCache=new r.z6({_capacity:1e3,_cacheKey:s.KU}),this._assetCache=new r.z6({_capacity:50,_cacheKey:s.RE}),this._typrCache=new r.z6({_capacity:50,_cacheKey:s.bW}),this._lockProportionCache=new r.z6({_capacity:2e3,_cacheKey:s.qh})}setEffectCache(e,t){this._effectCache.set(e,t)}getEffectCache(e){return this._effectCache.get(e)}removeEffectCache(e){this._effectCache.remove(e)}setAssetsCache(e,t){this._assetCache.set(e,t)}getAssetsCache(e){return this._assetCache.get(e)}setTyprCache(e,t){this._typrCache.set(e,t)}getTyprCache(e){return this._typrCache.get(e)}setLockProportionCache(e,t){this._lockProportionCache.set(e,t)}getLockProportionCache(e){return this._lockProportionCache.get(e)}initEffectCache(e){let t;const i=new Promise((i=>{t=()=>{var t;null!==(t=this._effectCache.get(e))&&void 0!==t&&t.cropCanvas&&i(!0)}}));this._effectCache.set(e,{onFirstCanvasReady:t,firstCanvasReady:i})}}},24638:(e,t,i)=>{"use strict";i.d(t,{s:()=>h});var r=i(8757),s=i(46436),n=i(71946),a=i(58548);class o{constructor(e){this._capacity=500,this._rects=[],this._divided=!1,this._boundary=e}insert(e){var t,i,r,n;const{corners:a}=e;(0,s.w3)(a,this._boundary)&&(this._rects.length<this._capacity?this._rects.push(e):(this._divided||this._subdivide(),null===(t=this._northeast)||void 0===t||t.insert(e),null===(i=this._northwest)||void 0===i||i.insert(e),null===(r=this._southeast)||void 0===r||r.insert(e),null===(n=this._southwest)||void 0===n||n.insert(e)))}intersectPoint(e,t=[]){if(!(0,s.Ag)(e,this._boundary))return[];for(const o of this._rects)(0,s.Ag)(e,o.corners)&&t.push(o);var i,r,n,a;this._divided&&(null===(i=this._northeast)||void 0===i||i.intersectPoint(e,t),null===(r=this._northwest)||void 0===r||r.intersectPoint(e,t),null===(n=this._southeast)||void 0===n||n.intersectPoint(e,t),null===(a=this._southwest)||void 0===a||a.intersectPoint(e,t));return t}_subdivide(){const[e,t,i,r]=this._boundary,s=e.x+(t.x-e.x)/2,n=e.y+(r.y-e.y)/2,a={x:s,y:e.y},h={x:s,y:r.y},d={x:e.x,y:n},c={x:t.x,y:n},l={x:s,y:n};this._northeast=new o([a,t,c,l]),this._northwest=new o([e,a,l,d]),this._southeast=new o([l,c,i,h]),this._southwest=new o([d,l,h,r]),this._divided=!0}}const h=new class{constructor(){this._materialsByBFS=[],this._materialsByDFS=[],this._rulerLines=[],this._layerRectCornersMap=new Map}intersectPoint(e,t){return t&&this._bfsQuadTree?this._bfsQuadTree.intersectPoint(e):!t&&this._dfsQuadTree?this._dfsQuadTree.intersectPoint(e):[]}init(e){this._renderer=e}update(){if(!this._renderer)return;this._clear();const{width:e,height:t}=this._renderer.getRenderer().stage;this._bfsQuadTree=new o([{x:0,y:0},{x:e,y:0},{x:e,y:t},{x:0,y:t}]),this._dfsQuadTree=new o([{x:0,y:0},{x:e,y:0},{x:e,y:t},{x:0,y:t}]);const i=this._renderer.getRenderer().getMainRenderer().getPageContainer();i&&(this._materialsByBFS=n.Z.findGroupSubMaterials(i,[],!0),this._materialsByDFS=n.Z.findGroupSubMaterials(i,[]),this._materialsByBFS.forEach((e=>{var t,i;const s=e.id(),o=n.Z.isEqual(e,r.Wq.PAGE)&&null!==(t=null===(i=this._renderer)||void 0===i?void 0:i.getRenderer().getActivePageRect())&&void 0!==t?t:e,h=(0,a.q)(o),d=e.attrs.type;this._layerRectCornersMap.set(s,h),this._bfsQuadTree.insert({layerId:s,corners:h,layerType:d})})),this._materialsByDFS.forEach((e=>{const t=e.id(),i=e.attrs.type,r=this._layerRectCornersMap.get(t);r&&this._dfsQuadTree.insert({layerId:t,corners:r,layerType:i})})),this._rulerLines=n.Z.findRulerLines(this._renderer.getRenderer().getFeatureRenderer().getLayer()),this._rulerLines.forEach((e=>{const t=(0,a.q)(e);this._bfsQuadTree.insert({layerId:e.id(),corners:t,layerType:r.Wq.RULER_LINE}),this._dfsQuadTree.insert({layerId:e.id(),corners:t,layerType:r.Wq.RULER_LINE})})))}_clear(){this._materialsByBFS=[],this._materialsByDFS=[],this._bfsQuadTree=void 0,this._dfsQuadTree=void 0,this._layerRectCornersMap.clear()}}},59238:(e,t,i)=>{"use strict";i.d(t,{U:()=>n});var r=i(48917),s=i(14764);const n=new class{constructor(){this._nodeCacheMap=new Map,this._cacheLayerIds=[s.fy,s.Ui]}clear(){this._nodeCacheMap.forEach((e=>e.clear())),this._nodeCacheMap.clear()}get(e,t){var i;return null===(i=this._nodeCacheMap.get(e.id()))||void 0===i?void 0:i.get(t)}has(e,t){var i;return Boolean(null===(i=this._nodeCacheMap.get(e.id()))||void 0===i?void 0:i.has(t))}init(){this._nodeCacheMap.clear();const{shapes:e}=r.Core;Object.keys(e).forEach((t=>{var i,r;const s=e[t],n=null===(i=s.getLayer())||void 0===i?void 0:i.id();if(!n||!this._cacheLayerIds.includes(n)||!s.id())return;(null!==(r=this._nodeCacheMap.get(n))&&void 0!==r?r:this._createLayerNodeCacheMap(n)).set(s.id(),s)}))}_createLayerNodeCacheMap(e){const t=new Map;return this._nodeCacheMap.set(e,t),t}}},56378:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});var r=i(67986),s=i(8757);const n=new class{constructor(){this._layerCacheMapper=new Map,this._enableCache=!0}cacheWidget(e,t){this._enableCache&&this._layerCacheMapper.set(e,{widget:t})}evictCacheByMutation(e){if(!e)return;e.map((e=>{const t=e.getMutationSideEffect(),i=this._layerCacheMapper.get(t.pageId);if(i){const{widget:e}=i;e.dirty=!0}const r=this._layerCacheMapper.get(t.layerId);if(r){const e=r.widget.getParent();e&&(e.dirty=!0)}if([s.x1.GROUP_LAYER,s.x1.UNGROUP_LAYER].includes(e.type))return[t.layerId,...t.childLayerIds,t.pageId];if(e.type===s.x1.UPDATE_LAYER&&r){const{widget:e}=r,t=e.getParent();(null==t?void 0:t.type)===s.Wq.GROUP_LAYER?t.getChildren().forEach((e=>e.dirty=!0)):e.dirty=!0}return[t.layerId,t.pageId]})).flat().forEach((e=>this.evictCache(e)))}evictCache(e){const t=this._layerCacheMapper.get(e);if(!t||t.widget.dirty)return;this._layerCacheMapper.delete(e),t.widget.destroy();t.widget.getChildren().forEach((e=>this._layerCacheMapper.delete(e.getId()))),r.t.debug("LayerNodeCacheManager.evictCache",e,t.widget)}evictAllCache(){Array.from(this._layerCacheMapper.values()).forEach((e=>e.widget.destroy())),this._layerCacheMapper.clear()}getAllReuseWidgetIds(){return Array.from(this._layerCacheMapper.values()).map((e=>e.widget.getId()))}getCacheWidget(e){var t,i;return this._enableCache&&null!==(t=null===(i=this._layerCacheMapper.get(e))||void 0===i?void 0:i.widget)&&void 0!==t?t:null}}},5317:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});const r=new class{initGlobalVars(e){this._globalVars=e}getGlobalVars(){return this._globalVars}getGlobalVar(e){return this._globalVars[e]}}},14764:(e,t,i)=>{"use strict";i.d(t,{$U:()=>a,Gm:()=>l,K8:()=>d,Qe:()=>u,Ui:()=>n,fy:()=>s,gt:()=>o,je:()=>g,lr:()=>h,mz:()=>c,uL:()=>f});var r=i(8757);const s="MainLayer",n="FeatureLayer",a="MainBackground",o=[r.Wq.IMAGE,r.Wq.TEXT,r.Wq.GROUP_LAYER,r.Wq.SHAPE,r.Wq.IMAGE_CONTAINER,r.Wq.LINE,r.Wq.PAGE,r.Wq.GRID,r.Wq.SVG_IMAGE],h=4e3,d=4e3,c=.6,l=8;var g;!function(e){e[e.editable=1]="editable",e[e.readonly=2]="readonly"}(g||(g={}));const u=4,f=0},63345:(e,t,i)=>{"use strict";i.d(t,{AI:()=>y,BF:()=>r,Fs:()=>l,JZ:()=>u,Jc:()=>n,PY:()=>_,SN:()=>w,UD:()=>s,X2:()=>p,eT:()=>c,es:()=>o,f7:()=>f,fV:()=>g,hm:()=>x,ox:()=>m,q:()=>a,qf:()=>h,tW:()=>v,y4:()=>d,zL:()=>I});const r="rgba(255, 255, 255, 1)",s="rgba(0, 202, 224, 0.2)",n="#00cae0",a="#7153E6",o="rgba(31, 58, 71, 0.65)",h="rgba(7, 50, 71, 0.16)",d="white",c="rgba(31, 58, 71, 0.65)",l="transparent",g="rgba(255, 255, 255, 1)",u="#1e1e28",f="#dce1e5",_="rgba(255, 255, 255, 0.5)",y="rgba(0, 0, 0, 0.4)",p="rgba(31, 66, 102, 0.16)",m="rgba(31, 66, 102, 0.12)",v="rgba(31, 66, 102, 0.85)",x="rgba(0, 202, 224, 0.8)",w="white",I="rgba(152, 161, 171, 1)"},11005:(e,t,i)=>{"use strict";var r,s;function n(...e){return e.reduce(((t,i,r)=>t+i+(r<e.length-1?" ":"")),"")}i.d(t,{VZ:()=>n,Z2:()=>r,qB:()=>s}),function(e){e.layoutupdate="layoutupdate",e.transform="transform",e.transformstart="transformstart",e.transformend="transformend",e.dblclick="dblclick",e.dragstart="dragstart",e.dragmove="dragmove",e.dragend="dragend",e.layoutupdateend="layoutupdateend",e.click="click",e.mousedown="mousedown",e.mousemove="mousemove",e.mouseup="mouseup",e.mouseenter="mouseenter",e.mouseout="mouseout"}(r||(r={})),function(e){e.replacestart="replacestart",e.replaceend="replaceend",e.cropstart="cropstart",e.cropend="cropend",e.texteditstart="texteditstart",e.texteditend="texteditend"}(s||(s={}))},34618:(e,t,i)=>{"use strict";i.d(t,{I5:()=>r,Jw:()=>_,Mz:()=>f,QJ:()=>u,Qb:()=>a,Vf:()=>o,_m:()=>h,jA:()=>c,ku:()=>l,lz:()=>y,o7:()=>d,uc:()=>g});var r,s=i(8757),n=i(58548);!function(e){e.Background="Background",e.BackgroundImage="BackgroundImage",e.ImageContainerClipPath="ImageContainerClipPath",e.ImageContainerContent="ImageContainerContent",e.TextContent="TextContent",e.GridAreaContainer="GridAreaContainer",e.GridContent="GridContainer",e.AI="AI"}(r||(r={}));const a=(e,t)=>({id:`${e}-${r.Background}`,type:`${t}-${r.Background}`,hitFunc(e){(0,n.b)(e,this)}}),o=(e,t)=>({id:`${e}-${r.BackgroundImage}`,type:`${t}-${r.BackgroundImage}`}),h=(e,t,i)=>({id:`${e}-${r.ImageContainerClipPath}`,type:`${t}-${r.ImageContainerClipPath}`}),d=(e,t,i)=>({id:`${e}-${r.ImageContainerContent}-${i}`,type:`${t}-${r.ImageContainerContent}`}),c=(e,t)=>({id:`${e}-${r.GridAreaContainer}-${t}`,type:`${s.Wq.GRID}-${r.GridAreaContainer}`}),l=(e,t)=>({id:`${e}-${r.GridContent}-${t}`,type:`${s.Wq.GRID}-${r.GridContent}`}),g=e=>`${e}-${r.Background}`,u=e=>`${e}-${r.AI}`,f=e=>{if(!e)return"";const t=e.split("-");return t.length>1?t[0]:""},_=e=>{if(void 0===e)return;const t=e.split("-"),i=[s.Wq.GROUP_LAYER,s.Wq.KONVA_LAYER,s.Wq.PAGE,s.Wq.IMAGE_CONTAINER,s.Wq.TEXT,s.Wq.GRID];return t.length>1&&i.includes(t[0])?t[0]:void 0},y=9},67926:(e,t,i)=>{"use strict";function r(){return function(e,t,i){const r=i.value;return i.value=async function(...e){const t=r.apply(this,e);this.onReady=()=>t;return await this.onReady()},i}}i.d(t,{C:()=>r})},25629:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var r=i(55900);const s=new class{constructor(){this.interact={onMaterialSelect:new r.j,onDeleteOutsideLayer:new r.j,onMaterialSelectChange:new r.j,onPageZoomChange:new r.j,onPageScrollChange:new r.j,onMoveModeChange:new r.j,onPageLayoutChange:new r.j,onContextMenu:new r.j,onModelInitFinish:new r.j,onPageBgImageDbClick:new r.j,onTextEdit:new r.j,onTextSelectRangeChange:new r.j,onDistanceMeasureStart:new r.j,onDistanceMeasureEnd:new r.j},this.canvas={mousedown:new r.j,mousemove:new r.j,mouseup:new r.j,click:new r.j,mouseover:new r.j,mouseout:new r.j,mouseenter:new r.j,scroll:new r.j,wheel:new r.j,contextmenu:new r.j},this.action={onPreviewModeChange:new r.j,onModelChange:new r.j},this.stage={viewportSizeChange:new r.j,ratioChange:new r.j,pageRangeChange:new r.j,onFirstRenderReady:new r.j},this.appLayer={onEditorModeChange:new r.j,onDragCopyEvent:new r.j,onGlobalHotKeyEvent:new r.j},this.textLayer={onNeedLayoutChange:new r.j}}}},87004:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var r=i(25629);class s{constructor(e){this._onContextmenu=e=>{r.Z.canvas.contextmenu.fire(e)},this._onMouseDown=e=>{2!==e.evt.button&&r.Z.canvas.mousedown.fire(e)},this._onMouseMove=e=>{r.Z.canvas.mousemove.fire(e)},this._onMouseUp=e=>{r.Z.canvas.mouseup.fire(e)},this._onMouseOver=e=>{r.Z.canvas.mouseover.fire(e)},this._onMouseOut=e=>{r.Z.canvas.mouseout.fire(e)},this._onClick=e=>{r.Z.canvas.click.fire(e)},this._onMouseEnter=e=>{r.Z.canvas.mouseenter.fire(e)},this._onWheel=e=>{r.Z.canvas.wheel.fire(e)},this._node=e}register(){if(!this._node)throw new Error("missing node");this._node.on("mousedown",this._onMouseDown),this._node.on("mousemove",this._onMouseMove),this._node.on("mouseup",this._onMouseUp),this._node.on("mouseover",this._onMouseOver),this._node.on("mouseout",this._onMouseOut),this._node.on("click",this._onClick),this._node.on("mouseenter",this._onMouseEnter),this._node.on("wheel",this._onWheel),this._node.on("contextmenu",this._onContextmenu)}destroy(){this._node&&(this._node.off("mousedown",this._onMouseDown),this._node.off("mousemove",this._onMouseMove),this._node.off("mouseup",this._onMouseUp),this._node.off("mouseover",this._onMouseOver),this._node.off("mouseout",this._onMouseOut),this._node.off("click",this._onClick),this._node.off("mouseenter",this._onMouseEnter),this._node.off("wheel",this._onWheel),this._node.off("contextmenu",this._onContextmenu),this._node=null)}}},33131:(e,t,i)=>{"use strict";i.d(t,{t:()=>C});var r,s,n,a,o,h,d,c,l,g,u=i(82440),f=i(49171),_=i(5317),y=i(34618),p=i(68967),m=i(67986),v=i(44362),x=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},w=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const I="offscreenCanvas";class P{constructor(){this._setEffectInitInfo=!1,this._textScaleMaps=new Map,this._maps=new Map}get wasm(){return u.fc.getInstance().wasm}get effectInstance(){return this.wasm.effectInstance}async init(){if(this.wasm.isReady()||await this.wasm.init(),!this._setEffectInitInfo){this._setEffectInitInfo=!0;const e=(0,p.gO)().__debug_console__?0:Number(localStorage.getItem("setEffectLogLevel")||y.lz);this.setLogLevel(e),await this.createEffectCanvas(720,720)}}_getTextScaleMaps(e){return this._textScaleMaps.get(e)}getTextScale(e){return this._getTextScaleMaps(e)}async setLogLevel(e){var t;await(null===(t=this.effectInstance)||void 0===t?void 0:t.setLogLevel(e))}async seekFrame(e){var t;await(null===(t=this.effectInstance)||void 0===t?void 0:t.seekFrame(e,0))}async addGraphic(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.addGraphic({element_id:e,width:t.width,height:t.height,binary_data:t.binaryData,is_need_premulti_alpha:!0}))}async replaceGraphic(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.replaceGraphic({element_id:e,width:t.width,height:t.height,binary_data:t.binaryData,is_need_premulti_alpha:!0}))}updateGraphic(...e){var t;return null===(t=this.effectInstance)||void 0===t?void 0:t.updateGraphic(...e)}async removeGraphic(...e){var t;await(null===(t=this.effectInstance)||void 0===t?void 0:t.removeGraphic(...e))}async initGraphicPostProcess(e){var t,i,r;const{id:s,path:n,width:a,height:o}=e;await(null===(t=this.effectInstance)||void 0===t?void 0:t.createLumiHub(s,n)),await(null===(i=this.effectInstance)||void 0===i?void 0:i.setInputTextureSize(s,a,o)),await(null===(r=this.effectInstance)||void 0===r?void 0:r.seekFrame(s,0))}async getOutputTextureSize(e){var t;const i=await(null===(t=this.effectInstance)||void 0===t?void 0:t.getOutputTextureSize(e));if(!i)throw new Error(`failed to get render texture size for ${e}`);const{width:r,height:s}=JSON.parse(i);return{width:r,height:s}}async addTextInTrack(e,t){var i;this._textScaleMaps.set(e,t.scale[0]);const r={...t,position:[0,0,0],rotation:[0,0,0]};await(null===(i=this.effectInstance)||void 0===i?void 0:i.addText({element_id:e,json_param:JSON.stringify(r)}))}async createEffectCanvas(e,t){if(this._getCanvas(I))return this._getCanvas(I);const{id:i,canvas:r}=this.createOffscreenCanvas(e,t,I);return await this._createEffectCanvas({id:i,width:e,height:t}),r}async updateEffectCanvasInfo(e){const t=this._getCanvas(I),{width:i,height:r}=e;await this._setCanvasSize({width:i,height:r}),t.width=i,t.height=r}async setTextUpdateCommand(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_TEXT_PARAM,iParam1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:t}))}async updateScaleSize(e,t,i){var r;this._textScaleMaps.set(e,t),await(null===(r=this.effectInstance)||void 0===r?void 0:r.setTextScaleRuntime(e,t,i))}async setSysFontPaths(e){var t;const{VectorString:i}=this.wasm;if(!i||!e)return;const r=new i;e.forEach((e=>{null==r||r.push_back(e)})),await(null===(t=this.effectInstance)||void 0===t?void 0:t.setSysFontPaths(r))}async getFontInnerLayout(e){const t=this._getCanvas(I);let i="";await(0,f.Rt)(u.Bm.getFontLayout,(async()=>{var t;i=await(null===(t=this.effectInstance)||void 0===t?void 0:t.getLocalBBoxRuntime(e))}));const r=JSON.parse(i);return{width:Math.max(1,Math.abs((r.left-r.right)*((null==t?void 0:t.width)||0))/2),height:Math.max(1,Math.abs((r.top-r.bottom)*((null==t?void 0:t.height)||0))/2)}}async setTextStaticInfo(e,t){try{var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextStatic(e,{iOpCode:u.QI.CT_EDIT_TEXT_PARAM,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:JSON.stringify(t)}))}catch(r){m.t.error(r,t)}}async setCanvasStaticSize(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setCanvasSizeStatic(e,t))}async getFontOuterLayout(e){var t;const i=await(null===(t=this.effectInstance)||void 0===t?void 0:t.getLocalExpandedBBoxRuntime(e));return JSON.parse(i)}async getFontStaticInnerLayout({id:e,scaleX:t,scaleY:i,canvasWidth:r,canvasHeight:s}){var n,a,o;const h=await(null===(n=this.effectInstance)||void 0===n?void 0:n.getTextStatic(e,{iOpCode:u.QI.CT_GET_TEXT_RECT,iParam1:t,iParam2:i,iParam3:1,iParam4:0,pParam5:""})),d=JSON.parse(h||"{}");return{width:Math.max(1,Math.abs(((null==d?void 0:d.iParam1)-(null==d?void 0:d.iParam3))*(r||0))/2),height:Math.max(1,Math.abs(((null==d?void 0:d.iParam2)-(null==d?void 0:d.iParam4))*(s||0))/2),ascentYmaxDis:(null!==(a=null===(o=JSON.parse(null==d?void 0:d.pParam5))||void 0===o?void 0:o.ascentYmaxDis)&&void 0!==a?a:0)*r}}getErrorInfos(){var e;const t=null===(e=this.effectInstance)||void 0===e?void 0:e.getErrorInfos();return JSON.parse(t||"[]")}removeText(e){var t;this._textScaleMaps.delete(e),null===(t=this.effectInstance)||void 0===t||t.removeText(e)}getCanvas(){return this._getCanvas(I)}createOffscreenCanvas(e,t,i=I){let r=this._maps.get(i);if(r)return r.width=e,r.height=t,{id:i,canvas:r};const{document:s}=_.Z.getGlobalVars();return r=s.createElement("canvas"),r.id=i,r.width=e,r.height=t,r.style.pointerEvents="none",r.style.position="fixed",r.style.left="0px",r.style.top="0px",r.style.display="none",i===I&&s.body.appendChild(r),this._maps.set(i,r),{id:i,canvas:r}}async getTextRichStr(e,t){var i;const{json:r=!1,range:s,selection:n=!0}=t,a={iParam1:0,iParam2:0,iParam3:0,iParam4:n?0:1,pParam5:JSON.stringify({getJson:r})};s&&Object.assign(a,{iParam1:2,iParam2:s.start,iParam3:s.end-s.start});const o=await(null===(i=this.effectInstance)||void 0===i?void 0:i.getTextRuntime(e,{iOpCode:u.QI.CT_GET_RICH_STR,...a}));let h="";return o&&(h=JSON.parse(o).pParam5),h}async getTextEditInfo(e){var t;const i=await(null===(t=this.effectInstance)||void 0===t?void 0:t.getTextRuntime(e,{iOpCode:u.QI.CT_GET_EDIT_CONTEXT_INFO,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""})),r=JSON.parse(i||"{}");return this._parseTextEditInfo(r)}async setFont(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_FONT,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:JSON.stringify(t)}))}async setFill(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_FILL,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:JSON.stringify(t)}))}async setSize(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_SIZE,iParam1:t,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async setBold(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_BOLD,iParam1:Number(t),iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async setItalic(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_ITALIC,iParam1:Number(t),iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async setUnderline(e,t){var i;const{enable:r,component:s}=t;var n,a;s&&await(null===(n=this.effectInstance)||void 0===n?void 0:n.setTextRuntime(e,{iOpCode:u.QI.CT_SELECT_ALL_CONTENT,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""}));(await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_UNDERLINE,iParam1:Number(r),iParam2:0,iParam3:0,iParam4:0,pParam5:""})),s)&&await(null===(a=this.effectInstance)||void 0===a?void 0:a.setTextRuntime(e,{iOpCode:u.QI.CT_SELECT_CONTENT,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async addShadow(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_SHADOW,iParam1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:JSON.stringify(t)}))}async editShadow(e,t,i){var r;await(null===(r=this.effectInstance)||void 0===r?void 0:r.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_SHADOW,iParam1:0,iParam2:t,iParam3:0,iParam4:0,pParam5:JSON.stringify(i)}))}async deleteShadow(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_SHADOW,iParam1:2,iParam2:t,iParam3:0,iParam4:0,pParam5:""}))}async deleteAllShadow(e){var t;await(null===(t=this.effectInstance)||void 0===t?void 0:t.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_SHADOW,iParam1:3,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async addOutline(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_STROKE,iParam1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:JSON.stringify(t)}))}async editOutline(e,t,i){var r;await(null===(r=this.effectInstance)||void 0===r?void 0:r.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_STROKE,iParam1:0,iParam2:t,iParam3:0,iParam4:0,pParam5:JSON.stringify(i)}))}async deleteOutline(e,t){var i;await(null===(i=this.effectInstance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_STROKE,iParam1:2,iParam2:t,iParam3:0,iParam4:0,pParam5:""}))}async deleteAllOutline(e){var t;await(null===(t=this.effectInstance)||void 0===t?void 0:t.setTextRuntime(e,{iOpCode:u.QI.CT_EDIT_MULTI_STROKE,iParam1:3,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}_getCanvas(e){return this._maps.get(e)}_createEffectCanvas({id:e,width:t,height:i}){var r;null===(r=this.effectInstance)||void 0===r||r.createCanvas({canvas_id:`#${e}`,width:t,height:i,font_path:""})}_setCanvasSize({width:e,height:t}){var i;null===(i=this.effectInstance)||void 0===i||i.setCanvasSize(e,t)}_parseTextEditInfo(e){try{const t=JSON.parse((null==e?void 0:e.pParam5)||"{}"),i=v.Q.xmlToJson(t.richText);let r=!1,s=0,n=0;i.styles.forEach((e=>{e.select&&(r||(s=e.range[0]),n=e.range[1],r=!0)}));const a={start:e.iParam2,end:e.iParam2};return s<n&&r&&(a.start=s,a.end=n),{richJson:i,text:r?i.text.slice(s,n):"",selectionStart:a.start,selectionEnd:a.end}}catch(t){throw m.t.error(`faild to parse text edit info: ${JSON.stringify(e)}`,t),t}}}x([(0,f.E4)(u.Bm.seekFrame),w("design:type",Function),w("design:paramtypes",[String]),w("design:returntype","function"==typeof(r="undefined"!=typeof Promise&&Promise)?r:Object)],P.prototype,"seekFrame",null),x([(0,f.E4)(u.Bm.addGraphic),w("design:type",Function),w("design:paramtypes",[String,Object]),w("design:returntype","function"==typeof(s="undefined"!=typeof Promise&&Promise)?s:Object)],P.prototype,"addGraphic",null),x([(0,f.E4)(u.Bm.replaceGraphic),w("design:type",Function),w("design:paramtypes",[String,Object]),w("design:returntype","function"==typeof(n="undefined"!=typeof Promise&&Promise)?n:Object)],P.prototype,"replaceGraphic",null),x([(0,f.E4)(u.Bm.updateGraphic),w("design:type",Function),w("design:paramtypes",[Object]),w("design:returntype",Object)],P.prototype,"updateGraphic",null),x([(0,f.E4)(u.Bm.removeGraphic),w("design:type",Function),w("design:paramtypes",[Object]),w("design:returntype","function"==typeof(a="undefined"!=typeof Promise&&Promise)?a:Object)],P.prototype,"removeGraphic",null),x([(0,f.E4)(u.Bm.initGraphicPostProcess),w("design:type",Function),w("design:paramtypes",[Object]),w("design:returntype",Promise)],P.prototype,"initGraphicPostProcess",null),x([(0,f.E4)(u.Bm.getOutputTextureSize),w("design:type",Function),w("design:paramtypes",[String]),w("design:returntype",Promise)],P.prototype,"getOutputTextureSize",null),x([(0,f.E4)(u.Bm.addText),w("design:type",Function),w("design:paramtypes",[String,Object]),w("design:returntype","function"==typeof(o="undefined"!=typeof Promise&&Promise)?o:Object)],P.prototype,"addTextInTrack",null),x([(0,f.E4)(u.Bm.setTextUpdateCommand),w("design:type",Function),w("design:paramtypes",[String,String]),w("design:returntype","function"==typeof(h="undefined"!=typeof Promise&&Promise)?h:Object)],P.prototype,"setTextUpdateCommand",null),x([(0,f.E4)(u.Bm.editScale),w("design:type",Function),w("design:paramtypes",[String,Number,Number]),w("design:returntype","function"==typeof(d="undefined"!=typeof Promise&&Promise)?d:Object)],P.prototype,"updateScaleSize",null),x([(0,f.E4)(u.Bm.setSysFontPaths),w("design:type",Function),w("design:paramtypes",[Array]),w("design:returntype","function"==typeof(c="undefined"!=typeof Promise&&Promise)?c:Object)],P.prototype,"setSysFontPaths",null),x([(0,f.E4)(u.Bm.setTextInfo),w("design:type",Function),w("design:paramtypes",[Object,Object]),w("design:returntype",Promise)],P.prototype,"setTextStaticInfo",null),x([(0,f.E4)(u.Bm.getFontLayout),w("design:type",Function),w("design:paramtypes",[String]),w("design:returntype","function"==typeof(l="undefined"!=typeof Promise&&Promise)?l:Object)],P.prototype,"getFontOuterLayout",null),x([(0,f.E4)(u.Bm.getTextEditInfo),w("design:type",Function),w("design:paramtypes",[String]),w("design:returntype","function"==typeof(g="undefined"!=typeof Promise&&Promise)?g:Object)],P.prototype,"getTextEditInfo",null),x([(0,f.E4)(u.Bm.createEffectCanvas),w("design:type",Function),w("design:paramtypes",[Object]),w("design:returntype",void 0)],P.prototype,"_createEffectCanvas",null),x([(0,f.E4)(u.Bm.setCanvasSize),w("design:type",Function),w("design:paramtypes",[Object]),w("design:returntype",void 0)],P.prototype,"_setCanvasSize",null);const C=new P},32598:(e,t,i)=>{"use strict";i.d(t,{g:()=>M});var r,s,n,a,o,h,d=i(33131),c=i(49171),l=i(8757),g=i(82440),u=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},f=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class _{constructor(){this.effectCore=d.t}get effectIntance(){var e;return null===(e=this.effectCore)||void 0===e?void 0:e.effectInstance}async setSelectSomeText(e,t,i){var r;await(null===(r=this.effectIntance)||void 0===r?void 0:r.setTextRuntime(e,{iOpCode:g.QI.CT_SELECT_CONTENT,iParam1:t,iParam2:i-t,iParam3:0,iParam4:0,pParam5:""}))}async setTextCursorByPos(e,t,i){var r;await(null===(r=this.effectIntance)||void 0===r?void 0:r.setTextStatic(e,{iOpCode:g.QI.CT_MOVE_CURSOR_BY_POS,iParam1:t,iParam2:i,iParam3:0,iParam4:0,pParam5:""}))}async getTextCursorIndex(e){var t,i;const r=await(null===(t=this.effectIntance)||void 0===t?void 0:t.getTextStatic(e,{iOpCode:g.QI.CT_GET_CURSOR_CHAR_INDEX,iParam1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:""})),s=JSON.parse(r||"{}");return null!==(i=null==s?void 0:s.iParam1)&&void 0!==i?i:0}async getTextCursorRect(e){var t,i,r;const s=await(null===(t=this.effectIntance)||void 0===t?void 0:t.getTextStatic(e,{iOpCode:g.QI.CT_GET_CURSOR_RECT,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""})),n=JSON.parse(s||"{}");return{x:null!==(i=null==n?void 0:n.iParam1)&&void 0!==i?i:0,y:null!==(r=null==n?void 0:n.iParam2)&&void 0!==r?r:0,width:(null==n?void 0:n.iParam3)||0,height:(null==n?void 0:n.iParam4)||0}}async setTextCursorByIndex(e,t,i){var r;await(null===(r=this.effectIntance)||void 0===r?void 0:r.setTextStatic(e,{iOpCode:g.QI.CT_MOVE_CURSOR_BY_INDEX,iParam1:t,iParam2:i,iParam3:0,iParam4:0,pParam5:""}))}async setTextCursorByIndexRuntime(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:g.QI.CT_MOVE_CURSOR_BY_INDEX,iParam1:t,iParam2:-1,iParam3:0,iParam4:0,pParam5:""}))}async insertText(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:g.QI.CT_INPUT_STR,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:t}))}async deleteText(e){var t;await(null===(t=this.effectIntance)||void 0===t?void 0:t.setTextRuntime(e,{iOpCode:g.QI.CT_BACK_DELETE,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async composeStart(e){var t;await(null===(t=this.effectIntance)||void 0===t?void 0:t.setTextRuntime(e,{iOpCode:g.QI.CT_START_COMPOSE,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async composeUpdate(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:g.QI.CT_PREEDIT_COMPOSE,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:t}))}async composeEnd(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:g.QI.CT_END_COMPOSE,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:t}))}async setCursorByMovePos(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:t===l.Nm.LEFT||t===l.Nm.RIGHT?g.QI.CT_MOVE_CURSOR_LR:g.QI.CT_MOVE_CURSOR_UPDOWN,iParam1:0===t||1===t?-1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async setTextCursorAndSelect(e,t){var i;await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:[l.Nm.LEFT,l.Nm.RIGHT].includes(t)?g.QI.CT_SELECT_LR_CONTENT:g.QI.CT_SELECT_UPDOWN_CONTENT,iParam1:[l.Nm.LEFT,l.Nm.UP].includes(t)?-1:1,iParam2:0,iParam3:0,iParam4:0,pParam5:""}))}async resetTextEditInfo(e,t){var i;const{selectionStart:r,selectionEnd:s,richJson:n}=t;var a,o;(await(null===(i=this.effectIntance)||void 0===i?void 0:i.setTextRuntime(e,{iOpCode:g.QI.CT_SELECT_ALL_CONTENT,iParam1:0,iParam2:0,iParam3:0,iParam4:0,pParam5:""})),await this.effectCore.setTextUpdateCommand(e,JSON.stringify({richText:JSON.stringify(n)})),r<s)?await(null===(a=this.effectIntance)||void 0===a?void 0:a.setTextRuntime(e,{iOpCode:g.QI.CT_SELECT_CONTENT,iParam1:r,iParam2:s-r,iParam3:0,iParam4:0,pParam5:""})):await(null===(o=this.effectIntance)||void 0===o?void 0:o.setTextRuntime(e,{iOpCode:g.QI.CT_MOVE_CURSOR_BY_INDEX,iParam1:s,iParam2:-1,iParam3:0,iParam4:0,pParam5:""}))}}u([(0,c.E4)(g.Bm.selectSomeText),f("design:type",Function),f("design:paramtypes",[String,Number,Number]),f("design:returntype",Promise)],_.prototype,"setSelectSomeText",null),u([(0,c.E4)(g.Bm.setTextCursor),f("design:type",Function),f("design:paramtypes",[String,Number,Number]),f("design:returntype",Promise)],_.prototype,"setTextCursorByPos",null),u([(0,c.E4)(g.Bm.getTextCursorIndex),f("design:type",Function),f("design:paramtypes",[String]),f("design:returntype","function"==typeof(r="undefined"!=typeof Promise&&Promise)?r:Object)],_.prototype,"getTextCursorIndex",null),u([(0,c.E4)(g.Bm.getTextCursorRect),f("design:type",Function),f("design:paramtypes",[String]),f("design:returntype","function"==typeof(s="undefined"!=typeof Promise&&Promise)?s:Object)],_.prototype,"getTextCursorRect",null),u([(0,c.E4)(g.Bm.setTextCursorByIndex),f("design:type",Function),f("design:paramtypes",[String,Number,Object]),f("design:returntype",Promise)],_.prototype,"setTextCursorByIndex",null),u([(0,c.E4)(g.Bm.setTextCursorByIndex),f("design:type",Function),f("design:paramtypes",[String,Number]),f("design:returntype",Promise)],_.prototype,"setTextCursorByIndexRuntime",null),u([(0,c.E4)(g.Bm.setTextCursorByIndex),f("design:type",Function),f("design:paramtypes",[String,String]),f("design:returntype",Promise)],_.prototype,"insertText",null),u([(0,c.E4)(g.Bm.deleteText),f("design:type",Function),f("design:paramtypes",[String]),f("design:returntype","function"==typeof(n="undefined"!=typeof Promise&&Promise)?n:Object)],_.prototype,"deleteText",null),u([(0,c.E4)(g.Bm.composeStart),f("design:type",Function),f("design:paramtypes",[String]),f("design:returntype",Promise)],_.prototype,"composeStart",null),u([(0,c.E4)(g.Bm.composeUpdate),f("design:type",Function),f("design:paramtypes",[String,String]),f("design:returntype",Promise)],_.prototype,"composeUpdate",null),u([(0,c.E4)(g.Bm.composeEnd),f("design:type",Function),f("design:paramtypes",[String,String]),f("design:returntype",Promise)],_.prototype,"composeEnd",null),u([(0,c.E4)(g.Bm.setCursorByMovePos),f("design:type",Function),f("design:paramtypes",[String,"function"==typeof(a=void 0!==l.Nm&&l.Nm)?a:Object]),f("design:returntype",Promise)],_.prototype,"setCursorByMovePos",null),u([(0,c.E4)(g.Bm.setTextCursorAndSelect),f("design:type",Function),f("design:paramtypes",[String,"function"==typeof(o=void 0!==l.Nm&&l.Nm)?o:Object]),f("design:returntype",Promise)],_.prototype,"setTextCursorAndSelect",null),u([(0,c.E4)(g.Bm.resetTextEditInfo),f("design:type",Function),f("design:paramtypes",[String,Object]),f("design:returntype","function"==typeof(h="undefined"!=typeof Promise&&Promise)?h:Object)],_.prototype,"resetTextEditInfo",null);var y,p,m,v,x=i(67986),w=i(28162),I=i(44264),P=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},C=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class M{constructor(){this._effectCore=d.t,this._taskSchedule=w.f,this._updateActionMaps={},this._effectTextEditCore=new _,this._updateActionMaps={selectSomeStr:async(e,t)=>{const{startIndex:i,endIndex:r}=t;await this._effectTextEditCore.setSelectSomeText(e,i,r)},insertText:async(e,t)=>{const{text:i,uppercase:r}=t;await this._effectTextEditCore.insertText(e,r?i.toLocaleUpperCase():i)},deleteText:async e=>{await this._effectTextEditCore.deleteText(e)},moveCursor:async(e,t)=>{t.select?await this._effectTextEditCore.setTextCursorAndSelect(e,t.direction):await this._effectTextEditCore.setCursorByMovePos(e,t.direction)},compose:async(e,t)=>{await this.compose(e,t.text,t.phase)},resetTextEditInfo:async(e,t)=>{await this._effectTextEditCore.resetTextEditInfo(e,t)}}}updateEditText(e,t){return this.addTask(e,(async()=>{var i;const r=this.getNode(e);if(!r)return null;const{offsetParams:s,scale:n}=t;r.setState({offsetParams:s,scale:n});const{richText:a,...o}=null!==(i=t.text_params)&&void 0!==i?i:{};r.setTextParams({...o,typeSettingPathEnable:!1,typeSettingPathParam:void 0});return await r.draw(!0)}))}async updateCacheCanvas(e,t){const i=this.getNode(e);i&&(i.setStateByModel((e=>({...t,layout:{...t.layout,scale:{x:e.scale[0],y:e.scale[1]}}}))),await i.draw())}async getCursorPosByClick({id:e,textInfo:t,clickAbsolutePos:i,params:r}){const{align:s}=r,{padding:n,renderScale:a,effectBbBoxWidth:o,layerWidth:h,layerHeight:d}=await this._getCommonTextInfo(e,r,t),{x:c,y:l}=await this.transLayerPosToEffect({layerWidth:h,layerHeight:d,effectBbBoxWidth:o,clickAbsolutePos:i,align:s});return await this._effectTextEditCore.setTextCursorByPos(e,c,l),this.getTextCursorPos(e,{align:s,padding:n,renderScale:a,effectBbBoxWidth:o,layerWidth:h,layerHeight:d})}async getCursorPosByIndex({id:e,textInfo:t,index:i,params:r,cursorPosition:s}){const{align:n}=r,{padding:a,renderScale:o,effectBbBoxWidth:h,layerWidth:d,layerHeight:c}=await this._getCommonTextInfo(e,r,t);return this._effectTextEditCore.setTextCursorByIndex(e,i,s),this.getTextCursorPos(e,{align:n,padding:a,renderScale:o,effectBbBoxWidth:h,layerWidth:d,layerHeight:c})}async getTextCursorPos(e,t){const{align:i,padding:r,effectBbBoxWidth:s,layerHeight:n}=t,a=await this._effectTextEditCore.getTextCursorRect(e),o=await this._effectTextEditCore.getTextCursorIndex(e);let h=(1+a.x)*(s/2);i===l.PH.CENTER?h+=r:i===l.PH.RIGHT&&(h+=2*r);const d=(1-a.y)*(n/2),c=a.width*s,g=a.height*n;return{x:h,y:d-g,width:c,height:g,index:o}}async execAction(e){const t=async()=>{const i=e.shift();i&&(await i(),t())};await t()}addTask(e,t){return this._taskSchedule.addTask(e,t).catch((e=>(e&&x.t.error("effect task error",e),null)))}async updateEffectAction(e,t){const i=Object.keys(t).filter((e=>this._updateActionMaps[e])).map((i=>{var r;return null===(r=this._updateActionMaps[i])||void 0===r?void 0:r.bind(null,e,t[i])}));var r;i.length&&(await this.execAction(i),await(null===(r=I.f.cache.get(e))||void 0===r?void 0:r.updateRuntimeRichJson()));const s=(null==t?void 0:t.selectSomeStr)&&(null==t?void 0:t.selectSomeStr.startIndex)!==(null==t?void 0:t.selectSomeStr.endIndex);t.setCursorIndex&&!s&&await this._effectTextEditCore.setTextCursorByIndexRuntime(e,t.setCursorIndex.index)}transLayerPosToEffect({layerWidth:e,layerHeight:t,effectBbBoxWidth:i,clickAbsolutePos:r,align:s}){const n=t/2,a=e/2,o=(n-r.y)/n;let h=0;return s===l.PH.LEFT?(h=(r.x-i/2)/(i/2),{x:h,y:o}):s===l.PH.CENTER?(h=(r.x-a)/(i/2),{x:h,y:o}):(h=(r.x-(e-i)-i/2)/(i/2),{x:h,y:o})}async _getCommonTextInfo(e,t,i){const r=(null==i?void 0:i.width)*(null==i?void 0:i.scale.x),s=(null==i?void 0:i.height)*(null==i?void 0:i.scale.y),n=this.getNode(e),[a]=n.state.scale;let o;if(t.text){o=(await this._effectCore.getFontInnerLayout(e)).width/a}else{var h;const e=JSON.parse(t.richText);await(null==n?void 0:n.syncStaticParams({richText:JSON.stringify({text:"a",styles:[{...null===(h=e.styles)||void 0===h?void 0:h[0],range:[0,1]}]})}));o=(await n.getStaticInnerLayout()).width}const d=o*(null==i?void 0:i.scale.x);return{padding:(r-d)/2,effectBbBoxWidth:d,layerHeight:s,layerWidth:r,renderScale:a}}async compose(e,t,i){i!==l.xb.Start?i!==l.xb.Update?await this._effectTextEditCore.composeEnd(e,t):await this._effectTextEditCore.composeUpdate(e,t):await this._effectTextEditCore.composeStart(e)}getTextEditInfo(e){return this._effectCore.getTextEditInfo(e)}getNode(e){return I.f.cache.get(e)}}P([(0,c.E4)(g.Bm.updateEditText),C("design:type",Function),C("design:paramtypes",[Object,Object]),C("design:returntype","function"==typeof(y="undefined"!=typeof Promise&&Promise)?y:Object)],M.prototype,"updateEditText",null),P([(0,c.E4)(g.Bm.getCursorPosByClick),C("design:type",Function),C("design:paramtypes",[Object]),C("design:returntype","function"==typeof(p="undefined"!=typeof Promise&&Promise)?p:Object)],M.prototype,"getCursorPosByClick",null),P([(0,c.E4)(g.Bm.getCursorPosByIndex),C("design:type",Function),C("design:paramtypes",[Object]),C("design:returntype","function"==typeof(m="undefined"!=typeof Promise&&Promise)?m:Object)],M.prototype,"getCursorPosByIndex",null),P([(0,c.E4)(g.Bm.getTextCursorPos),C("design:type",Function),C("design:paramtypes",[String,Object]),C("design:returntype","function"==typeof(v="undefined"!=typeof Promise&&Promise)?v:Object)],M.prototype,"getTextCursorPos",null)},39589:(e,t,i)=>{"use strict";i.d(t,{ZP:()=>R});var r=i(8757),s=i(49171),n=i(33131),a=i(28162),o=i(25629),h=i(67986),d=i(62587),c=i(50528),l=i(77204);const g=`${Date.now()}`,u={name:g,type:"text",fontPath:"",offsetParams:{offsetX:20,offsetY:20,layoutWidth:750,layoutHeight:80.84388000000001},text_params:{lineMaxWidth:-1,innerPadding:.1,typeSettingAlign:1,decorationWidth:.04,decorationOffset:.15,boldValue:.008,italicDegree:10,canvasRoundRadiusScale:0,canvasColor:[0,0,0,0],canvas:!1,globalAlpha:1,richText:'<b><size=24><color=(0.10588235294117647,0.10588235294117647,0.10588235294117647,1)><font id="7215557092847915521" path="">[a]</font></color></size></b>',autoAdaptDpiEnabled:!1,canvasCustomized:!1,canvasOffsetCustomized:[0,0],canvasRoundCorner:!0,canvasSplitPadding:0,canvasSplitThreshold:1e3,canvasWHCustomized:[1,1],canvasWrapped:!1,fallbackFontPathList:[],oneLineCutOff:!1,selectedColor:[0,.800000011920929,.800000011920929,.4000000059604645],shapeFlipX:!1,shapeFlipY:!1,shapePath:"",version:"2"},original_size:[750,80.84388000000001],position:[180,-180,0],rotation:[0,0,0],scale:[1,1,1],anims:[],duration:3,layout_params:{bottom_toBottomOf:"",fix_dimensionRatio:!1,fix_height:!0,fix_width:!0,hCenter_toHCenterOf:"",left_toLeftOf:"",right_toRightOf:"",top_toTopOf:"",vCenter_toVCenterOf:""},order_in_layer:2,start_time:0,visible:!0};var f,_,y,p,m,v=i(2970),x=i(65748),w=i(82440),I=i(22169),P=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},C=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.create=0]="create",e[e.update=1]="update",e[e.delete=2]="delete",e[e.cached=3]="cached"}(y||(y={})),function(e){e[e.canvas=0]="canvas",e[e.node=1]="node"}(p||(p={})),function(e){e[e.Init=0]="Init",e[e.Created=1]="Created",e[e.Updated=2]="Updated"}(m||(m={}));const M=new x.z6({_capacity:1e3,_cacheKey:"effect_node_cache"}),S=[y.update,y.cached];class E{constructor(e){this._rtSize={width:0,height:0},this._dirty=!0,this._imageDataStatus=m.Init,this._pkgMap=new Map,this._pkgList=[],this._postProcessorCreated=!1,this._postProcessMap=new Map,this._postProcessList=[],this.drawEffect=async()=>{const e=[...this._pkgList];[...this._pkgMap.keys()].forEach((t=>{const i=this._pkgMap.get(t);(null==i?void 0:i.status)===y.delete&&e.unshift(t)})),await Promise.all(e.map((async e=>{const t=this._pkgMap.get(e);if(!t)return;const{resourcePath:i,effectId:r}=t;if(t.status===y.delete)return await this._effectCore.updateGraphic(this.id,r,{iOpCode:w.Tl.GCT_REMOVE_EFFECT,pParam:""}),void this._pkgMap.delete(e);var s;t.status===y.create&&(await this._effectCore.updateGraphic(this.id,r,{iOpCode:w.Tl.GCT_ADD_EFFECT,pParam:i}),await(null===(s=this._effectCore)||void 0===s?void 0:s.seekFrame(this.id)),t.status=y.update);t.status===y.update&&await this._effectCore.updateGraphic(this.id,r,{iOpCode:w.Tl.GCT_EDIT_EFFECT,pParam:JSON.stringify(t.params)}),t.status=y.cached})))},this.drawPostProcess=async()=>{if(!this._postProcessorCreated&&this._postProcessList.length){if(!this.state.postProcessHubResourcePath)throw new Error("postProcessHubResourcePath is empty");await this._effectCore.initGraphicPostProcess({id:this.id,path:this.state.postProcessHubResourcePath,width:this.state.image.width,height:this.state.image.height}),this._postProcessorCreated=!0}const e=[...this._postProcessMap.keys()].reduce(((e,t)=>{const i=this._postProcessMap.get(t);return(null==i?void 0:i.status)===y.delete?(this._postProcessMap.delete(t),[...e,i.effectId]):e}),[]);e.length&&await this._removePostProcess(this.id,e);const t=[...this._postProcessList],i=async()=>{const e=t.shift();if(!e)return;const r=this._postProcessMap.get(e);if(!r)return;const{resourcePath:s}=r;if(r.status===y.create){const e=await this._addPostProcess(this.id,s);r.effectId=e,r.status=y.update}r.status===y.update&&await this._updatePostProcess({id:this.id,effectId:r.effectId,payload:r.params}),r.status=y.cached,await i()};await i()};const{id:t,effectCore:i,state:r}=e;let s=M.get(t);if(s)return s.setState(r),s;s=this,this.id=t,this._effectCore=i,this._state={},this.state=new Proxy(this._state,{set(e,t,i){const r=Reflect.get(e,t);return"image"===t&&i!==r&&s._updateImage(i),"effects"===t&&(s._pkgList=s._diffPkgList(i,s._pkgMap)),"postProcessEffects"===t&&(s._postProcessList=s._diffPkgList(i,s._postProcessMap)),(0,I.isEqual)(i,r)||(s._dirty=!0),Reflect.set(e,t,i)},get:(e,t)=>Reflect.get(s._state,t)}),this.setState(r),M.set(t,this)}setState(e){Object.assign(this.state,e)}async draw(){var e,t,i;if(!this._dirty&&this._renderTexture)return this._renderTexture;const{width:r,height:s}=this._rtSize;switch(await this._effectCore.init(),await this._effectCore.updateEffectCanvasInfo({width:r,height:s}),this._imageDataStatus){case m.Init:await this._effectCore.addGraphic(this.id,{width:r,height:s,binaryData:this._imageData}),await this._effectCore.seekFrame(this.id),this._pkgList.forEach((e=>{const t=this._pkgMap.get(e);t&&t.status!==y.delete?S.includes(null==t?void 0:t.status)&&(t.status=y.create):this._postProcessMap.delete(e)})),this._postProcessList.forEach((e=>{const t=this._postProcessMap.get(e);t&&t.status!==y.delete?S.includes(null==t?void 0:t.status)&&(t.status=y.create):this._postProcessMap.delete(e)}));break;case m.Updated:await this._effectCore.replaceGraphic(this.id,{width:r,height:s,binaryData:this._imageData}),await this._effectCore.seekFrame(this.id)}var n;(this._imageDataStatus=m.Created,await this.drawEffect(),await this.drawPostProcess(),this._postProcessList.length)?(this._rtSize=await(null===(n=this._effectCore)||void 0===n?void 0:n.getOutputTextureSize(this.id)),await this._effectCore.updateEffectCanvasInfo(this._rtSize)):this._rtSize={width:this.state.image.width,height:this.state.image.height};await(null===(e=this._effectCore)||void 0===e?void 0:e.seekFrame(this.id));const a=null===(t=this._effectCore)||void 0===t?void 0:t.getCanvas();if(!a)return;const o=new OffscreenCanvas(this._rtSize.width,this._rtSize.height);return null===(i=o.getContext("2d"))||void 0===i||i.drawImage(a,0,0),this._renderTexture={texture:o,width:this._rtSize.width,height:this._rtSize.height},this._dirty=!1,this._renderTexture}destroy(){this._remove(!0),M.remove(this.id)}_remove(e=!1){this._dirty=!0,this._renderTexture=null,this._imageDataStatus!==m.Init&&(this._imageDataStatus=m.Init,this._postProcessorCreated=!1,this._effectCore.removeGraphic(this.id)),e&&(this._pkgList=[],this._pkgMap.clear(),this._postProcessList=[],this._postProcessMap.clear())}_updateImage(e){this._imageData=(0,v.P)(e),this._rtSize={width:e.width,height:e.height},this._imageDataStatus===m.Init||(this._imageDataStatus=m.Updated)}_diffPkgList(e,t){const i=new Set,r=e.map((e=>{i.add(e.key);const r=t.get(e.key);return r?S.includes(r.status)&&!(0,I.isEqual)(r.params,e.params)&&Object.assign(r,{status:y.update,params:e.params}):t.set(e.key,{...e,effectId:`${this.id}.${e.key}`,status:y.create}),e.key}));return[...t.keys()].forEach((e=>{const r=t.get(e);!i.has(e)&&r&&(r.status=y.delete)})),r}async _addPostProcess(e,t){var i;const r=JSON.stringify({children:[{targetName:"",targetType:1,lumiPath:t}],type:"Video",extraParam:""}),s=await(null===(i=this._effectCore)||void 0===i?void 0:i.updateGraphic(e,"",{iOpCode:w.Tl.GCT_ADD_LUMI_EFFECT,pParam:r}));let n="";try{if(n=JSON.parse(null!=s?s:"{}").effect_id,!n)throw new Error}catch(a){throw new Error(`failed to add postprocess for ${e}, empty postEffectId`)}return n}async _updatePostProcess(e){const{id:t,effectId:i,payload:r}=e,s=JSON.stringify({effectID:i,params:r,enable:!0});await this._effectCore.updateGraphic(t,"",{iOpCode:w.Tl.GCT_EDIT_LUMI_EFFECT,pParam:s});const n=await this._effectCore.getOutputTextureSize(t);await this._effectCore.updateEffectCanvasInfo(n),await this._effectCore.seekFrame(t)}async _removePostProcess(e,t){const i=JSON.stringify({children:[{targetName:"",targetType:1,effectIDs:t}],type:"Video",extraParam:""});await this._effectCore.updateGraphic(e,"",{iOpCode:w.Tl.GCT_REMOVE_LUMI_EFFECT,pParam:i});const r=await this._effectCore.getOutputTextureSize(e);await this._effectCore.updateEffectCanvasInfo(r),await this._effectCore.seekFrame(e)}}E.cache=M,P([(0,s.E4)(w.Bm.renderGraphic),C("design:type",Function),C("design:paramtypes",[]),C("design:returntype","function"==typeof(f="undefined"!=typeof Promise&&Promise)?f:Object)],E.prototype,"draw",null),P([(0,s.E4)(w.Bm.addGraphicPostProcess),C("design:type",Function),C("design:paramtypes",[String,String]),C("design:returntype","function"==typeof(_="undefined"!=typeof Promise&&Promise)?_:Object)],E.prototype,"_addPostProcess",null),P([(0,s.E4)(w.Bm.updateGraphicPostProcess),C("design:type",Function),C("design:paramtypes",[Object]),C("design:returntype",Promise)],E.prototype,"_updatePostProcess",null),P([(0,s.E4)(w.Bm.removeGraphicPostProcess),C("design:type",Function),C("design:paramtypes",[String,Array]),C("design:returntype",Promise)],E.prototype,"_removePostProcess",null);var A=i(44264);const R=new class{constructor(){this._effectCore=n.t,this._taskSchedule=a.f,this._onModelChangeDispose=o.Z.action.onModelChange.event(this._updateEffectCache.bind(this))}initial(){this._triggerEffectFirstRender()}destroy(){this._onModelChangeDispose()}addTask(e,t){return this._taskSchedule.addTask(e,t).catch((e=>(e&&h.t.error("effect task error",e),null)))}renderEffectImage(e,t){return new E({id:e,effectCore:this._effectCore,state:t}).draw()}addEffectText(e,t){return this.addTask(e,(()=>(0,s.Rt)(w.Bm.renderText,(async()=>{const i=(0,d.Y)("effect_add_text"),r=c.X.getInstance();r.markStageStart(l.x5,i);const s=new A.f({id:e,effectCore:this._effectCore,state:t}),n=await s.draw();return r.markStageEnd(l.x5,i),n}))))}updateEffectText(e,t){return this.addTask(e,(()=>(0,s.Rt)(w.Bm.updateAllTime,(async()=>{const i=c.X.getInstance(),r=(0,d.Y)("effect_update_text");i.markStageStart(l.x5,r);let s=A.f.cache.get(e);s||(s=new A.f({id:e,effectCore:this._effectCore})),s.setState(t);const n=await s.draw();return i.markStageEnd(l.x5,r),n}))))}removeText(e){const t=A.f.cache.get(e);t&&t.destroy()}removeGraphic(e){const t=E.cache.get(e);t&&t.destroy()}getFontOuterLayout(e){return this._effectCore.getFontOuterLayout(e)}async getFontAscentMaxDis(e){const t=A.f.cache.get(e);await t.syncStaticParams();const{ascentYmaxDis:i}=await t.getStaticInnerLayout();return i}async getEffectTextLayoutInfo(e,t){const i=new A.f({id:e,effectCore:this._effectCore});return await i.updateRuntimeComponent(t),i.getLayout()}getErrorInfos(){return this._effectCore.getErrorInfos()}_updateEffectCache(e){const{mutations:t}=e;t.forEach((e=>{var t;if(e.type!==r.x1.REMOVE_LAYER)return;null===(t=e.getMutationSideEffect().childLayerIds)||void 0===t||t.forEach((e=>{this.removeGraphic(e),this.removeText(e)}))}))}_triggerEffectFirstRender(){const e=this._effectCore.wasm.init();Promise.resolve(e).then((()=>{this.addEffectText(g,u)}))}}},28162:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r,f:()=>s});class r{constructor(){this._concurrency=1,this._running=0,this._queue=[]}get queue(){return this._queue}addTask(e,t,i){var r;const{cancellable:s=!0}=null!=i?i:{};let n,a;const o=new Promise(((e,t)=>{n=e,a=t})),h=this._queue.findIndex((t=>t.id===e));return null!==(r=this._queue[h])&&void 0!==r&&r.cancellable&&(this._queue[h].reject({cancelled:!0}),this._queue.splice(h,1)),this._queue.push({id:e,taskGenerator:t,resolve:n,reject:a,promise:o,cancellable:s}),this._schedule(),o}_schedule(){for(;this._queue.length>0&&this._running<this._concurrency;){const e=this._queue[0];this._running+=1,e.taskGenerator().then((t=>{e.resolve(t)})).catch((t=>{e.reject(t)})).finally((()=>{this._running-=1,this._removeTask(e),this._schedule()}))}}_removeTask(e){const t=this._queue.findIndex((t=>t===e));t>-1&&this._queue.splice(t,1)}}const s=new r},44264:(e,t,i)=>{"use strict";i.d(t,{f:()=>m});var r=i(65748),s=i(53625),n=i(67986),a=i(43825),o=i(82440),h=i(22169),d=i(49171);const c=e=>{const{layoutWidth:t,layoutHeight:i,offsetX:r,offsetY:s}=e;return{width:Math.ceil(Math.max(1,t+2*r)),height:Math.ceil(Math.max(1,i+2*s))}};var l,g,u=i(38530),f=i(28162),_=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},y=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.canvas=0]="canvas",e[e.node=1]="node"}(g||(g={}));const p=new r.z6({_capacity:1e3,_cacheKey:"effect_node_cache"});class m{constructor(e){this.hasFixHeight=!1,this._dirty=new Set,this._dirtyTextParamKey=new Set,this._created=!1,this._firstCanvasReady=(0,s.P)(),this.updateTextComponent=async()=>{if(!this._created||this._dirty.size){if(await this._effectCore.init(),await this._effectCore.updateEffectCanvasInfo(c(this.state.offsetParams)),this._created&&!this._dirty.has("fallbackFontPathList")||(await this._effectCore.setSysFontPaths(this.state.fallbackFontPathList),this._cropCanvas=null),this._created&&!this._dirty.has("scale")||(await this._effectCore.updateScaleSize(this.id,this.state.scale[0],this.state.scale[1]),this._cropCanvas=null),this._created){if(this._dirty.has("text_params")){const e=this._dirtyTextParamKey.size?(0,h.pick)(this.state.text_params,Array.from(this._dirtyTextParamKey)):this.state.text_params;null!=e&&e.richText&&(this.runtimeRichJson=JSON.parse(e.richText)),await this._effectCore.setTextUpdateCommand(this.id,JSON.stringify(e)),this._cropCanvas=null}}else await this._effectCore.addTextInTrack(this.id,this.state),this._created=!0;this._dirty.clear(),this._dirtyTextParamKey.clear()}},this.syncStaticParams=async e=>{const t={...this.state.text_params,...e};t.richText||(t.richText=JSON.stringify(this.runtimeRichJson)),await this._effectCore.setTextStaticInfo(this.id,t),await this.updateCanvasStatic()},this.updateCanvasStatic=async()=>{const{width:e,height:t}=c(this.state.offsetParams);await this._effectCore.setCanvasStaticSize(e,t)},this.updateRuntimeLetter=async e=>{const t=Object.keys(e),i=async()=>{const r=t.shift();if(!r)return;const s=e[r];switch(r){case"text":const e=await this.getRichTextAttributes({component:!0,selection:!0});await this._effectCore.setTextUpdateCommand(this.id,JSON.stringify({richText:JSON.stringify({...e,text:s})}));break;case"fontSize":await this._effectCore.setSize(this.id,s);break;case"font":await this._effectCore.setFont(this.id,s);break;case"fill":await this._effectCore.setFill(this.id,s);break;case"bold":await this._effectCore.setBold(this.id,s);break;case"italic":await this._effectCore.setItalic(this.id,s);break;case"underline":await this._effectCore.setUnderline(this.id,s);break;case"shadow":if("add"===s.type)await this._effectCore.addShadow(this.id,s.payload);else if("edit"===s.type)await this._effectCore.editShadow(this.id,s.index,s.payload);else if("delete"===s.type)await this._effectCore.deleteShadow(this.id,s.index);else if("init"===s.type){const{current:e}=s;if(await this._effectCore.deleteAllShadow(this.id),null!=e&&e.length)for(let t=0;t<e.length;t++)await this._effectCore.addShadow(this.id,e[t])}break;case"outline":if("add"===s.type)await this._effectCore.addOutline(this.id,s.payload);else if("edit"===s.type)await this._effectCore.editOutline(this.id,s.index,s.payload);else if("delete"===s.type)await this._effectCore.deleteOutline(this.id,s.index);else if("init"===s.type){const{current:e}=s;if(await this._effectCore.deleteAllOutline(this.id),null!=e&&e.length)for(let t=0;t<e.length;t++)await this._effectCore.addOutline(this.id,e[t])}}await i()};return await i(),this._cropCanvas=null,await this._effectCore.seekFrame(this.id),await this.updateRuntimeRichJson(),{richText:this.runtimeRichJson}},this.updateRuntimeRichJson=async()=>{this.runtimeRichJson=await this.getRichTextAttributes({component:!0,selection:!0}),this.state.text_params.richText=JSON.stringify(this.runtimeRichJson)},this.getRichTextAttributes=async(e={component:!1})=>{const{component:t,selection:i}=e;let r;const{selectionStart:s,selectionEnd:a,richJson:o}=await this._effectCore.getTextEditInfo(this.id);t||(r={start:a>s?s:a-1,end:a});const h=await this._effectCore.getTextRichStr(this.id,{range:r,json:!0,selection:i});try{return JSON.parse(h)}catch(d){return n.t.error("\u83b7\u53d6\u5bcc\u6587\u672cJSON\u9519\u8bef",d,h),o}},this.getLayout=async()=>{const[{width:e,height:t},{width:i,height:r}]=await Promise.all([this._effectCore.getFontInnerLayout(this.id),this._effectCore.getFontOuterLayout(this.id)]),[s,n]=this.state.scale;return{innerBoundWidth:e/s,innerBoundHeight:t/n,outerBoundWidth:i/s,outerBoundHeight:r/n}},this.getStaticInnerLayout=async()=>(await this._effectCore.setCanvasStaticSize(a.I7,a.I7),this._effectCore.getFontStaticInnerLayout({id:this.id,scaleX:1,scaleY:1,canvasWidth:a.I7,canvasHeight:a.I7}));const{id:t,effectCore:i,state:r}=e;let o=p.get(t);if(o)return o.setState(r),o;o=this,this.id=t,this._effectCore=i,this._state={},this.state=new Proxy(this._state,{set(e,t,i){const r=Reflect.get(e,t);var s,n;if(!(0,h.isEqual)(i,r)&&(null===(s=o)||void 0===s||s._dirty.add(t),"text_params"===t))return null===(n=o)||void 0===n||n._diffTextParams(r,i),Reflect.set(e,t,{...r,...i});return Reflect.set(e,t,i)},get:(e,t)=>Reflect.get(o._state,t)}),this.setState(r),p.set(t,this)}get runtimeRichJson(){return this._richJson}set runtimeRichJson(e){this._richJson=e}get firstCanvasReady(){return this._firstCanvasReady.promise}get lineMaxWidth(){const{width:e}=c(this.state.offsetParams);return this.state.offsetParams.layoutWidth/e/this.state.scale[0]}setState(e){const t="function"==typeof e?e(this.state):e;Object.assign(this.state,t)}setStateByModel(e){const t=(0,u.m)("function"==typeof e?e(this.state):e);this.setState(t)}setTextParams(e){const t="function"==typeof e?e({...this.state.text_params}):e;this.setState((e=>({text_params:{...e.text_params,...t}})))}async draw(e=!1){if(e&&(this._cropCanvas=null),await this.updateTextComponent(),this._cropCanvas)return this._cropCanvas;await this._effectCore.seekFrame(this.id);const t=await this.createDrawCanvas();return this._cropCanvas=t,this._firstCanvasReady.resolve(),t}async createDrawCanvas(){const e=this._effectCore.getCanvas();if(!e)return null;const{canvas:t}=this._effectCore.createOffscreenCanvas(e.width,e.height,this.id),i=t.getContext("2d");null==i||i.clearRect(0,0,t.width,t.height),null==i||i.drawImage(e,0,0,e.width,e.height);const{width:r,height:s}=await this._effectCore.getFontInnerLayout(this.id);return{canvas:t,canvasRect:{width:r,height:s},scale:{x:this.state.scale[0],y:this.state.scale[1]}}}async updateRuntimeComponent(e){var t,i,r,s,n,a;const h="function"==typeof e?e(this.state):e;await Promise.all([...null!==(t=null===(i=h.fontDependResources)||void 0===i?void 0:i.map((e=>{var t;return null===(t=o.fc.getDependency(e.resourceId))||void 0===t?void 0:t.ready})))&&void 0!==t?t:[],(null==h||null===(r=h.glow)||void 0===r?void 0:r.enable)&&(null==h||null===(s=h.glow)||void 0===s?void 0:s.resourceId)&&(null===(n=o.fc.getDependency(null==h||null===(a=h.glow)||void 0===a?void 0:a.resourceId))||void 0===n?void 0:n.ready)]),this.setStateByModel(h),await f.f.addTask(this.id,this.updateTextComponent)}destroy(){this._remove(!0),p.remove(this.id)}_remove(e=!1){var t;this._dirty.clear(),null===(t=this._cropCanvas)||void 0===t||null===(t=t.canvas)||void 0===t||t.remove(),this._cropCanvas=null,this._created&&(this._created=!1,this._effectCore.removeText(this.id))}_diffTextParams(e,t){t?Object.keys(t).forEach((i=>{(0,h.isEqual)(t[i],null==e?void 0:e[i])||this._dirtyTextParamKey.add(i)})):this._dirtyTextParamKey.clear()}}m.cache=p,_([(0,d.E4)(o.Bm.webCreateCanvas),y("design:type",Function),y("design:paramtypes",[]),y("design:returntype","function"==typeof(l="undefined"!=typeof Promise&&Promise)?l:Object)],m.prototype,"createDrawCanvas",null),_([(0,d.E4)(o.Bm.getFontLayoutApi),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",Promise)],m.prototype,"updateRuntimeComponent",null)},48917:(e,t,i)=>{"use strict";i.d(t,{$T:()=>b,Cd:()=>D,Core:()=>m,Ee:()=>S,Fk:()=>N,Hf:()=>v,UL:()=>P,W2:()=>w,ZA:()=>x,Zr:()=>R,jZ:()=>L,kX:()=>A,mh:()=>I,pK:()=>E,wx:()=>T,x1:()=>C,y$:()=>M});i(13881);var r=i(19926),s=i(92122),n=i(3856),a=i(27484),o=i(21237),h=i(81287),d=i(60391),c=i(99986),l=i(79890),g=(i(97380),i(85846)),u=i(97172),f=i(82080),_=i(74051),y=i(20015),p=i(95780);const m=o.default,v=g.H,x=n.Z,w=a.W,I=h.m,P=l.U,C=f.x,M=c.y,S=d.E,E=r.b,A=u.k,R=_.Z,T=_.w,b=y.$,N=p.F,D=s.C,L=o.default.Filters.RGBA,{Easings:k}=o.default},58571:(e,t,i)=>{"use strict";i.d(t,{x:()=>n});i(19926);var r=i(67233),s=i(36451);class n extends r.x{constructor(){super(...arguments),this._measureTextVerticalOverflow=()=>{const e=(0,s.F)();e.save(),e.font=this._getContextFont(),e.textBaseline="middle",e.textAlign="left",e.direction="ltr";let t=0,i=0;const r=this.fontSize()*this.lineHeight();this.textArr.forEach(((s,n)=>{if(n&&n<this.textArr.length-1)return;const a=e.measureText(s.text);n||(t=a.actualBoundingBoxAscent-r/2),n===this.textArr.length-1&&(i=a.actualBoundingBoxDescent-r/2)})),e.restore();const n=this.scaleY();return{top:t*n,bottom:i*n}}}getClientRect(e){return super.getClientRect({...e,skipStroke:!0,skipShadow:!0})}getSelfRect(){const e=super.getSelfRect(),t=this._measureTextVerticalOverflow();return e.height+=t.top+t.bottom,e.y-=t.top,e}}},93123:(e,t,i)=>{"use strict";i.d(t,{V:()=>a});var r=i(48917),s=i(19926),n=i(58548);class a extends s.b{_sceneFunc(e){const{width:t,height:i,content:r,align:s="center"}=this.attrs;if(!r)return;const{texture:n,buffer:a,scale:o,offsetY:h}=r,d=(n.width-2*a.x)/o.x,c=(n.height,a.y,o.y,{width:n.width/o.x,height:n.height/o.y}),l=(t-d)/2,g=a.x/o.x;let u=0;u="left"===s?-g:"center"===s?l-g:t-(c.width-g),e.drawImage(n,0,0,n.width,n.height,u,(i-c.height)/2+h,c.width,c.height)}_hitFunc(e){(0,n.b)(e,this)}}r.Fk.addSetter(a,"align"),r.Fk.addSetter(a,"texture"),a.prototype.className="EffectTextShape"},99130:(e,t,i)=>{"use strict";i.d(t,{R:()=>s});var r=i(48917);class s extends r.ZA{constructor(e){super(e),this.getClientRect=(e={})=>{const{skipTransform:t,relativeTo:i}=e,r={x:0,y:0,width:0,height:0};return t?r:this._transformedRect(r,i)},this._drawChildren=(e,t,i)=>{let r;const s=null==t?void 0:t.getContext(),{clipPath:n}=this,a=i===this;if(n){s.save();const e=this.getAbsoluteTransform(i);let t=e.getMatrix();s.transform(t[0],t[1],t[2],t[3],t[4],t[5]),s.beginPath(),s._context.clip(n),t=e.copy().invert().getMatrix(),s.transform(t[0],t[1],t[2],t[3],t[4],t[5])}const o=!a&&"source-over"!==this.globalCompositeOperation()&&"drawScene"===e;o&&(s.save(),s._applyGlobalCompositeOperation(this)),null===(r=this.children)||void 0===r||r.forEach((function(r){r[e](t,i)})),o&&s.restore(),n&&s.restore()},this.clipPath=e.clipPath}getOriginalClientRect(){return super.getClientRect()}toClipCanvas(e){this._context||(this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d",{willReadFrequently:!0}));const{pixelRatio:t}=e;this._canvas.width=e.width*t,this._canvas.height=e.height*t;const{_context:i}=this;i.save(),i.scale(e.pixelRatio,e.pixelRatio),this.clipPath&&(i.beginPath(),i.clip(this.clipPath));const{attrs:r}=this.children[0];if(r.image){const e=this.children[0].getTransform();i.transform(e.m[0],e.m[1],e.m[2],e.m[3],e.m[4],e.m[5]),i.drawImage(r.image,0,0,r.width,r.height)}return i.restore(),this._canvas}setPath(e){this.clipPath=e}}},48763:(e,t,i)=>{"use strict";i.d(t,{Z:()=>W});var r=i(48917),s=i(71946),n=i(67830),a=i(8757),o=i(22169),h=i(28162),d=i(58548),c=i(5317),l=i(34618),g=i(82440),u=i(39589),f=i(14415);const _={lutColorFilter:{dir:"2d-lut-color-filter",programs:[{key:"filter",vertexShader:"filter.vertex.glsl",fragmentShader:"filter.frag.glsl",uniforms:[{key:"intensity"}]}]},imageAdjust:{dir:"image-adjust",programs:[{key:"generalEffect",viewport:{width:289,height:374},vertexShader:"adjust.vertex.glsl",fragmentShader:"adjust.frag.glsl",textures:[{key:"lutTexture",path:"lut.png"}],uniforms:[{key:"brightness"},{key:"saturation"},{key:"contrast"},{key:"exposure"},{key:"fade"},{key:"highlight"},{key:"lightSensation"},{key:"shadow"},{key:"temperature"},{key:"tone"},{key:"vibrance"}]},{key:"output",vertexShader:"output.vertex.glsl",fragmentShader:"output.frag.glsl",textures:[{key:"generalEffect",ref:"imageAdjust.generalEffect"}]}]},imageGrain:{dir:"image-grain",programs:[{key:"grain",vertexShader:"grain.vertex.glsl",fragmentShader:"grain.frag.glsl",textures:[{key:"grainTexture",path:"texture.png"}],uniforms:[{key:"grainIntensity"},{key:"width"},{key:"height"},{key:"randomX"},{key:"randomY"}]}]},imageOilTexture:{dir:"image-oil-texture",programs:[{key:"oilTexture",vertexShader:"texture.vertex.glsl",fragmentShader:"texture.frag.glsl",textures:[{key:"oilTexture",path:"texture.png"}],uniforms:[{key:"oilIntensity"},{key:"width"},{key:"height"}]}]},imageColorScheme:{dir:"image-color-scheme",programs:[{key:"colorScheme",vertexShader:"filter.vertex.glsl",fragmentShader:"filter.frag.glsl",uniforms:[{key:"colorScheme"}]}]}};class y{constructor(){if(this._packages={},y._instance)return y._instance;y._instance=this}async loadPackage(e,t){if(this._packages[e])return await this._packages[e].promise,this._packages[e];let r,s;const n={key:e,programs:[],promise:new Promise(((e,t)=>{r=e,s=t}))};this._packages[e]=n;const{dir:a,programs:o}=t;try{const e=await Promise.all(o.map((async e=>{var t,r;const s={key:e.key,viewport:e.viewport,vertexShader:"",fragmentShader:"",textures:[],uniforms:null!==(t=e.uniforms)&&void 0!==t?t:[],attributes:null!==(r=e.attributes)&&void 0!==r?r:[]};try{var n;await Promise.all([i(75265)(`./${a}/${e.vertexShader}`).then((e=>{s.vertexShader=e.default})),i(75265)(`./${a}/${e.fragmentShader}`).then((e=>{s.fragmentShader=e.default})),...(null!==(n=e.textures)&&void 0!==n?n:[]).map((async t=>{if("path"in t){const r=await i(75265)(`./${a}/${t.path}`),n=await(0,f.p)(r.default);if(!n)throw new Error(`load texture failed: url${r.default} program:${e.key}`);s.textures.push({key:t.key,data:n})}else"img"in t?s.textures.push({key:t.key,data:t.img}):s.textures.push({key:t.key,ref:t.ref})}))])}catch(o){return null}return s})));return n.programs=e.filter((e=>e)),r(n),n}catch(h){delete this._packages[e],s(h)}return null}}var p,m=i(65748),v=i(34269);!function(e){e[e.canvas=0]="canvas",e[e.node=1]="node"}(p||(p={}));const x={[p.node]:new m.z6({_capacity:50,_cacheKey:v.q2}),[p.canvas]:new m.z6({_capacity:50,_cacheKey:v.rj})};class w{constructor(e){if(this._idleTextureUnit=new Set,this._texturePool=new Map,w._instance)return w._instance;w._instance=this;const{gl:t}=e;this._gl=t,this._activeTextureUnit=t.TEXTURE0;const i=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let r=0;r<i;r++)this._idleTextureUnit.add(r)}createTextureWithoutRegister(e){const t=this._gl,{textureTarget:i=t.TEXTURE_2D,textureSetting:r}=e,s=this._getIdleTextureUnitBySort();if(!s.length)throw new Error("[texture-manager]createTextureWithoutRegister failure, cause there no idle texutre unit, please check.");const n=t.createTexture();if(!n)throw new Error("create texture error");return this._activeTexture(s[0]),t.bindTexture(i,n),r({gl:t}),n}registerTexture(e){const t=this._gl,{id:i,textureTarget:r=t.TEXTURE_2D,texture:s,autoBind:n=!0}=e;if(this._texturePool.get(i))return this._texturePool.get(i).unit;const a=this._getIdleTextureUnitBySort();if(!a.length)throw new Error("[texture-manager]registerTexture failure, cause there no idle texutre unit, please check.");const o=a[0];return n&&(this._activeTexture(o),t.bindTexture(r,s)),this._texturePool.set(i,{id:i,unit:o,textureTarget:r,texture:s}),this._idleTextureUnit.delete(o),o}unregisterTexture(e){const t=this._gl,i=this._texturePool.get(e.id);if(!i)return;const{unit:r,textureTarget:s}=i;this._activeTexture(r),t.bindTexture(s,null),this._idleTextureUnit.add(r),this._texturePool.delete(e.id)}updateTextureById(e){const t=this._gl,{id:i,textureTarget:r=t.TEXTURE_2D,texture:s}=e,n=this._texturePool.get(i);if(!n)throw new Error("[texture-manager]activeTextureById failure casuse not found target.");this._activeTexture(n.unit),t.bindTexture(r,s),this._texturePool.set(e.id,Object.assign({},n,{textureTarget:r,texture:s}))}activeTextureById(e){const t=this._texturePool.get(e.id);if(!t)throw new Error("[texture-manager]activeTextureById failure casuse not found target.");this._activeTexture(t.unit)}getTextureUnitById(e){const t=this._texturePool.get(e.id);if(!t)throw new Error("[texture-manager]getTextureUnitById failure casuse not found target.");return t.unit}getTextureTexById(e){const t=this._texturePool.get(e.id);if(!t)throw new Error("[texture-manager]getTextureUnitById failure casuse not found target.");return t.texture}_activeTexture(e){this._activeTextureUnit!==e&&(this._activeTextureUnit=e,this._gl.activeTexture(this._gl.TEXTURE0+e))}_getIdleTextureUnitBySort(){return[...this._idleTextureUnit].sort(((e,t)=>e-t))}}var I,P,C;!function(e){e[e.integer=0]="integer",e[e.float=1]="float"}(I||(I={})),function(e){e[e.vector=0]="vector",e[e.matrix=1]="matrix"}(P||(P={})),function(e){e.Attribute="a",e.Uniform="u"}(C||(C={}));const M={};class S{constructor(e){this._attributes={},this._uniforms={},this._textures={},this._createShader=(e,t)=>{const i=this._gl.createShader(e);if(!i)throw new Error("create shader failed: empty shader");this._gl.shaderSource(i,t),this._gl.compileShader(i);if(this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS))return i;const r=this._gl.getShaderInfoLog(i);throw this._gl.deleteShader(i),new Error(`create shader failed: ${r}`)},this._setAttribute=(e,t)=>{const{data:i}=t;let r=this._attributes[e];if(r)Object.assign(r,t);else{const i=this._gl.getAttribLocation(this.program,`${C.Attribute}_${e}`),s=this._gl.createBuffer();if(!s)throw new Error("buffer error");this._attributes[e]={...this._dftAttr,...t,location:i,buffer:s},r=this._attributes[e]}return void 0===i||(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,r.buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,i,this._gl.STATIC_DRAW)),r.location},this._setUniform=(e,t)=>{let i=this._uniforms[e];const r=`${C.Uniform}_${e}`;if(!i){const t=this._gl.getUniformLocation(this.program,r);if(!t)throw new Error(`create uniform location error ${e} `);this._uniforms[e]={location:t},i=this._uniforms[e]}if(void 0===t.data)return i.location;const s=[this._gl.uniform1iv,this._gl.uniform2iv,this._gl.uniform3iv,this._gl.uniform4iv],n=[this._gl.uniform1fv,this._gl.uniform2fv,this._gl.uniform3fv,this._gl.uniform4fv],a=[this._gl.uniformMatrix2fv,this._gl.uniformMatrix3fv,this._gl.uniformMatrix4fv];return Array.isArray(t.data)?t.matrix?a[t.data.length-2].call(this._gl,i.location,t.data):(t.float?n:s)[t.data.length-1].call(this._gl,i.location,t.data):t.float?this._gl.uniform1f(i.location,t.data):this._gl.uniform1i(i.location,t.data),i.location},this._setTexture=(e,t)=>{const i=this._gl,{data:r}=t,s=`${this.key}.${e}`;let n=this._textures[e];if(!n){const t=i.createTexture();if(!t)throw new Error("");const r=this._textureManager.registerTexture({id:s,texture:t,autoBind:!1});this._textures[e]={location:t,unit:r},n=this._textures[e]}if(void 0===r)return n.location;const a=i.RGBA,o=i.RGBA,h=i.UNSIGNED_BYTE;return this._setUniform(e,{data:n.unit,float:!1}),this._textureManager.activeTextureById({id:s}),i.bindTexture(i.TEXTURE_2D,n.location),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,a,o,h,r),n.location},this._gl=e.gl,this._dftAttr={type:e.gl.FLOAT,stride:0,offset:0,normalize:!1,size:0},this.key=e.source.key,this._source=e.source,this._textureManager=new w({gl:this._gl}),this._initProgram(e.source)}_initProgram(e){if(M[e.key]){const{program:t}=M[e.key];return void(this.program=t)}const t=this._createShader(this._gl.VERTEX_SHADER,e.vertexShader),i=this._createShader(this._gl.FRAGMENT_SHADER,e.fragmentShader),r=this._createProgram(t,i);M[e.key]={program:r}}_createProgram(e,t){const i=this._gl.createProgram();if(!i)throw new Error("create program failed");this._gl.attachShader(i,e),this._gl.attachShader(i,t),this._gl.linkProgram(i);if(this._gl.getProgramParameter(i,this._gl.LINK_STATUS))return this.program=i,i;const r=this._gl.getProgramInfoLog(i);throw this._gl.deleteProgram(i),new Error(`create program failed: ${r}`)}draw(e,t){var i,r;const s=this._gl;s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.useProgram(this.program),this._source.textures.concat(...null!==(i=null==t?void 0:t.textures)&&void 0!==i?i:[]).forEach((e=>{"data"in e&&this._setTexture(e.key,{data:e.data})})),Object.keys(this._textures).forEach((e=>{const t=this._textures[e];this._textureManager.activeTextureById({id:`${this.key}.${e}`}),s.bindTexture(s.TEXTURE_2D,t.location)})),this._source.uniforms.concat(...null!==(r=null==t?void 0:t.uniforms)&&void 0!==r?r:[]).forEach((t=>{var i;const r=null!==(i=e[t.key])&&void 0!==i?i:0;this._setUniform(t.key,{data:r,float:void 0===t.type||t.type===I.float,matrix:void 0!==t.struct&&t.struct===P.matrix})})),this._setAttribute("position",{data:new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),size:2}),this._source.attributes.forEach((t=>{var i;const r=null!==(i=e[t.key])&&void 0!==i?i:0;this._setAttribute(t.key,{data:new t.type(Array.isArray(r)?r:[r]),size:t.size})})),Object.values(this._attributes).forEach((e=>{e.size&&(s.enableVertexAttribArray(e.location),s.bindBuffer(s.ARRAY_BUFFER,e.buffer),s.vertexAttribPointer(e.location,e.size,e.type,e.normalize,e.stride,e.offset))}));const n=s.TRIANGLES;s.drawArrays(n,0,6)}destroy(){Object.keys(this._textures).forEach((e=>{const t=`${this.key}.${e}`;this._textureManager.unregisterTexture({id:t})}))}}var E=i(20484);class A{constructor(e){this._renderChain={order:[],config:{}},this._createRenderChainNode=(e,t,i)=>{const r=this._gl;let s=null,n=null,a="";if(!i){var o,h,d,c;const e=null!==(o=null===(h=t.viewport)||void 0===h?void 0:h.width)&&void 0!==o?o:this.state.width,i=null!==(d=null===(c=t.viewport)||void 0===c?void 0:c.height)&&void 0!==d?d:this.state.height;n=r.createTexture(),a=`${this.id}.${t.key}.fboTexture`,this._textureManager.registerTexture({id:a,texture:n});const l=0,g=r.RGBA,u=0,f=r.RGBA,_=r.UNSIGNED_BYTE,y=null;r.texImage2D(r.TEXTURE_2D,l,g,e,i,u,f,_,y),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),s=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,s),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,n,l)}return{packageKey:e.key,fb:s,textureId:a,program:new S({gl:r,source:t}),viewport:t.viewport,textureReference:{}}},this._createRenderChain=()=>{const e=[],t={},i=this._packages;i.forEach(((r,s)=>{const{programs:n}=r,a=s===i.length-1;n.forEach(((i,s)=>{const o=s===n.length-1,h=a&&o,d=this._createRenderChainNode(r,i,h),c=`${r.key}.${i.key}`;e.push(c),t[c]=d}))})),i.forEach(((e,r)=>{const{programs:s}=e;s.forEach(((n,a)=>{const o=a===s.length-1,h=t[`${e.key}.${n.key}`];if(n.textures.forEach((e=>{var i;if(!("ref"in e))return;const r=null===(i=t[e.ref])||void 0===i?void 0:i.textureId;r&&(h.textureReference[e.key]=r)})),o){let e="SOURCE";if(r){const s=i[r-1],n=`${s.key}.${s.programs[s.programs.length-1].key}`;e=t[n].textureId}h.textureReference.texture=e}}))})),this._renderChain={order:e,config:t}},this.id=e.id,this.state=e.state,this._packages=e.packages,this._gl=e.gl,this._textureManager=new w({gl:e.gl})}set packages(e){this._canvasCache.get(this.id)&&!(0,o.isEqual)(e,this._packages)&&this._canvasCache.remove(this.id),this._packages=e}get _canvasCache(){return x[p.canvas]}_clearRenderChain(){this._renderChain.order.forEach((e=>{const t=this._renderChain.config[e];try{const e=this._textureManager.getTextureTexById({id:t.textureId});this._gl.deleteTexture(e)}catch(i){}this._textureManager.unregisterTexture({id:t.textureId}),this._gl.deleteFramebuffer(t.fb)})),this._renderChain={order:[],config:{}}}update(e){const t={...this.state,...e};this._canvasCache.get(this.id)&&!(0,o.isEqual)(this.state,t)&&this._canvasCache.remove(this.id),this.state=t}destroy(){this._canvasCache.remove(this.id),this._clearRenderChain()}draw(){let e=this._canvasCache.get(this.id);if(e)return e;const t=this._gl,{canvas:i}=t;this._createRenderChain();for(const a of this._renderChain.order){var r,s;const e=this._renderChain.config[a],{program:i,fb:n,textureReference:o,viewport:h,packageKey:d}=e,c={...(0,E.ei)(this.state,["image","width","height"]),...this.state[d]};t.bindFramebuffer(t.FRAMEBUFFER,n);const l={textures:[],uniforms:[]};Object.keys(o).forEach((e=>{const i=o[e];i&&("SOURCE"!==i?(this._textureManager.activeTextureById({id:i}),t.bindTexture(t.TEXTURE_2D,this._textureManager.getTextureTexById({id:i})),l.uniforms.push({key:e,type:I.integer}),Object.assign(c,{[e]:this._textureManager.getTextureUnitById({id:i})})):l.textures.push({key:"texture",data:c.image}))})),"texture"in o&&(l.uniforms.push({key:"textureReverse"}),Object.assign(c,{textureReverse:"SOURCE"===o.texture?1:0})),t.viewport(0,0,null!==(r=null==h?void 0:h.width)&&void 0!==r?r:t.canvas.width,null!==(s=null==h?void 0:h.height)&&void 0!==s?s:t.canvas.height),i.draw(c,l)}var n;i instanceof OffscreenCanvas?e=i.transferToImageBitmap():(e=new OffscreenCanvas(i.width,i.height),null===(n=e.getContext("2d"))||void 0===n||n.drawImage(i,0,0));return this._canvasCache.set(this.id,e),this._clearRenderChain(),e}}class R{constructor(){if(this._packageManager=new y,R._instance)return R._instance;R._instance=this,this.init()}get _nodePool(){return x[p.node]}init(){const e=new OffscreenCanvas(200,200);this.canvas=e;const t=this.canvas.getContext("webgl2");null!==t&&(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.pixelStorei(t.UNPACK_ALIGNMENT,1),this._gl=t)}destroy(){for(const e of this._nodePool.getCache().FIFO)this.destroyNode(e)}destroyNode(e){const t=this._nodePool.get(e);t&&(this._nodePool.remove(e),t.destroy())}async drawNode(e,t,i,r){let s=this._nodePool.get(e);this.canvas.width=i.width,this.canvas.height=i.height;const n={image:i,width:i.width,height:i.height,...r};let a;try{a=(await Promise.all(t.map((e=>this._packageManager.loadPackage(e.key,e.config))))).filter((e=>e))}catch(o){return null}return s?r&&(s.packages=a,s.update(n)):(s=new A({id:e,state:n,gl:this._gl,packages:a}),this._nodePool.set(e,s)),s.draw()}}var T=i(15516),b=i(39113);let N;class D{constructor(e){this._renderIdx=0,this._lastRenderTask=null,this.addTask=e=>{const t=`${this.id}.${this._renderIdx++}`;this._lastRenderTask=u.ZP.addTask(t,(()=>e(t))).catch((()=>{}))},this.initResourcePkg=async()=>{var e,t,i,r,s;await Promise.all([null===(e=g.fc.getDependency(T.internalEffectResource.lumiHub.resourceId))||void 0===e?void 0:e.ready,...null!==(t=null===(i=this.postProcessEffects)||void 0===i?void 0:i.map((e=>{var t;return e.enable&&(null===(t=g.fc.getDependency(e.resourceId))||void 0===t?void 0:t.ready)})))&&void 0!==t?t:[],...null!==(r=null===(s=this.effectFilters)||void 0===s?void 0:s.map((async e=>{var t;await(null===(t=g.fc.getDependency(e.resourceId))||void 0===t?void 0:t.ready)})))&&void 0!==r?r:[]])},this.renderFilter=async()=>{var e,t;const i=null!==(e=null===(t=this.effectFilters)||void 0===t?void 0:t.reduce(((e,t)=>t.type===a.Yl.FILTER?[...e,t]:e),[]))&&void 0!==e?e:[],r={},s=await Promise.all(i.map((async e=>{var t;const i=this.pkgManager.get(e.resourceId),s=null==i||null===(t=i.features)||void 0===t||null===(t=t[0])||void 0===t||null===(t=t.filters)||void 0===t||null===(t=t[0])||void 0===t?void 0:t.texture;if(!s)return;const n=await(0,f.p)(s);if(!n||n instanceof SVGElement)return;const a=_.lutColorFilter,o=a.programs[0],h=`lutColorFilter.${e.resourceId}`;return r[h]={intensity:e.params[T.$3]},{key:h,config:{...a,programs:[{...o,textures:[{key:"lutTexture",img:n}]}]}}})));s.length&&this.addTask((async e=>{const t=await this._filterEngine.drawNode(e,s.filter(Boolean),this.imageSrc.current.texture,r);t&&(this.imageSrc.current.texture=t)}))},this.renderEffect=()=>{var e,t,i,r,s;const n=null!==(e=null===(t=this.effectFilters)||void 0===t?void 0:t.reduce(((e,t)=>{if(t.type===a.Yl.FILTER)return e;const i=this.pkgManager.get(t.resourceId||"");return i?[...e,{key:i.resourceId,resourcePath:i.fsPath,params:t.params}]:e}),[]))&&void 0!==e?e:[],o=null!==(i=null===(r=this.postProcessEffects)||void 0===r?void 0:r.reduce(((e,t,i)=>{const r=this.pkgManager.get(t.resourceId||"");return t.enable&&r?[...e,{key:`${r.resourceId}.${i}`,resourcePath:r.fsPath,params:b.default.model.effect.getPostProcessParams(t)}]:e}),[]))&&void 0!==i?i:[],h=null===(s=this.pkgManager.get(T.internalEffectResource.lumiHub.resourceId))||void 0===s?void 0:s.fsPath;(n.length||o.length)&&this.addTask((async()=>{const{texture:e}=this.imageSrc.current,t=await u.ZP.renderEffectImage(this.id,{image:e,effects:n,postProcessHubResourcePath:h,postProcessEffects:o});t&&(this.imageSrc.current={...t,offset:{x:t.width-e.width,y:t.height-e.height}})}))},this.renderColorScheme=()=>{this.colorScheme&&this.addTask((async e=>{const t=await this._filterEngine.drawNode(e,[{key:"imageColorScheme",config:_.imageColorScheme}],this.imageSrc.current.texture,{imageColorScheme:{colorScheme:this.colorScheme}});t&&(this.imageSrc.current.texture=t)}))},this.renderEditParams=()=>{var e;const t=[],i={},{grain:r,oilTexture:s,...n}=null!==(e=this.editParams)&&void 0!==e?e:{};Object.values(n).some((e=>e))&&(t.push({key:"imageAdjust",config:_.imageAdjust}),i.imageAdjust={...n}),s&&(t.push({key:"imageOilTexture",config:_.imageOilTexture}),i.imageOilTexture={oilIntensity:s}),r&&(t.push({key:"imageGrain",config:_.imageGrain}),i.imageGrain={grainIntensity:r,randomX:0,randomY:0}),t.length&&this.addTask((async e=>{const r=await this._filterEngine.drawNode(e,t,this.imageSrc.current.texture,i);r&&(this.imageSrc.current.texture=r)}))},this.render=async()=>{await this.initResourcePkg(),this.renderColorScheme(),this.renderEffect(),await this.renderFilter(),this.renderEditParams(),await this._lastRenderTask},this.id=e.id,this.imageSrc=e.imageSrc,this.editParams=e.editParams,this.effectFilters=e.effectFilters,this.colorScheme=e.colorScheme,this.postProcessEffects=e.postProcessEffects}get pkgManager(){return g.fc.getInstance().parser.filter.pkgManager}get _filterEngine(){return N||(N=new R),N}}const L="allEventListeners";var k,O;!function(e){e.Blur="blur"}(k||(k={})),function(e){e.Blur="blur"}(O||(O={}));const B={[O.Blur]:e=>`${k.Blur}(${e}px)`},F="crop_texture",G="effect_texture";class W extends r.Ee{constructor(e){super(e),this._scheduler=new h.Z,this._setImageLoad=()=>{const e=this.image(),t=()=>{this.drawQueue([F,G])};e instanceof ImageBitmap||e instanceof HTMLCanvasElement||null!=e&&e.complete||4===(null==e?void 0:e.readyState)?t():null!=e&&e.addEventListener&&e.addEventListener("load",t)},this._generateCroppedTexture=e=>{const t=this._cache.get(F);if(t)return t;if(!e)return;const i=s.Z.clipRectToImageCrop(this,this.attrs.clipRect);this.crop(i||{x:0,y:0,width:e.width,height:e.height});const r={...e};if(i){const t=new OffscreenCanvas(i.width,i.height);t.getContext("2d").drawImage(e.texture,i.x,i.y,i.width,i.height,0,0,i.width,i.height),r.texture=t,r.width=i.width,r.height=i.height}return r},this._generateEffectTexture=async e=>{const{id:t,editParams:i,effectFilters:r,postProcessEffects:s,colorScheme:n}=this.getAttrs();if(!e||e.texture instanceof SVGImageElement||!t||!i&&!r&&s&&n)return e;const a=this._cache.get(G);if(a)return a;const o=new D({id:t,editParams:i,effectFilters:r,postProcessEffects:s,colorScheme:n,imageSrc:{current:{width:e.width,height:e.height,texture:e.texture,offset:e.offset}}});return await o.render(),o.imageSrc.current},this._drawLoadingMask=e=>{var t;const{loadingText:i="loading...",x:r,y:s,width:o,height:h,type:d,rotation:c}=this.getAttrs();e.save();const g=Math.round(14/(null!==(t=this.getAbsoluteScale().x)&&void 0!==t?t:1));e.fillStyle="rgba(0,0,0,0.4)",e.fillRect(0,0,o,h),e.textBaseline="top",e.fillStyle="#ffffff",e.font=`${g}px Albert Sans`;const u=e.measureText(i).width,f={x:(o-u)/2,y:(h-g)/2};if(d===`${a.Wq.IMAGE_CONTAINER}-${l.I5.ImageContainerContent}`&&this.parent){const{width:t,height:i}=this.parent.getAttrs();f.x=(t-u)/2,f.y=(i-g)/2,e.rotate(-(0,n.V)(c)),e.translate(-r,-s)}e.fillText(i,f.x,f.y),e.restore()};const t=e=>{(0,o.isEqual)(e.oldVal,e.newVal)||this.drawQueue([F,G])};this.on("clipRectChange",t),this.on("isFlipXChange",t),this.on("isFlipYChange",t),this.on("widthChange",t),this.on("heightChange",t);const i=e=>{(0,o.isEqual)(e.oldVal,e.newVal)||this.drawQueue([G])};this.on("effectFiltersChange",i),this.on("postProcessEffectsChange",i),this.on("editParamsChange",i),this.on("colorSchemeChange",i);const r=e=>{(0,o.isEqual)(e.oldVal,e.newVal)||this._requestDraw()};this.on("loadingChange",r),this.on("loadingTextChange",r)}get taskQueue(){return this._scheduler.queue}clone(e){var t;const i=super.clone(e);return i._imageTexture=null!==(t=this._imageTexture)&&void 0!==t?t:i._imageTexture,i._scheduler=new h.Z,i}drawQueue(e){this._scheduler.addTask(this.id(),(async()=>{null!=e&&e.length&&e.forEach((e=>this._clearCache(e)));const t=this.image(),i=this._getFlipImageNode(this.attrs,{texture:t,width:t.width,height:t.height,offset:{x:0,y:0}}),r=await this._generateCroppedTexture(i),s=await this._generateEffectTexture(r);this._cache.set(F,r),this._cache.set(G,s),this._imageTexture=s,this._requestDraw()})).catch((()=>{}))}_hitFunc(e){(0,d.b)(e,this)}_sceneFunc(e){var t,i,r,s;const n=this.getWidth(),a=this.getHeight(),o=this._imageTexture;if(null==o||!o.texture)return;const h=this.cornerRadius();(this.hasFill()||this.hasStroke()||h)&&(e.beginPath(),h?((e,t,i,r)=>{let s=0,n=0,a=0,o=0;if("number"==typeof r){const e=Math.min(r,t/2,i/2);s=e,n=e,a=e,o=e}else s=Math.min(r[0]||0,t/2,i/2),n=Math.min(r[1]||0,t/2,i/2),o=Math.min(r[2]||0,t/2,i/2),a=Math.min(r[3]||0,t/2,i/2);e.moveTo(s,0),e.lineTo(t-n,0),e.arc(t-n,n,n,3*Math.PI/2,0,!1),e.lineTo(t,i-o),e.arc(t-o,i-o,o,0,Math.PI/2,!1),e.lineTo(a,i),e.arc(a,i-a,a,Math.PI/2,Math.PI,!1),e.lineTo(0,s),e.arc(s,s,s,Math.PI,3*Math.PI/2,!1)})(e,n,a,h):e.rect(0,0,n,a),e.closePath(),e.fillStrokeShape(this)),h&&e.clip(),e._context.filter=this._getFilters();const d=null!==(t=null===(i=o.offset)||void 0===i?void 0:i.x)&&void 0!==t?t:0,c=null!==(r=null===(s=o.offset)||void 0===s?void 0:s.y)&&void 0!==r?r:0,l=(o.width-d)/n,g=(o.height-c)/a;this.attrs.loading&&(e._context.filter="blur(10px)"),e.drawImage(o.texture,0,0,o.width,o.height,-d/2/l,-c/2/g,o.width/l,o.height/g),this.attrs.loading&&(e._context.filter="none",this._drawLoadingMask(e)),e.globalCompositeOperation&&"source-over"!==e.globalCompositeOperation&&(e.save(),e._context.fillStyle="transparent",e.fillRect(0,0,n,a),e.restore())}_getProtoListeners(e){let t=this._cache.get(L);if(!t){t={};let e=Object.getPrototypeOf(Object.getPrototypeOf(this));for(;e;)if(e.eventListeners){for(const i in e.eventListeners){const r=e.eventListeners[i];let s=t[i];s||(s=[],t[i]=s),Array.prototype.unshift.apply(s,r)}e=Object.getPrototypeOf(e)}else e=Object.getPrototypeOf(e);this._cache.set(L,t)}return t[e]}_getFilters(){return[O.Blur].reduce(((e,t)=>{const i=this.attrs[t];if(void 0===i)return e;const r=B[t](i);return r?`${e} ${r}`:e}),"").slice(1)}_getFlipImageNode(e,t){if(!e.isFlipX&&!e.isFlipY)return t;const{document:i}=c.Z.getGlobalVars(),r=i.createElement("canvas"),s=r.getContext("2d");r.width=t.width,r.height=t.height;const n={x:e.isFlipX?-1:1,y:e.isFlipY?-1:1},a={x:e.isFlipX?r.width:0,y:e.isFlipY?r.height:0};return null==s||s.transform(n.x,0,0,n.y,a.x,a.y),null==s||s.drawImage(t.texture,0,0,t.width,t.height,0,0,r.width,r.height),{...t,texture:r}}}},7063:(e,t,i)=>{"use strict";i.d(t,{Z:()=>f});var r=i(67986),s=i(14415),n=i(54643),a=i(56537),o=i(36919),h=i(48917),d=i(58571),c=i(99130),l=i(48763),g=i(26399),u=i(5317);const f=new class{constructor(){this._rectConfig={hitStrokeWidth:0,shadowForStrokeEnabled:!1,perfectDrawEnabled:!1,draggable:!1},this._lineConfig={perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,draggable:!1},this._textConfig={verticalAlign:"middle",shadowForStrokeEnabled:!0,fillAfterStrokeEnabled:!0,draggable:!1,perfectDrawEnabled:!0}}layer(e,t){const{backgroundConfig:i,...r}=null!=t?t:{},s=new h.mh({...r});if(e&&e.add(s),i){const e=new h.UL({...i});s.add(e)}return s}rect(e,t){const i=new h.UL({...this._rectConfig,...t});return e&&e.add(i),i}circle(e,t){const i=new h.Cd({...t});return e&&e.add(i),i}line(e,t){const i=new h.x1({...this._lineConfig,...t});return e&&e.add(i),i}text(e,t){const{fontResourceId:i,...s}=t,n=new d.x({...this._textConfig,...s});return i&&(0,o.Gk)(i,(e=>{n.fontFamily(e);const t=(0,o.vJ)(i);n.fontSize(n.fontSize()/t)})).catch((e=>{r.t.error("load font error",e)})),e&&e.add(n),n}path(e,t){const i=new h.y$({...this._textConfig,...t});return e&&e.add(i),i}container(e,t){const{backgroundConfig:i,...r}=null!=t?t:{},s=new h.ZA({...r});if(e&&e.add(s),i){const e=new h.UL({...i});s.add(e)}return s}image(e,t,i){const r=new l.Z({...i});if(e&&e.add(r),!t||"string"!=typeof t)return t&&"string"!=typeof t&&r.image(t),{image:r};const a=Promise.resolve(g.Z.getAssetsCache(t)||(0,s.p)(t)).then((s=>{if(!s)return;const a=s;if(g.Z.setAssetsCache(t,a),null!=i&&i.objectFit){const t=(0,n.NW)({width:i.width,height:i.height},{width:a.width,height:a.height},i.objectFit);r.width(t.width),r.height(t.height),r.x(t.x),r.y(t.y),null==e||e.clip({x:0,y:0,width:i.width,height:i.height})}r.image(a)}));return{image:r,onImageRendered:a}}svgImage(e,t,i,r,s,n=!1,a){var o,h;const d=null!=t?t:new l.Z;d.setAttrs({...s}),e&&e.add(d);const c=g.Z.getAssetsCache(i);if(c&&!n)return d.image(c),{image:d};const u=this.svgToImage(r,{...s,width:s.width*(null!==(o=null==a?void 0:a.x)&&void 0!==o?o:1),height:s.height*(null!==(h=null==a?void 0:a.y)&&void 0!==h?h:1)},c).then((e=>{if(!e)return null;g.Z.setAssetsCache(i,e),d.image(e)}));return{image:d,onImageRendered:u}}containerWithClipPath(e,t){const i=new c.R({...t});return null==e||e.add(i),i}svgLine(e,t,i,r){var s,n;const a=i.width*i.scale.x,o=i.height*i.scale.y,h=new l.Z({...i,width:a,height:o,scale:{x:1,y:1}});if(e&&e.add(h),!t)return{image:h};g.Z.getAssetsCache(i.id)&&h.image(g.Z.getAssetsCache(i.id));const d=this.svgToImage(t,{...i,width:i.width*(null!==(s=null==r?void 0:r.x)&&void 0!==s?s:1),height:i.height*(null!==(n=null==r?void 0:r.y)&&void 0!==n?n:1)}).then((e=>e?(h.image(e),g.Z.setAssetsCache(i.id,e),e):null));return{image:h,onImageRendered:d}}svgShape(e,t,i){const{width:r,height:s,scale:{x:n,y:a}}=i,o=new l.Z({...i,width:r,height:s,scale:{x:n,y:a}});if(e&&e.add(o),!t)return{image:o};g.Z.getAssetsCache(i.id)&&o.image(g.Z.getAssetsCache(i.id));const h=this.svgToImage(t,i).then((e=>e?(o.image(e),g.Z.setAssetsCache(i.id,e),e):null));return{image:o,onImageRendered:h}}async svgToImage(e,t,i){const r=t.width*t.scale.x,s=t.height*t.scale.y,{devicePixelRatio:n}=u.Z.getGlobalVars();return await a.F.svgToImage({data:e,width:r,height:s,dpr:n},i)}}},99624:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var r=i(17529),s=i(48917),n=i(54268);class a extends s.y${constructor(e){const{viewBox:t,strokeRadialGradientStartPoint:i,strokeRadialGradientStartPointX:r,strokeRadialGradientStartPointY:s,strokeRadialGradientEndPoint:n,strokeRadialGradientEndPointX:a,strokeRadialGradientEndPointY:o,strokeRadialGradientStartRadius:h,strokeRadialGradientEndRadius:d,strokeRadialGradientColorStops:c,...l}=e;super(l),this.getClientRect=(e={})=>{const t=e.skipTransform,i=e.relativeTo,{x:r,y:s,width:n,height:a}=this.viewBox,o=!e.skipShadow&&this.hasShadow(),h=o?this.shadowOffsetX():0,d=o?this.shadowOffsetY():0,c=o&&this.shadowBlur()||0,l={width:n,height:a,x:-c+Math.min(h,0)+s,y:-c+Math.min(d,0)+r};return t?l:this._transformedRect(l,i)},this.viewBox=t,this.strokeRadialGradientStartPoint=i,this.strokeRadialGradientStartPointX=r,this.strokeRadialGradientStartPointY=s,this.strokeRadialGradientEndPoint=n,this.strokeRadialGradientEndPointX=a,this.strokeRadialGradientEndPointY=o,this.strokeRadialGradientStartRadius=h,this.strokeRadialGradientEndRadius=d,this.strokeRadialGradientColorStops=c}clone(e){const t=super.clone(e);return t.viewBox=this.viewBox,t}setViewBox(e){this.viewBox=e}_sceneFunc(e){e.save(),e.beginPath(),this.data()&&(e instanceof n.jR?(e.fillStyle=this.colorKey,e.fill(new Path2D(this.data()))):(e._context.clip(new Path2D(this.data())),this.hasFill()?this._drawFillStroke(e):this._drawStroke(e))),e.closePath(),e.restore()}hasStroke(){const e=Boolean(this.strokeWidth()),t=Boolean(this.stroke()||this.strokeLinearGradientColorStops()||this.strokeRadialGradientColorStops);return this.strokeEnabled()&&e&&t}_drawStroke(e){this.hasStroke()&&this._strokeAction(e)}_drawFill(e){this.fillEnabled()&&this._fillAction(e)}_drawFillStroke(e){this.attrs.fillAfterStrokeEnabled?(this._drawStroke(e),this._drawFill(e)):(this._drawFill(e),this._drawStroke(e))}_drawStrokeLinearGradient(e){const t=this.strokeLinearGradientStartPoint(),i=this.strokeLinearGradientEndPoint(),r=this.strokeLinearGradientColorStops();if(!t||!i||!r)return;const s=e.createLinearGradient(t.x,t.y,i.x,i.y);for(let n=0;n<r.length;n+=2)s.addColorStop(r[n],r[n+1]);e.strokeStyle=s}_drawStrokeRadialGradient(e){const t=this.strokeRadialGradientColorStops,i=this.strokeRadialGradientStartPoint,r=this.strokeRadialGradientEndPoint,s=this.strokeRadialGradientStartRadius,n=this.strokeRadialGradientEndRadius;if(!i||!r||!t||void 0===s||void 0===n)return;const a=e.createRadialGradient(i.x,i.y,s,r.x,r.y,n);for(let o=0;o<t.length;o+=2)a.addColorStop(t[o],t[o+1]);e.strokeStyle=a}_strokeAction(e){if(this.hasStroke()){const t=this.attrs.lineCap;t&&(e.lineCap=t);const i=this.dash();i&&this.dashEnabled()&&(e.setLineDash?e.setLineDash(i):"mozDash"in e?e.mozDash=i:"webkitLineDash"in e&&(e.webkitLineDash=i),e.lineDashOffset=this.dashOffset()),e.lineWidth=this.strokeWidth();const r=this.strokeRadialGradientColorStops,s=this.strokeLinearGradientColorStops();r?this._drawStrokeRadialGradient(e):s?this._drawStrokeLinearGradient(e):e.strokeStyle=this.stroke(),e.stroke(new Path2D(this.data()))}}_drawFillLinearGradient(e){const t=this.fillLinearGradientColorStops(),i=this.fillLinearGradientStartPoint(),r=this.fillLinearGradientEndPoint();if(!i||!r||!t)return;const s=e.createLinearGradient(i.x,i.y,r.x,r.y);for(let n=0;n<t.length;n+=2)s.addColorStop(t[n],t[n+1]);e.fillStyle=s}_drawFillRadialGradient(e){const t=this.fillRadialGradientColorStops(),i=this.fillRadialGradientStartPoint(),r=this.fillRadialGradientEndPoint(),s=this.fillRadialGradientStartRadius(),n=this.fillRadialGradientEndRadius();if(!i||!r||!t||void 0===s||void 0===n)return;const a=e.createRadialGradient(i.x,i.y,s,r.x,r.y,n);for(let o=0;o<t.length;o+=2)a.addColorStop(t[o],t[o+1]);e.fillStyle=a}_fillAction(e){const t=this.fill(),i=this.fillLinearGradientColorStops(),s=this.fillRadialGradientColorStops();if(t?e.fillStyle=this.fill():i?this._drawFillLinearGradient(e):s&&this._drawFillRadialGradient(e),this.hasStroke()){const t=new r.OU(this.data()).toAbs().normalizeHVZ(),i=t.getBounds(),s=i.maxX-i.minX,n=i.maxY-i.minY,a=(this.getAbsoluteScale(),this.strokeWidth()/200),o=t.scale((s-2*a)/s,(n-2*a)/n).translate(a,a);e.fill(new Path2D(o.encode()))}else e.fill(new Path2D(this.data()))}}},33146:(e,t,i)=>{"use strict";i.d(t,{NH:()=>s,QN:()=>a,yv:()=>n});var r=i(91372);const s=e=>{if(e)return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`},n=(e,t=!1)=>{const[i,s,n,a]=e;let o=t?a:1;return o>1&&(o/=255),new r.Il({r:i,g:s,b:n,a:o}).colorPick()},a=e=>{var t;if(e)return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${null!==(t=e[3])&&void 0!==t?t:1})`}},35429:(e,t,i)=>{"use strict";i.d(t,{W:()=>n,p:()=>s});var r=i(46436);function s(e){const{type:t,...i}=e,{rotation:s,scale:{x:n,y:a}}=i;if(0!==s){const e={x:i.x,y:i.y,width:i.width*n,height:i.height*a,rotation:0},{x:t,y:o}=(0,r.Pl)(e,s*Math.PI/180);return{...i,x:t,y:o}}return i}function n(e){const{rotation:t,scale:{x:i,y:s}}=e;if(0!==t){const n=t*Math.PI/180,a={x:e.x,y:e.y,width:e.width*i,height:e.height*s,rotation:n},{x:o,y:h}=(0,r.Pl)(a,-n);return{...e,x:o,y:h}}return e}},49171:(e,t,i)=>{"use strict";i.d(t,{BC:()=>o,E4:()=>a,Rt:()=>n});var r=i(67986),s=i(14764);const n=async(e,t)=>{const i=performance.now();try{return await t()}catch(s){throw r.t.error("[effectsdk]-[web]-[error]",e,s),s}finally{r.t.info(`${e}: ${performance.now()-i}ms`)}},a=e=>(t,i,r)=>{const s=r.value;s&&"function"==typeof s&&(r.value=function(...t){return n(e,(()=>s.apply(this,t)))})},o=e=>{var t;const{x:i,y:r}=null!==(t=null==e?void 0:e.getAbsoluteScale())&&void 0!==t?t:{x:1,y:1},n=Math.max(1,i/s.mz),a=Math.max(1,r/s.mz),{width:o,height:h}=null==e?void 0:e.getAttrs(),d=o*n,c=h*a,l=Math.min(1,d>c?s.lr/d:s.K8/c);return{x:n*l,y:a*l}}},36919:(e,t,i)=>{"use strict";i.d(t,{vJ:()=>_,Gk:()=>f});var r=i(82440),s=i(43825),n=i(67986),a=i(38453);const o="OS/2";var h=i(26399),d=i(5317);const c=new Map,l=new Map,g=e=>`12px ${e}`,u=e=>{var t;let i=h.Z.getTyprCache(e);if(i)return i;const s=null===(t=r.fc.getDependency(e))||void 0===t?void 0:t.buffer;return i=new a.Z(s),h.Z.setTyprCache(e,i),i},f=async(e,t)=>{let i=`${s.O1}${e}`;try{if(!e)throw new Error;const t=(e=>{const t=g(e);let i=l.get(t);if(void 0===i){const{document:e}=d.Z.getGlobalVars();i=e.fonts.check(t),l.set(t,i)}return i})(i);if(!t){var a,o,h,f;const t=r.fc.getDependency(e);if(!t)throw new Error;const s=await t.ready,_=null==s?void 0:s.content,y=u(e),p=null!==(a=null===(o=y.head)||void 0===o?void 0:o.unitsPerEm)&&void 0!==a?a:1e3,m=null!==(h=null===(f=y.hhea)||void 0===f?void 0:f.lineGap)&&void 0!==h?h:0;_?await(async(e,t,i)=>{if(!c.get(e)){const r=new FontFace(e,`url(${t})`,i);c.set(e,r.load())}const r=await c.get(e);if(!r)return;const{document:s}=d.Z.getGlobalVars();s.fonts.add(r);const n=g(e);l.set(n,!0)})(i,_,{lineGapOverride:m/p*100+"%"}):n.t.error(`[loadFontFamily]: fontsrc for ${e} not ready`)}}catch(_){i="Albert Sans, SF Pro Text, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif"}return null==t||t(i),i},_=e=>{var t,i,s,n,a,h,d;if(!(null===(t=r.fc.getDependency(e))||void 0===t?void 0:t.buffer))return 1;const c=u(e),l=null!==(i=null===(s=c.head)||void 0===s?void 0:s.unitsPerEm)&&void 0!==i?i:1e3;let g=null!==(n=null===(a=c.hhea)||void 0===a?void 0:a.ascender)&&void 0!==n?n:750,f=Math.abs(null!==(h=null===(d=c.hhea)||void 0===d?void 0:d.descender)&&void 0!==h?h:250);var _,y;c[o]&&(g=null!==(_=c[o].sTypoAscender)&&void 0!==_?_:750,f=Math.abs(null!==(y=c[o].sTypoDescender)&&void 0!==y?y:250));return(g+f)/l}},58548:(e,t,i)=>{"use strict";i.d(t,{b:()=>a,q:()=>n});var r=i(46436),s=i(14764);function n(e){const t=(0,r.QO)(e,!0),i=e.getAbsoluteRotation(),[n,a,o,h]=(0,r.d5)(t,-i),d=h.y-n.y,c=a.x-n.x,l=Math.max(d,s.Gm),g=(Math.max(c,s.Gm)-c)/2,u=(l-d)/2,f=[{x:n.x-g,y:n.y-u},{x:a.x+g,y:a.y-u},{x:o.x+g,y:o.y+u},{x:h.x-g,y:h.y+u}];return(0,r.d5)(f,i)}function a(e,t){const i=t.getAbsoluteScale(),r=t.width(),n=t.height(),a=s.Gm/i.x,o=s.Gm/i.y,h=Math.max(a,r),d=Math.max(o,n),c=(h-r)/2,l=(d-n)/2;e.beginPath(),e.rect(-c,-l,h,d),e.closePath(),e.fillStrokeShape(t)}},2970:(e,t,i)=>{"use strict";i.d(t,{J:()=>l,P:()=>g});var r=i(82440),s=i(65748),n=i(14415),a=i(8091),o=i(36451),h=i(8757);const d=new s.z6({_capacity:1e3,_cacheKey:"PREVIEW_SOURCE_DEP"}),c=e=>{var t;let i=e.content?d.get(e.content):void 0;return i||(i={isPreview:e.isPreview,previewUrl:e.previewUrl,content:e.content||"",ready:(null!==(t=e.ready)&&void 0!==t?t:Promise.resolve(e)).then((async e=>(e.content&&await(0,n.p)(e.content),i.isPreview=!1,{content:e.content||""})))},e.content&&d.set(e.content,i),i)};const l=(e,t,i)=>{const s=r.fc.getDependency(e.resourceId||e.path);var n;if(!s)return c({content:null!==(n=e.path)&&void 0!==n?n:""});const o=c(s),{transcode:d}=s;if(!d&&"object"!=typeof d)return o;const l=(0,a.I)(d,t);if(!l)return o;if(s.type===h.xP.ImageInTemplate)return function({picked:e,origin:t,materialPixels:i}){if(i<4e4)return c({...t,content:e.full_url});const r=Object.keys(t.transcode||{}).sort(((e,t)=>parseInt(e)-parseInt(t)))[0];return c(r?{isPreview:!0,previewUrl:t.transcode[r].full_url,content:e.full_url}:{...t,content:e.full_url})}({picked:l,origin:s,materialPixels:(null==i?void 0:i.materialPixels)||0});const g=r.fc.getDependency(`${s.resourceId}:${l.width}:${l.height}`);return g?c(g):o},g=e=>{let t;return(0,o.v)(((i,r)=>{i.width=e.width,i.height=e.height,r.drawImage(e,0,0),t=new Uint8Array(r.getImageData(0,0,e.width,e.height).data.buffer)})),t}},74129:(e,t,i)=>{"use strict";i.d(t,{U:()=>n,j:()=>s});var r=i(35429);const s=e=>!("type"in e),n=e=>{if(s(e))return{};const{type:t,...i}=e.layout;return{visible:e.visibility,groupId:e.groupId,globalCompositeOperation:e.blendMode,isFlipX:e.isFlipHorizontal,isFlipY:e.isFlipVertical,...i,...(0,r.p)({...i,scale:i.scale})}}},71946:(e,t,i)=>{"use strict";i.d(t,{Z:()=>x});var r=i(8757),s=i(14764),n=i(34618),a=i(48917);class o{}class h extends o{is(e){return e.attrs.type===r.Wq.IMAGE}isTarget(e){return this.is(e)}isMatchResource(e,t){const{src:i}=e;return t===i.resourceId||t===i.path}transformClipRect(e,t){const i=Math.max(t.width/e.width,t.height/e.height);return{x:(t.width-e.width*i)/2,y:(t.height-e.height*i)/2,width:e.width*i,height:e.height*i}}clipRectToCrop(e,t){const i=e.image(),r=null==i?void 0:i.width,s=null==i?void 0:i.height;if("number"!=typeof r||"number"!=typeof s||null==t||!t.height||null==t||!t.width)return;const n=t.width/r,a=t.height/s,o={x:-t.x/n,y:-t.y/a,width:e.width()/n,height:e.height()/a},{isFlipX:h,isFlipY:d}=e.attrs;return i?(h&&(o.x=r-o.x-o.width),d&&(o.y=s-o.y-o.height),o):o}cropToClipRect(e){const t=e.image(),i=null==t?void 0:t.width,r=null==t?void 0:t.height;if("number"!=typeof i||"number"!=typeof r)return;const s=e.crop();if(!s.height||!s.width)return;const n=e.width()/s.width,a=e.height()/s.height,o={x:-s.x*n,y:-s.y*a,width:i*n,height:r*a},{isFlipX:h,isFlipY:d}=e.attrs;return h&&(o.x=-(o.width+o.x-e.width())),d&&(o.y=-(o.height+o.y-e.height())),o}}var d=i(17529),c=i(46436);class l extends o{is(e){return e.attrs.type===r.Wq.GROUP_LAYER}isTarget(e){return(0,n.Jw)(e.attrs.type)===r.Wq.GROUP_LAYER}}var g=i(91372),u=i(33146),f=i(55160);var _=i(67986),y=i(59238),p=i(43696);const m={[r.Wq.TEXT]:new class extends o{is(e){return e.attrs.type===r.Wq.TEXT}isMatchResource(e,t){return Boolean(e.fontDependResources.find((e=>e.resourceId===t)))}isTarget(e){return this.is(e)}},[r.Wq.IMAGE]:new h,[r.Wq.IMAGE_CONTAINER]:new class extends o{is(e){return e.attrs.type===r.Wq.IMAGE_CONTAINER}isTarget(e){return(0,n.Jw)(e.attrs.type)===r.Wq.IMAGE_CONTAINER}isImageContainerItem(e){if(void 0===e.attrs.type)return!1;const t=e.attrs.type.split("-");return t.length>1&&r.Wq.IMAGE_CONTAINER===t[0]&&[n.I5.ImageContainerContent,n.I5.ImageContainerClipPath].includes(t[1])}isCanFillImage(e){return!(null==e||!e.attrs.fillInfo)&&(!e.attrs.fillInfo.validFillType||e.attrs.fillInfo.validFillType.image)}isCanUpdateItem(e){return null==e?void 0:e.attrs.fillInfo.canUpdate}getId(e){return(0,n.Mz)(e.attrs.id)}getChildrenIndex(e){return null==e?void 0:e.attrs.index}findFirstCanUpdateItem(e){if(!e.children)return;const t=e.children.filter((e=>{var t;return(null===(t=e.attrs)||void 0===t||null===(t=t.type)||void 0===t||null===(t=t.split("-"))||void 0===t?void 0:t[1])!==n.I5.Background}));for(let i=0;i<t.length;i++){const e=t[i];if(this.isImageContainerItem(e)&&this.isCanUpdateItem(e))return{item:e,index:i}}}transformLayout(e,t){if(!t)return;const{pathBox:i,ltPointOffset:r}=this._getPathBoxOfRotation(t.rotation,e.width,e.height,e.path),{width:s,height:n}=i,a=0,o=0,{x:h,y:d}=this._getPointOfRotation({x:a+r.x,y:o+r.y,width:s,height:n},{x:a+e.width/2,y:o+e.height/2},t.rotation||0),c=this._getClipRectofLayout(s,n,t);return{...t,width:s,height:n,x:h,y:d,scale:{x:1,y:1},clipRect:c}}_getPathBoxOfRotation(e,t,i,r){const s=new d.OU(r).normalizeHVZ(),{minX:n,minY:a,maxX:o,maxY:h}=s.getBounds(),c=new d.OU(s.encode()).rotate(-e*Math.PI/180,t/2,i/2),{minX:l,minY:g,maxX:u,maxY:f}=c.getBounds();return{pathBox:{width:u-l,height:f-g},ltPointOffset:{x:l-n,y:g-a}}}_getPointOfRotation(e,t,i){const{x:r,y:s,width:n,height:a}=e,o=(0,c._1)({x:r,y:s},i*Math.PI/180,t),h=(0,c.Pl)({rotation:i*Math.PI/180,width:n,height:a,...o},-i*Math.PI/180);return{x:h.x,y:h.y}}_getClipRectofLayout(e,t,i){var r,s;const n=(null===(r=i.scale)||void 0===r?void 0:r.x)||1,a=(null===(s=i.scale)||void 0===s?void 0:s.y)||1,o=i.width*n,h=i.height*a;let d=0,c=0,l=0,g=0;i.clipRect&&(d=(i.clipRect.width||0)*n,c=(i.clipRect.height||0)*a,l=(i.clipRect.x||0)*n,g=(i.clipRect.y||0)*a);const u=Math.max(e/o,t/h);return{x:(e-o*u)/2+l*u,y:(t-h*u)/2+g*u,width:(d||o||0)*u,height:(c||h||0)*u}}},[r.Wq.GROUP_LAYER]:new l,[r.Wq.SHAPE]:new class extends o{is(e){return e.attrs.type===r.Wq.SHAPE}isTarget(e){return this.is(e)}getStrokeColor(e,t,i){const{solid:s,gradient:n}=(0,g.tB)(i.stroke),a={};if(s&&(a.stroke=(0,u.QN)(s)),n){const i=Math.max(e,t);if(n.type===r.cF.LinearGradient){const i=n,r=(0,f.y)(e,t,i.rotation);a.strokeLinearGradientStartPoint={x:r.x0,y:r.y0},a.strokeLinearGradientEndPoint={x:r.x1,y:r.y1},a.strokeLinearGradientColorStops=i.stops.map((e=>[e.offset,(0,g.xc)(e.color)])).flat()}else if(n.type===r.cF.RadialGradient){const r=n;a.strokeRadialGradientStartPoint={x:r.center[0]*e,y:r.center[1]*t},a.strokeRadialGradientEndPoint={x:r.center[0]*e,y:r.center[1]*t},a.strokeRadialGradientStartRadius=0,a.strokeRadialGradientEndRadius=i*r.radius[0],a.strokeRadialGradientColorStops=r.stops.map((e=>[e.offset,(0,g.xc)(e.color)])).flat()}}return a}getFillColor(e,t,i){const s={},{solid:n,gradient:a}=(0,g.tB)(i.fill);if(a){const i=Math.max(e,t);if(a.type===r.cF.LinearGradient){const i=a,r=(0,f.y)(e,t,i.rotation);s.fillLinearGradientStartPoint={x:r.x0,y:r.y0},s.fillLinearGradientEndPoint={x:r.x1,y:r.y1},s.fillLinearGradientColorStops=i.stops.map((e=>[e.offset,(0,g.xc)(e.color)])).flat()}else if(a.type===r.cF.RadialGradient){const r=a;s.fillRadialGradientStartPoint={x:r.center[0]*e,y:r.center[1]*t},s.fillRadialGradientEndPoint={x:r.center[0]*e,y:r.center[1]*t},s.fillRadialGradientStartRadius=0,s.fillRadialGradientEndRadius=i*r.radius[0],s.fillRadialGradientColorStops=r.stops.map((e=>[e.offset,(0,g.xc)(e.color)])).flat()}}else s.fill=(0,u.QN)(n);return s}getStrokeWidth(e){return 2*e}getStrokeDash(e){return{dash:null!=e&&e.length?e.map((e=>2*e)):void 0}}},[r.Wq.LINE]:new class extends o{is(e){return e.attrs.type===r.Wq.LINE}isTarget(e){return this.is(e)}},[r.Wq.PAGE]:new class extends o{is(e){return(null==e?void 0:e.attrs.type)===r.Wq.PAGE}isTarget(e){return(0,n.Jw)(null==e?void 0:e.attrs.type)===r.Wq.PAGE}changePageColor(e,t,i){const r=e.find(`#${(0,n.uc)(t)}`)[0],s=(0,u.NH)(i);r&&r.fill(null!=s?s:"")}isPageBgImage(e){const t=e.split("-");return Boolean(t[1]&&t[1]===n.I5.BackgroundImage)}isPageBg(e){const t=e.split("-");return Boolean(t[1]&&t[1]===n.I5.Background)}getPageIdFromBg(e){return e.split("-")[0]||void 0}isInPageHotSpot(e,t){const{x:i,y:r}=e.getAbsolutePosition(),{x:s,y:n}=e.getAbsoluteScale(),a=e.width()*s,o=e.height()*n,h=a>400?40:.1*a,d=o>400?40:.1*o,c=[[i,i+h],[i+a-h,i+a]],l=[[r,r+d],[r+o-d,r+o]];return c[0][0]<=t.x&&t.x<=c[0][1]||(c[1][0]<=t.x&&t.x<=c[1][1]||(l[0][0]<=t.y&&t.y<=l[0][1]||l[1][0]<=t.y&&t.y<=l[1][1]))}},[r.Wq.PAGE_CONTAINER]:new l,[r.Wq.KONVA_LAYER]:new class extends o{is(e){return e.attrs.type===r.Wq.KONVA_LAYER}isTarget(e){return(0,n.Jw)(e.attrs.type)===r.Wq.KONVA_LAYER}},[r.Wq.KONVA_STAGE]:new class extends o{is(e){return e.attrs.type===r.Wq.KONVA_STAGE}isTarget(e){return this.is(e)}},[r.Wq.RULER_LINE]:new class extends o{is(e){return e.attrs.type===r.Wq.RULER_LINE}isTarget(e){return this.is(e)}},[r.Wq.GRID]:new class extends o{is(e){return e.attrs.type===r.Wq.GRID}isTarget(e){return(0,n.Jw)(e.attrs.type)===r.Wq.GRID}isGridArea(e){if(void 0===e.attrs.type)return!1;const t=e.attrs.type.split("-");return t.length>1&&r.Wq.GRID===t[0]&&[n.I5.GridAreaContainer,n.I5.GridContent].includes(t[1])}getId(e){return(0,n.Mz)(e.attrs.id)}getAreaId(e){return null==e?void 0:e.attrs.areaId}getAreaIndex(e){return null==e?void 0:e.attrs.index}},[r.Wq.SVG_IMAGE]:new class extends h{is(e){return e.attrs.type===r.Wq.SVG_IMAGE}isTarget(e){return this.is(e)}}},v=(Object.values(r.Wq),{isEqual:(e,t)=>(m[t]||_.t.error(`${t} \u5c1a\u672a\u5b9e\u73b0!`),m[t].is(e)),isTargetEqual:(e,t)=>(m[t]||_.t.error(`${t} \u5c1a\u672a\u5b9e\u73b0!`),m[t].isTarget(e)),isMatchResource(e,t,i){var r,s;return m[e]||_.t.error(`${e} \u5c1a\u672a\u5b9e\u73b0!`),null===(r=(s=m[e]).isMatchResource)||void 0===r?void 0:r.call(s,t,i)},isMaterial:e=>s.gt.findIndex((t=>v.isEqual(e,t)))>=0,isMaterialTarget:e=>s.gt.findIndex((t=>v.isTargetEqual(e,t)))>=0,isBgRect:e=>{var t;return(null===(t=e.attrs)||void 0===t||null===(t=t.type)||void 0===t||null===(t=t.split("-"))||void 0===t?void 0:t[1])===n.I5.Background},handelMaterialNodeByTarget:(e,t,i)=>{var r,s;m[e]||_.t.error(`${e} \u5c1a\u672a\u5b9e\u73b0!`),null===(r=(s=m[e]).handelMaterialNodeByTarget)||void 0===r||r.call(s,t,i)},findByID:(e,t,i=!0)=>{if(!t)return;if(i&&y.U.has(e,t))return y.U.get(e,t);const r=e=>{if(e.id()===t)return e;if(e instanceof a.W2&&e.hasChildren())for(const t of e.children){const e=r(t);if(e)return e}};return r(e)},findByFilter:(e,t,i=!0)=>{const r=[],s=n=>{const o=t(n)&&e!==n;if(o&&i&&r.push(n),n instanceof a.W2&&n.hasChildren()&&n.children)for(const e of n.children)s(e);o&&!i&&r.push(n)};return s(e),r},getMaterialNodeByTarget:e=>{if(v.isMaterial(e))return e;const t=(0,n.Mz)(e.attrs.id)||"",i=e.getLayer();if(t&&i){const e=v.findByID(i,t);if(e)return e}return null},getMultiMaterialsNodeByTarget:e=>{if(e.parent instanceof p.D)return e.parent.nodes()},findMaterials:(e,t=[])=>{const i=new Set;return v.findByFilter(e,(e=>{const i=t.findIndex((t=>v.isEqual(e,t)))>=0;return v.isMaterial(e)&&!i})).forEach((t=>{if(!t)return;const r=v.getMaterialGroup(t),s=null!=r?r:t;s!==e&&i.add(s)})),Array.from(i)},findGroupSubMaterials:(e,t=[],i)=>{const r=new Set;return v.findByFilter(e,(e=>{const i=t.findIndex((t=>v.isEqual(e,t)))>=0;return v.isMaterial(e)&&!i}),Boolean(i)).forEach((t=>{t&&t!==e&&r.add(t)})),Array.from(r)},findRulerLines:(e,t)=>{const i=new Set;return v.findByFilter(e,(e=>v.isEqual(e,r.Wq.RULER_LINE)),Boolean(t)).forEach((t=>{t&&t!==e&&i.add(t)})),Array.from(i)},getRenderLayerUtil:e=>m[e],setFilters(e,t){0!==t.length&&t.forEach((t=>{e.setAttr(t.key,t.value)}))},transformFilters(e){if(e)return Object.keys(e).reduce(((t,i)=>(t.push({key:i,value:e[i]}),t)),[])},getMaterialGroupIdById(e,t){var i;const r=v.findByID(e,t);return null===(i=r.getAttr)||void 0===i?void 0:i.call(r,"groupId")},getMaterialGroupId(e){var t;return null===(t=e.getAttr)||void 0===t?void 0:t.call(e,"groupId")},getMaterialGroup(e){if(!e)return null;const t=v.getMaterialGroupId(e);if(!t)return null;const i=e.getLayer();if(!i)return null;const r=v.findByID(i,t);return r||null},clipRectToImageCrop:(e,t)=>m[r.Wq.IMAGE].clipRectToCrop(e,t),imageCropToClipRect:e=>m[r.Wq.IMAGE].cropToClipRect(e),changePageColor:m[r.Wq.PAGE].changePageColor,getLayerIdByNode(e){if(e.attrs.groupId)return e.attrs.groupId;const t=(0,n.Mz)(e.attrs.id);return t||e.attrs.id}}),x=v},38530:(e,t,i)=>{"use strict";i.d(t,{U:()=>n,m:()=>a});var r=i(89811),s=i(49171);const n=(e,t)=>{const i=(0,s.BC)(e);return{...t,layout:{...t.layout,scale:i}}},a=(e,t)=>{var i;const s=new r.R8([e]).parse(),n=null==s?void 0:s.children[0];if(t&&null!==(i=n.text_params)&&void 0!==i&&i.richText){const e=JSON.parse(n.text_params.richText);e.styles.forEach((e=>{delete e.select})),n.text_params.richText=JSON.stringify(e)}return n}},46436:(e,t,i)=>{"use strict";i.d(t,{$D:()=>g,Ag:()=>P,Cy:()=>l,Di:()=>_,EK:()=>u,L0:()=>h,O2:()=>v,Pl:()=>f,QO:()=>p,Ww:()=>a,Xv:()=>c,_1:()=>y,d5:()=>m,kM:()=>n,qg:()=>o,tn:()=>d,w3:()=>I,z3:()=>M});var r=i(48917),s=i(67830);function n(e,t,i){let s=t;return e.forEach((e=>{const n=r.Core.getAngle(e),a=Math.abs(n-t)%(2*Math.PI);Math.min(a,2*Math.PI-a)<i&&(s=n)})),s}function a({target:e,anchor:t,result:i}){const r=t.x-e.x,s=t.y-e.y,n=i.x-t.x,a=i.y-t.y,o=(r*n+s*a)/(Math.sqrt(r**2+s**2)*Math.sqrt(n**2+a**2)),h=o<0?Math.max(o,-1):Math.min(o,1);let d=Math.acos(h)-Math.PI;return r*a-s*n<0&&(d*=-1),d}function o(e){return{x:e.x+e.width/2*Math.cos(e.rotation)+e.height/2*Math.sin(-e.rotation),y:e.y+e.height/2*Math.cos(e.rotation)+e.width/2*Math.sin(e.rotation)}}function h(e){return{x:e.x+e.width*Math.cos(e.rotation)+e.height/2*Math.sin(-e.rotation),y:e.y+e.height/2*Math.cos(e.rotation)+e.width*Math.sin(e.rotation)}}function d(e){return{x:e.x+0*Math.cos(e.rotation)+e.height/2*Math.sin(-e.rotation),y:e.y+e.height/2*Math.cos(e.rotation)+0*Math.sin(e.rotation)}}function c(e){return{x:e.x+e.width*Math.cos(e.rotation)+0*Math.sin(-e.rotation),y:e.y+0*Math.cos(e.rotation)+e.width*Math.sin(e.rotation)}}function l({point1:e,point2:t}){const i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return Math.sqrt(i**2+r**2)}function g(e,t,i){const r=i.x+(e.x-i.x)*Math.cos(t)-(e.y-i.y)*Math.sin(t),s=i.y+(e.x-i.x)*Math.sin(t)+(e.y-i.y)*Math.cos(t);return{...e,rotation:e.rotation+t,x:r,y:s}}function u({x:e,y:t},{x:i,y:r},s){return{x:i+(e-i)*s,y:r+(t-r)*s}}function f(e,t){return g(e,t,o(e))}function _(e,t,i,r,s){const n=s*Math.PI/180;return{x:e+(i*Math.cos(n)-r*Math.sin(n)),y:t+(i*Math.sin(n)+r*Math.cos(n))}}function y(e,t,i){return{x:i.x+(e.x-i.x)*Math.cos(t)-(e.y-i.y)*Math.sin(t),y:i.y+(e.x-i.x)*Math.sin(t)+(e.y-i.y)*Math.cos(t)}}function p(e,t=!0){const i=e.size(),r=[{x:0,y:0},{x:i.width,y:0},{x:i.width,y:i.height},{x:0,y:i.height}],s=t?e.getAbsoluteTransform():e.getTransform();return r.map((e=>s.point(e)))}function m(e,t){const[i,r,n,a]=e,o=(0,s.V)(t);return[y(i,o,{x:0,y:0}),y(r,o,{x:0,y:0}),y(n,o,{x:0,y:0}),y(a,o,{x:0,y:0})]}function v(e){const{x:t,y:i,rotation:r,scale:{x:n,y:a}}=e,o=e.width*n,h=e.height*a,d={x:t+o/2,y:i+h/2},c=(0,s.V)(r);return[{x:t,y:i},{x:t+o,y:i},{x:t+o,y:i+h},{x:t,y:i+h}].map((e=>y(e,c,d)))}function x(e){const t=[];for(let i=0;i<e.length;i++){const r=(i+1)%e.length;t.push({x:e[r].x-e[i].x,y:e[r].y-e[i].y})}return t}function w(e,t){return e.x*t.x+e.y*t.y}function I(e,t){const i=x(e).concat(x(t));for(const r of i){const i={x:r.y,y:-r.x};let s=Number.MAX_VALUE,n=-Number.MAX_VALUE;e.forEach((e=>{const t=w(i,e);t<s&&(s=t),t>n&&(n=t)}));let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;if(t.forEach((e=>{const t=w(i,e);t<a&&(a=t),t>o&&(o=t)})),n<a||o<s)return!1}return!0}function P(e,t){return I([e,e,e,e],t)}function C(e,t,i){const r=t.x-e.x,s=t.y-e.y,n=i.x-e.x;return r*(i.y-e.y)-s*n}function M(e,t){const[i,r,s,n]=t;return C(i,r,e)*C(s,n,e)>=0&&C(r,s,e)*C(n,i,e)>=0}},13578:(e,t,i)=>{"use strict";i.d(t,{j:()=>l});var r=i(8757),s=i(58992),n=i(57860),a=i(26684),o=i(23659),h=i(13995),d=i(61887),c=i(79876);const l=e=>{switch(e){case r.F5.IMAGE:return s.b;case r.F5.LINE:return n.z;case r.F5.SHAPE:return a.t;case r.F5.IMAGE_CONTAINER:return h.v;case r.F5.SVG_IMAGE:return c.N;case r.F5.TEXT:return o.y;case r.F5.GRID:return d.l;default:return o.y}}},91123:(e,t,i)=>{"use strict";i.d(t,{default:()=>pt});var r=i(8757),s=i(25629),n=i(52034),a=i(67986),o=i(14415),h=i(22390),d=i(58236),c=i(349),l=i(77204),g=i(49469),u=i(75510),f=i(84969),_=i(5434),y=i(84020),p=i(48917),m=i(58571),v=(i(22169),i(44362)),x=i(50477),w=i(46436),I=i(48737),P=i(47747);class C{constructor(e){this.getNodeLayer=e=>{const t=this._renderer.model.getLayerById(e);return t||void 0},this.getPageId=e=>{const t=this._getNode(e);if(!t)return;const i=e=>e.attrs.type===r.Wq.PAGE?e.attrs.id:e.parent?i(e.parent):void 0;return i(t)},this.checkCache=e=>{e._getCanvasCache()&&e.clearCache()},this.getPixel=()=>this._renderer.getMainRenderer().getPixel(),this._getNode=e=>{const t=this._renderer.findByID(e);if(t)return t;a.t.warn(`id\u4e3a${e}\u7684\u56fe\u5c42\u4e0d\u5b58\u5728`)},this._renderer=e}get mainRenderer(){return this._renderer.getMainRenderer()}hide(e){const t=this._getNode(e);t&&t.hide()}show(e){const t=this._getNode(e);t&&t.show()}setTheme(e){this._renderer.stage.setTheme(e),this._renderer.accessors.page.getRulerFeature().updateTheme(e)}getClientRectRelativeToStage(...e){if(1===e.length){const[t]=e,i=this._getNode(t);return null==i?void 0:i.getClientRect({relativeTo:this._renderer.stage.container})}const t=(0,x.b)(e);if(!t)return;const i=this._renderer.getFeatureRenderer().findByID(t);return i?i.getNodesClientRect(this._renderer.stage.container):void 0}getClientRectRelativeToPage(e){const t=this._getNode(e);if(t){const e=this._renderer.getActivePage();return t.getClientRect({relativeTo:e})}}getAbsolutePositionRelativeToPage(e){const t=this._getNode(e);if(t){const e=this._renderer.getActivePage();return t.getAbsolutePosition(e)}return{x:0,y:0}}getAttr(e,t){const i=this._getNode(e);if(i)return i.attrs[t]}getDimensionById(e){const t=this._getNode(e);if(!t)return{width:0,height:0,unit:r.fb.PX};const{width:i,height:s}=t.getSize();return{width:i,height:s,unit:r.fb.PX}}rotaterShowDetect(e){const t="string"==typeof e?[e]:e,i=(0,x.b)(t);if(!i)return;const s=this._renderer.getFeatureRenderer().findByID(i);if(null==s||!s.enableRotater)return;let n=I.A_.bottom;s.rotaterDirection=n;const a={[I.A_.top]:I.A_.left,[I.A_.left]:I.A_.bottom,[I.A_.bottom]:I.A_.right,[I.A_.right]:I.A_.top},o=new Set([n]),h=s.findOne(`.${r.h_}`),d=()=>{const{width:e,height:t}=this._renderer.stage;return(0,w.QO)(h).some((i=>!(0,w.Ag)(i,[{x:0,y:r.cM},{x:e,y:r.cM},{x:e,y:t},{x:0,y:t}])))};for(;o.size<4&&d();)n=a[n],s.rotaterDirection=n,o.add(n);s.setRotaterVisible(!0)}imageRotaterShowDetect(e,t){const i=(0,x.b)(e);if(!i)return;const s=this._renderer.getFeatureRenderer().findByID(i);if(null==s||!s.enableRotater)return;let n=I.A_.bottom;s.rotaterDirection=n;const a={[I.A_.top]:I.A_.bottom,[I.A_.left]:I.A_.right,[I.A_.bottom]:I.A_.top,[I.A_.right]:I.A_.left},o={[I.A_.top]:I.A_.left,[I.A_.left]:I.A_.bottom,[I.A_.bottom]:I.A_.right,[I.A_.right]:I.A_.top},h=new Set([n]),d=s.findOne(`.${r.h_}`),c=()=>{const e=(0,w.QO)(d);return(0,w.w3)(e,t)},l=()=>{const{width:e,height:t}=this._renderer.stage;return(0,w.QO)(d).some((i=>!(0,w.Ag)(i,[{x:0,y:r.cM},{x:e,y:r.cM},{x:e,y:t},{x:0,y:t}])))};for(c()&&(n=a[n],s.rotaterDirection=n,h.add(n));h.size<4&&(l()||c());)n=o[n],s.rotaterDirection=n,h.add(n);c()?s.setRotaterVisible(!1):s.setRotaterVisible(!0)}materialLoadingChecker(e){const t=this._getNode(e);return!!t&&(0,P.dJ)(t,this._renderer.accessors)}getMaterialWidgetById(e){return this.mainRenderer.getMaterialWidget(e)}}var M=i(36919),S=i(32598),E=i(39589),A=i(3549),R=i(43825),T=i(41658);class b{constructor(e){this.textAccessor=e}get getNodeLayer(){return this.textAccessor.getNodeLayer}get getNode(){return this.textAccessor.getNode}get checkCache(){return this.textAccessor.checkCache}}class N extends b{getUpperCase(e){var t;return(null===(t=this.getNodeLayer(e))||void 0===t?void 0:t.upperCase)||!1}}var D=i(57123),L=i(33146);const k=D.EY.tool,O=D.w3.layer;class B extends b{getBackgroundColor(e){var t;const{background:i}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return null!=i&&i.enable&&i.color?(0,L.yv)(i.color):null}getBackgroundCornerRadiusScale(e){var t;return k.backgroundCornerRadiusScale(null===(t=this.getNodeLayer(e))||void 0===t||null===(t=t.background)||void 0===t?void 0:t.cornerRadius)}getBackgroundOpacity(e){var t,i;const{background:r}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return k.opacity((null!==(i=null==r?void 0:r.color)&&void 0!==i?i:R.YW)[3])}getCurveAngle(e){var t,i;const{curve:r}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return null!=r&&r.enable?k.curveAngle(null!==(i=null==r?void 0:r.angle)&&void 0!==i?i:R.r9):null}getGlowColor(e){var t;const{glow:i}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return null!=i&&i.enable&&i.color?(0,L.yv)(i.color):null}getGlowIntensity(e){var t,i;const{glow:r}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return k.glowIntensity(null!==(i=null==r?void 0:r.intensity)&&void 0!==i?i:R.f$)}getGlowRange(e){var t,i;const{glow:r}=null!==(t=this.getNodeLayer(e))&&void 0!==t?t:{};return k.glowRange(null!==(i=null==r?void 0:r.range)&&void 0!==i?i:R.DI)}getOpacity(e){var t,i;const r=null!==(t=null===(i=this.getNodeLayer(e))||void 0===i||null===(i=i.layout)||void 0===i?void 0:i.opacity)&&void 0!==t?t:1;return k.opacity(r)}setOpacity(e,t=100){const i=this.getNode(e);if(!i)return;const r=O.opacity(t);null==i||i.opacity(r)}}const F=D.EY.tool;class G extends b{getLetterSpacing(e){var t;const i=null===(t=this.getNodeLayer(e))||void 0===t?void 0:t.letterSpacing;return F.letterSpacing(i)}getLineHeight(e){var t;const i=null===(t=this.getNodeLayer(e))||void 0===t?void 0:t.lineSpacing;return F.lineHeight(i)}}var W=i(11005),H=i(44264);class U extends C{constructor(){super(...arguments),this.operator=new N(this),this.style=new B(this),this.font=new G(this),this._effectEditHelper=new S.g,this._textEditInfo={isEdit:!1,textId:""},this.getLayoutInfoByText=e=>{const t={id:e.effectId,resourceId:e.resourceId,useEffectDefaultColor:!1,fallbackTextInfoList:[]},i=v.Q.toJSON({color:[0,0,0,1],boldWidth:0,text:e.text,fontSize:e.fontSize,font:t}),s=(0,A.V)(),n={type:r.F5.TEXT,id:s,layout:{x:0,y:0,width:e.defaultWidth,height:e.defaultHeight,opacity:1,scale:{x:1,y:1},rotation:0,type:"fixed",anchor:{x:.5,y:.5}},visibility:!0,isLocked:!1,canClip:!1,extra:{textOuterRect:{width:e.defaultWidth,height:e.defaultHeight}},orientation:0,align:1,letterSpacing:0,lineSpacing:0,innerPadding:.1,lineMaxWidth:1,upperCase:!1,text:e.text,fontDependResources:[t],richText:JSON.stringify(i)};return E.ZP.getEffectTextLayoutInfo(s,n)},this.getTextEffectLayout=e=>E.ZP.getEffectTextLayoutInfo(e.id,e),this.getNodeAttrs=(e,t)=>{var i;const r=null===(i=this._getNode(e))||void 0===i?void 0:i.getAttrs();return t.reduce(((e,t)=>({...e,[t]:r[t]})),{})},this.batchDraw=async(e,t)=>{const i=this._renderer.getMainRenderer().getMaterialWidget(e);i&&await i.updateNode(t)},this.getTextLayerFontResources=e=>{const t=new Set(null!=e?e:[]),i={};return this._renderer.model.getLayersByFilter(!0,(e=>{if(t.size&&t.has(e.id)||e.type===r.F5.TEXT){JSON.parse(e.richText).styles.forEach((t=>{var r;const s=null===(r=t.font)||void 0===r?void 0:r.id;if(s){(i[s]||(i[s]=new Set)).add(e.id)}}))}return!0})),i},this.getNodeExtendBuffer=e=>{var t,i,r,s;const n=this.getNodeLayer(e);if(!n)return{x:0,y:0};const{layout:a,extra:o}=n;return{x:(null!==(t=null===(i=o.textOuterRect)||void 0===i?void 0:i.width)&&void 0!==t?t:a.width)-a.width,y:(null!==(r=null===(s=o.textOuterRect)||void 0===s?void 0:s.height)&&void 0!==r?r:a.height)-a.height}},this.getTextRuntimeLayout=e=>{const t=H.f.cache.get(e);return null==t?void 0:t.getLayout()},this.getRichJson=async(e,t)=>{const i=H.f.cache.get(e);return await(null==i?void 0:i.getRichTextAttributes(t))},this.updateTextRuntimeComponentStyle=async(e,t)=>{const i=H.f.cache.get(e),r=this.getNodeLayer(e);if(!i||!r)return;const s={...t};if(delete s.richText,t.layout){var n;const e={x:i.state.scale[0]/r.layout.scale.x,y:i.state.scale[1]/r.layout.scale.y},a=null!==(n=t.layout.scale)&&void 0!==n?n:r.layout.scale;Object.assign(s,{layout:{...r.layout,...t.layout,scale:{x:e.x*a.x,y:e.y*a.y}}})}await i.updateRuntimeComponent(s)},this.updateTextRuntimeLetterStyle=(e,t)=>{const i=H.f.cache.get(e);if(i)return i.updateRuntimeLetter(t)}}get getNode(){return this._getNode}getEffectTextRatioByResourceId(e){return(0,M.vJ)(e)}getText(e){var t,i;return null!==(t=null===(i=this.getNodeLayer(e))||void 0===i?void 0:i.text)&&void 0!==t?t:""}setText(e,t){var i;null===(i=this._getNode(e))||void 0===i||i.setAttr("text",t)}getLayerRichJson(e){var t,i;const r=null!==(t=null===(i=this.getNodeLayer(e))||void 0===i?void 0:i.richText)&&void 0!==t?t:"";return JSON.parse(r)}getTextLayoutInfo(e){var t;const i=this._getNode(e);if(!i)return;const{x:r=1,y:s=1}=null!==(t=i.getAbsoluteScale())&&void 0!==t?t:{},n=i.getAbsolutePosition();return{width:i.width(),height:i.height(),absolutePosition:{x:n.x,y:n.y},rotation:i.rotation(),scale:{x:r,y:s},absolute:{position:n,scale:{...i.getAbsoluteScale()},rotation:i.getAbsoluteRotation(),opacity:i.getAbsoluteOpacity()}}}async revalidateTextLayerRenderHeight(e,t){var i;const{defaultEffectTextNode:r}=t,s=null!=r?r:H.f.cache.get(e),n=this.getNodeLayer(e);if(!s||!n)return;const{autoWrap:a=!0,params:o}=t,h=this.getNodeExtendBuffer(e),d=null!==(i=t.width)&&void 0!==i?i:n.layout.width,c={lineMaxWidth:a?d/R.I7:-1};this._textEditInfo.isEdit&&this._textEditInfo.textId===e&&Object.assign(c,{richText:JSON.stringify(s.runtimeRichJson)}),await s.syncStaticParams({...c,...o});const l=await s.getStaticInnerLayout();return{innerBoundWidth:l.width,innerBoundHeight:l.height,outerBoundWidth:l.width+h.x||1,outerBoundHeight:l.height+h.y||1}}setTextEditState(e,t){const i=this._renderer.getMainRenderer().getMaterialWidget(e);t?null==i||i.enterTextEdit():null==i||i.exitTextEdit(),this._textEditInfo={textId:e,isEdit:t}}getTextShapeNode(e){const t=this._getNode(e);var i;if(t)return t instanceof p.ZA?null===(i=t.children)||void 0===i?void 0:i.find((e=>e instanceof m.x)):t}updateTextLayerHeight(e,t){const i=this._getNode(e);if(!i)return;const r=i.attrs;i.setAttrs({height:t});(0,T.d)(r,{height:t},["height"])&&i.fire(W.Z2.layoutupdate)}fireTextEditStart(e){const t=this._getNode(e);t&&t.fire(W.qB.texteditstart)}fireTextEditEnd(e){const t=this._getNode(e);t&&t.fire(W.qB.texteditend)}}g.U.delegates(U.prototype,"operator",{getUpperCase:g.s.METHOD}),g.U.delegates(U.prototype,"style",{getBackgroundColor:g.s.METHOD,getBackgroundCornerRadiusScale:g.s.METHOD,getBackgroundOpacity:g.s.METHOD,getGlowColor:g.s.METHOD,getGlowIntensity:g.s.METHOD,getGlowRange:g.s.METHOD,getCurveAngle:g.s.METHOD,getOpacity:g.s.METHOD,setOpacity:g.s.METHOD}),g.U.delegates(U.prototype,"font",{getLetterSpacing:g.s.METHOD,getLineHeight:g.s.METHOD});var z=i(71946),j=i(53971),Z=i(76970),$=i(39113),q=i(52169),X=i(20484),K=i(54643),V=i(10224),Y=i(35263);class Q{constructor(e){this._imageAccessor=e}handleUniformScaling(e,t,i){const r=this._imageAccessor.getImageNode(i),s=this._imageAccessor.getNodeLayer(i);if(!s)return;const{width:n,height:a}=s.layout,{clipRect:o}=s.layout;r&&r.setAttrs({height:a,width:n,scale:{x:e/n,y:t/a},clipRect:o})}handleNonUniformScaling(e,t,i,r){const s=this._imageAccessor.getImageNode(i),n=this.calNonUniformScaling(e,t,i,r);s&&n&&s.setAttrs({...n})}calNonUniformScaling(e,t,i,s){const n=this._imageAccessor.getNodeLayer(i);if(!n||!s)return;const{width:a,height:o,scale:h={x:1,y:1}}=n.layout,d={width:a*h.x,height:o*h.y},c={width:e,height:t},l=n.layout.clipRect?this._scaleClipRect(n.layout.clipRect,h):this._getDefaultClipRect(d.width,d.height);return r.Wk===s?this._applyScaling(V.U.calRightNonScaling(d,c,l),h):r.XE===s?this._applyScaling(V.U.calLeftNonScaling(d,c,l),h):r.Py===s?this._applyScaling(V.U.calTopNonScaling(d,c,l),h):r.DA===s?this._applyScaling(V.U.calBottomNonScaling(d,c,l),h):r.nh===s?this._applyScaling(V.U.callLeftTopScaling(d,c,l),h):r.EK===s?this._applyScaling(V.U.callRightTopScaling(d,c,l),h):r.ng===s?this._applyScaling(V.U.callLeftBottomScaling(d,c,l),h):r.Z0===s?this._applyScaling(V.U.callRightBottomScaling(d,c,l),h):void 0}_applyScaling(e,t){const{width:i,height:r,clipRect:s}=e;return{width:i/t.x,height:r/t.y,scale:t,clipRect:s?{width:s.width/t.x,height:s.height/t.y,x:s.x/t.x,y:s.y/t.y}:void 0}}_scaleClipRect(e,t){return{width:e.width*t.x,height:e.height*t.y,x:e.x*t.x,y:e.y*t.y}}_getDefaultClipRect(e,t){return{width:e,height:t,x:0,y:0}}}class J extends C{constructor(e){super(e),this._loadingWidgets=new Map,this._highlight=new q.Z(e),this._scale=new Q(this)}isMoreThan4K(e){const t=this._getNode(e).image();if(!t)return;const{width:i,height:r}=t;return i>=3840&&r>=2160}setFilters(e,t){if(this._getNode(e)){const i=this.getNodeLayer(e),r=t.reduce(((e,t)=>({...e,[t.key]:t.value})),{...i.filter}),s=this.getMaterialWidgetById(e);if(!s)return;s.updateNode({filter:r})}}getFilters(e){const t=this.getNodeLayer(e),i={};if(t){var r;const{tool:e}=$.default.model;Object.keys(null!==(r=t.filter)&&void 0!==r?r:{}).reduce(((i,r)=>{var s,n;let a=null!==(s=null===(n=t.filter)||void 0===n?void 0:n[r])&&void 0!==s?s:0;return"function"==typeof e[r]&&(a=e[r](a)),i[r]=a,i}),i)}return i}setEffectFilters(e,t){if(this._getNode(e)){const i=this._renderer.getMainRenderer().getMaterialWidget(e);if(!i)return;i.updateNode({effectFilters:t})}}getEffectFilters(e){var t;const i=this.getNodeLayer(e);return null!==(t=null==i?void 0:i.effectFilters)&&void 0!==t?t:[]}setPostProcessEffects(e,t){if(this._getNode(e)){const i=this._renderer.getMainRenderer().getMaterialWidget(e);if(!i)return;i.updateNode({postProcessEffects:t})}}getPostProcessEffects(e){var t;const i=this.getNodeLayer(e);return null!==(t=null==i?void 0:i.postProcessEffects)&&void 0!==t?t:[]}getImageSrc(e){var t;const i=this._renderer.findByID(e);return null==i||null===(t=i.attrs)||void 0===t||null===(t=t.image)||void 0===t?void 0:t.src}getImageType(e){const t=this.getNodeLayer(e);return null==t?void 0:t.src.type}getImageCutOutFeature(){return this._renderer.getFeatureRenderer().getFeature(j.Z.Name)}getImageReplaceFeature(){return this._renderer.getFeatureRenderer().getFeature(Z.Z.Name)}getClipRect(e,t,i){const s=this._getNode(e);if(!s||!t||!i)return;const{attrs:n}=s;return z.Z.getRenderLayerUtil(r.Wq.IMAGE).transformClipRect({width:t,height:i},{width:n.width,height:n.height})}transformClipRect(e,t){return z.Z.getRenderLayerUtil(r.Wq.IMAGE).transformClipRect(e,t)}isPointInImage(e,t){const{x:i,y:s}=e;let n;if(n=t?this._renderer.getFeatureRenderer().getLayer().getIntersection({x:i,y:s}):this._renderer.getMainRenderer().getLayer().getIntersection({x:i,y:s}),n&&z.Z.getRenderLayerUtil(r.Wq.IMAGE).is(n))return n.attrs.id}renderHoverImageResource(e,t,i){const s=this.getImageNode(e,i),n=this.getMaterialWidgetById(e);if(!s||!n)return;const{image:a,...o}=s.attrs;if(o.lastAttrs)return;const h={...o,...i?{image:a}:null},d=z.Z.getRenderLayerUtil(r.Wq.IMAGE).transformClipRect({width:t.width,height:t.height},{width:o.width,height:o.height});return d?(s.setAttrs({lastAttrs:h,clipRect:d,editParams:void 0,effectFilters:void 0,postProcessEffects:void 0}),i?Y.e.replace(s,{src:{path:t.url,type:t.type},pixels:n.props.pixels,zoom:n.props.zoom}):n.updateNode({src:{path:t.url,type:t.type},aiTool:void 0,isFlipHorizontal:void 0,isFlipVertical:void 0,replacePalette:void 0}),this.renderHoverBorder(s),d):void 0}renderHoverBorder(e,t,i){const r=e=>{var t;e&&(this._highlight.has(e)||null!==(t=this._renderer.getFeatureRenderer().getInteractive().selection)&&void 0!==t&&t.selectedIds.includes(e.attrs.id)||this._highlight.add(e))};e&&r(e),t&&r(this.getImageNode(t,i))}removeHoverImage(e,t){const i=this.getImageNode(e,t),r=this.getMaterialWidgetById(e);if(!i||!r)return;const{attrs:s}=i;if(s.lastAttrs){if(i.setAttrs({...s.lastAttrs,clipRect:s.lastAttrs.clipRect||null,lastAttrs:void 0}),!t){const e=(0,X.ei)(r.props,["src","cutout","replacePalette"]);r.updateNode(e)}this.removeHoverBorder(i)}}removeHoverBorder(e,t,i){const r=e=>{e&&this._highlight.has(e)&&this._highlight.remove(e)};e&&r(e),t&&r(this.getImageNode(t,i))}showLoading(e,t="loading..."){const i=this._renderer.getMainRenderer().getMaterialWidget(e);return i&&this._loadingWidgets.set(e,i),null==i?void 0:i.showLoading(t)}hideLoading(e){const t=this._loadingWidgets.get(e);return null==t?void 0:t.hideLoading()}getLoading(e){const t=this._renderer.getMainRenderer().getMaterialWidget(e);return Boolean(null==t?void 0:t.waitingState)}getLayoutFillInPage(e){const t=this.getPageId(e);if(!t)return;const i=this.getNodeLayer(e),r=this._renderer.model.getPageById(t);if(!i||!r)return;const{width:s,height:n}=(0,K.Ln)(r.dimension);return V.U.calImageLayoutToFillContainer({width:s,height:n},i.layout)}getImageNode(e,t){return t?this._renderer.getFeatureRenderer().findByID(e):this._getNode(e)}handleNonUniformScaling(e,t,i,r){this._scale.handleNonUniformScaling(e,t,i,r)}handleUniformScaling(e,t,i){this._scale.handleUniformScaling(e,t,i)}calNonUniformScaling(e,t,i,r){return this._scale.calNonUniformScaling(e,t,i,r)}switchImage(e,t){this.getMaterialWidgetById(e).updateNode({...t})}}var ee=i(56537);class te extends C{getShapePaths(e){const t=this._renderer.model.getLayerById(e);return t?t.paths:[]}changeStrokeColor(e,{stroke:t,defaultStrokeWidth:i}){const r=this.getMaterialWidgetById(e);if(!r||!r.element)return;const s=r.element,{zoom:n}=r.props,{svgInfo:a,width:o,height:h,scaleX:d,scaleY:c}=s.attrs,{source:l,attr:g,radius:u,fixedAreas:f}=a;this.drawSvg({source:l,radius:u,attrs:{...g,stroke:t,strokeWidth:g.strokeWidth||i},imageLayer:s,width:o,height:h,zoom:n,scale:{x:d,y:c},id:e,fixedAreas:f})}changeFillColor(e,t){const i=this.getMaterialWidgetById(e);if(!i||!i.element)return;const r=i.element,{zoom:s}=i.props,{svgInfo:n,width:a,height:o,scaleX:h,scaleY:d}=r.attrs,{source:c,attr:l,radius:g,fixedAreas:u}=n;this.drawSvg({source:c,radius:g,attrs:{...l,fill:t},fixedAreas:u,imageLayer:r,width:a,height:o,zoom:s,scale:{x:h,y:d},id:e})}changeBorderWidth(e,t,i){const r=this.getMaterialWidgetById(e);if(!r||!r.element)return;const s=r.element,{zoom:n}=r.props,{svgInfo:a,width:o,height:h,scaleX:d,scaleY:c}=s.attrs,{source:l,attr:g,radius:u,fixedAreas:f}=a;this.drawSvg({source:l,radius:u,attrs:{...g,...ee.F.updateShapeStrokeWidth(t,i)},fixedAreas:f,imageLayer:s,width:o,height:h,zoom:n,scale:{x:d,y:c},id:e})}changeBorderRadius(e,t){const i=this.getMaterialWidgetById(e);if(!i||!i.element)return;const r=i.element,{zoom:s}=i.props,{svgInfo:n,width:a,height:o,scaleX:h,scaleY:d}=r.attrs,{source:c,attr:l,fixedAreas:g}=n;this.drawSvg({source:c,radius:t,attrs:l,fixedAreas:g,imageLayer:r,width:a,height:o,zoom:s,scale:{x:h,y:d},id:e})}changeLayout(e,t){const i=this._getNode(e);if(!i)return;const r={...i.attrs,width:t.width,height:t.height,scaleX:t.scale.x,scaleY:t.scale.y};i.setAttrs(r)}drawSvg(e){var t;const{source:i,radius:s,attrs:n,width:a,height:o,id:h,scale:d,fixedAreas:c}=e,l={source:i,radius:s,attr:n,fixedAreas:c},g=ee.F.updatePolygonPath(l.attr,l.radius,{width:a,height:o,scale:{x:1,y:1}},l.fixedAreas),u=z.Z.getRenderLayerUtil(r.Wq.SHAPE),f=u.getStrokeWidth(g.strokeWidth)/((null==d?void 0:d.x)||1),_=u.getStrokeDash(g.strokeDasharray),y=u.getStrokeColor(null!=a?a:0,null!=o?o:0,g),p=u.getFillColor(null!=a?a:0,null!=o?o:0,g),m=this._renderer.getMainRenderer().getMaterialWidget(h);m&&(null===(t=m.element)||void 0===t||t.setAttrs({...y,...p,..._,width:a,height:o,scaleX:d.x,scaleY:d.y,data:g.d,strokeWidth:f}))}}var ie=i(35429),re=i(26399),se=i(5317);class ne extends C{getLineLayer(e){return this._renderer.model.getLayerById(e)}getNewLayout(e,t,i){const r=this.getLineLayer(e),{layout:s}=r,n=(0,ie.p)(s),a=Math.floor(n.width*n.scale.x),o=Math.floor(n.height*n.scale.y),h=a/t.width,d=i.height*h,c=n.y+(o-d)/2*Math.cos(n.rotation*Math.PI/180),l=n.x-(o-d)/2*Math.sin(n.rotation*Math.PI/180);return{width:a,height:d,scale:{x:1,y:1},rotation:s.rotation,y:c,x:l}}getNewLayoutForModel(e,t,i){return(0,ie.W)(this.getNewLayout(e,t,i))}changeBorderWidth(e,t,i){const r=this._getNode(e);if(!r)return;const{svgInfo:s}=r.attrs,{source:n,attr:a}=s,o=ee.F.updateLineStrokeWidth(n,Object.assign({},a,{strokeWidth:t}),t,i),h=ee.F.composeLineByAttrs(n,{...a,...o}),{devicePixelRatio:d}=se.Z.getGlobalVars();ee.F.svgToImage({data:h,width:r.width(),height:r.height(),dpr:d}).then((t=>{if(t){r.image(t);const i=this.getNewLayout(e,a.viewBox,o.viewBox);re.Z.setAssetsCache(r.attrs.id,t),r.setAttrs({...i})}}))}changeStrokeColor(e,t){const i=this._getNode(e);if(!i)return;const{svgInfo:r}=i.attrs,{source:s,attr:n}=r,a=ee.F.composeLineByAttrs(s,{...n,stroke:t}),{devicePixelRatio:o}=se.Z.getGlobalVars();ee.F.svgToImage({data:a,dpr:o,width:i.width(),height:i.height()}).then((e=>{e&&(i.image(e),re.Z.setAssetsCache(i.attrs.id,e))}))}}var ae=i(43382),oe=i(14764),he=i(8325);class de extends C{constructor(e){super(e),this.createNodeLayerLayout=(e,t)=>{const i={id:e.id(),x:e.x(),y:e.y(),rotation:e.rotation(),width:e.width(),height:e.height(),scale:{x:e.scaleX(),y:e.scaleY()},opacity:e.opacity(),layerType:e.attrs.type,...t};return(z.Z.isEqual(e,r.Wq.IMAGE)||z.Z.isEqual(e,r.Wq.SVG_IMAGE))&&(i.clipRect=z.Z.imageCropToClipRect(e)),{...i,...(0,ie.W)({x:i.x,y:i.y,width:i.width,height:i.height,rotation:i.rotation,scale:i.scale})}},this._layerHighlightDashed=new q.Z(e,{dash:[10,6],buffer:[oe.Qe,oe.Qe]}),this._layerHighlightSolid=new q.Z(e,{buffer:[oe.Qe,oe.Qe]})}setOpacity(e,t){const i=this._getNode(e);i&&i.opacity(t)}getOpacity(e){const t=this._getNode(e);if(t)return t.opacity()}getLayerById(e){return this._renderer.model.getLayerById(e)}getLayerAbsoluteScale(e){const t=this._renderer.model.getPageByChildLayerId(e);if(!t)return;const i=t.getLayerAccessRoad(e),r={x:1,y:1};for(;i.length>=2;){var s,n;i.splice(0,1);const e=i[0],t=this._renderer.model.getLayerById(e);r.x=r.x*(null!==(s=null==t?void 0:t.layout.scale.x)&&void 0!==s?s:1),r.y=r.y*(null!==(n=null==t?void 0:t.layout.scale.y)&&void 0!==n?n:1)}return r}getPageByChildLayerId(e){return this._renderer.model.getPageByChildLayerId(e)}getMaterialsSelectRect(e){const t=(0,x.b)(e);if(!t)return;const i=this._renderer.getFeatureRenderer().findByID(t);return i&&i instanceof I.A4?i.__getNodeRect():void 0}getMaterialsSelectRectForModel(e){const t=this.getMaterialsSelectRect(e);if(!t)return;const{x:i,y:r,width:s,height:n,rotation:a}=t,o=this._renderer.getMainRenderer().getZoom(),h=this._renderer.stage.container,d=this._renderer.getActivePage(),{x:c,y:l}=d.getAbsolutePosition(h),g=o.x,u=o.y,f=(0,ie.W)({x:i-c,y:r-l,width:s,height:n,rotation:180*a/Math.PI,scale:{x:1,y:1}});return{...f,width:s/g,height:n/u,x:f.x/g,y:f.y/u}}getStagePointerPosition(){return this._renderer.stage.container.getPointerPosition()}isLocked(e){return e.length>0&&e.every((e=>{var t;return null===(t=this.getLayerById(e))||void 0===t?void 0:t.isLocked}))}getBatchEditorMainLayerInfoByLayerId(e){var t,i;const s=this._renderer.isBatchEditorType(),n=this.getLayerById(e),a=n&&(0,he.Pz)(n);let o;if(s&&a){switch(n.type){case r.F5.IMAGE_CONTAINER:o=null===(t=(0,he.gQ)(n))||void 0===t?void 0:t.position;break;case r.F5.GRID:o=null===(i=(0,he.gQ)(n))||void 0===i?void 0:i.areaId}return{isMainLayer:!0,position:o}}return{isMainLayer:!1,position:o}}onDblClick(e,t){return this._generateEventListener(e,W.Z2.dblclick,t)}onClick(e,t){return this._generateEventListener(e,W.Z2.click,t)}onMouseDown(e,t){return this._generateEventListener(e,W.Z2.mousedown,t)}onMouseUp(e,t){return this._generateEventListener(e,W.Z2.mouseup,t)}onMouseMove(e,t){return this._generateEventListener(e,W.Z2.mousemove,t)}onMouseEnter(e,t){return this._generateEventListener(e,W.Z2.mouseenter,t)}onMouseOut(e,t){return this._generateEventListener(e,W.Z2.mouseout,t)}onDragStart(e,t){return this._generateEventListener(e,W.Z2.dragstart,t)}onDragMove(e,t){return this._generateEventListener(e,W.Z2.dragmove,t)}onDragEnd(e,t){return this._generateEventListener(e,W.Z2.dragend,t)}onCropStart(e,t){return this._generateEventListener([e],W.qB.cropstart,t)}onCropEnd(e,t){return this._generateEventListener([e],W.qB.cropend,t)}onReplaceStart(e,t){return this._generateEventListener([e],W.qB.replacestart,t)}onReplaceEnd(e,t){return this._generateEventListener([e],W.qB.replaceend,t)}onTransformStart(e,t){return this._generateEventListener(e,W.Z2.transformstart,t)}onTransform(e,t){return this._generateEventListener(e,W.Z2.transform,t)}onTransformEnd(e,t){return this._generateEventListener(e,W.Z2.transformend,t)}onLayoutUpdate(e,t){const i=this._getNode(e);if(!i)return ae.G;return this._generateEventListener([e],[W.Z2.transformend,W.Z2.dragend,W.Z2.layoutupdateend],((s,n)=>{const o={id:i.id(),layerType:i.attrs.type,x:i.x(),y:i.y(),rotation:i.rotation(),width:i.width(),height:i.height(),opacity:i.opacity(),scale:{x:i.scaleX(),y:i.scaleY()}};(z.Z.isEqual(i,r.Wq.IMAGE)||z.Z.isEqual(i,r.Wq.SVG_IMAGE))&&(o.clipRect=z.Z.imageCropToClipRect(i));const h={...o,...(0,ie.W)({x:o.x,y:o.y,rotation:o.rotation,width:o.width,height:o.height,scale:o.scale})},d=this._renderer.accessors.layer.getLayerById(e);if(!d)return a.t.error("onLayoutUpdate, layer not exist"),ae.G;const c=(0,x.b)(i.id()),l=c?this._renderer.getFeatureRenderer().findByID(c):null;t({id:i.id(),layerType:i.attrs.type,...d.layout},h,n,null==l?void 0:l.getActiveAnchor())}))}onLayoutBatchUpdate(e,t){const i=(0,x.b)(e);if(!i)return ae.G;if(!this._renderer.getFeatureRenderer().findByID(i))return ae.G;if(e.map((e=>this._getNode(e))).filter((e=>e)).length<=0)return ae.G;return this._generateEventListener(e,[W.Z2.transformend,W.Z2.dragend,W.Z2.layoutupdateend],((i,r)=>{const s=e.map((e=>{var t;const i=null===(t=this._renderer.accessors.layer.getLayerById(e))||void 0===t?void 0:t.layout,r=this._getNode(e);if(i&&r)return{oldLayout:{id:e,...i},newLayout:this.createNodeLayerLayout(r)}})).filter((e=>Boolean(e))),n=s.map((e=>null==e?void 0:e.oldLayout)),a=s.map((e=>null==e?void 0:e.newLayout));t(n,a,r)}))}moveLayers(e){const t=e.map((e=>e.id));if(null==t||!t.length)return;const i=(0,x.b)(t);if(i){const t=this._renderer.getFeatureRenderer().findByID(i),r={};e.forEach((e=>{r[e.id]={x:e.offsetX,y:e.offsetY}})),t.moveLayers(r,0)}}getAbsoluteScale(e){var t;const i=this._getNode(e);return null==i||null===(t=i.parent)||void 0===t?void 0:t.getAbsoluteScale()}showBorderHighlight(e){"dashed"===e&&(this._layerHighlightDashed.show(),this._layerHighlightSolid.hide()),"solid"===e&&(this._layerHighlightSolid.show(),this._layerHighlightDashed.hide())}clearBorderHighlight(){this._layerHighlightSolid.clear(),this._layerHighlightDashed.clear()}addBorderHighlight(){const e=this._renderer.getActivePage();e&&(this._layerHighlightDashed.add(e),this._layerHighlightSolid.add(e),this._layerHighlightDashed.hide(),this._layerHighlightSolid.hide())}getMaterialGroupIdByNodeId(e){const t=this._renderer.findByID(e);return z.Z.getMaterialGroupId(t)}lockProportion(e){re.Z.setLockProportionCache(e,!0)}unLockProportion(e){re.Z.setLockProportionCache(e,!1)}getLockProportionStatus(e){return re.Z.getLockProportionCache(e)}_generateEventListener(e,t,i){if(e.length<=0)return ae.G;const r=e.length>1,s=r?(0,x.b)(e):e[0];if(!s)return ae.G;const n=r?this._renderer.getFeatureRenderer().findByID(s):this._getNode(s);if(!n)return ae.G;const a=(t instanceof Array?t:[t]).join(" "),o=e=>{const{evt:t,type:r}=e;i(t,r)};return n.on(a,o),()=>{n.off(a,o)}}}var ce=i(34618),le=i(61077),ge=i(49036),ue=i(24638),fe=i(70986),_e=i(27482),ye=i(52579),pe=i(33839);class me extends C{getLayersByFilter(e,t,i){const r=this._renderer.model.getPageById(e);return null==r?void 0:r.getLayersByFilter(t,i)}getPageById(e){return this._renderer.model.getPageById(e)}isPage(e){return Boolean(this._renderer.model.getPageById(e))}setBgImageWithOpacity(e){const t=this.mainRenderer.getActivePageWidget();t&&t.updateBackgroundImage({layout:{opacity:e/100}})}setFilters(e){var t;const i=this._renderer.model.getPageById(this.getActivePageId()),r=e.reduce(((e,t)=>({...e,[t.key]:t.value})),{...null==i||null===(t=i.background.image)||void 0===t?void 0:t.filter}),s=this.mainRenderer.getActivePageWidget();s&&s.updateBackgroundImage({filter:r})}getFilters(){const e={};if(this.getActivePageId()){var t,i;const r=this._renderer.model.getPageById(this.getActivePageId()),{tool:s}=$.default.model,n=null!==(t=null==r||null===(i=r.background.image)||void 0===i?void 0:i.filter)&&void 0!==t?t:{};Object.keys(n).reduce(((e,t)=>{var i;let r=null!==(i=null==n?void 0:n[t])&&void 0!==i?i:0;return"function"==typeof s[t]&&(r=s[t](r)),e[t]=r,e}),e)}return e}getEffectFilters(){var e,t;const i=this._renderer.model.getPageById(this.getActivePageId());return null!==(e=null==i||null===(t=i.background.image)||void 0===t?void 0:t.effectFilters)&&void 0!==e?e:[]}getPostProcessEffects(){var e,t;const i=this._renderer.model.getPageById(this.getActivePageId());return null!==(e=null==i||null===(t=i.background.image)||void 0===t?void 0:t.postProcessEffects)&&void 0!==e?e:[]}switchPage(e){const t=this.getActivePageId();this._renderer.switchPage(t,e)}hasBackgroundImage(e){return Boolean(this.getBackgroundImage(e))}hasBackgroundColor(e){var t;return Boolean(null===(t=this._renderer.model.getPageById(e))||void 0===t?void 0:t.background.color)}getTitle(e){var t;return null===(t=this._renderer.model.getPageById(e))||void 0===t?void 0:t.title}getBackgroundImage(e){var t;return null===(t=this._renderer.model.getPageById(e))||void 0===t?void 0:t.background.image}getBackgroundColor(e){var t;return null===(t=this._renderer.model.getPageById(e))||void 0===t?void 0:t.background.color}setBackgroundColor(e,t){var i;null===(i=this._renderer.getMainRenderer().getPageWidgetById(e))||void 0===i||i.setBgColor(t)}getBackgroundImageNode(e){const{id:t}=(0,ce.Vf)(e,r.Wq.PAGE);return this._getNode(t)}getFill(e){const{id:t}=(0,ce.Qb)(e,r.Wq.PAGE),i=this._getNode(t);if(i)return i.fill()}getDraftIsEmpty(e){const{layers:t}=this._renderer.model.pages[e];return 0===t.length}getDimension(e){return this.mainRenderer.getDimension(null!=e?e:this.getActivePageId())}getDimensionByIndex(e){const{id:t}=this._renderer.model.pages[null!=e?e:this.getActivePageIndex()];return this.mainRenderer.getDimension(t)}getPageDragEnable(){return this._renderer.getMainRenderer().getInteractive().moveAction.isDragEnable}getStagePositionRelativeToPage(e,t){const i=this._renderer.getActivePage();if(!i)return{x:0,y:0};const r=i.getAbsolutePosition(this._renderer.stage.container),s=i.getAbsoluteScale(),n=e-r.x,a=t-r.y;return{x:n/s.x,y:a/s.y}}getViewportPositionRelativeToStage(e,t){const i=this._renderer.stage.rect,{left:r,top:s}=i;return{x:e-r,y:t-s}}getViewportPositionRelativeToPage(e,t){const i=this.getViewportPositionRelativeToStage(e,t);return this.getStagePositionRelativeToPage(i.x,i.y)}getPageVisibleRect(){const e=this._renderer.getMainRenderer().getPageAbsoluteRectWithBleedArea(),{x:t,y:i,width:s,height:n}=null!=e?e:{x:0,y:0,width:0,height:0},a=this._renderer.stage.rect,{width:o,height:h}=a,d=t>=0?0:-t,c=i>=r.cM?0:r.cM-i,l=t+s<=o?s-d:o-Math.max(t,0),g=i+n<=h?n-c:h-Math.max(i,0),{x:u,y:f}=this.getZoom();return{x:d/u,y:c/f,width:l/u,height:g/f}}getActivePageClientRectRelativeToStage(){const e=this._renderer.getActivePageRect();if(e)return e.getClientRect({relativeTo:this._renderer.stage.container})}getScrollerFeature(){return this._renderer.getFeatureRenderer().getFeature(le.Z.Name)}getRulerFeature(){return this._renderer.getFeatureRenderer().getFeature(_e.Z.Name)}getPageMarginFeature(){return this._renderer.getFeatureRenderer().getFeature(ye.Z.Name)}getPageBleedFeature(){return this._renderer.getFeatureRenderer().getFeature(pe.Z.Name)}getCursor(){return this._renderer.cursor}isOver(e,t,i){const r=i.getAbsolutePosition(this._renderer.stage.container),s=i.getAbsoluteScale(),n=i.width()*s.x,a=i.height()*s.y,o=i.getAbsoluteRotation()*Math.PI/180,h={x:r.x,y:r.y,width:n,height:a,rotation:o},{x:d,y:c}=(0,w.qg)(h),{x:l,y:g}=(0,w.Pl)(h,-o),u={x:e,y:t},f={x:d,y:c},{x:_,y}=(0,w._1)(u,-o,f),p=_-l,m=y-g;return p>=0&&p<=n&&m>=0&&m<=a}isOverByLayerId(e,t,i){const r=this._getNode(i);return!!r&&this.isOver(e,t,r)}isOverPage(e,t){const i=this._renderer.getActivePage();return!!i&&this.isOver(e,t,i)}getPagePosition(){return this._renderer.getPagePosition()}getRect(e){const{id:t}=(0,ce.Qb)(e,r.Wq.PAGE);return this._getNode(t)}getClientRectSkipChildren(e){const{id:t}=(0,ce.Qb)(e,r.Wq.PAGE),i=this._getNode(t);return i?i.getClientRect():{x:0,y:0,width:0,height:0}}getZoom(){return this._renderer.stage.getZoom()}setZoom({scale:e=100,isFit:t=!1,layerId:i}){return this._renderer.stage.setZoom({scale:e,isFit:t,layerId:i})}setZoomByPointer(e,t,i){return this._renderer.stage.setZoomByPointer(e,t,i)}setCenter(){this._renderer.stage.setCenter()}fitToWindow(e){this._renderer.stage.fitToWindow(e)}getPositionById(e){const t=this._renderer.findByID(e);if(!t)return{x:0,y:0,width:0,height:0};const i=t.getAbsolutePosition(),r=this.getZoom();return{x:i.x,y:i.y,width:(null==t?void 0:t.width())*r.x,height:(null==t?void 0:t.height())*r.y}}setPositionByOffset(e){this._renderer.stage.setPositionByOffset(e)}setPositionByPoint(e){this._renderer.stage.setPositionByPoint(e)}getScrollPosition(){return this._renderer.stage.getScrollPosition()}findAllMaterialsWithoutPage(){const e=this._renderer.getMainRenderer().getAllPages(),t=[];return e.forEach((e=>{z.Z.findMaterials(e,[r.Wq.PAGE]).forEach((e=>{t.push({id:e.id(),node:e})}))})),t}findMaterialLevelById(e){const t=this._getNode(e);if(!t)return;const i=this.mainRenderer.getRenderer().getActivePage(),r=z.Z.getMaterialGroup(t),s=null!=r?r:i;if(!s)return;const{children:n}=s,a=n?n.filter((e=>z.Z.isMaterial(e))):[];return{level:a.findIndex((t=>t.id()===e))+1,topLevel:a.length}}isNodeIntersectPage(e){const t=this._renderer.getMainRenderer().getPageAbsoluteRect();if(!t)return;const{x:i,y:r,width:s,height:n}=t,a=[{x:i,y:r},{x:i+s,y:r},{x:i+s,y:r+n},{x:i,y:r+n}];return(0,w.w3)((0,w.QO)(e),a)}isNodeIntersect(e,t){const i=this._renderer.findByID(e);if(!i)return!1;return t.some((e=>{const t=this._renderer.findByID(e);return!!t&&(0,w.w3)((0,w.QO)(i),(0,w.QO)(t))}))}isPointIntersectNode(e,t){const i=this._renderer.findByID(t);return!!i&&(0,w.Ag)(e,(0,w.QO)(i))}getPointerIntersectLayers(e,t){var i;const r=this._renderer.getPagePosition(),s=this._renderer.getMainRenderer().getZoom(),n=this._renderer.getActivePageRect().width()*s.x,a=this._renderer.getActivePageRect().height()*s.y,o=null!==(i=this._renderer.stateManager.getBleedArea())&&void 0!==i?i:0,h={x:e.x+r.x,y:e.y+r.y};if(e.x<-o||e.x>n+o||e.y<-o||e.y>a+o)return[];return ue.s.intersectPoint(h,t).map((e=>({id:e.layerId,type:e.layerType})))}getLayersRectCorners(e,t=!1){return e.map((e=>this._getNode(e))).filter((e=>Boolean(e))).map((e=>(0,w.QO)(e,t)))}getPageRectCorners(e=this.getActivePageIndex()){const{id:t}=this._renderer.model.pages[e],i=this.getRect(t);return(0,w.QO)(i,!0)}getAverageLuminanceByRange(e,t=50){const i=this._renderer.getActivePage().toCanvas().getContext("2d",{willReadFrequently:!0});if(!i)return 1;const r=this._renderer.getMainRenderer().getPageAbsoluteRectWithBleedArea(),{width:s,height:n}=null!=r?r:{x:0,y:0,width:0,height:0},{x:a,y:o,width:h,height:d}=e,c=this.getZoom(),l=Math.min(Math.max(a,0)*c.x,s),g=Math.min(Math.max(o,0)*c.y,n),u={x:l,y:g,width:Math.min(Math.min(h,h+a)*c.x,s-l),height:Math.min(Math.min(d,d+o)*c.y,n-g)},{data:f}=i.getImageData(u.x,u.y,u.width,u.height),_=Math.ceil(h/t),y=Math.ceil(d/t),p=Math.min(t,Math.ceil(h/_)),m=Math.min(t,Math.ceil(d/y));let v=0,x=0;for(let w=0;w<m;w++){const e=w*y;for(let t=0;t<p;t++){const i=4*(e*_+t*_);if(i+2>=f.length)break;if(v+=.2126*f[i]+.7152*f[i+1]+.0722*f[i+2],x++,x>=1e4)break}if(x>=1e4)break}return v/x/255}getPageCount(){return this._renderer.model.pageCount}getActivePage(){const e=this.getActivePageId();return this._renderer.model.getPageById(e)}getActivePageId(){return this._renderer.getActivePageId()}getActivePageIndex(){return this._renderer.getActivePageIndex()}getNextPageId(){const e=this.getActivePageIndex();return e>=this._renderer.model.pages.length-1?"":this._renderer.model.pages[e+1].id}getPreviousPageId(){const e=this.getActivePageIndex();return e<=0?"":this._renderer.model.pages[e-1].id}getPageIdByIndex(e){var t;return null===(t=this._renderer.model.pages[e])||void 0===t?void 0:t.id}getPageIndexesByIdList(e){return e.map((e=>this._renderer.model.pages.findIndex((t=>t.id===e))))}getBgImageCutOutFeature(){return this._renderer.getFeatureRenderer().getFeature(ge.Z.Name)}getBgImageReplaceFeature(){return this._renderer.getFeatureRenderer().getFeature(fe.Z.Name)}isPointInPageBgImg(e,t){var i;const{x:s,y:n}=e;let a;if(a=t?this._renderer.getFeatureRenderer().getLayer().getIntersection({x:s,y:n}):this._renderer.getMainRenderer().getLayer().getIntersection({x:s,y:n}),!a)return;const{id:o="",type:h=""}=a.attrs,d=z.Z.getRenderLayerUtil(r.Wq.PAGE),c=null!==(i=d.getPageIdFromBg(o))&&void 0!==i?i:"",l=d.isPageBg(h)||d.isPageBgImage(h),g=this.getPageNode(c,t);if(!g)return;const u=t||!t&&d.isInPageHotSpot(g,e);return a&&l&&u?c:void 0}renderHoverImageResource(e,t,i){const r=this.getPageNode(e,i),s=this._renderer.model.getPageById(e);if(!r||!s)return;return Boolean(s.background.image)?this._renderHoverImageForReplace(e,t,i):this._renderHoverImageForFill(e,t,i)}getPageNode(e,t){return t?this._renderer.getFeatureRenderer().findByID(e):this._getNode(e)}getPageBgImageNode(e,t){const i=(0,ce.Vf)(e,r.Wq.PAGE).id;return t?this._renderer.getFeatureRenderer().findByID(i):this._getNode(i)}removeHoverImage(e,t){const i=this.getPageNode(e,t),r=this._renderer.model.getPageById(e);if(!i||!r)return;return Boolean(r.background.image)?this._removeHoverImageForReplace(e,t):this._removeHoverImageForFill(e,t)}getClientRectRelativeToStage(e){var t;const i=this._getNode(e);var r;if(null!==(t=i.children)&&void 0!==t&&t[0])return null===(r=i.children)||void 0===r?void 0:r[0].getClientRect({relativeTo:this._renderer.stage.container})}calBgImageLayout(e,t){const i=this._renderer.model.getPageById(e);if(!i)return;const r={x:0,y:0,width:t.width,height:t.height,scale:{x:1,y:1},rotation:0},{width:s,height:n}=(0,K.Ln)(i.dimension);return V.U.calImageLayoutToFillContainer({width:s,height:n},r)}drawGuideLine(e,t){return this._renderer.getMainRenderer().getInteractive().guideLine.drawGuideLine(e,t)}removeGuideLines(){return this._renderer.getMainRenderer().getInteractive().guideLine.removeGuideLine()}showLoading(e="loading..."){const t=this._renderer.getMainRenderer().getActivePageWidget();return null==t?void 0:t.showLoading(e)}hideLoading(){const e=this._renderer.getMainRenderer().getActivePageWidget();null==e||e.hideLoading()}switchImage(e,t){const i=this._renderer.getMainRenderer().getActivePageWidget();null==i||i.updateBackgroundImage({...t})}_renderHoverImageForFill(e,t,i){const s=this.getPageBgImageNode(e,i),n=this.getPageNode(e,i);if(s||!n)return;const a=this._renderer.getMainRenderer().getPageWidgetById(e);if(!a)return;const o={path:t.url,type:t.type},h=this.calBgImageLayout(e,t);return h?(i?Y.e.render(n,{...(0,ce.Vf)(e,r.Wq.PAGE),url:t.url,...h,...(0,ie.p)(h)}):a.renderBackgroundImage({...(0,ce.Vf)(e,r.Wq.PAGE),type:r.F5.IMAGE,src:o,layout:h},!0),h):void 0}_renderHoverImageForReplace(e,t,i){var r;const s=this.getPageBgImageNode(e,i),n=null===(r=this._renderer.model.getPageById(e))||void 0===r?void 0:r.background.image;if(!s||!n)return;const{attrs:a}=s;if(a.lastAttrs)return;const o=this._renderer.getMainRenderer().getPageWidgetById(e);if(!o)return;const h={...a},d={path:t.url,type:t.type},c=this.calBgImageLayout(e,t);if(c){s.setAttrs({lastAttrs:h,...c,...(0,ie.p)(c),id:a.id,type:a.type});const e=z.Z.transformFilters(n.filter),r=(null!=e?e:[]).reduce(((e,t)=>({...e,[t.key]:t.value})),{}),{effectFilters:l}=n;i?Y.e.replace(s,{src:{path:t.url,type:t.type},pixels:o.props.pixels,zoom:o.props.zoom}):o.updateBackgroundImage({src:d,layout:c,filter:r,effectFilters:null!=l?l:[],aiTool:void 0,replacePalette:void 0,isFlipHorizontal:void 0,isFlipVertical:void 0})}return c}_removeHoverImageForFill(e,t){const i=this._renderer.getMainRenderer().getPageWidgetById(e);if(i)if(t){this.getPageBgImageNode(e,t).destroy()}else i.removeHoverBgImage()}_removeHoverImageForReplace(e,t){const i=this.getPageBgImageNode(e,t);if(!i)return;const{attrs:r}=i;r.lastAttrs&&i.setAttrs({...r.lastAttrs,lastAttrs:void 0})}}var ve=i(79399),xe=i(99130);let we=null;const Ie=(e,t,i,r)=>{const s=(()=>{const{document:e}=se.Z.getGlobalVars();return we||(we=e.createElement("canvas"),we)})().getContext("2d");null==s||s.save(),null==s||s.transform(...r);const n=null==s?void 0:s.isPointInPath(e,t,i);return null==s||s.restore(),n},Pe={x:0,y:0,width:3600,height:1200,scale:{x:1,y:1},rotation:0};class Ce{constructor(e){this._accessor=e}handleScaling(e,t,i){var r;const s=this._accessor.getGridNode(e),n=null!=i?i:this._calGridLayout(e),a=this._accessor.getGridLayer(e);if(!n||!s||!a)return;const{width:o,height:h}=n;s.setAttrs({...n}),null===(r=s.children)||void 0===r||r[0].setAttrs({width:o,height:h}),this._handleGridAreaScaling(e,n,a.spacing,a.radius,t)}handleSpacing(e,t){const i=this._accessor.getGridLayer(e),r=this._calGridLayout(e);if(!r||!i)return;this._handleGridAreaScaling(e,r,t,i.radius);const s=this._accessor.getGridWidget(e);null==s||s.changeSpace()}handleRadius(e,t){var i;const r=this._accessor.getGridNode(e),s=this._accessor.getGridLayer(e),n=this._calGridLayout(e);if(!r||!s||!n)return;const a=null==r||null===(i=r.children)||void 0===i?void 0:i.slice(1),{width:o,height:h}=n,{devicePixelRatio:d}=se.Z.getGlobalVars(),{areas:c,points:l,spacing:g}=s,u=V.U.calGridAreaLayouts({width:o,height:h,areas:c,points:l,spacing:g,radius:t*d});a.length&&u&&a.forEach((e=>{const{areaId:t}=e.attrs,i=u.find((e=>e.id===t));i&&(e.setPath(new Path2D(i.path)),e.setAttrs({clipPath:new Path2D(i.path)}))}))}calScaling(e,t,i){var r;const s=null!=i?i:this._calGridLayout(e),n=this._accessor.getGridLayer(e),a=this._accessor.getGridWidget(e);if(!s||!a||!n)return;const{points:o,areas:h,spacing:d,radius:c,layout:l}=n,{devicePixelRatio:g}=se.Z.getGlobalVars(),u=V.U.calGridScaling({rect:s,oldRect:{width:l.width*l.scale.x,height:l.height*l.scale.y,scale:{x:1,y:1}},points:o,areas:h,spacing:d,radius:c,anchor:t,dpr:g});return u?{...u,items:null===(r=u.items)||void 0===r?void 0:r.map((e=>({id:e.id,fillLayout:e.fillLayout})))}:void 0}calSpacing(e,t){var i;const r=this._calGridLayout(e),s=this._accessor.getGridLayer(e),n=this._accessor.getGridWidget(e);if(!r||!n||!s)return;const{points:a,areas:o,radius:h,layout:d}=s,{devicePixelRatio:c}=se.Z.getGlobalVars(),l=V.U.calGridScaling({rect:r,oldRect:{width:d.width*d.scale.x,height:d.height*d.scale.y,scale:{x:1,y:1}},points:a,areas:o,spacing:t,oldSpacing:s.spacing,radius:h,dpr:c});return l&&l?{spacing:t,items:null===(i=l.items)||void 0===i?void 0:i.map((e=>({id:e.id,fillLayout:e.fillLayout})))}:void 0}_calGridLayout(e){const t=this._accessor.getGridNode(e);if(!t)return;return{width:t.width()*t.scaleX(),height:t.height()*t.scaleY(),scale:{x:1,y:1}}}_handleGridAreaScaling(e,t,i,r,s){var n;const a=this._accessor.getGridNode(e),o=null==a||null===(n=a.children)||void 0===n?void 0:n.slice(1),h=this._accessor.getGridLayer(e);if(!o||!h)return;const{layout:d,points:c,areas:l}=h,{devicePixelRatio:g}=se.Z.getGlobalVars(),u=V.U.calGridScaling({rect:t,spacing:i,oldSpacing:h.spacing,radius:r,anchor:s,oldRect:{width:d.width*d.scale.x,height:d.height*d.scale.y,scale:{x:1,y:1}},points:c,areas:l,dpr:g});if(null==u||!u.items)return;const{items:f}=u;o.forEach((t=>{const{areaId:i}=t.attrs,r=f.find((e=>e.id===i));r&&(t.setPath(new Path2D(r.path)),t.setAttrs({...r.layout,clipPath:new Path2D(r.path)}),this._handleImageScaling(e,i,r.fillLayout),this._handleDefaultImageScaling(e,i,r))}))}_handleImageScaling(e,t,i){const r=this._accessor.getSelectImageNodeById(e,t),s=this._accessor.getSelectImageById(e,t);if(!i||!r||!s)return;const n={...s.layout,...i};r.setAttrs({...n,...(0,ie.p)(n)})}_handleDefaultImageScaling(e,t,i){const s=this._accessor.getSelectImageNodeById(e,t),n=this._accessor.getSelectAreaById(e,t);if(!n||!s)return;const{fill:a}=n;if(a.fillType===r.kl.NONE){const{layout:e,path:t}=i,{width:r,height:n}=e,a=V.U.calImageLayoutToFillContainer({width:r,height:n,path:t},{...Pe});s.setAttrs({...a,...(0,ie.p)(a)})}}}var Me=i(42476);class Se extends C{constructor(e){super(e),this._loadingWidgets=new Map,this._transform=new Ce(this)}getGridWidget(e){return this._renderer.getMainRenderer().getMaterialWidget(e)}getGridLayer(e){return this._renderer.model.getLayerById(e)||void 0}getSelectAreaById(e,t){const i=this.getGridLayer(e);if(null==i||!i.areas)return;return i.areas.find((e=>e.id===t))}getSelectAreaByIndex(e,t){const i=this.getGridLayer(e);if(null==i||!i.areas)return;return i.areas[t]}getSelectImageByIndex(e,t){if(void 0===t)return;const i=this.getSelectAreaByIndex(e,t);return i&&i.fill.fillType===r.kl.IMAGE?i.fill.image:void 0}getSelectImageById(e,t){const i=this.getSelectAreaById(e,t);if(i)return i.fill.fillType===r.kl.IMAGE?i.fill.image:void 0}getGridNode(e){return this._getNode(e)}getSelectAreaNodeByIndex(e,t){var i;const r=this.getGridNode(e);return null==r||null===(i=r.children)||void 0===i?void 0:i[Number(t)+1]}getSelectAreaNodeById(e,t){var i;const r=this.getGridNode(e);return null==r||null===(i=r.children)||void 0===i?void 0:i.find((e=>e.attrs.areaId===t))}getSelectImageNodeByIndex(e,t){var i;const r=this.getSelectAreaNodeByIndex(e,t);if(!r)return;return null===(i=r.children)||void 0===i?void 0:i[0]}getSelectImageNodeById(e,t){var i;const r=this.getSelectAreaNodeById(e,t);if(!r)return;return null===(i=r.children)||void 0===i?void 0:i[0]}getSelectedAreaIndex(e){const t=this.getGridWidget(e);return null==t?void 0:t.getSelectedAreaIndex()}setSelectedAreaIndex(e,t){const i=this.getGridWidget(e);if(!i)return r.q6;const s=this.getGridAreaByPoint(t);if(!s)return i.setSelectedAreaIndex(r.q6),i.getSelectedAreaIndex();const{id:n,index:a}=s;return"number"==typeof a&&e===n?i.setSelectedAreaIndex(a):i.setSelectedAreaIndex(r.q6),i.getSelectedAreaIndex()}clearSelectedAreaIndex(e){const t=this.getGridWidget(e);if(!t)return r.q6;t.setSelectedAreaIndex(r.q6)}getGridAreaIdByIndex(e,t){const i=this.getSelectAreaByIndex(e,t);return null==i?void 0:i.id}getGridByPoint(e,t){const{x:i,y:s}=e;let n;n=t?this._renderer.getFeatureRenderer().getLayer().getIntersection({x:i,y:s}):this._renderer.getMainRenderer().getLayer().getIntersection({x:i,y:s});const a=z.Z.getRenderLayerUtil(r.Wq.GRID);if(n&&a.isGridArea(n))return{id:a.getId(n)||"",index:a.getAreaIndex(n),areaId:a.getAreaId(n)}}getGridAreaByPoint(e,t){var i;const r=this.getGridByPoint(e,t);if(!r)return;const s=this.getGridNode(r.id);if(!s)return;const n=null===(i=s.children)||void 0===i?void 0:i.filter((e=>e instanceof xe.R));if(null==n||!n.length)return;const{x:a,y:o}=e,h=n.find((t=>{const i=(0,w.QO)(t);if(!(0,w.Ag)(e,i))return!1;const r=t.clipPath,s=t.getAbsoluteTransform().getMatrix();return Ie(r,a,o,s)}));return h?{id:r.id,index:h.attrs.index,areaId:h.attrs.areaId}:void 0}setImageFiltersByIndex(e,t,i){var r,s;const n={...null!==(r=null===(s=this.getSelectImageByIndex(e,t))||void 0===s?void 0:s.filter)&&void 0!==r?r:{}};i.forEach((e=>{Object.assign(n,{[e.key]:e.value})}));const a=this._renderer.getMainRenderer().getMaterialWidget(e);if(!a)return;const o=this.getGridAreaIdByIndex(e,t);void 0!==o&&a.updateNode(o,{filter:n})}getImageFiltersByIndex(e,t){const i=this.getSelectImageByIndex(e,t),r={};if(i){var s;const{tool:e}=$.default.model;Object.keys(null!==(s=i.filter)&&void 0!==s?s:{}).reduce(((t,r)=>{var s,n;let a=null!==(s=null===(n=i.filter)||void 0===n?void 0:n[r])&&void 0!==s?s:0;return"function"==typeof e[r]&&(a=e[r](a)),t[r]=a,t}),r)}return r}getImageEffectFiltersByIndex(e,t){var i;const r=this.getSelectImageByIndex(e,t);return null!==(i=null==r?void 0:r.effectFilters)&&void 0!==i?i:[]}setImageEffectFiltersByIndex(e,t,i){const r=this._renderer.getMainRenderer().getMaterialWidget(e);if(!r)return;const s=this.getGridAreaIdByIndex(e,t);"number"==typeof s&&r.updateNode(s,{effectFilters:i})}getImagePostProcessEffectsByIndex(e,t){var i;const r=this.getSelectImageByIndex(e,t);return null!==(i=null==r?void 0:r.postProcessEffects)&&void 0!==i?i:[]}setImagePostProcessEffects(e,t,i){const r=this._renderer.getMainRenderer().getMaterialWidget(e);if(!r)return;const s=this.getGridAreaIdByIndex(e,t);"number"==typeof s&&r.updateNode(s,{postProcessEffects:i})}handleScaling(e,t,i){this._transform.handleScaling(e,t,i)}handleSpacing(e,t){this._transform.handleSpacing(e,t)}calScaling(e,t,i){return this._transform.calScaling(e,t,i)}calSpacing(e,t){return this._transform.calSpacing(e,t)}handleRadius(e,t){return this._transform.handleRadius(e,t)}renderHoverImageResource(e,t,i,r){return this._renderHoverImage(e,t,{src:{path:i.url,type:i.type}},{x:0,y:0,width:i.width,height:i.height,scale:{x:1,y:1},rotation:0},r)}renderHoverImageLayer(e,t,i){const r=this.getNodeLayer(i);if(null==r||!r.src)return;return this._renderHoverImage(e,t,r,r.layout)}calImageLayoutForFill(e,t,i,r){const s=this._getImageNode(e,t,r);if(!s)return;const{parent:n}=s;return V.U.calImageLayoutToFillContainer({width:null==n?void 0:n.attrs.width,height:null==n?void 0:n.attrs.height},i)}removeHoverImage(e,t,i){const r=this._getImageNode(e,t,i),s=this.getGridWidget(e);if(!r||!s)return;const{attrs:n}=r;if(n.lastAttrs&&(r.setAttrs({...n.lastAttrs,lastAttrs:void 0}),!i)){const i=this.getSelectImageById(e,t);if(i){const{src:e,replacePalette:r,aiTool:n}=i;s.updateNode(t,{src:e,aiTool:n,replacePalette:r})}else s.updateNode(t,{src:void 0})}}setImageLayerOpacity(e,t){const i=this._renderer.findByID(e);i&&i.setAttrs({opacity:t})}resetImageLayerOpacity(e){const t=this.getNodeLayer(e),i=this._renderer.findByID(e);i&&t&&t.layout&&i.setAttrs({opacity:t.layout.opacity})}getImageReplaceFeature(){return this._renderer.getFeatureRenderer().getFeature(ve.Z.Name)}getImageCutOutFeature(){return this._renderer.getFeatureRenderer().getFeature(Me.Z.Name)}showLoading(e,t="loading...",i){var r;if("number"!=typeof i)return;const s=this._renderer.getMainRenderer().getMaterialWidget(e);s&&this._loadingWidgets.set(e,s);const n=null===(r=this.getSelectAreaByIndex(e,i))||void 0===r?void 0:r.id;void 0!==n&&s&&s.showLoading(n,t),a.t.log("showLoading",e)}hideLoading(e,t){var i;if("number"!=typeof t)return;const r=this._loadingWidgets.get(e),s=null===(i=this.getSelectAreaByIndex(e,t))||void 0===i?void 0:i.id;return a.t.log("hideLoading",e),void 0!==s&&r?r.hideLoading(s):void 0}getLoading(e){const t=this._renderer.getMainRenderer().getMaterialWidget(e);return Boolean(null==t?void 0:t.waitingState)}switchImage(e,t,i){const r=this.getMaterialWidgetById(e),s=this.getGridAreaIdByIndex(e,i);if(r&&void 0!==s)return r.updateNode(s,{...t})}setGridLimit(e,t){const i=this.getGridWidget(e);i&&i.setGridLimit(t)}getGridLimit(e){const t=this.getGridWidget(e);if(t)return t.getGridLimit()}_getImageNode(e,t,i){return i?this._renderer.getFeatureRenderer().findByID((0,ce.ku)(e,t).id):this.getSelectImageNodeById(e,t)}_renderHoverImage(e,t,i,r,s){const n=this._getImageNode(e,t,s);if(!n)return;const{image:a,...o}=n.attrs;if(o.lastAttrs)return;const h={...o,...s?{image:a}:null},d=this.calImageLayoutForFill(e,t,r,s);if(!d)return;n.setAttrs({lastAttrs:h,...d,...(0,ie.p)(d),id:o.id,type:o.type,index:o.index,editParams:void 0,effectFilters:void 0});const c=this._renderer.getMainRenderer().getMaterialWidget(e);return c?(s?Y.e.replace(n,{src:i.src,pixels:c.props.pixels,zoom:c.props.zoom}):c.updateNode(t,{src:i.src,aiTool:i.aiTool,replacePalette:i.replacePalette,isFlipHorizontal:i.isFlipHorizontal,isFlipVertical:i.isFlipVertical}),d):void 0}}var Ee=i(97701),Ae=i(63345),Re=i(7063);const Te={stroke:Ae.Jc,strokeWidth:6};class be{constructor(e){this._highlightMap=new Map,this._config={...Te,...e}}hide(){this._highlightMap.forEach((e=>{e.hide()}))}show(){this._highlightMap.forEach((e=>{e.show()}))}has(e){return this._highlightMap.has(e)}getNodes(){const e=[];return this._highlightMap.forEach(((t,i)=>{e.push(i)})),e}add(e,t){var i;if(this.has(e))return()=>{this.remove(e)};const r=this._createHighlight(e,t);null===(i=e.parent)||void 0===i||i.add(r),this._highlightMap.set(e,r)}remove(e){var t;this.has(e)&&(null===(t=this._highlightMap.get(e))||void 0===t||t.destroy(),this._highlightMap.delete(e))}clear(){this._highlightMap.clear()}_getStrokeWidth(e,t,i){return e/(2*(t+i))}_getCreateParams(e){const{stroke:t,strokeWidth:i,dash:r}=this._config,{scaleX:s,scaleY:n,width:a,height:o,rotation:h,x:d,y:c}=e.attrs;return{scaleX:s,scaleY:n,x:d,y:c,width:a,height:o,rotation:h,stroke:t,strokeWidth:this._getStrokeWidth(i,s,n),dash:r}}_createHighlight(e,t){return Re.Z.path(null,{...this._getCreateParams(e),data:t,listening:!1,hitFunc:()=>null})}}var Ne=i(35962),De=i(60551);const Le={x:0,y:0,width:3600,height:1200,scale:{x:1,y:1},rotation:0};class ke{constructor(e){this._accessor=e}handleScaling(e,t,i,r){this._accessor.getIsSingle(e)&&(i||this._handleNonUniformScaling(e,t,{...r}))}calNonUniformScaling(e,t,i){if(!this._accessor.getIsSingle(e))return;const r=this._calImageContainerNonScaling(e,i);if(!r)return;const{width:s,height:n}=r,a={layout:r,items:[]},o=this._calItemNonScaling(e,0,t,{width:s,height:n});return o?(a.items.push({position:0,layout:{width:o.layout.width,height:o.layout.height},fillLayout:o.imageLayout}),a):a}_handleNonUniformScaling(e,t,i){var r;const s=this._accessor.getImageContainer(e),n=this._accessor.getImageContainerNode(e),a=this._calImageContainerNonScaling(e,i);if(!s||!n||!a)return;const{width:o,height:h,scale:d}=a;n.setAttrs({width:o,height:h,scaleX:d.x,scaleY:d.y}),null===(r=n.children)||void 0===r||r[0].setAttrs({width:o,height:h}),this._handleItemNonUniformScaling(e,0,t,{width:o,height:h})}_handleItemNonUniformScaling(e,t,i,r){const s=this._accessor.getSelectClipPathNode(e,t),n=this._calItemNonScaling(e,t,i,r);if(!n||!s)return;const{layout:a,imageLayout:o}=n;s.setPath(new Path2D(a.clipPath)),s.setAttrs({...a,clipPath:new Path2D(a.clipPath)}),this._handleImageNonUniformScaling(e,t,o),this._handleDefaultImageNonUniformScaling(e,t,a)}_handleImageNonUniformScaling(e,t,i){const r=this._accessor.getSelectImageNode(e,t),s=this._accessor.getSelectImage(e,t);if(!i||!s||!r)return;const n={...s.layout,...i};r.setAttrs({...n,...(0,ie.p)(n)})}_handleDefaultImageNonUniformScaling(e,t,i){const s=this._accessor.getSelectImageNode(e,t),n=this._accessor.getSelectClipPath(e,t);if(!n||!s)return;const{fill:a}=n;if(a.fillType===r.lm.IMAGE&&!a.image){const{width:e,height:t,clipPath:r}=i,n=V.U.calImageLayoutToFillContainer({width:e,height:t,path:r},{...Le});s.setAttrs({...n,...(0,ie.p)(n)})}}_calImageContainerNonScaling(e,t){const i=this._accessor.getImageContainer(e);if(!i)return;const{scale:r}=i.layout;return{...{width:t.width/r.x,height:t.height/r.y},scale:r}}_calItemNonScaling(e,t,i,r){const s=this._accessor.getImageContainer(e),n=this._accessor.getSelectClipPath(e,t);if(!n||!s)return;const a=s.layout.width,o=s.layout.height,{layout:h,path:d}=n,{width:c,height:l}=h,g=c/a,u=l/o,f=r.width*g,_=r.height*u,y={width:f,height:_,clipPath:V.U.scalePath({width:f,height:_,path:d})};return{layout:y,imageLayout:this._calImageNonScaling(e,t,i,{width:c,height:l,clipPath:d},y)}}_calImageNonScaling(e,t,i,s,n){const a=this._accessor.getSelectImage(e,t);if(!a)return;let o=De.G.RIGHT;r.XE===i&&(o=De.G.LEFT),r.Py===i&&(o=De.G.TOP),r.DA===i&&(o=De.G.BOTTOM);const h=V.U.calPathBoxLayoutOfRotation(s.width,s.height,s.clipPath,a.layout.rotation||0),d=V.U.calPathBoxLayoutOfRotation(n.width,n.height,n.clipPath,a.layout.rotation||0),c=n.width-s.width,l=n.height-s.height,{x:g=0,y:u=0,width:f=0,height:_=0,rotation:y=0}=a.layout,p={imageBox:{...(0,w.Pl)({x:g,y:u,width:f,height:_,rotation:0},y*Math.PI/180),rotation:y},pathBoxLayout:h,newPathBoxLayout:d,increase:[r.Wk,r.XE].includes(i)?c:l,parentRect:{width:s.width,height:s.height}};return V.U.calContainerNonUniformScaling(p,o)}}class Oe extends C{constructor(e){super(e),this._loadingWidgets=new Map,this._highlight=new be,this._scaling=new ke(this)}showLoading(e,t="loading...",i=0){const r=this._renderer.getMainRenderer().getMaterialWidget(e);r&&this._loadingWidgets.set(e,r),null==r||r.showLoading(i,t),a.t.log("showLoading",e)}hideLoading(e,t=0){const i=this._loadingWidgets.get(e);return a.t.log("hideLoading",e),null==i?void 0:i.hideLoading(t)}getLoading(e){const t=this._renderer.getMainRenderer().getMaterialWidget(e);return Boolean(null==t?void 0:t.waitingState)}getImageSrc(e,t){var i,r,s;const n=this._renderer.findByID(e),a=null==n||null===(i=n.children)||void 0===i?void 0:i[t],o=null==a||null===(r=a.children)||void 0===r?void 0:r[0];return null==o||null===(s=o.attrs.image)||void 0===s?void 0:s.src}isCanFillImage(e,t=0){const i=this._renderer.model.getLayerById(e);if(!i)return!1;const s=i.items[t];if(!s)return!1;const{fill:n}=s;return!!n&&n.fillType===r.lm.IMAGE}hasFillImage(e,t=0){var i;const s=this._renderer.model.getLayerById(e);if(!s||s.type!==r.F5.IMAGE_CONTAINER)return!1;const n=s.items[t];if(!n)return!1;const{fill:a}=n;return!!a&&(a.fillType===r.lm.IMAGE&&!(null===(i=a.image)||void 0===i||!i.src))}isPointInImageContainer(e,t){const{x:i,y:s}=e;let n;n=t?this._renderer.getFeatureRenderer().getLayer().getIntersection({x:i,y:s}):this._renderer.getMainRenderer().getLayer().getIntersection({x:i,y:s});const a=z.Z.getRenderLayerUtil(r.Wq.IMAGE_CONTAINER);if(n&&a.isImageContainerItem(n))return{id:a.getId(n)||"",index:a.getChildrenIndex(n)}}getImageContainerWidget(e){return this._renderer.getMainRenderer().getMaterialWidget(e)}getIsSingle(e){const t=this.getImageContainerWidget(e);if(t)return Boolean(t.isSingle);const i=this.getImageContainer(e);return!!i&&1===i.items.length}getIsSingleFillImage(e){const t=this.getImageContainerWidget(e);if(t)return Boolean(t.isSingleFillIamge);const i=this.getImageContainer(e);return!!i&&1===i.items.filter((e=>e.fill.canUpdate&&e.fill.fillType===r.lm.IMAGE)).length}getSelectIndex(e){const t=this.getImageContainerWidget(e);return null==t?void 0:t.getSelectIndex()}setSelectIndex(e,t){const i=this.getImageContainerWidget(e);if(!i)return r.ch;const s=this.isPointInImageContainerItem(t);if(!s)return i.setSelectIndex(r.ch),i.getSelectIndex();const{id:n,index:a}=s;return"number"==typeof a&&e===n?i.setSelectIndex(a):i.setSelectIndex(r.ch),i.getSelectIndex()}clearSelectIndex(e){const t=this.getImageContainerWidget(e);if(!t)return r.ch;t.setSelectIndex(r.ch)}isPointInImageContainerItem(e,t){var i;const s=this.isPointInImageContainer(e,t);if(!s)return;const n=this.getImageContainerNode(s.id);if(null==n||null===(i=n.children)||void 0===i||!i.length)return;const a=z.Z.getRenderLayerUtil(r.Wq.IMAGE_CONTAINER),{x:o,y:h}=e,d=n.children.filter((e=>e instanceof xe.R&&a.isCanUpdateItem(e)&&a.isCanFillImage(e))).find((t=>{const i=(0,w.QO)(t);if(!(0,w.Ag)(e,i))return!1;const r=t.clipPath,s=t.getAbsoluteTransform().getMatrix();return Ie(r,o,h,s)}));return d?{id:s.id,index:d.attrs.index}:void 0}renderHoverImageResource(e,t,i,r){return this._renderHoverImage(e,t,{src:{path:i.url,type:i.type}},{x:0,y:0,width:i.width,height:i.height,scale:{x:1,y:1},rotation:0},r)}renderHoverImageLayer(e,t,i){const r=this.getNodeLayer(i);if(null==r||!r.src)return;return this._renderHoverImage(e,t,r,r.layout)}renderHoverBorder(e,t){null!=e&&e.parent&&t&&(this._highlight.has(e.parent)||this._highlight.add(e.parent,V.U.scalePath({width:e.parent.width(),height:e.parent.height(),path:t})))}removeHoverImage(e,t,i){const r=this._getImageNode(e,t,i),s=this.getMaterialWidgetById(e);if(!r||!s)return;const{attrs:n}=r;if(n.lastAttrs){if(r.setAttrs({...n.lastAttrs,lastAttrs:void 0}),!i){const i=this.getSelectImage(e,t);if(i){const{src:e,replacePalette:r,aiTool:n}=i;s.updateNode(t,{src:e,aiTool:n,replacePalette:r})}else s.updateNode(t,{src:void 0})}this.removeHoverBorder(r)}}removeHoverBorder(e,t,i){if(null!=e&&e.parent&&this._highlight.remove(e.parent),t){const e=this._getImageNode(t.id,t.index,i);(null==e?void 0:e.parent)&&this._highlight.remove(e.parent)}}getImageContainer(e){return this._renderer.model.getLayerById(e)||void 0}getSelectClipPath(e,t){const i=this.getImageContainer(e);if(null==i||!i.items)return;return i.items[t]}getSelectImage(e,t=0){var i;const r=this.getSelectClipPath(e,t);if(r)return null==r||null===(i=r.fill)||void 0===i?void 0:i.image}getImageContainerNode(e){return this._getNode(e)}getSelectClipPathNode(e,t){var i;const r=this._getNode(e);return null==r||null===(i=r.children)||void 0===i?void 0:i[Number(t)+1]}getSelectImageNode(e,t){var i,r;const s=this._getNode(e);if(!s)return;const n=null===(i=s.children)||void 0===i?void 0:i[t+1];if(!n)return;return null===(r=n.children)||void 0===r?void 0:r[0]}getImageFilters(e,t){const i=this.getSelectImage(e,t),r={};if(i){var s;const{tool:e}=$.default.model;Object.keys(null!==(s=i.filter)&&void 0!==s?s:{}).reduce(((t,r)=>{var s,n;let a=null!==(s=null===(n=i.filter)||void 0===n?void 0:n[r])&&void 0!==s?s:0;return"function"==typeof e[r]&&(a=e[r](a)),t[r]=a,t}),r)}return r}getImageEffectFilters(e,t){var i;const r=this.getSelectImage(e,t);return null!==(i=null==r?void 0:r.effectFilters)&&void 0!==i?i:[]}setImageEffectFilters(e,t,i){const r=this._renderer.getMainRenderer().getMaterialWidget(e);r&&r.updateNode(t,{effectFilters:i})}getImagePostProcessEffects(e,t){var i;const r=this.getSelectImage(e,t);return null!==(i=null==r?void 0:r.postProcessEffects)&&void 0!==i?i:[]}setImagePostProcessEffects(e,t,i){const r=this._renderer.getMainRenderer().getMaterialWidget(e);r&&r.updateNode(t,{postProcessEffects:i})}calImageLayoutForFill(e,t,i,r){const s=this._getImageNode(e,t,r),n=this.getSelectClipPath(e,t);if(!s||!n)return;const{parent:a}=s,{path:o}=n;return V.U.calImageLayoutToFillContainer({width:null==a?void 0:a.attrs.width,height:null==a?void 0:a.attrs.height,path:o},i)}setImageFilters(e,t,i){var r,s;const n={...null!==(r=null===(s=this.getSelectImage(e,t))||void 0===s?void 0:s.filter)&&void 0!==r?r:{}};i.forEach((e=>{Object.assign(n,{[e.key]:e.value})}));const a=this._renderer.getMainRenderer().getMaterialWidget(e);a&&a.updateNode(t,{filter:n})}setImageLayerOpacity(e,t){const i=this._renderer.findByID(e);i&&i.setAttrs({opacity:t})}resetImageLayerOpacity(e){const t=this.getNodeLayer(e),i=this._renderer.findByID(e);i&&t&&t.layout&&i.setAttrs({opacity:t.layout.opacity})}getImageReplaceFeature(){return this._renderer.getFeatureRenderer().getFeature(Ee.Z.Name)}getImageCutOutFeature(){return this._renderer.getFeatureRenderer().getFeature(Ne.Z.Name)}handleScaling(e,t,i,r){this._scaling.handleScaling(e,t,i,r)}calNonUniformScaling(e,t,i){if(i&&[r.Py,r.DA,r.XE,r.Wk].includes(i))return this._scaling.calNonUniformScaling(e,i,t)}getClientRectRelativeToStage(e){var t;const i=this._getNode(e);var r;if(null!==(t=i.children)&&void 0!==t&&t[0])return null===(r=i.children)||void 0===r?void 0:r[0].getClientRect({relativeTo:this._renderer.stage.container})}switchImage(e,t,i=0){this.getMaterialWidgetById(e).updateNode(i,{...t})}_getImageNode(e,t,i){var s,n,a;let o;if(i)return this._renderer.getFeatureRenderer().findByID((0,ce.o7)(e,r.Wq.IMAGE_CONTAINER,t).id);if(o=this._renderer.findByID(e),null===(s=o)||void 0===s||!s.hasChildren())return;const h=null===(n=o.children)||void 0===n?void 0:n[t+1];if(null==h||!h.hasChildren())return;const d=null===(a=h.children)||void 0===a?void 0:a[0];return d||void 0}_renderHoverImage(e,t,i,r,s){var n;const a=this._getImageNode(e,t,s);if(!a)return;const{image:o,...h}=a.attrs;if(h.lastAttrs)return;const d={...h,...s?{image:o}:null},c=this.calImageLayoutForFill(e,t,r,s);if(!c)return;a.setAttrs({lastAttrs:d,...c,...(0,ie.p)(c),id:h.id,type:h.type,index:h.index,editParams:void 0,effectFilters:void 0});const l=this._renderer.getMainRenderer().getMaterialWidget(e);if(!l)return;s?Y.e.replace(a,{src:i.src,pixels:l.props.pixels,zoom:l.props.zoom}):l.updateNode(t,{src:i.src,aiTool:i.aiTool,replacePalette:i.replacePalette,isFlipHorizontal:i.isFlipHorizontal,isFlipVertical:i.isFlipVertical});const g=this.getNodeLayer(e);return this.renderHoverBorder(a,null==g||null===(n=g.items)||void 0===n?void 0:n[t].path),c}}class Be extends C{getSelectedMaterials(){var e;const{selection:t}=this._renderer.getFeatureRenderer().getInteractive();return null!==(e=null==t?void 0:t.selectedIds)&&void 0!==e?e:[]}getTopSelectedMaterials(){const e=this.getSelectedMaterials().map((e=>{var t;const i=this._getNode(e);return i?null!==(t=z.Z.getMaterialGroupId(i))&&void 0!==t?t:e:""})).filter((e=>e));return Array.from(new Set(e))}triggerMaterialsSelection(e,t){var i;null===(i=this._renderer.getFeatureRenderer().getInteractive().selection)||void 0===i||i.select(e,t)}triggerSelectionAll(){var e;const t=this._renderer.getMainRenderer().getAllPages(),i=new Set;t.forEach((e=>{z.Z.findMaterials(e,[r.Wq.PAGE]).filter((e=>!this._renderer.accessors.layer.isLocked([e.id()]))).forEach((e=>{i.add(e.id())}))}));null===(e=this._renderer.getFeatureRenderer().getInteractive().selection)||void 0===e||e.select(Array.from(i))}hover(e){var t;return null===(t=this._renderer.getFeatureRenderer().getInteractive().hover)||void 0===t?void 0:t.hover(e)}unHover(e){var t;return null===(t=this._renderer.getFeatureRenderer().getInteractive().hover)||void 0===t?void 0:t.unHover(e)}}var Fe,Ge=i(33955),We=i(2322),He=i(37145),Ue=i(38530);class ze{constructor(e){this._renderer=e}get mainRenderer(){return this._renderer.getMainRenderer()}async exportLayerImage(e,t){var i;const s=await this._getLayerReadyForPreview(e),n=1/(null!==(i=null==s?void 0:s.getAbsoluteScale().x)&&void 0!==i?i:1);if(s)return null==s?void 0:s.toDataURL({mimeType:r.HY.PNG,quality:1,pixelRatio:null!=t?t:n});const a=this._renderer.accessors.layer.getLayerById(e);if(a){return(await this.exportOfflineLayerCanvas(a)).toDataURL(r.HY.PNG,1)}}async exportLayerCanvas(e,t){const i=await this._getLayerReadyForPreview(e);return null==i?void 0:i.toCanvas({quality:1,pixelRatio:null!=t?t:1})}async exportPageBgImage(e,t){const i=await this._getPageBgReadyForPreview(e),s=1/((null==i?void 0:i.getAbsoluteScale().x)||1);return null==i?void 0:i.toDataURL({mimeType:r.HY.PNG,quality:1,pixelRatio:null!=t?t:s})}async exportPageBgCanvas(e,t){const i=await this._getPageBgReadyForPreview(e);return null==i?void 0:i.toCanvas({pixelRatio:null!=t?t:1})}getPaletteByElement(e){return this._renderer.getColorMatcher().getPaletteByElement(e)}async exportOfflineLayerCanvas(e,t){const{document:i}=se.Z.getGlobalVars(),s=i.createElement("div"),{width:n,height:a,scale:o}=e.layout,h=n*o.x,d=a*o.y,c=new p.Hf({container:s,width:h,height:d,scaleX:1,scaleY:1}),l=Re.Z.layer(c,{}),g=this._renderer.getMainRenderer().getRenderCore(),u=new We.G({});return g.buildMaterial({parent:u,layer:{...e,id:(0,A.V)(),layout:{...e.layout,x:0,y:0,rotation:0}},pixels:h*d,zoom:this._renderer.getMainRenderer().getZoom(),dimension:{width:h,height:d,unit:r.fb.PX}}),g.renderWidgetTree(u,l),await(null==u?void 0:u.onReady()),await new Promise((e=>{requestAnimationFrame(e)})),c.toCanvas({quality:1,pixelRatio:null!=t?t:1})}async createOfflineStage(e){const t={scale:1,suffix:(0,A.V)(),...e},i=this._modifyPageIds(t.page,t.suffix),{width:r,height:s}=(0,K.Ln)(i.dimension),{document:n}=se.Z.getGlobalVars(),a=n.createElement("div"),o=new p.Hf({container:a,width:r*t.scale,height:s*t.scale,scaleX:t.scale,scaleY:t.scale}),h=Re.Z.layer(o,{}),d=this._renderer.getMainRenderer().getRenderCore(),c={x:t.scale,y:t.scale},l=d.buildWidgetTree({pages:[i],pixels:this.mainRenderer.getPixel(c),zoom:{x:1,y:1}});return d.renderWidgetTree(l,h),await(null==l?void 0:l.onReady()),await new Promise((e=>{requestAnimationFrame(e)})),{stage:o,rootWidget:l}}async addEffectTextCanvas(e,t){const i=(0,Ue.m)(t,!0);return await E.ZP.addEffectText(e,i)}async updateEffectTextCanvas(e,t){const i=(0,Ue.m)(t,!0);return await E.ZP.updateEffectText(e,i)}_modifyPageIds(e,t){return(0,Ge.U)(e,(i=>{i.id=`${e.id}-${t}`,this._modifyAllLayersIds(i.layers,t)}))}_modifyAllLayersIds(e,t){e.forEach((e=>{if(e.id=`${e.id}-${t}`,e.type===r.F5.GROUP_LAYER){const{children:i}=e;this._modifyAllLayersIds(i,t)}}))}async _getLayerReadyForPreview(e){const t=this._renderer.getMainRenderer().getMaterialWidget(e);try{await(null==t?void 0:t.onReady())}catch(r){}const i=new Promise((e=>requestAnimationFrame((()=>e()))));await i;return this._renderer.findByID(e)}async _getPageBgReadyForPreview(e){const t=this._renderer.getMainRenderer().getPageWidgetById(e);if(!(t instanceof He.C))return;try{await(null==t?void 0:t.onReady())}catch(h){}const i=this._renderer.findByID(e);if(!i)return;const{type:s}=(0,ce.Vf)(i.id(),r.Wq.PAGE),{type:n}=(0,ce.Qb)(i.id(),r.Wq.PAGE),a=i.getChildren().find((e=>e.attrs.type===s)),o=i.getChildren().find((e=>e.attrs.type===n));return null!=a?a:o}}class je extends C{constructor(){super(...arguments),this.export=new ze(this._renderer)}getModelPages(){return this._renderer.model.pages}getPagePixel(){return this._renderer.getMainRenderer().getPixel()}autoColor(){return this._renderer.getColorMatcher().autoColor()}applyPalettes(e){return this._renderer.getColorMatcher().applyPalettes(e)}applyStyle(e,t,i){return this._renderer.getColorMatcher().applyStyle(e,t,i)}applyFonts(e){return this._renderer.getColorMatcher().applyFonts(e)}recommendPalette(e){return this._renderer.getColorMatcher().recommendPalette(e)}getPaletteByElement(e){return this._renderer.getColorMatcher().getPaletteByElement(e)}setVisible(e){if(this._renderer.stateManager.setIsVisible(e),e)return this._renderer.renderForce()}matchSvgImageColor(e,t,i){return this._renderer.getColorMatcher().matchSvgImageColor(e,t,i)}}g.U.delegates(je.prototype,"export",{createOfflineStage:g.s.METHOD,exportOfflineLayerCanvas:g.s.METHOD,exportLayerImage:g.s.METHOD,exportPageBgImage:g.s.METHOD,exportLayerCanvas:g.s.METHOD,exportPageBgCanvas:g.s.METHOD,getPaletteByElement:g.s.METHOD,addEffectTextCanvas:g.s.METHOD,updateEffectTextCanvas:g.s.METHOD}),function(e){e.SELECTION="selection",e.LAYER="layer",e.TEXT="text",e.IMAGE="image",e.SHAPE="shape",e.LINE="line",e.PAGE="page",e.IMAGECONTAINER="imageContainer",e.STAGE="stage",e.GRID="grid"}(Fe||(Fe={}));var Ze=i(59238),$e=i(6430);const qe=[0,15,30,45,60,75,90,105,120,135,150,165],Xe=e=>`resize-cursor_${e}`,Ke=[0,15,30,45,60,75,90,105,120,135,150,165,180,195,210,225,240,255,270,285,300,315,330,345],Ve=e=>`rotate-cursor_${e}`;class Ye{constructor(e){this.useRotateCursor=(e=0)=>{this._showRotateCursor(e)},this.useResizeCursor=(e=0)=>{this._showResizeCursor(e)},this.useDefaultCursor=()=>{this._showDefaultCursor()},this.useMoveCursor=()=>{this._showMoveCursor()},this.useGrabCursor=()=>{this._showGrabCursor()},this.useGrabbingCursor=()=>{this._showGrabbingCursor()},this.useNsResizeCursor=()=>{this._showNsResizeCursor()},this.useEwResizeCursor=()=>{this._showEwResizeCursor()},this.useVerticalDragDeleteCursor=()=>{this._showVerticalDragDeleteCursor()},this.useHorizontalDragDeleteCursor=()=>{this._showHorizontalDragDeleteCursor()},this.destroy=()=>{},this._showHorizontalDragDeleteCursor=()=>{this._setClassName("horizontal-drag-delete-cursor")},this._showVerticalDragDeleteCursor=()=>{this._setClassName("vertical-drag-delete-cursor")},this._showRotateCursor=e=>{this._setClassName((e=>{const t=e,i=Ke.map((e=>Number(e)));return i.indexOf(t)>=0?Ve(t):Ve(i.find((e=>Math.abs(e-t)<7.5))||0)})(e))},this._showResizeCursor=e=>{this._setClassName((e=>{const t=(e+180)%180,i=qe.map((e=>Number(e)));return i.indexOf(t)>=0?Xe(t):Xe(i.find((e=>Math.abs(e-t)<7.5))||0)})(e))},this._showMoveCursor=()=>{this._setClassName("move-cursor")},this._showGrabCursor=()=>{this._setClassName("grab-cursor")},this._showGrabbingCursor=()=>{this._setClassName("grabbing-cursor")},this._showNsResizeCursor=()=>{this._setClassName("ns-resize-cursor")},this._showEwResizeCursor=()=>{this._setClassName("ew-resize-cursor")},this._showDefaultCursor=()=>{this._resetClassName()},this._setClassName=e=>{this._container.className=`${this._originClassName} ${e}`},this._resetClassName=()=>{this._container.className=this._originClassName};const{container:t}=e;if(!t)throw new Error("Cursor not found container");this._container=t,this._originClassName=this._container.className}}var Qe,Je,et=i(67162),tt=i(55900),it=i(15516),rt=i(56378);!function(e){e.fadeIn="fadeIn"}(Qe||(Qe={})),function(e){e.fadeOut="fadeOut"}(Je||(Je={}));class st{constructor(e,t){var i,r;this._renderSdk=e,this._activeId="",this._cache=new Map,this._activePageSwitchedEmitter=new tt.j,this._pagePositionUpdatedEmitter=new tt.j,this.getActivePageRect=()=>{const e=this.getActivePage();return null==e?void 0:e.findOne(`.${it.ID}`)},this.onActivePageSwitched=this._activePageSwitchedEmitter.event,this.onPagePositionUpdated=this._pagePositionUpdatedEmitter.event,this._activeId=null!==(i=null===(r=e.model.pages)||void 0===r||null===(r=r[0])||void 0===r?void 0:r.id)&&void 0!==i?i:"",t&&this._renderSdk.model.getPageById(t)&&(this.setActivePageId(t),this._activePageSwitchedEmitter.fire({from:"",to:t}))}get model(){return this._renderSdk.model}getPageIndexById(e){return this._renderSdk.stateManager.getPageIndexById(e)}setActivePageId(e){this._activeId=e}getActivePageId(){return this._activeId}getActivePageIndex(){return this.model.pages.findIndex((e=>e.id===this._activeId))}getAllPages(){return this.model.pages.map(((e,t)=>{var i;return{name:`Page ${t}`,id:e.id,title:null!==(i=e.title)&&void 0!==i?i:"",background:e.background}}))}getActivePage(){return this._renderSdk.getMainRenderer().getPage(this.getActivePageId())}getPagePosition(){return this.getActivePage().getAbsolutePosition()}cache(e,t){this._cache.set(e,t)}clearCache(e){this._cache.delete(e)}switchPageIfNecessary(e){if(0===this._renderSdk.model.pageCount)return;0===this._renderSdk.stateManager.getPages().length&&this._renderSdk.model.pageCount>0&&(this._activeId=this._renderSdk.model.pages[0].id);const{mutations:t}=e;let i="";t.forEach((e=>{const{pageId:t,position:r}=e.getMutationSideEffect();t&&t!==this.getActivePageId()&&this.clearCache(t),void 0!==r&&this._pagePositionUpdatedEmitter.fire(),t&&t!==this.getActivePageId()&&this._renderSdk.model.getPageById(t)&&(i=t)}));const s=t.map((e=>e.getMutationSideEffect())).map((e=>e.pageId)).filter((e=>e));if(i&&1===new Set(s).size)this.switchPage(this.getActivePageId(),i);else{if(e.commandType===r.wI.UNDO)return e.actionType!==r.Us.RemovePageAction&&e.actionType!==r.Us.MultiAction||e.mutations.forEach((e=>{if(e.type===r.x1.ADD_PAGE){const{pageId:t}=e.getMutationSideEffect();return this.switchPage(this.getActivePageId(),t),!0}})),e.actionType!==r.Us.AddPageAction&&e.actionType!==r.Us.MultiAction||e.mutations.forEach((e=>{if(e.type===r.x1.REMOVE_PAGE){const{pageId:t}=e.getMutationSideEffect(),i=this._renderSdk.stateManager.getPageIndexById(t);let r=this.model.pages[i];return r||(r=this.model.pages[i-1]),this.switchPage(this.getActivePageId(),r.id),!0}})),!1;if(e.actionType===r.Us.AddPageAction||e.actionType===r.Us.MultiAction){let t="";if(e.mutations.forEach((e=>{e.type===r.x1.ADD_PAGE&&(t=e.getMutationSideEffect().pageId)})),t)return this.switchPage(this.getActivePageId(),t),!0}if(e.actionType===r.Us.RemovePageAction||e.actionType===r.Us.MultiAction){let t=!1;if(e.mutations.forEach((e=>{e.type===r.x1.REMOVE_PAGE&&(t=!0)})),!t)return!1;const i=this._renderSdk.stateManager.getPageIndexById(this.getActivePageId());let s=this.model.pages[i];return s||(s=this.model.pages[i-1]),this.switchPage(this.getActivePageId(),s.id),!0}}}switchPage(e,t,i){const r=this._renderSdk.getMainRenderer();this._renderSdk.getFeatureRenderer().resetSelection(),r.removePage(e),this.setActivePageId(t),rt.Z.evictAllCache(),this._renderSdk.stage.updated(),null!=i&&i.leave||this._renderSdk.stage.fitToWindow(),r.renderForce();const s=this.getActivePage();if((null==i?void 0:i.leave)===Je.fadeOut){s.opacity(0);new p.kX({node:s,duration:.8,opacity:1}).play()}Ze.U.init(),ue.s.update(),this._activePageSwitchedEmitter.fire({from:e,to:t})}}class nt{constructor(){this._pages=[],this.isVisible=!0}updatePages(e){this._pages=e.map((e=>e.id))}getPages(){return this._pages}getPageIndexById(e){return this._pages.findIndex((t=>t===e))}getBleedArea(){return this._bleedArea}setBleedArea(e){this._bleedArea=e}clearBleedArea(){this._bleedArea=void 0}setIsVisible(e){this.isVisible=e}}class at{constructor(e){this._disposableStore=new ae.S,this._onMaterialCropStart=new tt.j,this._onMaterialCropEnd=new tt.j,this._onMaterialReplaceStart=new tt.j,this._onMaterialReplaceEnd=new tt.j,this._onMaterialSelect=e=>{var t,i;const{selectedList:r}=e;if(1!==r.length)return;const[s]=r,n=null!==(t=null===(i=s.subMaterial)||void 0===i?void 0:i.id)&&void 0!==t?t:s.id;this._disposableStore.add(this.accessors.layer.onCropStart(n,(()=>{this._onMaterialCropStart.fire()}))),this._disposableStore.add(this.accessors.layer.onCropEnd(n,(()=>{this._onMaterialCropEnd.fire()}))),this._disposableStore.add(this.accessors.layer.onReplaceStart(n,(()=>{this._onMaterialCropStart.fire()}))),this._disposableStore.add(this.accessors.layer.onReplaceEnd(n,(()=>{this._onMaterialCropEnd.fire()})))},this.accessors=e,this._initEvents()}destroy(){this._removeEvents()}onMaterialCropStart(e){return this._onMaterialCropStart.event(e)}onMaterialCropEnd(e){return this._onMaterialCropEnd.event(e)}onMaterialReplaceStart(e){return this._onMaterialReplaceStart.event(e)}onMaterialReplaceEnd(e){return this._onMaterialReplaceEnd.event(e)}_initEvents(){this._disposableStore.add(s.Z.interact.onMaterialSelect.event(this._onMaterialSelect))}_removeEvents(){this._disposableStore.clear()}}function ot(e){return new Proxy({value:!1},{set:(t,i,r)=>(t[i]=r,e(),!0)})}class ht{constructor(e){this._disposableStore=new ae.S,this._validation=()=>{this._selectionValidation(),this._hoverValidation(),this._rulerValidation()},this._onMaterialCropStart=()=>{this._isCroppingMode.value=!0},this._onMaterialCropEnd=()=>{this._isCroppingMode.value=!1},this._onMaterialReplaceStart=()=>{this._isReplacingMode.value=!0},this._onMaterialReplaceEnd=()=>{this._isReplacingMode.value=!1},this._moveModeChange=e=>{this._isHandMode.value=e===r.Ll.Hand},this._editorModeChange=e=>{this._isReadOnlyMode.value=e===oe.je.readonly},this.renderSDK=e,this._editEvent=new at(e.accessors)}get selection(){return this.renderSDK.getFeatureRenderer().getInteractive().selection}get hover(){return this.renderSDK.getFeatureRenderer().getInteractive().hover}get ruler(){return this.renderSDK.getFeatureRenderer().getFeature(_e.Z.Name)}get isCroppingMode(){return this._isCroppingMode.value}get isReplacingMode(){return this._isReplacingMode.value}get isHandMode(){return this._isHandMode.value}get isReadOnlyMode(){return this._isReadOnlyMode.value}init(){this._isCroppingMode=ot(this._validation),this._isReplacingMode=ot(this._validation),this._isHandMode=ot(this._validation),this._isReadOnlyMode=ot(this._validation),this._initEvents()}destroy(){this._removeEvents()}_initEvents(){this._disposableStore.add(this._editEvent.onMaterialCropStart(this._onMaterialCropStart)),this._disposableStore.add(this._editEvent.onMaterialCropEnd(this._onMaterialCropEnd)),this._disposableStore.add(this._editEvent.onMaterialReplaceStart(this._onMaterialReplaceStart)),this._disposableStore.add(this._editEvent.onMaterialReplaceEnd(this._onMaterialReplaceEnd)),this._disposableStore.add(pt.events.interact.onMoveModeChange.event(this._moveModeChange)),this._disposableStore.add(pt.events.appLayer.onEditorModeChange.event(this._editorModeChange))}_removeEvents(){this._disposableStore.clear()}_selectionValidation(){if(this.isCroppingMode||this.isReplacingMode||this.isHandMode){var e;const t=this.isHandMode;null===(e=this.selection)||void 0===e||e.disable(t)}else{var t;null===(t=this.selection)||void 0===t||t.enable()}}_hoverValidation(){var e,t;this.isCroppingMode||this.isReplacingMode||this.isHandMode?null===(e=this.hover)||void 0===e||e.disable():null===(t=this.hover)||void 0===t||t.enable()}_rulerValidation(){this.isReadOnlyMode||this.isHandMode?this.ruler.switchStatus(r.nx.readonly):this.ruler.switchStatus(r.nx.editable)}}class dt{constructor(e){this._renderSdk=e,this._timer=null,this._isPresenting=!1,this._originScale=1,this._onFullScreenChangedEmitter=new tt.j,this._onFullscreenChange=()=>{this._isPresenting=!this._isPresenting,!this._isPresenting&&this._timer&&(this._renderSdk.stage.setZoom({scale:100*this._originScale}),this._renderSdk.stage.setCenter(),clearTimeout(this._timer)),this._onFullScreenChangedEmitter.fire({isFullScreen:this._isPresenting})},this.onFullScreenChanged=this._onFullScreenChangedEmitter.event}async autoPlay(e){const{speed:t=1.5,animation:i={duration:.8,enter:Qe.fadeIn,leave:Je.fadeOut}}=null!=e?e:{},{dom:r}=this._renderSdk.stage;this._unlistenFullscreenChange(),this._listenFullscreenChange(),this._originScale=this._renderSdk.getMainRenderer().getZoom().x,this._renderSdk.stage.setZoom({scale:100}),this._renderSdk.stage.setFitState(!1),Object.assign(null==r?void 0:r.style,{width:"100%",height:"100%"}),await(null==r?void 0:r.requestFullscreen()),this._renderSdk.stage.setCenter(),this._renderSdk.switchEditorMode(oe.je.readonly);const s=()=>{const e=this._renderSdk.getActivePageIndex();if(e>=this._renderSdk.getAllPages().length-1||!this._isPresenting)return void(this._timer&&clearTimeout(this._timer));const{id:r}=this._renderSdk.model.pages[e+1],n=this._renderSdk.getActivePage();if(i.enter!==Qe.fadeIn)this._renderSdk.switchPage(this._renderSdk.getActivePageId(),r);else{new p.kX({node:n,duration:i.duration,opacity:0,onFinish:()=>{this._renderSdk.switchPage(this._renderSdk.getActivePageId(),r,{leave:Je.fadeOut}),this._timer=setTimeout(s,1e3*t)}}).play()}};this._timer=setTimeout(s,1e3*t)}_listenFullscreenChange(){const{dom:e}=this._renderSdk.stage;e&&(e.onfullscreenchange=this._onFullscreenChange)}_unlistenFullscreenChange(){const{dom:e}=this._renderSdk.stage;e&&(e.onfullscreenchange=null)}}var ct,lt=i(6884),gt=i(79244);!function(e){e.transform="transform",e.drag="drag"}(ct||(ct={}));const ut=[I.A_.top,I.A_.bottom,I.A_.left,I.A_.right];class ft{constructor(e){this._renderSDK=e,this._exportSize={width:0,height:0},this._container=document.createElement("div"),this._stage=new p.Hf({container:this._container,width:window.innerWidth,height:window.innerHeight}),this._layer=new p.mh,this._group=new p.ZA,this._stage.add(this._layer),this._layer.add(this._group),this._cursor=new Ye({container:this._container})}get container(){return this._container}destroy(){this._cursor.destroy(),this._changeHandler=void 0,this._image=void 0,this._stage.destroy()}setSize(e,t){a.t.info("adjust","setSize",e,t);const i={width:e,height:t};if(this._stage.setSize(i),this._group.setSize(i),this._image){const e=this._getLayout(this._node,i);this._render(this._image,e)}}setExportSize(e,t){this._exportSize.width=e,this._exportSize.height=t}async setImage(e){a.t.info("adjust","setImage");const t=await(0,o.p)(e);if(t){const{canvas:e,ox:i,oy:r}=this._getAABBImage(t);this._image=e;const s=Math.min(this._stage.width()/t.width,this._stage.height()/t.height),n={x:(this._stage.width()-t.width*s)/2+i*s,y:(this._stage.height()-t.height*s)/2+r*s,width:e.width*s,height:e.height*s};this._resetLayout=n,this._render(e,n),this._saveOriginSize()}}changeHandler(e){this._changeHandler=e}transformHandler(e){this._transformHandler=e}show(){this._resetLayout=this._getCurrentLayout()}getImage(){const e=this._exportSize.width?this._exportSize.width/this._group.width():1;return this._group.toDataURL({x:0,y:0,width:this._group.width(),height:this._group.height(),pixelRatio:e})}reset(){var e;this._image&&this._resetLayout&&(this._render(this._image,this._resetLayout),null===(e=this._transformHandler)||void 0===e||e.call(this,!1))}async getBlackImage(e){const t=await(0,o.p)(e);if(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0});i.drawImage(t,0,0);const r=i.getImageData(0,0,t.width,t.height),s=r.data;for(let t=0;t<s.length;t+=4){const e=s[t+3];s[t]=e,s[t+1]=e,s[t+2]=e,s[t+3]=255}return i.putImageData(r,0,0),e.toDataURL("image/jpeg")}return""}_getCurrentLayout(){const e=this._node;if(e)return{x:e.x(),y:e.y(),width:e.width()*e.scaleX(),height:e.height()*e.scaleY(),rotation:e.rotation()}}_getLayout(e,t){var i;const r=null!==(i=this._originLayout)&&void 0!==i?i:e.getClientRect();if(this._originSize.width===t.width&&this._originSize.height===t.height)return r;const s=Math.min(t.width/(r.width+1),t.height/(r.height+1)),n=s>1?1:s,a=n*r.width,o=n*r.height,h=r.x<0?r.x:(t.width-a)*(r.x/(this._originSize.width-r.width)),d=r.y<0?r.y:(t.height-o)*(r.y/(this._originSize.height-r.height)),c={x:h,y:d,width:a,height:o};if(0===e.rotation())return c;{const t=e.width()*e.scaleX()*n,i=e.height()*e.scaleY()*n,r={x:h+a/2,y:d+o/2},s=(0,w._1)({x:t/2,y:i/2},e.rotation()*Math.PI/180,{x:0,y:0});return{x:r.x-s.x,y:r.y-s.y,width:t,height:i,rotation:e.rotation()}}}_render(e,t){var i;this._layer.removeChildren(),this._group.destroyChildren(),this._layer.add(this._group);const s=new p.Ee({image:e,x:t.x,y:t.y,width:t.width,height:t.height,rotation:null!==(i=t.rotation)&&void 0!==i?i:0,draggable:!0});this._node=s,this._group.add(s);const n=new gt.G({disableDraggable:!1,renderSDK:this._renderSDK,cursor:this._cursor,enabledAnchors:[r.nh,r.EK,r.ng,r.Z0]});n.showTransformInfo=!1,n.rotaterDirection=I.A_.top,this._layer.add(n),n.nodes([s]);const a=()=>{const e=s.getClientRect(),t=e.x+e.width/2,i=e.y+e.height/2;t<0?s.x(s.x()-t):t>this._stage.width()&&s.x(s.x()+(this._stage.width()-t)),i<0?s.y(s.y()-i):i>this._stage.height()&&s.y(s.y()+(this._stage.height()-i))},o=()=>{for(const t of ut){var e;n.rotaterDirection=t;const i=null===(e=n.findOne(`.${r.h_}`))||void 0===e?void 0:e.findOne("Rect");if(i){const e=i.getAbsolutePosition();if(e.x>0&&e.x<this._stage.width()&&e.y>0&&e.y<this._stage.height())return}}};s.on(W.Z2.dragmove,(()=>{a()})),s.on(W.Z2.transformend,(()=>{var e;a(),this._saveOriginSize(),n.nodes([s]),o(),this._changeImage(ct.transform),null===(e=this._transformHandler)||void 0===e||e.call(this,!0)})),s.on(W.Z2.dragend,(()=>{var e;o(),this._saveOriginSize(),this._changeImage(ct.drag),null===(e=this._transformHandler)||void 0===e||e.call(this,!0)})),a(),this._changeImage()}_saveOriginSize(){this._originLayout=this._getCurrentLayout(),this._originSize={width:this._stage.width(),height:this._stage.height()}}_changeImage(e){if(this._changeHandler){const t=this.getImage();this._changeHandler.call(this,t,e)}}_getAABBImage(e){const{x:t,y:i,width:r,height:s}=(0,lt.n)(e),n=document.createElement("canvas");n.width=r,n.height=s;return n.getContext("2d").drawImage(e,-t,-i),{canvas:n,ox:t,oy:i}}}var _t=function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},yt=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class pt extends n.J{constructor(e){super(),this._ticks=[],this._editorFeatureType=r.ot.Main,this._isPreview=!1,this._isRenderReady=!1,this._skipNextMutation=!1,this.waitRenderReady=async(e=!1)=>{this._setRenderReadyFlag(!1);const t=this.getActivePageId(),i=this._mainRenderer.getWidgetTree();this._isPreview||this.pageManager.cache(t,i),await this._mainRenderer.getRenderCore().onWidgetRenderReady(),e&&pt.events.stage.onFirstRenderReady.fire(void 0),this._setRenderReadyFlag(!0)},this.getWidgetTree=()=>this._mainRenderer.getWidgetTree(),this._afterPreviewModeChange=e=>{this._isPreview=e,this.renderForce(),s.Z.action.onPreviewModeChange.fire()},this.renderForce=e=>{const t=null==e?void 0:e.mutations;a.t.log("nodeCache","reflush ",t),t&&rt.Z.evictCacheByMutation(t),this.stage.updated(),this._featureRenderer.reset(),this._mainRenderer.reset(rt.Z.getAllReuseWidgetIds()),this._mainRenderer.renderForce(),this._mainRenderer.updated(),this._featureRenderer.updated(),Ze.U.init(),ue.s.update()},this._onModelChange=e=>{if(e.actionType===r.Us.ResizePageAction)this._featureRenderer.updated()},this._pageLayoutChange=()=>{this._featureRenderer.updated(),ue.s.update()},this._onActivePageSwitched=()=>{this._featureRenderer.updated()},this._viewportSizeChange=()=>{var e,t;null===(e=this.accessors.page.getScrollerFeature())||void 0===e||null===(t=e.updateDebounce)||void 0===t||t.call(e),ue.s.update()},this._loadImageContainer=()=>{(0,o.p)($e)},this._setRenderReadyFlag=e=>{const{document:t}=se.Z.getGlobalVars();t.body.setAttribute(h.B,`${e}`),this._isRenderReady=e},this.initModel(e),this.initEffect(e),this.initCanvas(e),this.initEvents(e),this.initPermission(),this._loadImageContainer(),this._editorFeatureType=e.editorFeatureType,this.renderConfig=e.renderConfig}initModel(e){this.model=e.model,this.modelEvent=e.modelEvent,this.stateManager=new nt}initEffect(e){se.Z.initGlobalVars(e.globalVars),E.ZP.initial()}initCanvas(e){var t;this.stage=new u.Z(this,e.stage),this.accessors=(t=this,{[Fe.SELECTION]:new Be(t),[Fe.LAYER]:new de(t),[Fe.TEXT]:new U(t),[Fe.IMAGE]:new J(t),[Fe.SHAPE]:new te(t),[Fe.LINE]:new ne(t),[Fe.PAGE]:new me(t),[Fe.IMAGECONTAINER]:new Oe(t),[Fe.STAGE]:new je(t),[Fe.GRID]:new Se(t)}),this.pageManager=new st(this,e.currentPageId),this.presentManager=new dt(this),this.cursor=new Ye({container:this.stage.dom}),this.renderInit=this.renderInit.bind(this),this._afterMutationRun=this._afterMutationRun.bind(this),this._mainRenderer=new f.Z(this),this._featureRenderer=new _.Z(this),this._mainRenderer.getInteractive().guideLine.initFeatureCanvasEvent(),this._colorMatcher=new et.Z(this)}initPermission(){this.permissionManager=new ht(this),this.permissionManager.init()}initEvents(e){this._register(s.Z.interact.onPageLayoutChange.event(this._pageLayoutChange)),this._register(s.Z.stage.viewportSizeChange.event(this._viewportSizeChange)),this._register(this.pageManager.onActivePageSwitched(this._onActivePageSwitched)),this._register(s.Z.action.onModelChange.event(this._onModelChange)),this.modelEvent.addListener(y.B.AFTER_MUTATION_RUN,this._afterMutationRun),this.modelEvent.addListener(y.B.MODEL_PREVIEW_STATUS_CHANGE,this._afterPreviewModeChange),e.modelInitFinish?this.renderInit():this.modelEvent.addListener(y.B.MODEL_INIT_FINISH,this.renderInit)}get isPreview(){return this._isPreview}_clearTicks(){for(;this._ticks.length;){var e;null===(e=this._ticks.shift())||void 0===e||e()}}async _afterMutationRun(e){this._preprocessing(e)||this.renderForce(e),this.stateManager.updatePages(this.model.pages),s.Z.action.onModelChange.fire(e),await this.waitRenderReady()}async renderInit(){this.stateManager.updatePages(this.model.pages),this._featureRenderer.bootstrap(),this.stage.updated(),this.stage.fitToWindow(),this.stage.preventDefaultEvent(),ue.s.init(this._mainRenderer),this.renderForce(),pt.events.interact.onModelInitFinish.fire(void 0),await this.waitRenderReady(!0)}get renderReady(){return this._isRenderReady}getColorMatcher(){return this._colorMatcher}getMainRenderer(){return this._mainRenderer}getFeatureRenderer(){return this._featureRenderer}switchEditorMode(e){this._editorMode=e,s.Z.appLayer.onEditorModeChange.fire(e)}getEditorMode(){return this._editorMode}createAdjustRender(){return new ft(this)}isEditorFeatureType(e=r.ot.Main){return this._editorFeatureType===e}isCoverEditorType(){return this.isEditorFeatureType(r.ot.CoverEditorPC)||this.isEditorFeatureType(r.ot.CoverEditorWeb)}isBatchEditorType(){return this.isEditorFeatureType(r.ot.BatchEditor)}nextTick(e){this._ticks.push(e),this._clearTicks()}destroy(){super.destroy(),this.modelEvent.removeListener(y.B.AFTER_MUTATION_RUN,this._afterMutationRun),this.modelEvent.removeListener(y.B.MODEL_INIT_FINISH,this.renderInit),this._mainRenderer.destroy(),this._featureRenderer.destroy(),this.stage.destroy()}findByID(e){return z.Z.findByID(this.stage.layer,e)}findByIDList(e){return e.reduce(((e,t)=>{const i=this.findByID(t);return i?[...e,i]:e}),[])}scale(e){this.stage.container.scale({x:e,y:e})}skipNextMutation(){this._skipNextMutation=!0}_preprocessing(e){return!this.stateManager.isVisible||(this._skipNextMutation?(this._skipNextMutation=!1,!0):((null==e?void 0:e.actionType)===r.Us.ResizePageAction&&this.stage.fitToWindow(),this.pageManager.switchPageIfNecessary(e)))}}pt.events=s.Z,_t([(0,d.ab)(),yt("design:type",Function),yt("design:paramtypes",[]),yt("design:returntype",void 0)],pt.prototype,"_clearTicks",null),_t([(0,c.f)(l.cM,"canvas_render"),yt("design:type",Function),yt("design:paramtypes",[Object]),yt("design:returntype",Promise)],pt.prototype,"_afterMutationRun",null),_t([(0,c.f)(l.lR,"first_canvas_render"),yt("design:type",Function),yt("design:paramtypes",[]),yt("design:returntype",Promise)],pt.prototype,"renderInit",null),g.U.delegates(pt.prototype,"pageManager",{onActivePageSwitched:g.s.METHOD,onPagePositionUpdated:g.s.METHOD,setActivePageId:g.s.METHOD,getActivePageId:g.s.METHOD,getActivePageIndex:g.s.METHOD,switchPage:g.s.METHOD,getAllPages:g.s.METHOD,getActivePage:g.s.METHOD,getActivePageRect:g.s.METHOD,getPagePosition:g.s.METHOD,cache:g.s.METHOD,clearCache:g.s.METHOD,switchPageIfNecessary:g.s.METHOD,getPageIndexById:g.s.METHOD}),g.U.delegates(pt.prototype,"presentManager",{autoPlay:g.s.METHOD,onFullScreenChanged:g.s.METHOD})},55160:(e,t,i)=>{"use strict";function r(e,t,i){for(;i>=360;)i-=360;for(;i<0;)i+=360;if(0===(i=Math.round(i)))return{x0:Math.round(e/2),y0:t,x1:Math.round(e/2),y1:0};if(180===i)return{x0:Math.round(e/2),y0:0,x1:Math.round(e/2),y1:t};if(90===i)return{x0:0,y0:Math.round(t/2),x1:e,y1:Math.round(t/2)};if(270===i)return{x0:e,y0:Math.round(t/2),x1:0,y1:Math.round(t/2)};const r=Math.round(180*Math.asin(e/Math.sqrt(Math.pow(e,2)+Math.pow(t,2)))/Math.PI);if(i===r)return{x0:0,y0:t,x1:e,y1:0};if(i===180-r)return{x0:0,y0:0,x1:e,y1:t};if(i===180+r)return{x0:e,y0:0,x1:0,y1:t};if(i===360-r)return{x0:e,y0:t,x1:0,y1:0};let s=0,n=0,a=0,o=0;if(i<r||i>180-r&&i<180||i>180&&i<180+r||i>360-r){const h=i*Math.PI/180,d=i<r||i>360-r?t/2:-t/2,c=Math.tan(h)*d,l=i<r||i>180-r&&i<180?e/2-c:-e/2-c,g=Math.pow(Math.sin(h),2)*l;a=c+g,o=d+g/Math.tan(h),s=-a,n=-o}if(i>r&&i<90||i>90&&i<180-r||i>180+r&&i<270||i>270&&i<360-r){const h=(90-i)*Math.PI/180,d=i>r&&i<90||i>90&&i<180-r?e/2:-e/2,c=Math.tan(h)*d,l=i>r&&i<90||i>270&&i<360-r?t/2-c:-t/2-c,g=Math.pow(Math.sin(h),2)*l;a=d+g/Math.tan(h),o=c+g,s=-a,n=-o}return s=Math.round(s+e/2),n=Math.round(t/2-n),a=Math.round(a+e/2),o=Math.round(t/2-o),{x0:s,y0:n,x1:a,y1:o}}i.d(t,{y:()=>r})},56578:(e,t,i)=>{"use strict";i.d(t,{OW:()=>a,Wr:()=>o,ZP:()=>h,rk:()=>n});var r=i(48917),s=i(58548);const n="#000000",a=1,o=0;class h extends r.pK{constructor(e,t){super(e),this._isHoverActive=!1,this._isLocked=!1,this._isPointerOver=!1,this._onMouseOver=e=>{this.isLocked||(this._isPointerOver=!0,this._hoverActive(e.evt),this._setHoverCursor())},this._onMouseOut=e=>{this.isLocked||(this._isPointerOver=!1,this._unHoverActive(e.evt),this.cursor.useDefaultCursor())},this._onDragStart=e=>{this.isLocked||(this._hoverActive(e.evt),this._setHoverCursor())},this._onDragEnd=e=>{this.isLocked||(this._isPointerOver||(this._unHoverActive(e.evt),this.cursor.useDefaultCursor()),this._onDragEndHandle())},this._onDragMove=e=>{this._hoverActive(e.evt),this._setHoverCursor(),this._onDragMoveHandle()},this._config=e,this._renderer=t,this._init(e)}get config(){return this._config}get isLocked(){return this._isLocked}get cursor(){return this._renderer.cursor}get guideLineManager(){return this._renderer.getMainRenderer().getInteractive().guideLine}get pageContainer(){return this._renderer.getMainRenderer().getPageContainer()}get pageAbsoluteRect(){return this._renderer.getFeatureRenderer().getPageAbsoluteRect()}get pageAbsoluteRectWithBleedArea(){return this._renderer.getFeatureRenderer().getPageAbsoluteRectWithBleedArea()}_hitFunc(e){(0,s.b)(e,this)}lock(){this._isLocked=!0,this.draggable(!1)}unlock(){this._isLocked=!1,this.draggable(!0)}_getXRelativePageContainer(e){const t=this.pageContainer.getAbsolutePosition(),i=this.pageContainer.getAbsoluteScale();return(e-t.x)/i.x}_getYRelativePageContainer(e){const t=this.pageContainer.getAbsolutePosition(),i=this.pageContainer.getAbsoluteScale();return(e-t.y)/i.y}_getAttrs(){const{x:e,y:t,width:i,height:r,strokeWidth:s,strokeColor:n,dash:a,dashColor:o,dashOffset:h}=this.attrs;return{x:e,y:t,width:i,height:r,strokeWidth:s,strokeColor:n,dash:a,dashColor:o,dashOffset:h,scale:this.getAbsoluteScale().x}}_moveOffset(e){const t=this.getAbsoluteScale(),i=this.pageContainer.getAbsoluteScale();if("number"==typeof e.x){const r=e.x*i.x/t.x;this.x(this.x()+Math.round(r))}if("number"==typeof e.y){const r=e.y*i.y/t.y;this.y(this.y()+Math.round(r))}}_moveToPosition(e){const t=this.getAbsoluteScale(),i=this.pageContainer.getAbsoluteScale(),r=this.pageContainer.getAbsolutePosition();if("number"==typeof e.x){const s=(r.x+e.x*i.x)/t.x;this.x(s)}if("number"==typeof e.y){const s=(r.y+e.y*i.y)/t.y;this.y(s)}}_hoverActive(e){const{hoverColor:t}=this._config;this._isHoverActive=!0,this.fire("hoverActive",{evt:e,target:this}),this.setAttrs({strokeColor:[t]})}_unHoverActive(e){const{strokeColor:t}=this._config;this._isHoverActive=!1,this.fire("unHoverActive",{evt:e,target:this}),this.setAttrs({strokeColor:t})}_init(e){var t;null!==(t=e.isLocked)&&void 0!==t&&t?this.lock():this.unlock(),this._initEventListener()}_initEventListener(){this.dragBoundFunc(this._dragBoundFuncHandle.bind(this)),this.on("mouseover",this._onMouseOver),this.on("mouseout",this._onMouseOut),this.on("dragstart",this._onDragStart),this.on("dragend",this._onDragEnd),this.on("dragmove",this._onDragMove)}}},16610:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var r=i(56578);class s extends r.ZP{_sceneFunc(e){this._drawRectGuideLine(e)}getGuideLineData(){const e=this.getAbsolutePosition(this.pageContainer),t=this.getAbsoluteScale();return{xl:this._getXRelativePageContainer(e.x),xr:this._getXRelativePageContainer(e.x+this.width()*t.x),yt:this._getYRelativePageContainer(e.y),yb:this._getYRelativePageContainer(e.y+this.height()*t.y)}}_setHoverCursor(){}_onDragMoveHandle(){}_onDragEndHandle(){}_dragBoundFuncHandle(e){return e}_drawRectGuideLine(e){const{width:t=0,height:i=0,scale:s,dash:n,dashColor:a,dashOffset:o,strokeWidth:h,strokeColor:d}=this._getAttrs(),c=(null!=h?h:r.OW)/s;if(n){const[h,d]=a||[];return e.beginPath(),e.strokeStyle=null!=h?h:r.rk,e.lineWidth=c,e.lineJoin="round",e.strokeRect(0,0,t,i),e.closePath(),e.beginPath(),e.setLineDash(n.map((e=>e/s))),e.lineDashOffset=null!=o?o:r.Wr,e.strokeStyle=null!=d?d:r.rk,e.lineJoin="round",e.strokeRect(0,0,t,i),e.closePath(),void e.fillStrokeShape(this)}const[l,g]=d||[];e.beginPath(),e.strokeStyle=null!=l?l:r.rk,e.lineWidth=g?c/2:c,e.lineJoin="round",e.strokeRect(0,0,t,i),e.closePath(),g&&(e.beginPath(),e.strokeStyle=null!=g?g:r.rk,e.lineWidth=c/2,e.lineJoin="round",e.strokeRect(c/2,c/2,t-c,i-c),e.closePath()),e.fillStrokeShape(this)}}},16179:(e,t,i)=>{"use strict";i.d(t,{s:()=>n});var r=i(16610);const s=i(8757).z_.BleedLine;class n extends r.Z{constructor(e,t){super({...e,type:s},t)}}},15095:(e,t,i)=>{"use strict";i.d(t,{O:()=>n});var r=i(16610);const s=i(8757).z_.MarginLine;class n extends r.Z{constructor(e,t){super({...e,type:s},t)}}},31091:(e,t,i)=>{"use strict";i.d(t,{E:()=>o});var r=i(56578),s=i(8757),n=i(14764);const a=s.z_.RulerLine;class o extends r.ZP{constructor(e,t){super({...e,type:a},t),this._direction=e.direction,this._outsidePageDash=e.outsidePageDash}get direction(){return this._direction}get isHoverActive(){return this._isHoverActive}hoverActive(){return this._hoverActive()}unHoverActive(){return this._unHoverActive()}_hitFunc(e){const t=this.getAbsoluteScale(),i=this.getAbsolutePosition(),r=this.width(),s=this.height(),a=this.pageAbsoluteRect;if(!a)return super._hitFunc(e);const o={x:i.x<a.x?a.x:0,y:i.y<a.y?a.y:0,width:Math.min(a.width,r),height:Math.min(a.height,s)},h=Math.max(n.Gm/t.x,o.width),d=Math.max(n.Gm/t.y,o.height),c=(h-o.width)/2,l=(d-o.height)/2;e.beginPath(),e.rect(-c+o.x,-l+o.y,h,d),e.closePath(),e.fillStrokeShape(this)}_sceneFunc(e){switch(this._direction){case s.$I.vertical:this._drawVerticalLine(e);break;case s.$I.horizontal:this._drawHorizontalLine(e)}}getGuideLineData(){const e=this.getAbsolutePosition(this.pageContainer);switch(this._direction){case s.$I.vertical:return{xl:this._getXRelativePageContainer(e.x)};case s.$I.horizontal:default:return{yt:this._getYRelativePageContainer(e.y)}}}isOutsidePageContainer(){const{direction:e}=this,t=this.pageAbsoluteRect;if(!t)return!0;const{x:i,y:r,width:n,height:a}=t;switch(e){case s.$I.vertical:const e=this.x();return e<i-1||e>i+n+1;case s.$I.horizontal:const t=this.y();return t<r-1||t>r+a+1}return!1}isOverRuler(){switch(this._direction){case s.$I.vertical:return this.x()<s.d0;case s.$I.horizontal:return this.y()<s.cM+s.d0;default:return!1}}_setHoverCursor(){switch(this._direction){case s.$I.vertical:this.cursor.useEwResizeCursor();break;case s.$I.horizontal:this.cursor.useNsResizeCursor()}}_onDragMoveHandle(){var e,t;const i=[s.ul.PAGE_MARGIN_LINE,s.ul.HORIZONTAL_LINE,s.ul.VERTICAL_LINE],r=null!==(e=this.getGuideLineData())&&void 0!==e?e:{};if(this._direction===s.$I.vertical){const[e]=this.guideLineManager.doGuideLineMeasure(r,i);if(e)return this._moveToPosition({x:e.guideLinePosition}),void this._drawMeasureGuideLine(e)}if(this._direction===s.$I.horizontal){const[e]=this.guideLineManager.doGuideLineMeasure(r,i);if(e)return this._moveToPosition({y:e.guideLinePosition}),void this._drawMeasureGuideLine(e)}null===(t=this._drawMeasureGuideLineDispose)||void 0===t||t.call(this)}_onDragEndHandle(){var e;null===(e=this._drawMeasureGuideLineDispose)||void 0===e||e.call(this)}_dragBoundFuncHandle(e){const t={...e};switch(this._direction){case s.$I.vertical:t.y=this.y();break;case s.$I.horizontal:t.x=this.x()}return t}_drawMeasureGuideLine(e){if(e.scene===s.ul.PAGE_MARGIN_LINE){const e=this.guideLineManager.getPageMargin();null==e||e.drawGuideLine(),this._drawMeasureGuideLineDispose=()=>null==e?void 0:e.removeGuideLine()}}_drawVerticalLine(e){var t;const{height:i=0,scale:n,strokeWidth:a,strokeColor:o}=this._getAttrs(),h=(null!=a?a:r.OW)/n,d=null!==(t=null==o?void 0:o[0])&&void 0!==t?t:r.rk;if(e.strokeStyle=d,e.lineWidth=h,this.isOutsidePageContainer()||!this.pageAbsoluteRect||this.isOverRuler())e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(0,0),e.lineTo(0,i),e.stroke();else{const t=Math.max(this.pageAbsoluteRect.y,s.cM+s.d0),r=this.pageAbsoluteRect.y+this.pageAbsoluteRect.height;this._isHoverActive&&(e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(0,0),e.lineTo(0,t),e.stroke()),e.beginPath(),e.setLineDash([]),e.moveTo(0,t),e.lineTo(0,r),e.stroke(),this._isHoverActive&&(e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(0,r),e.lineTo(0,i),e.stroke())}e.fillStrokeShape(this)}_drawHorizontalLine(e){var t;const{width:i=0,scale:n,strokeWidth:a,strokeColor:o}=this._getAttrs(),h=(null!=a?a:r.OW)/n,d=null!==(t=null==o?void 0:o[0])&&void 0!==t?t:r.rk;if(e.strokeStyle=d,e.lineWidth=h,this.isOutsidePageContainer()||!this.pageAbsoluteRect||this.isOverRuler())e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(0,0),e.lineTo(i,0),e.stroke();else{const t=Math.max(this.pageAbsoluteRect.x,s.d0),r=this.pageAbsoluteRect.x+this.pageAbsoluteRect.width;this._isHoverActive&&(e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(0,0),e.lineTo(t,0),e.stroke()),e.beginPath(),e.setLineDash([]),e.moveTo(t,0),e.lineTo(r,0),e.stroke(),this._isHoverActive&&(e.beginPath(),e.setLineDash(this._outsidePageDash),e.moveTo(r,0),e.lineTo(i,0),e.stroke())}e.fillStrokeShape(this)}}},52169:(e,t,i)=>{"use strict";i.d(t,{Z:()=>u});var r,s=i(63345),n=i(8757),a=i(48917),o=i(71946),h=i(25629),d=i(46436),c=i(11005);!function(e){e[e.line=0]="line",e[e.rect=1]="rect"}(r||(r={}));const l={stroke:s.Jc,strokeWidth:2,buffer:[0,0]},g=(0,c.VZ)(c.Z2.transform,c.Z2.dragmove,c.Z2.layoutupdate);class u{constructor(e,t){this._highlightMap=new Map,this._highlightDisposeMap=new Map,this._renderSDK=e,this._config={...l,...t}}hide(){this._highlightMap.forEach((({border:e})=>{null==e||e.hide()}))}show(){this._highlightMap.forEach((({border:e})=>{null==e||e.show()}))}has(e){return this._highlightMap.has(e)}getNodes(){const e=[];return this._highlightMap.forEach(((t,i)=>{e.push(i)})),e}add(e,t={}){var i;if(this.has(e))return()=>{this.remove(e)};const s=this._getHighlightStyle(e),{padding:n,stroke:a}=t;this._highlightMap.set(e,{padding:n,stroke:a});const o=null!==(i=this._config.container)&&void 0!==i?i:this._renderSDK.getFeatureRenderer().getLayer(),h=s===r.line?this._createLineHighlight(e):this._createRectHighlight(e);o.add(h);const d=this._highlightMap.get(e);this._highlightMap.set(e,{border:h,...d});const c=this._onUpdate(e);return this._highlightDisposeMap.set(e,c),c}remove(e){var t;return null===(t=this._highlightDisposeMap.get(e))||void 0===t?void 0:t()}clear(){this._highlightDisposeMap.forEach((e=>e())),this._highlightDisposeMap.clear(),this._highlightMap.clear()}_getHighlightStyle(e){return o.Z.isEqual(e,n.Wq.LINE)?r.line:r.rect}_onUpdate(e){const t=()=>{this._update(e)};e.on(g,t);const i=h.Z.interact.onPageLayoutChange.event(t);return()=>{e.off(g,t),i();const r=this._highlightMap.get(e);null!=r&&r.border&&(r.border.remove(),this._highlightMap.delete(e),this._highlightDisposeMap.delete(e))}}_getCreateParams(e){const{stroke:t,strokeWidth:i,dash:r,buffer:s}=this._config,{padding:n=0,stroke:a}=this._highlightMap.get(e)||{},{x:o,y:h}=e.getAbsoluteScale(),c=e.getAbsolutePosition(),l=e.getAbsoluteRotation(),g=o*e.width(),u=h*e.height(),{x:f,y:_}=(0,d.Di)(c.x,c.y,-n,-n,l);return{x:f,y:_,stroke:null!=a?a:t,strokeWidth:i,width:g+2*n,height:u+2*n,dash:r,buffer:s}}_createRectHighlight(e){const{x:t,y:i,stroke:r,strokeWidth:s,width:n,height:o,dash:h,buffer:d=[0,0]}=this._getCreateParams(e),[c,l]=d,g=[-c,-l,n+c,-l,n+c,o+l,-c,o+l,-c,-l];return new a.x1({x:t,y:i,points:g,stroke:r,strokeWidth:s,closed:!0,dash:h,rotation:e.getAbsoluteRotation(),hitFunc:()=>null})}_createLineHighlight(e){const{x:t,y:i,stroke:r,strokeWidth:s,width:n,height:o}=this._getCreateParams(e),h=[0,0,n,0],d=e.getAbsoluteRotation()*Math.PI/180,c=t-o*Math.sin(d)/2,l=i+o*(0===d?1:Math.sin(d)/Math.tan(d))/2;return new a.x1({x:c,y:l,points:h,stroke:r,strokeWidth:s,closed:!0,rotation:e.getAbsoluteRotation(),hitFunc:()=>null})}_updateLineHighlight(e){var t;const{x:i,y:r,width:s,height:n,strokeWidth:a}=this._getCreateParams(e),o=[0,0,s,0],h=this._highlightMap.get(e),d=e.getAbsoluteRotation()*Math.PI/180,c=i-n*Math.sin(d)/2,l=r+n*(0===d?1:Math.sin(d)/Math.tan(d))/2;null==h||null===(t=h.border)||void 0===t||t.setAttrs({x:c,y:l,points:o,strokeWidth:a,rotation:e.getAbsoluteRotation()})}_updateRectHighlight(e){var t;const{x:i,y:r,width:s,height:n,strokeWidth:a}=this._getCreateParams(e),o=[0,0,s,0,s,n,0,n,0,0],h=this._highlightMap.get(e);null==h||null===(t=h.border)||void 0===t||t.setAttrs({x:i,y:r,points:o,strokeWidth:a,rotation:e.getAbsoluteRotation()})}_update(e){this._getHighlightStyle(e)===r.line?this._updateLineHighlight(e):this._updateRectHighlight(e)}}},48737:(e,t,i)=>{"use strict";i.d(t,{A4:()=>E,A_:()=>M,YB:()=>w});var r=i(63345),s=i(11005),n=i(8757),a=i(48917);i(18571);var o=i(46436),h=i(7063),d=i(5317);class c{constructor(e){this._getPosition=e=>{const t=e.clientX+this._safeDistance,i=e.clientY+this._safeDistance,r=window.innerWidth-this._infoElement.offsetWidth-2*this._safeDistance,s=window.innerHeight-this._infoElement.offsetHeight-2*this._safeDistance;return{x:Math.max(this._safeDistance,Math.min(r,t)),y:Math.max(this._safeDistance,Math.min(s,i))}},this._safeDistance=e,this._createElement()}show(e,t){const{x:i,y:r}=this._getPosition(t);this._infoElement.textContent=e,this._infoElement.style.display="block",i&&(this._infoElement.style.left=`${i}px`),r&&(this._infoElement.style.top=`${r}px`)}hide(){this._infoElement.style.display="none"}remove(){this._infoElement.remove()}_createElement(){const{document:e}=d.Z.getGlobalVars();this._infoElement=e.createElement("div"),this._infoElement.style.position="fixed",this._infoElement.style.padding="4px 12px",this._infoElement.style.borderRadius="6px",this._infoElement.style.whiteSpace="nowrap",this._infoElement.style.lineHeight="20px",this._infoElement.style.zIndex="10",this._infoElement.style.backgroundColor=r.JZ,this._infoElement.style.color=r.f7,e.body.appendChild(this._infoElement),this.hide()}}var l=i(43382),g=i(54845),u=i(54643),f=i(22231),_=i(25629),y=i(28161);const p=[0,45,90,135,180,225,270,315],m=360,v=24,x=20,w={stroke:r.es,fill:r.y4,strokeWidth:1,shadowBlur:4,shadowOffsetX:0,shadowOffsetY:1,shadowColor:r.X2,hitStrokeWidth:0,shadowForStrokeEnabled:!1},I="custom-rotater-rect",P="custom-rotater-line",C=[n.Py,n.DA,n.XE,n.Wk,n.EK,n.ng,n.Z0,n.nh];var M;!function(e){e[e.top=1]="top",e[e.left=2]="left",e[e.right=3]="right",e[e.bottom=4]="bottom"}(M||(M={}));const S={boundBoxFunc(e,t){if(!this.resizeLimits)return t;const i=a.Core.getAngle(this.rotation()),r=(0,o.$D)(t,-i,{x:0,y:0}),{maxWidth:s=n.DW.MAX_WIDTH,maxHeight:h=n.DW.MAX_HEIGHT,minWidth:d,minHeight:c}=this.resizeLimits,{x:l,y:g}=this.getPageScale(),u=this._getNodeRect(),f=u.width/l,_=u.height/g;let y=Math.min(f,d),p=Math.min(_,c),m=Math.max(f,s),v=Math.max(_,h);const x=this.getActiveAnchor()||"";if([n.nh,n.EK,n.ng,n.Z0].includes(x)&&this.keepRatio()){const e=this.sin/this.cos;e<1?(y=p/e,v=m*e):(p=y*e,m=v/e)}const w=Math.abs(r.width),I=Math.abs(r.height),P=y*l,C=p*g,M=m*l,S=v*g;return w<P&&(x.indexOf("left")>=0&&(r.x-=P-r.width,r.width=P),x.indexOf("right")>=0&&(r.width=P)),I<C&&(x.indexOf("top")>=0&&(r.y-=C-r.height,r.height=C),x.indexOf("bottom")>=0&&(r.height=C)),w>M&&(x.indexOf("left")>=0&&(r.x+=r.width-M,r.width=M),x.indexOf("right")>=0&&(r.width=M)),I>S&&(x.indexOf("top")>=0&&(r.y+=r.height-S,r.height=S),x.indexOf("bottom")>=0&&(r.height=S)),(0,o.$D)(r,i,{x:0,y:0})},anchorDragBoundFunc(e,t){const i=this.getActiveAnchor();return n.h_===i?(this.enabledAnchors([n.h_]),t):this._firstAnchor?(this._firstAnchor===i&&(this.enabledAnchors([i]),this.setRotaterVisible(!1)),t):t}};class E extends a.$T{constructor(e){const{renderSDK:t}=e,i=t.getFeatureRenderer().getLayer();if(!i)throw new Error("Transformer: Layer not exist!");super(e),this.showTransformInfo=!0,this._lastEnableAnchor=[],this._disposeStore=new l.S,this._beforeDragAbsPosList=[],this._currentDragAbsPosList=[],this._transformNodeAttrsByDelta=(e,t)=>{const i=e.getParent().getAbsoluteTransform(),r=e.getTransform().copy();r.translate(e.offsetX(),e.offsetY());const s=new a.wx;return s.multiply(i.copy().invert()).multiply(t).multiply(i).multiply(r),s.decompose()},this._forceUpdateAnchorPos=(e,t,i)=>{let r,s,n;if(e.setAbsolutePosition(t),"rotater"===this._movingAnchorName){const t=this._getNodeRect();r=e.x()-t.width/2,s=-e.y()+t.height/2;let n=Math.atan2(-s,r)+Math.PI/2;t.height<0&&(n-=Math.PI);const h=a.Core.getAngle(this.rotation())+n,d=a.Core.getAngle(this.rotationSnapTolerance()),c=(0,o.kM)(this.rotationSnaps(),h,d)-t.rotation,l=(0,o.Pl)(t,c);return void this._fitNodesInto(l,i)}const h=this.keepRatio(),d=this.centeredScaling()||i.altKey;if("top-left"===this._movingAnchorName){if(h){const t=d?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()},i=t.x-e.x(),a=t.y-e.y();n=Math.sqrt(Math.pow(i<0?0:i,2)+Math.pow(a<0?0:a,2)),r=n*this.cos,s=n*this.sin,this.findOne(".top-left").x(t.x-r),this.findOne(".top-left").y(t.y-s)}}else if("top-center"===this._movingAnchorName)this.findOne(".top-left").y(e.y());else if("top-right"===this._movingAnchorName){if(h){const t=d?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()},i=e.x()-t.x,a=t.y-e.y();n=Math.sqrt(Math.pow(i<0?0:i,2)+Math.pow(a<0?0:a,2)),r=n*this.cos,s=n*this.sin,this.findOne(".top-right").x(t.x+r),this.findOne(".top-right").y(t.y-s)}const t=e.position();this.findOne(".top-left").y(t.y),this.findOne(".bottom-right").x(t.x)}else if("middle-left"===this._movingAnchorName)this.findOne(".top-left").x(e.x());else if("middle-right"===this._movingAnchorName)this.findOne(".bottom-right").x(e.x());else if("bottom-left"===this._movingAnchorName){if(h){const t=d?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()},i=t.x-e.x(),a=e.y()-t.y;n=Math.sqrt(Math.pow(i<0?0:i,2)+Math.pow(a<0?0:a,2)),r=n*this.cos,s=n*this.sin,e.x(t.x-r),e.y(t.y+s)}const t=e.position();this.findOne(".top-left").x(t.x),this.findOne(".bottom-right").y(t.y)}else if("bottom-center"===this._movingAnchorName)this.findOne(".bottom-right").y(e.y());else if("bottom-right"===this._movingAnchorName&&h){const t=d?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()},i=e.x()-t.x,a=e.y()-t.y;n=Math.sqrt(Math.pow(i<0?0:i,2)+Math.pow(a<0?0:a,2)),r=n*this.cos,s=n*this.sin,this.findOne(".bottom-right").x(t.x+r),this.findOne(".bottom-right").y(t.y+s)}if(this.centeredScaling()||i.altKey){const e=this.findOne(".top-left"),t=this.findOne(".bottom-right"),i=e.x(),r=e.y(),s=this.getWidth()-t.x(),n=this.getHeight()-t.y();t.move({x:-i,y:-r}),e.move({x:s,y:n})}const c=this.findOne(".top-left").getAbsolutePosition(),l=this.findOne(".bottom-right").getAbsolutePosition(),{x:g,y:u}=c,{x:f,y:_}=l;let y=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),p=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();let m=1,v=1;h&&(m=y<p?1:1/(this.sin/this.cos),v=y<p?1*this.sin/this.cos:1),r=g,s=u;const x=a.Core.getAngle(-this.rotation()),w=Math.cos(x),I=Math.tan(x),P=Math.sin(x);if(this._movingAnchorName.indexOf("left")>=0&&y<m){y=m;const e=w*(p-m*I);r=f-e*I-m/w,s=_-e}if(this._movingAnchorName.indexOf("top")>=0&&p<v)if(p=v,this.rotation()%180==0)s=_+(0===this.rotation()?-v:v);else{const e=P*(y-v/I);r=f-e/I-v/P,s=_+e}this._movingAnchorName.indexOf("right")>=0&&y<m&&(y=m),this._movingAnchorName.indexOf("bottom")>=0&&p<v&&(p=v),this._fitNodesInto({x:r,y:s,width:y,height:p,rotation:a.Core.getAngle(this.rotation())},i)},this._showMoveCursor=()=>{this.cursor.useMoveCursor(),this._cursorChange=!0},this._showDefaultCursor=()=>{this.cursor.useDefaultCursor(),this._cursorChange=!1},this._initResizeCursorListener=()=>{this.on("transform.cursor",(()=>{this.getActiveAnchor()===n.h_?this._showRotateCursor():this._showResizeCursor()})),this.on("transformend.cursor",(()=>{this._showDefaultCursor();const e=this.getActiveAnchor();this.findOne(`.${e}`).setAttrs({fill:r.y4,stroke:r.es})}))},this._removeResizeCursorListener=()=>{this.off("transformstart.cursor transformend.cursor transform.cursor")},this._initMovementListener=()=>{this.on("dragmove.movement",(()=>{this.enabledAnchors([]),this.setRotaterVisible(!1)})),this.on("dragend.movement",(()=>{this.setRotaterVisible(Boolean(this._lastRotaterVisible)),this.enabledAnchors(this._lastEnableAnchor)}))},this._initPageLayoutListener=()=>{this._disposeStore.add(_.Z.interact.onPageLayoutChange.event((()=>{const e=this.findOne(`.${n.h_}`);null==e||e.fire("mouseout")})))},this._removeMovementListener=()=>{this.off("dragmove.movement dragend.movement")},this._onHotKeys=e=>{this.onHotKeys(e)},this._shiftDragHandle=(e,t)=>{const i=this._beforeDragAbsPosList[t];if(!i)return e;const r=e.x-i.x,s=e.y-i.y,n={...e};return Math.abs(r)>Math.abs(s)?n.y=i.y:n.x=i.x,n},this._nodeDragBoundFunc=(e,t,i)=>(this._currentDragAbsPosList[t]={...e},i.shiftKey?this._shiftDragHandle(e,t):e),this._initTransformListener=()=>{this.on("transform.info",(e=>{const t=this.getActiveAnchor()===n.h_?this.getDragRotateInfo():this.getDragAnchorInfo();this.showTransformInfo&&this._transformInfo.show(t,e.evt)})),this.on("transformend.info",(()=>{this._transformInfo.hide()})),this.on("dragstart.anchor transformstart.anchor",(()=>{this._firstAnchor=this.getActiveAnchor(),this._lastEnableAnchor=this.enabledAnchors(),this._lastRotaterVisible=this.rotaterVisible})),this.on("dragend.anchor transformend.anchor",(()=>{this.setRotaterVisible(Boolean(this._lastRotaterVisible)),this.enabledAnchors(this._lastEnableAnchor)})),this.on("dragstart.move",(()=>{this._showMoveCursor();const e=this.nodes();this._beforeDragAbsPosList=e.map((e=>e.getAbsolutePosition()))})),this.on("dragend.move",(()=>{this._showDefaultCursor()}))},this._removeTransformListener=()=>{const e=(0,s.VZ)("transform.info","transformend.info","transformstart.anchor","transformend.anchor","dragend.anchor","dragstart.anchor","dragstart.move","dragend.move");this.off(e)},this._showResizeCursor=e=>{const t=e||this.getActiveAnchor(),i={[n.nh]:-45,[n.Py]:0,[n.EK]:45,[n.Wk]:90,[n.Z0]:135,[n.DA]:180,[n.ng]:-135,[n.XE]:-90};if(Object.keys(i).indexOf(t)>=0){const e=(i[t]+this.rotation())%180;this.cursor.useResizeCursor(e),this._cursorChange=!0}},this._showRotateCursor=e=>{let t=this.rotation()+180;switch(this.rotaterDirection){case M.right:t-=90;break;case M.left:t+=90;break;case M.top:t-=180}t<360&&(t=360+t),this.cursor.useRotateCursor(t%360),this._cursorChange=!0},this._config=e,this._init(i,e),this._layer=i,this._renderSDK=t,this._transformInfo=new c(20)}get cursor(){return this._config.cursor||this._renderSDK.cursor}get rotaterVisible(){return this._rotaterVisible}get isHideAnchor(){return this._isHideAnchor}get enableRotater(){return this._enableRotater}set enableRotater(e){this._enableRotater=e,this.update()}get rotaterDirection(){return this._rotaterDirection}set rotaterDirection(e){this._rotaterDirection=e,this.update()}static getTRId(e){return`${e.join("_")}__custom_transformer__`}readonly(){this.hideAnchor(),this.disableDrag()}lock(){this.hideAnchor(),this.disableDrag(),this.borderStroke(r.zL)}unlock(){var e;this.showAnchor(),this.enableDrag(),this.borderStroke(null!==(e=this._config.borderStroke)&&void 0!==e?e:r.Jc)}hideAnchor(){this._isHideAnchor=!0,this.update()}showAnchor(){this._isHideAnchor=!1,this.update()}disableDrag(){const e=this.findOne(`.${n.d7}`);e&&e.draggable(!1);const t=this.nodes();t&&t.forEach((e=>e.draggable(!1)))}enableDrag(){const e=this.findOne(`.${n.d7}`);e&&e.draggable(!0);const t=this.nodes();t&&t.forEach((e=>e.draggable(!0)))}getNodesClientRect(e){const t=this.findOne(`.${n.d7}`).getClientRect({relativeTo:e}),i=(0,g.G)(2,2);return{x:t.x+i,y:t.y+i,width:t.width-2*i,height:t.height-2*i}}select(...e){const{disableDraggable:t}=this.attrs;e.forEach((e=>e.setDraggable(!t)));const i=E.getTRId(e.map((e=>e.id())));this.id(i),this.nodes(e),this._setDragBoundFunc(e),(0,y.Z)("*",{scope:n.IB.Default,keyup:!0},this._onHotKeys)}borderDashConfig(e){this._borderDashConfig=e,this.update()}setRotaterVisible(e){this._rotaterVisible=e,this.update()}update(){var e;const t=this._getNodeRect();this.rotation(a.Zr._getRotation(t.rotation));const{width:i}=t,{height:r}=t,s=this.enabledAnchors(),o=this.resizeEnabled();[n.nh,n.EK,n.ng,n.Z0].forEach((e=>{this._batchChangeChild(`.${e}`,{x:e.indexOf("left")>=0?0:i,y:e.indexOf("bottom")>=0?r:0,visible:o&&s.indexOf(e)>=0&&!this._isHideAnchor})}));[n.Py,n.DA,n.XE,n.Wk].forEach((e=>{const t=this.findOne(`.${e}`);let n=0,a=0;e.indexOf("center")>=0&&(n=i/2),e.indexOf("right")>=0&&(n=i),e.indexOf("middle")>=0&&(a=r/2),e.indexOf("bottom")>=0&&(a=r),this._batchChangeChild(`.${e}`,{x:n,y:a,offsetX:t.width()/2,offsetY:t.height()/2,visible:o&&s.indexOf(e)>=0&&!this._isHideAnchor})}));const h={x:0,y:0},d=32.5,c={x:0,y:0,points:[0,0,0,0]};switch(this.rotaterDirection){case M.bottom:h.x=i/2,h.y=r+d,c.x=12,c.y=-20,c.points=[0,0,0,x];break;case M.right:h.x=i+d,h.y=r/2,c.x=-20,c.y=12,c.points=[0,0,x,0];break;case M.left:h.x=-32.5,h.y=r/2,c.x=v,c.y=12,c.points=[0,0,x,0];break;case M.top:h.x=i/2,h.y=-32.5,c.x=12,c.y=v,c.points=[0,0,0,x]}this._batchChangeChild(`.${n.h_}`,{...h,visible:Boolean(this.enableRotater&&this.rotaterVisible&&!this._isHideAnchor)}),this._batchChangeChild(`.${P}`,{...c,visible:this._enableRotaterLineTo}),this._batchChangeChild(`.${n.d7}`,{width:i,height:r,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),x:0,y:0,...this._borderDashConfig}),this._anchorsOverlapHandler(),null===(e=this.getLayer())||void 0===e||e.batchDraw()}unselect(){this._removeResizeCursorListener(),this._removeTransformListener(),this._removeMovementListener(),y.Z.unbind("*",this._onHotKeys),this._showDefaultCursor(),this._transformInfo.remove(),this._disposeStore.clear()}getDragRotateInfo(){const e=Math.round(this.rotation());return e>180?e-m+"\xb0":e<-180?`${e+m}\xb0`:`${e}\xb0`}getPageScale(){return this._renderSDK.accessors.page.getZoom()}getDragAnchorInfo(){var e;const t=this._renderSDK.accessors.page.getZoom(),i=t.x,r=t.x;let s=Math.round(this.width()/i),a=Math.round(this.height()/r);return(null===(e=this._renderSDK.getMainRenderer().getDimension())||void 0===e?void 0:e.unit)===n.fb.CM?(s=(0,u.$S)(s),a=(0,u.$S)(a),`${s.toFixed(2)} \xd7 ${a.toFixed(2)}`):`${s} \xd7 ${a}`}getAnchorNode(e){return e.map((e=>this.findOne(`.${e}`)))}moveLayers(e,t){const i=this.nodes()[0],r=e[i.id()];r&&i&&(r.x&&i.x(i.x()+r.x),r.y&&i.y(i.y()+r.y),"number"==typeof t&&(this.rotation(t),this.forceUpdate()),i.fire(s.Z2.layoutupdateend))}_getNodeRect(){const e=this._getNodeRectNode();if(!e)return super._getNodeRect();const t=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()});let i={x:t.x,y:t.y},r={x:t.x+t.width,y:t.y+t.height};const s=e.getAbsoluteTransform();i=s.point(i),r=s.point(r);const n=new a.wx;n.rotate(-a.Core.getAngle(this.rotation()));const{x:o,y:h}=n.point(i),{x:d,y:c}=n.point(r);n.invert();const l=n.point({x:o,y:h});return{x:l.x,y:l.y,width:d-o,height:c-h,rotation:a.Core.getAngle(this.rotation())}}_handleMouseMove(e){const t=this.findOne(`.${this._movingAnchorName}`),i=t.getStage();null==i||i.setPointersPositions(e);const r=null==i?void 0:i.getPointerPosition();let s={x:(null==r?void 0:r.x)||0-this._anchorDragOffset.x,y:(null==r?void 0:r.y)||0-this._anchorDragOffset.y};const n=t.getAbsolutePosition();this.anchorDragBoundFunc()&&(s=this.anchorDragBoundFunc()(n,s,e)),this._activeAnchorNewAbs=s,t.setAbsolutePosition(s),n.x===s.x&&n.y===s.y||this._forceUpdateAnchorPos(t,s,e)}_fitNodesInto(e,t){var i;const r=this._getNodeRect();if(this.boundBoxFunc()){const t=this.boundBoxFunc()(r,e);t?e=t:a.Zr.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const s=this._getDeltaTransform(r,e);this._nodes.forEach((e=>{var i;const r=this._transformNodeAttrsByDelta(e,s);e.setAttrs(r),this._fire("transform",{evt:t,target:e}),e._fire("transform",{evt:t,target:e}),null===(i=e.getLayer())||void 0===i||i.batchDraw()})),this.rotation(a.Zr._getRotation(e.rotation)),this._resetTransformCache(),this.update(),null===(i=this.getLayer())||void 0===i||i.batchDraw()}_createElements(){this._createBack(),C.forEach(function(e){this._createAnchor(e)}.bind(this)),this._createAnchor("rotater")}_createAnchor(e){const t=this._createAnchorByName(e);t&&(t.on("mouseenter",(()=>{this._showResizeCursor(e),t.setAttrs({fill:r.Jc,stroke:r.eT})})),t.on("mouseout",(()=>{this._transforming||(t.setAttrs({fill:r.y4,stroke:r.es}),this._showDefaultCursor())})),t.on("mousedown",(e=>{this._handleMouseDown(e)})),t.on("dragstart",(e=>{t.stopDrag(),e.cancelBubble=!0})),t.on("dragend",(e=>{e.cancelBubble=!0})),this.add(t))}_batchChangeChild(e,t){const i=this.findOne(e);null==i||i.setAttrs(t)}selectOutsideHandle(e){this._renderSDK.accessors.page.isNodeIntersectPage(e)?this.shouldOverdrawWholeArea(!1):this.shouldOverdrawWholeArea(!0)}_getDeltaTransform(e,t){const i=1e7,r=new a.wx;r.translate(e.x,e.y),r.rotate(e.rotation),r.scale(e.width/i,e.height/i);const s=new a.wx;return s.translate(t.x,t.y),s.rotate(t.rotation),s.scale(t.width/i,t.height/i),s.multiply(r.invert())}onHotKeys(e){if(!y.Z.shift)return;const t=this.nodes();"keydown"!==e.type?"keyup"===e.type&&t.forEach(((t,i)=>{const r=this._currentDragAbsPosList[i];r&&(t.setAbsolutePosition(r),t.fire(s.Z2.layoutupdate,{type:s.Z2.layoutupdate,target:t,evt:e},!1),this.update())})):t.forEach(((t,i)=>{const r=this._shiftDragHandle(t.getAbsolutePosition(),i);t.setAbsolutePosition(r),t.fire(s.Z2.layoutupdate,{type:s.Z2.layoutupdate,target:t,evt:e},!1),this.update()}))}_getNodeRectNode(){const e=this.nodes();if(1===e.length&&this._nodeRectSelector)return this._nodeRectSelector(e[0])}_createRotater(){const e=h.Z.container(null,{name:`${n.h_} _anchor`,width:v,height:v,offsetX:12,offsetY:12});h.Z.rect(e,{x:0,y:0,name:I,stroke:r.qf,width:v,height:v,fill:r.y4,cornerRadius:v,strokeWidth:1.4,shadowBlur:20,shadowOffsetX:0,shadowOffsetY:4,shadowColor:r.ox,hitStrokeWidth:0,shadowForStrokeEnabled:!1}),h.Z.line(e,{name:P,stroke:r.qf,strokeWidth:1.4,listening:!1}),h.Z.image(e,"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTciIHZpZXdCb3g9IjAgMCAxNiAxNyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik04LjU2MDY2IDMuNTMxMjhDOC4yMjczNiAzLjg2NjE1IDcuOTcxNDUgNC4yODEwMSA3LjgyNDA4IDQuNzQ5NDZMOC45Njg3OCA1LjEwOTU2QzkuMTc3OTggNC40NDQ1MiA5Ljc1MTMxIDMuOTU5MzEgMTAuNDQxOCAzLjg2Mjk0TDEwLjczODIgMy44MjE1NkwxMC44OTg4IDIuNjc4OTZMMTAuNjI1MyAyLjU1NzQ3QzkuOTg4MSAyLjI3NDUxIDkuNTcwNzIgMS42NTAwNiA5LjU1MjkzIDAuOTUzMTI1TDguMzUzMzIgMC45ODM3NDhDOC4zNjQyNyAxLjQxMjk5IDguNDY2MjkgMS44MjU3MSA4LjY0NDIxIDIuMTk5MjNDOC40MzI0OSAyLjE3Nzg1IDguMjE3NjkgMi4xNjY5IDguMDAwMzMgMi4xNjY5QzQuNTAyNTIgMi4xNjY5IDEuNjY2OTkgNS4wMDI0MyAxLjY2Njk5IDguNTAwMjNDMS42NjY5OSA5Ljc2NjY2IDIuMDM4NzEgMTAuOTQ2MyAyLjY3ODk4IDExLjkzNTlMMy42NDkzNiAxMC45NjU2QzMuMjM2MjQgMTAuMjM4IDMuMDAwMzMgOS4zOTY2NyAzLjAwMDMzIDguNTAwMjNDMy4wMDAzMyA1LjczODgxIDUuMjM4OSAzLjUwMDIzIDguMDAwMzMgMy41MDAyM0M4LjE4OTc1IDMuNTAwMjMgOC4zNzY3MSAzLjUxMDc2IDguNTYwNjYgMy41MzEyOFpNOC4xNzY1NyAxMi4yNTA4QzguMDI5MTggMTIuNzE5MyA3Ljc3MzE5IDEzLjEzNDIgNy40Mzk3OSAxMy40NjkyQzcuNjIzODEgMTMuNDg5NyA3LjgxMDgzIDEzLjUwMDIgOC4wMDAzMyAxMy41MDAyQzEwLjc2MTcgMTMuNTAwMiAxMy4wMDAzIDExLjI2MTcgMTMuMDAwMyA4LjUwMDIzQzEzLjAwMDMgNy42MDM2NyAxMi43NjQ0IDYuNzYyMjMgMTIuMzUxMSA2LjAzNDYyTDEzLjMyMTUgNS4wNjQyNkMxMy45NjE5IDYuMDUzOTYgMTQuMzMzNyA3LjIzMzY4IDE0LjMzMzcgOC41MDAyM0MxNC4zMzM3IDExLjk5OCAxMS40OTgxIDE0LjgzMzYgOC4wMDAzMyAxNC44MzM2QzcuNzgzIDE0LjgzMzYgNy41NjgyMyAxNC44MjI2IDcuMzU2NTQgMTQuODAxMkM3LjUzNDM5IDE1LjE3NDcgNy42MzYzOCAxNS41ODczIDcuNjQ3MzMgMTYuMDE2NUw2LjQ0NzcyIDE2LjA0NzFDNi40Mjk5MyAxNS4zNTAyIDYuMDEyNTYgMTQuNzI1NyA1LjM3NTM5IDE0LjQ0MjhMNS4xMDE4MiAxNC4zMjEzTDUuMjYyNCAxMy4xNzg3TDUuNTU4ODYgMTMuMTM3M0M2LjI0OTM0IDEzLjA0MDkgNi44MjI2NyAxMi41NTU3IDcuMDMxODcgMTEuODkwN0w4LjE3NjU3IDEyLjI1MDhaIiBmaWxsPSIjMUIxRTIxIi8+Cjwvc3ZnPgo=",{x:4,y:4,width:16,height:16}),this._handleRotate(e),this.add(e),e.moveToBottom()}_handleRotate(e){const t=t=>{(f.t.MacOS?t.metaKey:t.ctrlKey)&&this.rotationSnaps([]),t.metaKey||t.ctrlKey||this.rotationSnaps(p);const i=e.getStage();null==i||i.setPointersPositions(t);const r=null==i?void 0:i.getPointerPosition();if(!r)return;let s={x:(null==r?void 0:r.x)-this._anchorDragOffset.x,y:(null==r?void 0:r.y)-this._anchorDragOffset.y};const n=e.getAbsolutePosition();this.anchorDragBoundFunc()&&(s=this.anchorDragBoundFunc()(n,s,t)),e.setAbsolutePosition(s);const h=e.getAbsolutePosition();if(n.x===h.x&&n.y===h.y)return;const d=this._getNodeRect(),c=e.x()-d.width/2,l=-e.y()+d.height/2;let g=0;switch(this.rotaterDirection){case M.bottom:g=Math.atan2(-l,c)-Math.PI/2;break;case M.right:g=Math.atan2(-l,c);break;case M.left:g=Math.atan2(-l,c)+Math.PI;break;case M.top:g=Math.atan2(-l,c)+Math.PI/2}d.height<0&&(g-=Math.PI);const u=a.Core.getAngle(this.rotation())+g,_=a.Core.getAngle(this.rotationSnapTolerance()),y=(0,o.kM)(this.rotationSnaps(),u,_)-d.rotation,m=(0,o.Pl)(d,y);this._fitNodesInto(m,t)},i=e=>{var r,s;if(!this._transforming)return;this._transforming=!1,null===(r=window)||void 0===r||r.removeEventListener("mousemove",t),null===(s=window)||void 0===s||s.removeEventListener("mouseup",i,!0);const n=this.getNode();this._fire("transformend",{evt:e,target:n}),n&&this._nodes.forEach((t=>{t._fire("transformend",{evt:e,target:t})})),this._movingAnchorName=""};e.on("mousedown",(r=>{var s,a,o;this._movingAnchorName=n.h_;const h=this._getNodeRect(),{width:d,height:c}=h,l=(0,g.G)(d,c);this.sin=Math.abs(c/l),this.cos=Math.abs(d/l),this._transforming=!0;const u=e.getAbsolutePosition(),f=null===(s=r.target.getStage())||void 0===s?void 0:s.getPointerPosition();f&&(null===(a=window)||void 0===a||a.addEventListener("mousemove",t),null===(o=window)||void 0===o||o.addEventListener("mouseup",i,!0),this._anchorDragOffset={x:(null==f?void 0:f.x)-u.x,y:(null==f?void 0:f.y)-u.y},this._fire("transformstart",{evt:r.evt,target:this.getNode()}),this._nodes.forEach((e=>{e._fire("transformstart",{evt:r.evt,target:e})})))})),e.on("dragstart",(t=>{e.stopDrag(),t.cancelBubble=!0})),e.on("dragend",(e=>{e.cancelBubble=!0})),e.on("mouseover",(t=>{this._showRotateCursor();const i=e.findOne(`.${I}`);null==i||i.setAttr("fill",r.Jc),this.showTransformInfo&&this._transformInfo.show(this.getDragRotateInfo(),t.evt)})),e.on("mouseout",(()=>{if(!this._transforming){const t=e.findOne(`.${I}`);null==t||t.setAttr("fill",r.y4),this._transformInfo.hide(),this._showDefaultCursor()}}))}_createAnchorByName(e){const t={name:`${e} _anchor`,...w},{createCornerAnchor:i}=this.attrs;if([n.nh,n.EK,n.ng,n.Z0].indexOf(e)>=0)return i?i(e):h.Z.circle(null,{...t,radius:6,dragDistance:0,draggable:!0,hitStrokeWidth:"auto"});if([n.Py,n.DA].indexOf(e)>=0){const i=h.Z.rect(null,{...t,width:18,height:8,cornerRadius:8,hitFunc:t=>{t.beginPath(),t.rect(-(this.width()-i.width())/2,e===n.Py?0:i.height()/2,this.width(),i.height()/2),t.rect(-(this.width()-i.width())/2,e===n.Py?i.height()/2:0,this.width(),Math.min(this.height()/2,i.height()/2)),t.closePath(),t.fillStrokeShape(i)}});return i}if([n.XE,n.Wk].indexOf(e)>=0){const i=h.Z.rect(null,{...t,width:8,height:18,cornerRadius:8,hitFunc:t=>{t.beginPath(),t.rect(e===n.XE?0:i.width()/2,-(this.height()-i.height())/2,i.width()/2,this.height()),t.rect(e===n.XE?i.width()/2:0,-(this.height()-i.height())/2,Math.min(this.width()/2,i.width()/2),this.height()),t.rect(0,0,i.width(),i.height()),t.closePath(),t.fillStrokeShape(i)}});return i}}_init(e,t){var i;const{enableRotater:s,resizeLimits:n,rotaterDirection:a,enableRotaterLineTo:o,nodeRectSelector:h,borderDashConfig:d,rotaterVisible:c}=t;this.resizeLimits=n,this._enableRotater="boolean"!=typeof s||s,this._enableRotaterLineTo="boolean"!=typeof o||o,this._rotaterDirection=a||M.bottom,this._borderDashConfig=d,this._rotaterVisible="boolean"!=typeof c||c,this._nodeRectSelector=h,this.boundBoxFunc(S.boundBoxFunc.bind(this)),this.anchorDragBoundFunc(S.anchorDragBoundFunc.bind(this)),this.rotateEnabled(!1),this.rotationSnapTolerance(2),this.rotationSnaps(p),this.borderStroke(null!==(i=t.borderStroke)&&void 0!==i?i:r.Jc),this.borderStrokeWidth(2),this._createRotater(),this._initResizeCursorListener(),this._initTransformListener(),this._initMovementListener(),this._initPageLayoutListener()}_setDragBoundFunc(e){e.forEach(((e,t)=>{e.dragBoundFunc(((e,i)=>this._nodeDragBoundFunc(e,t,i)))}))}_anchorsOverlapHandler(){if(this._isHideAnchor)return;const{width:e,height:t}=this._getNodeRect(),i=this.enabledAnchors(),r=[n.Py,n.DA,n.XE,n.Wk],[s,a,o,h]=this.getAnchorNode(r);e<30||t<8?(s.opacity(0),a.opacity(0)):(s.opacity(1),a.opacity(1)),e<16?(s.visible(!1),a.visible(!1)):(i.indexOf(n.Py)>=0&&s.visible(!0),i.indexOf(n.DA)>=0&&a.visible(!0)),t<30||e<8?(o.opacity(0),h.opacity(0)):(o.opacity(1),h.opacity(1)),t<16?(o.visible(!1),h.visible(!1)):(i.indexOf(n.XE)>=0&&o.visible(!0),i.indexOf(n.Wk)>=0&&h.visible(!0));const d=this.findOne(`.${n.EK}`),c=this.findOne(`.${n.ng}`),l=this.findOne(`.${n.Z0}`);t<12||e<12?(d.opacity(0),c.opacity(0)):(d.opacity(1),c.opacity(1)),t<12&&e<12?l.opacity(0):l.opacity(1)}}},96497:(e,t,i)=>{"use strict";i.d(t,{JM:()=>o,_k:()=>a,xX:()=>n});var r=i(8757),s=i(63345);const n={disableDraggable:!1,resizeLimits:{minHeight:r.DW.MIN_HEIGHT,minWidth:r.DW.MIN_WIDTH,maxWidth:r.DW.MAX_WIDTH,maxHeight:r.DW.MAX_HEIGHT},flipEnabled:!1,borderStroke:s.Jc},a=[4,6],o={lineCap:"round",lineJoin:"round",shadowBlur:2,shadowOffsetX:0,shadowOffsetY:0,shadowColor:s.tW}},51012:(e,t,i)=>{"use strict";i.d(t,{H2:()=>D});var r=i(8757),s=i(96497),n=i(48917),a=i(45065),o=i(67986),h=i(43825),d=i(46436),c=i(48737),l=i(93123);class g extends c.A4{constructor(){super(...arguments),this._updateEffectNode=(0,a.r)(((e,t)=>this._renderSDK.accessors.text.batchDraw(e,t)),16),this._transformHandler=async()=>{const[e]=this.nodes(),t={...e.getAttrs()},{accessors:i}=this._renderSDK,r=e.rotation();if(r!==t.rotation&&(t.rotation=r),this._isMiddleAnchorActive()){const r={...e.getAttrs()},{width:s}=r;let a;try{a=await i.text.revalidateTextLayerRenderHeight(e.id(),{autoWrap:!0,width:s})}catch(n){return void(n&&o.t.error("TextTransformer revalidateTextLayerRenderHeight error",n))}if(!a)return void o.t.error("TextTransformer revalidateTextLayerRenderHeight empty with layerId",e.id());const{innerBoundWidth:h,innerBoundHeight:d,outerBoundHeight:c,outerBoundWidth:g}=a,u={x:Math.max(1,g-h),y:c-d};if(e.setAttrs({height:d,extendBuffer:u}),t.height=d,e instanceof l.V){const{type:t,...s}=i.layer.createNodeLayerLayout(e);this._updateEffectNode(e.id(),{lineMaxWidth:1,layout:{...s,opacity:r.opacity},extra:{textOuterRect:{width:u.x+s.width,height:u.y+s.height}}})}this.forceUpdate()}const s=e.scaleX();s!==t.scaleX&&(t.scaleX=s)},this._textBoundBoxFunc=(e,t,i)=>{const r=this._getDeltaTransform(e,t),s=this._nodes[0],a=this._transformNodeAttrsByDelta(s,r),o=s.getAttrs();let c=t;const l=[],g=this.getActiveAnchor()||"",u=e=>{const t=i||g.indexOf("left")>=0?(c.width-e)/(i?2:1):0;c.x+=t,c.width=e};let f=1;const _=h.wS.displayMax/o.textFontSize,y=h.wS.displayMin/o.textFontSize;if(a.scaleY>_?f=_/a.scaleY:a.scaleY<y&&(f=y/a.scaleY),1!==f&&l.push((()=>{u(c.width*f),(e=>{const t=i||g.indexOf("top")>=0?(c.height-e)/(i?2:1):0;c.y+=t,c.height=e})(c.height*f)})),this._isMiddleAnchorActive()){var p;const e=a.scaleX*f,t=this._renderSDK.accessors.text.getNodeLayer(s.id()),i=o.textHeight*(1+2*(null!==(p=t.innerPadding)&&void 0!==p?p:0)),r=o.width*e/o.scaleX;r<i&&l.push((()=>{u(c.width*(i/r))}))}if(l.length){const e=n.Core.getAngle(this.rotation());c=(0,d.$D)(t,-e,{x:0,y:0}),l.forEach((e=>e())),c=(0,d.$D)(c,e,{x:0,y:0})}return c},this._isMiddleAnchorActive=()=>{const e=this.getActiveAnchor();return"middle-left"===e||"middle-right"===e}}select(e){super.select(e),e.on("transform",this._transformHandler),this._updateAnchors(),this.selectOutsideHandle(e)}unselect(){this.nodes()[0].off("transform",this._transformHandler),super.unselect()}_fitNodesInto(e,t){var i;const r=this._getNodeRect(),s=this._textBoundBoxFunc(r,e,this.centeredScaling()||(null==t?void 0:t.altKey)),a=this._getDeltaTransform(r,s);this._nodes.forEach((e=>{var i;const r=this._transformNodeAttrsByDelta(e,a);if(this._isMiddleAnchorActive()){const t=e.getAttrs(),i=t.width*r.scaleX/t.scaleX;Object.assign(r,{scaleX:t.scaleX,width:i})}e.setAttrs(r),this._fire("transform",{evt:t,target:e}),e._fire("transform",{evt:t,target:e}),null===(i=e.getLayer())||void 0===i||i.batchDraw()})),this.rotation(n.Zr._getRotation(e.rotation)),this._resetTransformCache(),this.update(),null===(i=this.getLayer())||void 0===i||i.batchDraw()}_updateAnchors(){const e=this.nodes()[0],t=this._renderSDK.accessors.text.getCurveAngle(e.id());this.enabledAnchors(null!==t?[r.nh,r.EK,r.ng,r.Z0]:[r.nh,r.EK,r.ng,r.Z0,r.XE,r.Wk])}}var u=i(79244);var f=i(63345),_=i(52169),y=i(71946);class p extends c.A4{constructor(e){super(e),this._highlight=new _.Z(this._renderSDK.getFeatureRenderer().getRenderer())}get selectedNode(){return this.nodes()[0]}select(e){super.select(e),this._initGroupListener(e),this.selectOutsideHandle(e)}unselect(){var e;const t=this.selectedNode;null===(e=this._highlight)||void 0===e||e.clear(),this._removeGroupListener(t),super.unselect()}enableBorderDash(){this.borderDash(s._k),this.borderStroke(f.SN),this.borderDashConfig(s.JM)}disableBorderDash(){this.borderDash([]),this.borderStroke(f.Jc),this.borderDashConfig(void 0)}activeChild(e){var t;y.Z.getMaterialGroupId(e)===this.selectedNode.id()&&(null===(t=this._highlight)||void 0===t||t.add(e),this.moveToTop())}_initGroupListener(e){e.on("dragmove.group",(()=>{var e;null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("dragmove")))})),e.on("transform.group",(()=>{var e;null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("transform")))}))}_removeGroupListener(e){e.off("mousedown.group dragmove.group transform.group")}}function m(e,t){const{rotaterDirection:i}=t||{};return new p({...s.xX,enabledAnchors:[r.nh,r.EK,r.ng,r.Z0],keepRatio:!0,renderSDK:e,rotaterDirection:i})}var v=i(56537);const x=[r.nh,r.EK,r.ng,r.Z0],w=[r.Py,r.DA,r.XE,r.Wk];class I extends c.A4{constructor(e){super(e),this._handleTransform=()=>{var e,t,i,s,n,a,o;const h=this.selectedNode;if(!h)return;const{id:d}=this.selectedNode.attrs,c=this._renderSDK.getMainRenderer().getMaterialWidget(d);if(!c)return;const l=c.getShapeLayout(),{width:g,height:u,scaleX:f,scaleY:_,svgInfo:p}=h.attrs,m=this.getActiveAnchor();let x;x=-1!==w.indexOf(m)&&this.keepRatio()?{width:g*f/l.scale.x,height:u*_/l.scale.y,scale:{...l.scale}}:{width:l.width,height:l.height,scale:{x:g*f/l.width,y:u*_/l.height}};const I=v.F.updatePolygonPath(p.attr,p.radius,{...x,scale:{x:1,y:1}},p.fixedAreas),P=y.Z.getRenderLayerUtil(r.Wq.SHAPE),C=P.getStrokeWidth(I.strokeWidth)/((null===(e=x.scale)||void 0===e?void 0:e.x)||1),M=P.getStrokeDash(I.strokeDasharray),S=P.getStrokeColor(null!==(t=x.width)&&void 0!==t?t:0,null!==(i=x.height)&&void 0!==i?i:0,I),E=P.getFillColor(null!==(s=x.width)&&void 0!==s?s:0,null!==(n=x.height)&&void 0!==n?n:0,I);null===(a=c.element)||void 0===a||a.setViewBox(I.viewBox),null===(o=c.element)||void 0===o||o.setAttrs({...x,...M,...S,...E,scaleX:x.scale.x,scaleY:x.scale.y,data:I.d,strokeWidth:C})},this.boundBoxFunc(((e,t)=>{var i,s;const a=n.Core.getAngle(this.rotation()),o=(0,d.$D)(t,-a,{x:0,y:0}),{maxWidth:h=r.DW.MAX_WIDTH,maxHeight:c=r.DW.MAX_HEIGHT}=null!==(i=this.resizeLimits)&&void 0!==i?i:{};let{minWidth:l=r.DW.MIN_WIDTH,minHeight:g=r.DW.MIN_HEIGHT}=null!==(s=this.resizeLimits)&&void 0!==s?s:{};const{x:u,y:f}=this.getPageScale(),_=this._getNodeRect(),y=_.width/u,p=_.height/f,m=this.getActiveAnchor()||"",v=x.includes(m),{svgInfo:{fixedAreas:w},scaleX:I,scaleY:P}=this.selectedNode.attrs;if(w&&!v){var C,M;const e=(null!==(C=w.vertical)&&void 0!==C?C:[]).reduce(((e,t)=>e+t[1]-t[0]),0),t=(null!==(M=w.horizontal)&&void 0!==M?M:[]).reduce(((e,t)=>e+t[1]-t[0]),0);l=Math.max(t*I,l),g=Math.max(e*P,g)}let S=Math.min(y,l),E=Math.min(p,g),A=Math.max(y,h),R=Math.max(p,c);if(v&&this.keepRatio()){const e=this.sin/this.cos;e<1?(S=E/e,R=A*e):(E=S*e,A=R/e)}const T=Math.abs(o.width),b=Math.abs(o.height),N=S*u,D=E*f,L=A*u,k=R*f;return T<N&&(m.indexOf("left")>=0&&(o.x-=N-o.width,o.width=N),m.indexOf("right")>=0&&(o.width=N)),b<D&&(m.indexOf("top")>=0&&(o.y-=D-o.height,o.height=D),m.indexOf("bottom")>=0&&(o.height=D)),T>L&&(m.indexOf("left")>=0&&(o.x+=o.width-L,o.width=L),m.indexOf("right")>=0&&(o.width=L)),b>k&&(m.indexOf("top")>=0&&(o.y+=o.height-k,o.height=k),m.indexOf("bottom")>=0&&(o.height=k)),(0,d.$D)(o,a,{x:0,y:0})}))}get selectedNode(){return this.nodes()[0]}select(e){super.select(e),this.selectedNode.on("transform",this._handleTransform),this.selectOutsideHandle(e)}unselect(){this.selectedNode.off("transform",this._handleTransform),super.unselect()}}var P=i(62378);var C=i(25629);const M=[r.nh,r.EK,r.ng,r.Z0],S=[r.Py,r.DA,r.XE,r.Wk];class E extends c.A4{constructor(){super(...arguments),this._mouseDown=()=>{this._hasMouseDown=!0},this._onClick=e=>{if(!e||!this.selectedNode||!this._hasMouseDown)return;const{currentTarget:t,evt:{button:i}}=e;if(0!==i)return;const{id:r}=this.selectedNode.attrs,s=t.getStage().getPointerPosition();if(!s)return this._renderSDK.accessors.imageContainer.clearSelectIndex(r),void this._selectItemSelectEventFire(e.evt);this._renderSDK.accessors.imageContainer.setSelectIndex(r,s),this._selectItemSelectEventFire(e.evt),this._selectItemHighlight()},this._onContextMenu=e=>{if(!e||!this.selectedNode||!this._hasMouseDown)return;const{currentTarget:t}=e,i=t.getStage().getPointerPosition();if(!i)return;const{id:r}=this.selectedNode.attrs;this._renderSDK.accessors.imageContainer.setSelectIndex(r,i),this._selectItemSelectEventFire(e.evt),this._selectItemHighlight()},this._onDragMove=()=>{var e;null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("dragmove")))},this._onTransform=()=>{var e;const t=this.selectedNode;if(!t)return;const{id:i,scaleX:r,scaleY:s,width:n,height:a}=t.attrs,o=this.getActiveAnchor(),h=-1!==M.indexOf(o)&&this.keepRatio();this._renderSDK.accessors.imageContainer.handleScaling(i,o,h,{width:n*r,height:a*s}),null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("transform")))},this._selectItemSelectEventFire=e=>{const t=[],i={type:this.selectedNode.attrs.type,id:this.selectedNode.id(),selectIndex:this._renderSDK.accessors.imageContainer.getSelectIndex(this.selectedNode.id())},s=y.Z.getMaterialGroupId(this.selectedNode);s?t.push({type:r.Wq.GROUP_LAYER,id:s,subMaterial:i}):t.push(i),C.Z.interact.onMaterialSelect.fire({selectedList:t,e})}}get selectedNode(){return this.nodes()[0]}select(e){super.select(e),this._highlight||(this._highlight=new _.Z(this._renderSDK.getFeatureRenderer().getRenderer(),{container:this.parent}));const{id:t}=e.attrs,i=this._renderSDK.accessors.imageContainer,r=i.getIsSingle(t),s=i.getIsSingleFillImage(t);r&&this.enabledAnchors([...M,...S]),this.selectOutsideHandle(e),this._initEventListener();i.getImageContainerWidget(t)&&!s&&this._initSubSelect()}unselect(){const{id:e}=this.selectedNode.attrs,t=this._renderSDK.accessors.imageContainer.getIsSingleFillImage(e);this._removeEventListener(),t||this._removeSubSelect(),super.unselect()}hide(){return super.hide(),this._clearSelectItemHighlight(),this}show(){return super.show(),this._selectItemHighlight(),this}_initEventListener(){this.selectedNode.on("transform",this._onTransform)}_removeEventListener(){this.selectedNode.off("transform",this._onTransform)}_initSubSelect(){this.selectedNode.on("mousedown",this._mouseDown),this.selectedNode.on("click",this._onClick),this.selectedNode.on("dragmove",this._onDragMove),this.selectedNode.on("contextmenu",this._onContextMenu),this._selectItemHighlight()}_removeSubSelect(){this.selectedNode.off("mousedown",this._mouseDown),this.selectedNode.off("click",this._onClick),this.selectedNode.off("dragmove",this._onDragMove),this.selectedNode.off("contextmenu",this._onContextMenu),this._clearSelectItemHighlight()}_selectItemHighlight(){if(this._renderSDK.accessors.imageContainer.getIsSingleFillImage(this.selectedNode.id()))return;const e=this._getSelectItem();if(this._clearSelectItemHighlight(),!e)return;const t=this._renderSDK.accessors.layer.isLocked([this.selectedNode.id()]);this._highlight.add(e,{stroke:t?f.zL:f.Jc}),this.moveToTop()}_clearSelectItemHighlight(){this._highlight.clear()}_getSelectItem(){var e;const t=this._renderSDK.getMainRenderer().getMaterialWidget(this.selectedNode.id()),i=null==t?void 0:t.getSelectIndex();if(!("number"!=typeof i||i<0))return null===(e=this.selectedNode.children)||void 0===e?void 0:e[i+1]}}var A=i(43696);var R=i(14764);const T=[r.nh,r.EK,r.ng,r.Z0],b=[r.Py,r.DA,r.XE,r.Wk];class N extends c.A4{constructor(e){super(e),this._onSpacing=e=>{var t;this.selectedNode&&(null===(t=this._highlight)||void 0===t||t.getNodes().forEach((e=>e.fire("layoutupdate"))),this._selectItemSelectEventFire(e.evt))},this._onTransform=()=>{var e;const t=this.selectedNode;if(!t)return;const{id:i}=t.attrs,r=this._renderSDK.accessors.grid,s=this.getActiveAnchor();r.handleScaling(i,s),null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("transform")))},this._onDragMove=()=>{var e;null===(e=this._highlight)||void 0===e||e.getNodes().forEach((e=>e.fire("dragmove")))},this._mouseDown=()=>{this._hasMouseDown=!0},this._onClick=e=>{if(!e||!this.selectedNode||!this._hasMouseDown)return;const{currentTarget:t,evt:{button:i}}=e;if(0!==i)return;const{id:r}=this.selectedNode.attrs,s=t.getStage().getPointerPosition();if(!s)return this._renderSDK.accessors.grid.clearSelectedAreaIndex(r),void this._selectItemSelectEventFire(e.evt);this._renderSDK.accessors.grid.setSelectedAreaIndex(r,s),this._selectItemSelectEventFire(e.evt),this._selectItemHighlight()},this._onContextMenu=e=>{if(!e||!this.selectedNode||!this._hasMouseDown)return;const{currentTarget:t}=e,i=t.getStage().getPointerPosition();if(!i)return;const{id:r}=this.selectedNode.attrs;this._renderSDK.accessors.grid.setSelectedAreaIndex(r,i),this._selectItemSelectEventFire(e.evt),this._selectItemHighlight()},this._selectItemSelectEventFire=e=>{const t=[],i={type:this.selectedNode.attrs.type,id:this.selectedNode.id(),selectIndex:this._renderSDK.accessors.grid.getSelectedAreaIndex(this.selectedNode.id())},s=y.Z.getMaterialGroupId(this.selectedNode);s?t.push({type:r.Wq.GROUP_LAYER,id:s,subMaterial:i}):t.push(i),C.Z.interact.onMaterialSelect.fire({selectedList:t,e})},this.boundBoxFunc(((e,t)=>{if(!this.selectedNode)return e;const i=this._renderSDK.getMainRenderer().getMaterialWidget(this.selectedNode.attrs.id);if(!i)return e;const r=this.selectedNode.getAbsoluteRotation()*Math.PI/180,s=this.selectedNode.getAbsoluteScale(),n=i.getGridLimit(),a=this.getActiveAnchor()||"",o=n.minRect.width*s.x,h=n.minRect.height*s.y;return t.width<o&&(a.indexOf("left")>=0&&(t.x-=(o-t.width)*Math.cos(r),t.y-=(o-t.width)*Math.sin(r)),a.indexOf("right")>=0&&(t.x=e.x),t.width=o),t.height<h&&(a.indexOf("top")>=0&&(t.y-=(h-t.height)*Math.cos(r),t.x-=(h-t.height)*Math.sin(-r)),a.indexOf("bottom")>=0&&(t.y=e.y),t.height=h),t}))}get selectedNode(){return this.nodes()[0]}select(e){super.select(e),this._highlight||(this._highlight=new _.Z(this._renderSDK.getFeatureRenderer().getRenderer(),{container:this.parent})),this.enabledAnchors([...T,...b]),this._initEventListener(),this._initSubEventListener()}unselect(){this._removeEventListener(),this._removeSubEventListener(),super.unselect()}_initEventListener(){this.selectedNode.on("transform",this._onTransform)}_removeEventListener(){this.selectedNode.off("transform",this._onTransform)}_initSubEventListener(){this.selectedNode.on("mousedown",this._mouseDown),this.selectedNode.on("click",this._onClick),this.selectedNode.on("dragmove",this._onDragMove),this.selectedNode.on("contextmenu",this._onContextMenu),this.selectedNode.on("spacing",this._onSpacing),this._selectItemHighlight()}_removeSubEventListener(){this.selectedNode.off("mousedown",this._mouseDown),this.selectedNode.off("click",this._onClick),this.selectedNode.off("dragmove",this._onDragMove),this.selectedNode.off("contextmenu",this._onContextMenu),this.selectedNode.off("spacing",this._onSpacing),this._clearSelectItemHighlight()}_selectItemHighlight(){const e=this._getSelectArea();if(this._clearSelectItemHighlight(),!e)return;const t=this._renderSDK.accessors.layer.isLocked([this.selectedNode.id()]);this._highlight.add(e,{stroke:t?f.zL:f.Jc}),this.moveToTop()}_clearSelectItemHighlight(){this._highlight.clear()}_getSelectArea(){var e;const t=this._renderSDK.getMainRenderer().getMaterialWidget(this.selectedNode.id()),i=null==t?void 0:t.getSelectedAreaIndex();if(!("number"!=typeof i||i<0))return null===(e=this.selectedNode.children)||void 0===e?void 0:e.find((e=>e.attrs.index===i))}}class D{constructor(e){this._renderSDK=e}createTransformer(e,t){switch(e){case r.Wq.TEXT:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new g({...s.xX,enabledAnchors:null!=i?i:[r.nh,r.EK,r.ng,r.Z0,r.XE,r.Wk],keepRatio:!0,renderSDK:e,rotaterDirection:n})}(this._renderSDK,t);case r.Wq.IMAGE:case r.Wq.SVG_IMAGE:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new u.G({...s.xX,enabledAnchors:null!=i?i:[r.nh,r.EK,r.ng,r.Z0],keepRatio:!0,renderSDK:e,rotaterDirection:n})}(this._renderSDK,t);case r.Wq.GROUP_LAYER:return m(this._renderSDK);case r.Wq.SHAPE:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new I({...s.xX,enabledAnchors:i,renderSDK:e,rotaterDirection:n,resizeLimits:{minHeight:r.gy.MIN_HEIGHT,minWidth:r.gy.MIN_WIDTH,maxWidth:r.gy.MAX_WIDTH,maxHeight:r.gy.MAX_HEIGHT}})}(this._renderSDK,t);case r.Wq.LINE:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new P.hq({...s.xX,enabledAnchors:null!=i?i:[P.QM,P.lB],renderSDK:e,resizeLimits:{minHeight:r.gy.MIN_HEIGHT,minWidth:r.gy.MIN_WIDTH,maxWidth:r.gy.MAX_WIDTH,maxHeight:r.gy.MAX_HEIGHT},borderStroke:f.Fs,enableRotaterLineTo:!1,rotaterDirection:n})}(this._renderSDK,t);case r.Wq.IMAGE_CONTAINER:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new E({...s.xX,enabledAnchors:null!=i?i:[r.nh,r.EK,r.ng,r.Z0],keepRatio:!0,renderSDK:e,rotaterDirection:n})}(this._renderSDK,t);case r.Wq.PAGE:return i=this._renderSDK,new c.A4({...s.xX,nodeRectSelector:e=>{var t;if(e instanceof n.ZA)return null==e||null===(t=e.children)||void 0===t?void 0:t[0]},padding:R.Qe,disableDraggable:!0,enabledAnchors:[],enableRotater:!1,renderSDK:i});case r.Wq.GRID:return function(e,t){const{enabledAnchors:i,rotaterDirection:n}=t||{};return new N({...s.xX,enabledAnchors:null!=i?i:[r.nh,r.EK,r.ng,r.Z0],keepRatio:!0,renderSDK:e,rotaterDirection:n})}(this._renderSDK);default:throw new Error("createTransformer error: unexpected type")}var i}createMultiTransformer(e){return function(e,t){const{initRotation:i,rotaterDirection:n,shouldOverdrawWholeArea:a}=t||{};return new A.D({...s.xX,enabledAnchors:[r.nh,r.EK,r.ng,r.Z0],keepRatio:!0,shouldOverdrawWholeArea:null==a||a,borderDash:s._k,borderStroke:f.SN,renderSDK:e,initRotation:i,borderDashConfig:s.JM,rotaterDirection:n})}(this._renderSDK,e)}createGroupTransformer(e){return m(this._renderSDK,e)}}},79244:(e,t,i)=>{"use strict";i.d(t,{G:()=>h});var r=i(8757),s=i(28161),n=i(48737);const a=[r.nh,r.EK,r.ng,r.Z0],o=[r.Py,r.DA,r.XE,r.Wk];class h extends n.A4{constructor(){super(...arguments),this._handleTransformStart=e=>{const{effectFilters:t}=this.selectedNode.getAttrs();t.length&&(this._isUseKeepRationScaling(e)||this.selectedNode.setAttrs({effectFilters:[],_effectFilters:t}))},this._handleTransformEnd=()=>{var e;const t=null!==(e=this.selectedNode.getAttrs()._effectFilters)&&void 0!==e?e:[];t.length&&this.selectedNode.setAttrs({effectFilters:t,_effectFilters:[]})},this._handleTransform=e=>{const t=this.selectedNode;if(!t)return;const{id:i,scaleX:r,scaleY:s,width:n,height:a}=t.attrs;this._isUseKeepRationScaling(e)?this._renderSDK.accessors.image.handleUniformScaling(r*n,s*a,i):this._renderSDK.accessors.image.handleNonUniformScaling(r*n,s*a,i,this.getActiveAnchor())}}get selectedNode(){return this.nodes()[0]}select(e){super.select(e),this.enabledAnchors([...a,...o]),this.selectOutsideHandle(e),this.selectedNode.on("transformstart",this._handleTransformStart),this.selectedNode.on("transform",this._handleTransform),this.selectedNode.on("transformend",this._handleTransformEnd)}unselect(){this.selectedNode.off("transformstart",this._handleTransformStart),this.selectedNode.off("transform",this._handleTransform),this.selectedNode.off("transformend",this._handleTransformEnd),super.unselect()}onHotKeys(e){super.onHotKeys(e);if(!this.selectedNode)return;if(!s.Z.shift)return;const{shiftKey:t}=e;this.keepRatio(!t);const i=this.findOne(`.${this.getActiveAnchor()}`);i&&this._activeAnchorNewAbs&&this._forceUpdateAnchorPos(i,this._activeAnchorNewAbs,e)}_isUseKeepRationScaling(e){const t=this.getActiveAnchor(),i=o.indexOf(t)<0;return this.keepRatio(i),i}}},43696:(e,t,i)=>{"use strict";i.d(t,{D:()=>h});var r=i(52169),s=i(71946),n=i(48737),a=i(11005),o=i(63345);class h extends n.A4{constructor(e){super(e),this._initRotation=e.initRotation}select(...e){super.select(...e),this._highlight=new r.Z(this._renderSDK.getFeatureRenderer().getRenderer(),{container:this.parent}),this._initRotation&&(this.rotation(this._initRotation),this.forceUpdate()),this.highlightAll()}unselect(){this._highlight.clear(),this.clearHighlight(),super.unselect()}lock(){this.hideAnchor(),this.disableDrag(),this.clearHighlight(),this.highlightAll(o.zL)}unlock(){this.showAnchor(),this.enableDrag(),this.clearHighlight(),this.highlightAll()}hide(){return super.hide(),this.clearHighlight(),this}show(){return super.show(),this.highlightAll(),this}moveLayers(e,t){this.nodes().forEach((t=>{const i=e[t.id()];i&&t&&(i.x&&t.x(t.x()+i.x),i.y&&t.y(t.y()+i.y))})),"number"==typeof t&&(this.rotation(t),this.forceUpdate()),this.fire(a.Z2.layoutupdateend)}highlightAll(e){this.nodes().forEach((t=>{const i=s.Z.getMaterialGroup(t),r=null!=i?i:t;this._highlight.add(r,{stroke:e})})),this.moveToTop()}clearHighlight(){this._highlight.clear()}}},62378:(e,t,i)=>{"use strict";i.d(t,{QM:()=>f,hq:()=>m,lB:()=>_});var r=i(48917),s=i(63345),n=i(8757),a=i(46436),o=i(54643),h=i(56537),d=i(22169),c=i(26399),l=i(5317),g=i(48737),u=i(28161);const f="custom-shape-line-l",_="custom-shape-line-r",y={stroke:s.es,fill:s.y4,radius:6,strokeWidth:1,hitStrokeWidth:"auto"},p=[0,45,90,135,180,225,270,315];class m extends g.A4{constructor(e){super(e),this._resizeSnaps=[],this._createResizeAnchor(),this._resizeSnaps=p}select(e){super.select(e),this._initListener(),this.selectOutsideHandle(e)}unselect(){this._removeListener(),super.unselect()}update(){super.update();const e=this._getNodeRect(),{width:t,height:i}=e,r=this.enabledAnchors();this._batchChangeChild(`.${f}`,{x:0,y:i/2,visible:r.includes(f)}),this._batchChangeChild(`.${_}`,{x:t,y:i/2,visible:r.includes(_)})}getDragAnchorInfo(){var e;const t=this._renderSDK.accessors.page.getZoom().x;let i=Math.round(this.width()/t);const r=null===(e=this._renderSDK.getMainRenderer().getDimension())||void 0===e?void 0:e.unit,s=Math.round(this.rotation());return r===n.fb.CM?(i=(0,o.$S)(i),`${i.toFixed(2)} ${s}\xb0`):`${i} ${s}\xb0`}onHotKeys(e){if(super.onHotKeys(e),u.Z.shift&&this._currentResizeInfo)if("keydown"!==e.type){if("keyup"===e.type){const{anchorNewAbs:e,anchorOldAbs:t,e:i}=this._currentResizeInfo;this._fitShape(e,t,i)}}else{const{anchorNewAbs:e,anchorOldAbs:t,rotateAnchor:i,e:r}=this._currentResizeInfo,s=this._anchorDragOptions.startPos;this._fitShape(this._resizeSnapsHandler(s,e,i),t,r)}}_showDragAnchorCursor(){const e=this.getActiveAnchor();e!==f&&e!==_||this._showMoveCursor()}_initListener(){this.on("transform",this._showDragAnchorCursor),this.on("transformend",this._showDefaultCursor)}_removeListener(){this.off("transform",this._showDragAnchorCursor),this.off("transformend",this._showDefaultCursor)}_createResizeAnchor(){this._createCircle(f),this._createCircle(_)}_createCircle(e){const t=new r.Cd({name:e,...y});this._handleResizeAnchor(t,e),this.add(t)}_matchResizeSnaps(e){let t=e,i=1/0;return this._resizeSnaps.forEach((s=>{const n=r.Core.getAngle(s),a=Math.abs(n-e)%(2*Math.PI),o=Math.min(a,2*Math.PI-a);i>o&&(i=o,t=n)})),t}_resizeSnapsHandler(e,t,i){if(this._resizeSnaps.length<=0)return t;const r=this._getNewRotationRad(e,t,i),s=this._matchResizeSnaps(r)-r;return(0,a._1)(t,s,i)}_getNewRotationRad(e,t,i){let r=(0,a.Ww)({target:e,anchor:i,result:t});return this._getNodeRect().height<0&&(r-=Math.PI),this._anchorDragOptions.startRotation+r}_fitShape(e,t,i){if(t.x===e.x&&t.y===e.y)return;const s=this.getActiveAnchor(),o=this.findOne(`.${s}`),d=this._anchorDragOptions.startPos;o.setAbsolutePosition(e);const g=o.getAbsolutePosition(),u=this._getNodeRect(),{rotateAnchor:_}=this._anchorDragOptions;let y=Math.floor((0,a.Cy)({point1:g,point2:_}));const{minWidth:p=n.DW.MIN_WIDTH,maxWidth:m=n.DW.MAX_WIDTH}=this.resizeLimits||{},{x:v}=this.getPageScale();y/v<p&&(y=p*v),y/v>m&&(y=m*v);const x=this._anchorDragOptions.baseAttrs,w=this._getNewRotationRad(d,g,_),I=r.Core.getAngle(this.rotationSnapTolerance()),P=(0,a.kM)(this.rotationSnaps(),w,I),C=y/x.width;let M;if(s===f){const e=P-x.rotation;M=(0,a.$D)({...x,...(0,a.EK)(x,(0,a.Xv)(x),C),width:y},e,_)}else{const e=P-u.rotation;M={...(0,a.$D)(u,e,_),width:y}}const{source:S,attr:E}=this.getNode().attrs.svgInfo;if(null!=E&&E.viewBox){const e=y/this._selectInfo.width,t=Math.floor(E.viewBox.width*e),i=h.F.composeLineByAttrs(S,{...E,viewBox:{...E.viewBox,width:t}}),{devicePixelRatio:r}=l.Z.getGlobalVars();h.F.svgToImage({data:i,dpr:r,width:this.getNode().width(),height:this.getNode().height()}).then((e=>{e&&(this.getNode().image(e),c.Z.setAssetsCache(this.getNode().attrs.id,e))}))}this._fitNodesInto(M,i)}_handleResizeAnchor(e,t){if(!e)return;const i=(0,d.throttle)((t=>{const i=e.getStage();null==i||i.setPointersPositions(t);const r=null==i?void 0:i.getPointerPosition();if(!r)return;let s={x:(null==r?void 0:r.x)-this._anchorDragOffset.x,y:(null==r?void 0:r.y)-this._anchorDragOffset.y};const{rotateAnchor:n}=this._anchorDragOptions,a=this._anchorDragOptions.startPos,o=e.getAbsolutePosition();this.anchorDragBoundFunc()&&(s=this.anchorDragBoundFunc()(o,s,t)),this._currentResizeInfo={anchorNewAbs:s,anchorOldAbs:o,rotateAnchor:n,e:t},t.shiftKey&&(s=this._resizeSnapsHandler(a,s,n)),this._fitShape(s,o,t)}),20),n=e=>{var t,r;if(!this._transforming)return;this._transforming=!1,this._anchorDragOptions=void 0,null===(t=window)||void 0===t||t.removeEventListener("mousemove",i),null===(r=window)||void 0===r||r.removeEventListener("mouseup",n,!0);const s=this.getNode();this._fire("transformend",{evt:e,target:s}),s&&this._nodes.forEach((t=>{t._fire("transformend",{evt:e,target:t})})),this._movingAnchorName=""};e.on("mousedown",(e=>{var s,o,h;this._movingAnchorName=t;const d=this._getNodeRect(),{width:c,height:l,scaleX:g}=d;this._selectInfo={width:c,scaleX:g};const u=Math.sqrt(Math.pow(c,2)+Math.pow(l,2));this.sin=Math.abs(l/u),this.cos=Math.abs(c/u),this._transforming=!0;const _=e.target.getAbsolutePosition(),y=null===(s=e.target.getStage())||void 0===s?void 0:s.getPointerPosition();y&&(null===(o=window)||void 0===o||o.addEventListener("mousemove",i),null===(h=window)||void 0===h||h.addEventListener("mouseup",n,!0),this._anchorDragOptions={startPos:{x:y.x,y:y.y},baseAttrs:d,startRotation:r.Core.getAngle(this.rotation()),rotateAnchor:t!==f?(0,a.tn)(d):(0,a.L0)(d)},this._anchorDragOffset={x:(null==y?void 0:y.x)-_.x,y:(null==y?void 0:y.y)-_.y},this._fire("transformstart",{evt:e.evt,target:this.getNode()}),this._nodes.forEach((t=>{t._fire("transformstart",{evt:e.evt,target:t})})))})),e.on("dragstart",(t=>{e.stopDrag(),t.cancelBubble=!0})),e.on("dragend",(e=>{e.cancelBubble=!0})),e.on("mouseenter",(()=>{this._showDragAnchorCursor(),e.setAttrs({fill:s.Jc,stroke:s.eT})})),e.on("mouseout",(()=>{this._showDefaultCursor(),this._transforming||e.setAttrs({fill:s.y4,stroke:s.es})}))}}},50477:(e,t,i)=>{"use strict";i.d(t,{b:()=>s});var r=i(48737);function s(e){return"string"==typeof e?r.A4.getTRId([e]):e.length<0?void 0:r.A4.getTRId(e)}},75265:(e,t,i)=>{var r={"./2d-lut-color-filter/filter.frag.glsl":[16214,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./2d-lut-color-filter/filter.vertex.glsl":[34114,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-adjust/adjust.frag.glsl":[87024,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-adjust/adjust.vertex.glsl":[97107,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-adjust/lut.png":[67354,1,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-adjust/output.frag.glsl":[69276,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-adjust/output.vertex.glsl":[17544,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-color-scheme/filter.frag.glsl":[84247,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-color-scheme/filter.vertex.glsl":[985,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-grain/grain.frag.glsl":[8017,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-grain/grain.vertex.glsl":[37455,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-grain/texture.png":[2400,1,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-oil-texture/texture.frag.glsl":[9114,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-oil-texture/texture.png":[69224,1,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873],"./image-oil-texture/texture.vertex.glsl":[46969,9,592,444,425,29,542,430,294,922,377,52,435,774,54,880,375,933,188,408,611,429,634,458,550,873]};function s(e){if(!i.o(r,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],s=t[0];return Promise.all(t.slice(2).map(i.e)).then((()=>i.t(s,16|t[1])))}s.keys=()=>Object.keys(r),s.id=75265,e.exports=s},6430:(e,t,i)=>{"use strict";e.exports=i.p+"static/image/default.0887dfcf.png"}}]);