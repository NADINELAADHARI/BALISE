"use strict";(globalThis.webpackChunkgraphic=globalThis.webpackChunkgraphic||[]).push([[164],{64700:(e,t,i)=>{i.d(t,{Z:()=>p});var r=i(14552),s=i(5789),n=i.n(s),o=i(18571),a=i(72322);const l=(e,t)=>{const{isSiderCollapsed:i,className:r,style:s}=e;return(0,a.jsxs)("div",{className:n()("graphic-layout-sider",{"is-collapsed":i},r),style:s,ref:t,children:[(0,a.jsx)("div",{className:"menu-list","lv-theme-version":"2.0","data-lv-theme-force":"dark"}),(0,a.jsx)("div",{className:n()("layout-container"),"lv-theme-version":"2.0","data-lv-theme-force":"dark",children:null})]})},h=(0,o.forwardRef)(l);var c=i(66094);const d=()=>(0,a.jsx)(c.Z,{className:"layout-header-skeleton-container",children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.Z.Image,{className:"cover",style:{width:100,height:40}},0),(0,a.jsx)(c.Z.Image,{className:"cover",style:{width:184,height:40}},1),(0,a.jsx)(c.Z.Image,{className:"cover",style:{width:100,height:40}},2)]})}),u="sider-BZOzKk",g="container-kx0mOO",_="header-sPsVAq",p=e=>{const{readonly:t}=e;return(0,a.jsxs)(r.Z,{id:"graphic-ssr-container",className:n()("apps-graphic-container",g),style:{},children:[t?null:(0,a.jsx)(r.Z.Sider,{className:u,collapsed:!1,collapsedWidth:356,trigger:null,theme:"dark",children:(0,a.jsx)(h,{onSiderFadeInLeft:()=>{},isSiderCollapsed:!1,updateSidebarWidth:()=>{}})}),(0,a.jsxs)(r.Z.Content,{children:[(0,a.jsx)("div",{className:_,children:(0,a.jsx)(d,{})}),(0,a.jsx)("div",{className:"container"})]})]})}},61418:(e,t,i)=>{i.d(t,{R:()=>n});var r=i(27175),s=i(73842);function n(){s.Z.warning({content:r.ZP.t("web_graphic_server_failure_title",{},"Server exception")})}},92043:(e,t,i)=>{i.d(t,{Z:()=>p});var r=i(18571),s=i(78933),n=i(27175),o=i(59126),a=i(92204),l=i(8757);const h=function(e){const t=(0,r.useRef)(),i=(0,r.useRef)(),s=(0,r.useCallback)((e=>{const t=document.querySelector(`.${l.xv}-mask`);if(!t)return;const i=parseInt(t.style.borderBottomWidth,10)-e+"px";t.style.borderBottomWidth=i}),[]),n=(0,r.useCallback)((e=>{const t=document.querySelector(e),i=t.offsetHeight,r=t.parentNode,n=t.offsetTop,o=r.offsetHeight-n-i-8;s(o)}),[]),o=(0,r.useCallback)((()=>{const e=document.querySelector(`div[data-id=${l.tR}]`);if(!e)return;const r=e.cloneNode(!0);r.classList.add("header-editor-export-clone"),document.body.appendChild(r);const{top:s,left:n,width:o,height:a}=e.getBoundingClientRect(),h=window.innerWidth-n-o-0;Object.assign(r.style,{top:`${s}px`,right:`${h}px`,width:`${o}px`,height:`${a}px`,visibility:"hidden"}),t.current=e,i.current=r}),[]),a=(0,r.useCallback)((()=>{document.querySelector(`.${l.xv}-mask`).classList.add("guid-export"),t.current.style.visibility="hidden",i.current.style.visibility="visible"}),[]),h=(0,r.useCallback)((()=>{t.current&&i.current&&(t.current.style.visibility="visible",i.current.remove())}),[]);(0,r.useEffect)((()=>{1===e&&o(),2===e&&n(`#${l.s4.MATERIAL_EVER_CLOUD}`),3===e&&a(),-1===e&&h()}),[e]),(0,r.useEffect)((()=>{if(!t.current)return;const e=()=>{const{left:e}=t.current.getBoundingClientRect();Object.assign(i.current.style,{left:`${e}px`})};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[t,e])};var c=i(25629),d=i(5789),u=i.n(d),g=i(5100),_=(i(84377),i(72322));function p({userId:e,graphicSDKApi:t,showNextGuide:i,showGoogleDriveGuide:d}){const[p,f]=(0,r.useState)(!1),[m,v]=(0,r.useState)(""),[y,x]=(0,r.useState)(0),[b,w]=(0,r.useState)(!0),[C,I]=(0,r.useState)(!0),L=(0,r.useMemo)((()=>`${l.oI}${e}`),[e]);h(y);const R=(0,r.useMemo)((()=>`${l.Y0}${e}`),[e]),E=(0,r.useMemo)((()=>d&&!localStorage.getItem(R)),[d,R]),M=(0,r.useMemo)((()=>E?[{title:n.ZP.t("web_marketplace_text_from_google_drive",{},"Upload media from Google Drive"),content:n.ZP.t("web_marketplace_text_valid_from_google",{},"You\u2019ve already linked a Google Drive account. You can upload media from Google Drive."),placement:"right",selector:()=>document.querySelector(".guide-google-drive-btn"),offset:{x:0,y:0}}]:[]),[E]),S=(0,r.useMemo)((()=>M.concat([{title:b?n.ZP.t("web_guide_text_choose_a_template"):n.ZP.t("web_guide_title_replace_the_template"),content:b?n.ZP.t("web_guide_text_drag_a_template"):n.ZP.t("web_guide_text_replace_the_template"),placement:"right",selector:()=>document.querySelector(`#${l.s4.MATERIAL_TEMPLATES}`),offset:{x:9,y:0}},{title:n.ZP.t("web_guide_title_improve_your_design"),selector:()=>document.querySelector(`#${l.s4.MATERIAL_DESIGN}`),content:n.ZP.t("web_guide_text_improve_your_design"),placement:"right",offset:{x:9,y:0}},{title:n.ZP.t("web_guide_title_add_more_elements"),selector:()=>document.querySelector(`#${l.s4.MATERIAL_EVER_CLOUD}`),content:n.ZP.t("web_guide_text_add_more_elements"),placement:"right",offset:{x:9,y:130}},{title:n.ZP.t("web_guide_button_export_image"),selector:()=>document.querySelector(".header-editor-export-clone"),content:n.ZP.t("web_guide_text_export_image"),placement:"bottom-right",offset:{x:0,y:4}}])),[b,M]);(0,r.useEffect)((()=>{if(!e||null==t||!t.document)return;const i=c.Z.interact.onModelInitFinish.event((()=>{const e=t.document.getLayersByFilter(!0,(()=>!0));w(!(null!=e&&e.length))}));if(E){var r;const e=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});null===(r=document.querySelector(".guide-google-drive-upload"))||void 0===r||r.dispatchEvent(e)}return f(!0),()=>i()}),[t,e,E]);const{ready:A}=(0,g.Z)({dependence:[p],delay:500});return(0,r.useEffect)((()=>{A&&m&&(0,o.PI)(a.WA.SHOW,y)}),[A]),(0,r.useEffect)((()=>{A&&localStorage.getItem(L)&&i()}),[A,L]),(0,_.jsx)(_.Fragment,{children:(0,_.jsx)(s.ZP,{visible:p,closable:!0,steps:S,localKey:L,mask:!0,modalClassName:u()(`${l.xv}-modal`,`step-${y}`,{[`${l.xv}-modal__hide`]:!C,[`${l.xv}-modal__ready`]:A}),maskClassName:u()(`${l.xv}-mask`,{[`${l.xv}-mask__ready`]:A}),stepText:()=>m,beforeStepChange:e=>{(E?3===e:2===e)&&I(!1)},afterStepChange:e=>{v(`${e+1} of ${S.length}`),x(e),I(!0),(0,o.gi)(e>y,y)},onClose:()=>{(0,o.TG)(y),x(-1),i(),E&&localStorage.setItem(R,"true")},showSkipBtn:y!==S.length-1,nextText:n.ZP.t("web_guide_button_next",{},"Next"),okText:n.ZP.t("web_guide_button_got_it",{},"Got it"),skipText:n.ZP.t("web_guide_button_skip",{},"Skip")})})}},34702:(e,t,i)=>{i.d(t,{z:()=>d});var r=i(8757),s=i(78933),n=i(27175),o=i(18571),a=i(5789),l=i.n(a),h=(i(84377),i(5100)),c=i(72322);const d=e=>{const{userId:t,showNextGuide:i}=e,[a,d]=(0,o.useState)(!1),u=(0,o.useMemo)((()=>`${r.Y0}${t}`),[t]),g=(0,o.useMemo)((()=>`${r.oI}${t}`),[t]),_=(0,o.useRef)(!1),{ready:p}=(0,h.Z)({dependence:[a],delay:500}),f=(0,o.useMemo)((()=>[{title:n.ZP.t("web_marketplace_text_from_google_drive",{},"Upload media from Google Drive"),content:n.ZP.t("web_marketplace_text_valid_from_google",{},"You\u2019ve already linked a Google Drive account. You can upload media from Google Drive."),placement:"right",selector:()=>document.querySelector(".guide-google-drive-btn"),offset:{x:0,y:0}}]),[]);return(0,o.useEffect)((()=>{if(localStorage.getItem(g)&&!localStorage.getItem(u)){var e;const t=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});null===(e=document.querySelector(".guide-google-drive-upload"))||void 0===e||e.dispatchEvent(t)}d(!0)}),[a,g,u]),(0,o.useEffect)((()=>{p&&localStorage.getItem(u)&&i()}),[p,u]),(0,c.jsx)(s.ZP,{stepText:()=>"",visible:a,closable:!0,steps:f,localKey:u,mask:!0,modalClassName:l()(`${r.xv}-modal`,{[`${r.xv}-modal__ready`]:p}),maskClassName:l()(`${r.xv}-mask`,{[`${r.xv}-mask__ready`]:p}),okText:n.ZP.t("web_marketplace_button_got_it",{},"OK"),onClickOk:()=>{_.current=!0},onClose:()=>{const e=setTimeout((()=>{_.current,clearTimeout(e)}),100);i()},stopPropagation:!0})}},14460:(e,t,i)=>{i.d(t,{t:()=>u});var r=i(8757),s=i(78933),n=i(27175),o=i(18571),a=i(5789),l=i.n(a),h=(i(84377),i(5100)),c=i(37180),d=i(72322);const u=e=>{const{userId:t,spaceCount:i,spaceName:a}=e,u=(0,o.useMemo)((()=>i>=2),[i]),g=(0,o.useMemo)((()=>`${r.lN}_${t}`),[t]),_=(0,o.useRef)(!1),{ready:p}=(0,h.Z)({dependence:[],delay:500}),f=(0,o.useMemo)((()=>[{title:n.ZP.t("web_default_space_title_switch_space",{},"Switch space"),content:n.ZP.t("web_default_space_desc_switch_space",{string0:null!=a?a:"MySpace",strong0:e=>(0,d.jsx)("strong",{children:e},`${e}-${Math.random()}`)},"Your project will be saved to {string0}, or you can save it to another space. You can also set a default space in <strong0>Spaces</strong0>"),placement:"bottom-left",selector:()=>document.querySelector(".draft-save-status-container"),offset:{x:-12,y:6}}]),[a]);return(0,o.useEffect)((()=>{p&&u&&!localStorage.getItem(g)&&(0,c.No)("show")}),[p,u,g]),(0,d.jsx)(s.ZP,{stepText:()=>"",visible:u,closable:!0,steps:f,localKey:g,mask:!0,modalClassName:l()(`${r.xv}-modal`,{[`${r.xv}-modal__ready`]:p}),maskClassName:l()(`${r.xv}-guide-space-mask`,{[`${r.xv}-mask__ready`]:p}),okText:n.ZP.t("web_default_space_btn_ok",{},"OK"),onClickOk:()=>{_.current=!0,(0,c.No)("got_it")},onClose:()=>{const e=setTimeout((()=>{_.current||(0,c.No)("close"),clearTimeout(e)}),100)},stopPropagation:!0})}},5100:(e,t,i)=>{i.d(t,{Z:()=>s});var r=i(18571);const s=function(e){const{dependence:t=[],delay:i}=e,[s,n]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{if(t.length>0&&!t.every(Boolean))return;let e=null;const r=()=>{n(!0)};return i&&"number"==typeof i&&i>0?e=window.setTimeout(r,i):Promise.resolve().then(r),()=>{null!==e&&clearTimeout(e)}}),[i,t]),{ready:s}}},36161:(e,t,i)=>{i.d(t,{e:()=>n});var r=i(27175),s=i(36702);function n(){s.Z.error({title:r.ZP.t("web_graphic_server_failure_title",{},"Server exception"),content:r.ZP.t("web_graphic_server_failure_content",{},"Your project ran into a problem, please refresh to reload page."),okText:r.ZP.t("web_graphic_server_failure_refresh_page_btn",{},"Refresh page"),okButtonProps:{type:"primary"},closable:!1,escToExit:!1,maskClosable:!1,onOk:()=>{window.location.reload()}})}},41575:(e,t,i)=>{i.d(t,{Z:()=>r});class r{constructor(e){this.isActived=!1,this.canvas=e}toActived(){this.isActived||(this.isActived=!0,this.addActivedEvents())}toDeactivated(){this.isActived&&(this.isActived=!1,this.removeActivedEvents())}}},6899:(e,t,i)=>{i.d(t,{Z:()=>g});var r=i(41575),s=i(48607),n=i(10224),o=i(72918),a=i(7063),l=i(73178),h=i(50477),c=i(46436),d=i(63345),u=i(58992);class g extends r.Z{constructor(){super(...arguments),this._createImage=(e,t,i)=>{var r,s,n;const{x:o,y:l,rotation:h,scaleX:c,scaleY:d}=e,g=this.canvas.getLayer(),_=a.Z.container(null,{x:o,y:l,scaleX:c,scaleY:d,rotation:h}),p={...i,layout:{...i.layout,x:0,y:0,rotation:0,scale:{x:1,y:1}},pixels:this.canvas.getRenderer().getMainRenderer().getPixel(),zoom:this.canvas.getRenderer().getMainRenderer().getZoom()},f=new u.b(p);if(f.render(_),this._interCropImage=f.element,g.add(_),!this._cropLimitBox)throw new Error("image container cut out, this._cropLimitBox not exist");const m=null===(r=this._cropLimitBox)||void 0===r?void 0:r.getAbsolutePosition(),v=null===(s=this._cropLimitBox)||void 0===s?void 0:s.getAbsoluteScale(),{width:y,height:x}=this._cropLimitBox.size(),b={x:null==m?void 0:m.x,y:null==m?void 0:m.y,rotation:h*Math.PI/180,width:y*v.x,height:x*v.y};return this._posTransformer=this._createPosTransformer(b,this._interCropImage),this._posTransformer&&t.add(this._posTransformer),null===(n=this._posTransformer)||void 0===n||n.moveDown(),{destroy:()=>{var e,t;null===(e=this._posTransformer)||void 0===e||e.unselect(),null===(t=this._posTransformer)||void 0===t||t.destroy(),_.destroy(),this._interCropImage=null},update:()=>{const e=this._cropImage,t=this._cropLimitBox;if(!e||!t)return;const i=this._calculateCutOutConfig(e);if(!i)return;const{x:r,y:s,scaleX:n,scaleY:o}=i;_.setAttrs({x:r,y:s,scaleX:n,scaleY:o})}}},this._createCropLayer=(e,t)=>{const{x:i,y:r,width:o,height:l,rotation:h,scaleX:c,scaleY:u}=e,g=a.Z.layer(null);g.getNativeCanvasElement().style.zIndex=String(s.SA+1),this._createMask(g,t);const _=n.U.scalePath({width:o,height:l,path:this.getClipPathData()||""}),p=a.Z.containerWithClipPath(g,{x:i,y:r,rotation:h,width:o,height:l,scaleX:c,scaleY:u,clipPath:new Path2D(_)});return a.Z.rect(p,{x:0,y:0,width:o,height:l,fill:"rgba(255, 255, 255, 1)",globalCompositeOperation:"destination-out",listening:!1}),a.Z.path(p,{x:0,y:0,width:o,height:l,stroke:d.Jc,strokeWidth:4,data:_,listening:!1,strokeScaleEnabled:!1,hitFunc:()=>null}),g&&this.canvas.getRenderer().stage.container.add(g),{destroy:()=>{g.destroy()},update:()=>{const e=this._cropItem;if(!e)return;const t=this._calculateCutOutConfig(e);if(!t)return;const{x:i,y:r,scaleX:s,scaleY:n}=t;p.setAttrs({x:i,y:r,scaleX:s,scaleY:n})},cropLayer:g}}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._cutOutContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this)}addActivedEvents(){}removeActivedEvents(){}getCropRect(){var e;return null===(e=this._cropLimitBox)||void 0===e?void 0:e.getClientRect()}closeCrop(){var e;this._isOpen&&(this._isOpen=!1,this.setOriginImageVisible(!0),null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this))}onAdjustStart(e){var t,i;null===(t=this._cropLimitBox)||void 0===t||t.on("transformstart dragstart",e),null===(i=this._interCropImage)||void 0===i||i.on("transformstart dragstart",e)}onAdjustEnd(e){var t,i;null===(t=this._cropLimitBox)||void 0===t||t.on("transformend dragend",e),null===(i=this._interCropImage)||void 0===i||i.on("transformend dragend",e)}setOriginImageVisible(e){var t,i;const r=null===(t=this._cropItem)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._cropItem)||void 0===i||i.visible(e);const s=(0,h.b)(r);if(!s)return;const n=this.canvas.findByID(s);null==n||n.visible(e)}getClipPathData(){}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage,s=a.Z.rect(e,{fill:(0,o.G)()?d.PY:d.AI,x:0,y:0,width:i,height:r});return s.on("click",t),s}_createLimitBox(e){const t=this._cropImage.getAbsoluteRotation(),i=this.getClipPathData(),r={...this._calculateLimitBoxLayout(this._cropItem,t,i),stroke:"red",strokeWidth:1,listening:!1,opacity:1,scale:{x:1,y:1}},s=a.Z.rect(null,r);return this._cropLimitBox=s,{destroy:()=>{var e;null===(e=this._cropLimitBox)||void 0===e||e.destroy(),this._cropLimitBox=null},update:()=>{var e;const r=this._cropItem;if(!r||!this._cropLimitBox||!this._posTransformer)return;const s=this._calculateLimitBoxLayout(r,t,i);this._cropLimitBox.setAttrs({...s}),this._posTransformer.setCropBox({...s,rotation:(null!==(e=null==s?void 0:s.rotation)&&void 0!==e?e:0)*Math.PI/180})},cropLimitBox:s}}_createPosTransformer(e,t){if(!t)return;const i=new l.x({cropBox:e,disableDraggable:!1,flipEnabled:!1,enableRotater:!1,renderSDK:this.canvas.getRenderer()});return i.select(t),i.on("dragstart transformstart",(()=>{})),i.on("dragend transformend",(()=>{var e;null===(e=this._cutOutContainerUpdaterHelper)||void 0===e||e.call(this)})),i}_calculateCutOutConfig(e){const{x:t,y:i}=e.getAbsoluteScale(),{x:r,y:s}=e.getAbsolutePosition();return{x:r,y:s,rotation:e.getAbsoluteRotation(),width:e.width(),height:e.height(),scaleX:t,scaleY:i}}_getBox(e,t){const i=e.getAbsolutePosition(),r=e.getAbsoluteScale(),s=e.width()*r.x,n=e.height()*r.y,o=void 0!==t?t:e.getAbsoluteRotation(),a=o*Math.PI/180,l={...i,width:s,height:n,rotation:a},{x:h,y:d}=(0,c.Pl)(l,-a);return{x:h,y:d,width:s,height:n,scale:r,rotation:o}}_calculateLimitBoxLayout(e,t,i){if(!e)return;const{x:r,y:s}=e.getAbsolutePosition(),{x:o,y:a}=e.getAbsoluteScale(),l=e.width()*o,h=e.height()*a,d=e.getAbsoluteRotation(),u=t-d,{pathBox:g,ltPointOffset:_}=n.U.getPathBoxOfRotation(u,l,h,i),p=(0,c._1)({..._},u*Math.PI/180,{x:l/2,y:h/2}),f=d*Math.PI/180,m={x:r,y:s,width:l,height:h,rotation:f},v=(0,c.$D)(m,-f,{x:0,y:0}),y={x:v.x+p.x,y:v.y+p.y};return{...(0,c._1)(y,f,{x:0,y:0}),...g,rotation:t}}}},42476:(e,t,i)=>{i.d(t,{Z:()=>l});var r=i(50477),s=i(11005),n=i(8757),o=i(6899),a=i(46436);class l extends o.Z{constructor(){super(...arguments),this.openCrop=async e=>{var t,i;if(this._isOpen)return;this._isOpen=!0;const{id:r,index:n}=e,o=this.canvas.getRenderer().findByID(r);if(!o)return;this._id=r,this._index=n,this._grid=o;const a=null===(t=o.children)||void 0===t?void 0:t[n+1];if(!a)return;this._cropItem=a;const l=null===(i=a.children)||void 0===i?void 0:i[0];if(!l)return;this._cropImage=l;const h=this._calculateCutOutConfig(a),c=this._calculateCutOutConfig(l);c&&h&&(this.setOriginImageVisible(!1),await this._createCutOutContainer(c,h,e));const{onCropAdjustEnd:d,onCropAdjustStart:u}=e;d&&this.onAdjustEnd(d),u&&this.onAdjustStart(u),this._grid.fire(s.qB.cropstart)},this.confirmCrop=e=>{if(!(this._cropItem&&this._cropLimitBox&&this._interCropImage&&this._cropImage))return;if(!this.canvas.getRenderer().accessors.grid.getSelectImageByIndex(this._id||"",this._index))throw new Error("image container cut out, imageData not exist");const t=this._getImageBox(this._interCropImage,this._cropItem.getAbsoluteRotation()),i=this._getItemBox(this._cropItem),r={x:(t.x-i.x)/i.scale.x,y:(t.y-i.y)/i.scale.y,width:t.width/i.scale.x,height:t.height/i.scale.y};this._cropImage.setAttrs({...r}),e({...r}),this.setOriginImageVisible(!0),this.closeCrop()},this._createCutOutContainer=async(e,t,i)=>{const{destroy:r,update:s,cropLayer:n}=this._createCropLayer(t,i.onClickMask),{destroy:o,update:a}=this._createLimitBox(n),l=this.canvas.getRenderer().accessors.grid.getSelectImageByIndex(this._id||"",this._index);if(!l)throw new Error("image container cut out, imageData not exist");const{destroy:h,update:c}=await this._createImage(e,n,l);this._disposeCutOutContainer=()=>{h(),r(),o(),delete this._cutOutContainerUpdaterHelper,delete this._disposeCutOutContainer},this._cutOutContainerUpdaterHelper=()=>{a(),s(),c()}}}closeCrop(){var e;super.closeCrop(),null===(e=this._grid)||void 0===e||e.fire(s.qB.cropend)}setOriginImageVisible(e){var t,i;const s=null===(t=this._grid)||void 0===t?void 0:t.id();if(!s)return;null===(i=this._cropItem)||void 0===i||i.visible(e);const n=(0,r.b)(s);if(!n)return;const o=this.canvas.findByID(n);null==o||o.visible(e)}getClipPathData(){var e,t;if(!this._cropItem)return;const i=this.canvas.getRenderer().getMainRenderer().getMaterialWidget(null!==(e=this._id)&&void 0!==e?e:"");if(!i||i.type!==n.Wq.GRID)return;const{areaId:r}=this._cropItem.attrs;return void 0!==r&&i?null===(t=i.getAreaLayoutById(r))||void 0===t?void 0:t.path:void 0}_getImageBox(e,t){const i=e.getAbsolutePosition(),r=e.getAbsoluteScale(),s=e.width()*r.x,n=e.height()*r.y,o=e.getAbsoluteRotation(),l=o-t,h=(o-t)*Math.PI/180,c={...i,width:s,height:n,rotation:o*Math.PI/180},{x:d,y:u}=(0,a.Pl)(c,-h);return{...(0,a._1)({x:d,y:u},-t*Math.PI/180,{x:0,y:0}),width:s,height:n,scale:r,rotation:l}}_getItemBox(e){const t=e.getAbsolutePosition(),i=e.getAbsoluteScale(),r=e.width()*i.x,s=e.height()*i.y,n=e.getAbsoluteRotation(),o=n*Math.PI/180,l={...t,width:r,height:s,rotation:o},{x:h,y:c}=(0,a.$D)(l,-o,{x:0,y:0});return{x:h,y:c,width:r,height:s,scale:i,rotation:n}}}l.Name="gridCutOut"},79399:(e,t,i)=>{i.d(t,{Z:()=>h});var r=i(41575),s=i(72918),n=i(7063),o=i(11005),a=i(63345),l=i(50477);class h extends r.Z{constructor(){super(...arguments),this.openReplace=e=>{var t;if(this._isOpen)return;this._isOpen=!0;const{id:i,index:r}=e;this._id=i,this._index=r;const s=this.canvas.getRenderer().findByID(i);if(!s)return;this._grid=s;const n=null===(t=s.children)||void 0===t?void 0:t[r+1];n&&(this._replaceItem=n,this._setOriginImageVisible(!1),this._create(e),this._grid.fire(o.qB.replacestart))},this.closeReplace=()=>{var e,t;this._isOpen&&(this._isOpen=!1,this._setOriginImageVisible(!0),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this),null===(t=this._grid)||void 0===t||t.fire(o.qB.replaceend))}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._replaceContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}addActivedEvents(){}removeActivedEvents(){}getImageSrc(e,t){var i,r,s,n;let o=this._grid;(null===(i=this._grid)||void 0===i?void 0:i.id())!==e&&(o=this.canvas.getRenderer().findByID(e));const a=null===(r=o)||void 0===r||null===(r=r.children)||void 0===r?void 0:r[t+1],l=null==a||null===(s=a.children)||void 0===s?void 0:s[0];return null==l||null===(n=l.attrs.image)||void 0===n?void 0:n.src}_calculateDropImageConfig(e){const{width:t,height:i}=e.size(),{x:r,y:s}=e.getAbsolutePosition(),{x:n,y:o}=e.getAbsoluteScale();return{x:r,y:s,width:t,height:i,scale:{x:n,y:o},rotation:e.getAbsoluteRotation()}}_createDropGrid(e,t){const i=this._calculateDropImageConfig(e.parent),r=e.clone();null==r||r.setAttrs({isReplace:!0,visible:!0,draggable:!1});const s=n.Z.container(t);return null==s||s.setAttrs({...i,visible:!0}),n.Z.rect(s,{...null==r?void 0:r.getAttrs(),id:"",type:"",stroke:a.Jc,strokeWidth:2,strokeScaleEnabled:!1}),s.add(r),()=>{const e=this._calculateDropImageConfig(r.parent);s.setAttrs({...e})}}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage;n.Z.rect(e,{fill:(0,s.G)()?a.PY:a.AI,x:0,y:0,width:i,height:r}).on("click",t)}async _create(e){const{onClickMask:t}=e,i=this._replaceItem;if(!i)return;const r=this.canvas.getLayer(),s=n.Z.container(r);this._createMask(s,t);const o=await this._createDropGrid(i,s);this._disposeReplaceContainer=()=>{s.destroy(),delete this._disposeReplaceContainer,delete this._replaceContainerUpdaterHelper},this._replaceContainerUpdaterHelper=()=>{o()}}_setOriginImageVisible(e){var t,i;const r=null===(t=this._grid)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._replaceItem)||void 0===i||i.visible(e);const s=(0,l.b)(r);if(!s)return;const n=this.canvas.findByID(s);null==n||n.visible(e)}}h.Name="gridReplace"},35962:(e,t,i)=>{i.d(t,{Z:()=>a});var r=i(50477),s=i(11005),n=i(6899),o=i(46436);class a extends n.Z{constructor(){super(...arguments),this.openCrop=async e=>{var t,i;if(this._isOpen)return;this._isOpen=!0;const{id:r,index:n}=e,o=this.canvas.getRenderer().findByID(r);if(!o)return;this._id=r,this._index=n,this._imageContainer=o;const a=null===(t=o.children)||void 0===t?void 0:t[n+1];if(!a)return;this._cropItem=a;const l=null===(i=a.children)||void 0===i?void 0:i[0];if(!l)return;this._cropImage=l;const h=this._calculateCutOutConfig(a),c=this._calculateCutOutConfig(l);c&&h&&(this.setOriginImageVisible(!1),await this._createCutOutContainer(c,h,e));const{onCropAdjustEnd:d,onCropAdjustStart:u}=e;d&&this.onAdjustEnd(d),u&&this.onAdjustStart(u),this._imageContainer.fire(s.qB.cropstart)},this.confirmCrop=e=>{if(!(this._cropItem&&this._cropLimitBox&&this._interCropImage&&this._cropImage))return;if(!this.canvas.getRenderer().accessors.imageContainer.getSelectImage(this._id||"",this._index))throw new Error("image container cut out, imageData not exist");const t=this._getImageBox(this._interCropImage,this._cropItem.getAbsoluteRotation()),i=this._getItemBox(this._cropItem),r={x:(t.x-i.x)/i.scale.x,y:(t.y-i.y)/i.scale.y,width:t.width/i.scale.x,height:t.height/i.scale.y};this._cropImage.setAttrs({...r}),e({...r}),this.setOriginImageVisible(!0),this.closeCrop()},this._createCutOutContainer=async(e,t,i)=>{const{destroy:r,update:s,cropLayer:n}=this._createCropLayer(t,i.onClickMask),{destroy:o,update:a}=this._createLimitBox(n),l=this.canvas.getRenderer().accessors.imageContainer.getSelectImage(this._id||"",this._index);if(!l)throw new Error("image container cut out, imageData not exist");const{destroy:h,update:c}=await this._createImage(e,n,l);this._disposeCutOutContainer=()=>{h(),r(),o(),delete this._cutOutContainerUpdaterHelper,delete this._disposeCutOutContainer},this._cutOutContainerUpdaterHelper=()=>{a(),s(),c()}}}closeCrop(){var e;super.closeCrop(),null===(e=this._imageContainer)||void 0===e||e.fire(s.qB.cropend)}setOriginImageVisible(e){var t,i;const s=null===(t=this._imageContainer)||void 0===t?void 0:t.id();if(!s)return;null===(i=this._cropItem)||void 0===i||i.visible(e);const n=(0,r.b)(s);if(!n)return;const o=this.canvas.findByID(n);null==o||o.visible(e)}getClipPathData(){var e;if(!this._cropItem)return;const{id:t,index:i}=this._cropItem.attrs;if(!t)return;const r=this.canvas.getRenderer().model.getLayerById(t.split("-")[0]);return null==r||null===(e=r.items[i])||void 0===e?void 0:e.path}_getImageBox(e,t){const i=e.getAbsolutePosition(),r=e.getAbsoluteScale(),s=e.width()*r.x,n=e.height()*r.y,a=e.getAbsoluteRotation(),l=a-t,h=(a-t)*Math.PI/180,c={...i,width:s,height:n,rotation:a*Math.PI/180},{x:d,y:u}=(0,o.Pl)(c,-h);return{...(0,o._1)({x:d,y:u},-t*Math.PI/180,{x:0,y:0}),width:s,height:n,scale:r,rotation:l}}_getItemBox(e){const t=e.getAbsolutePosition(),i=e.getAbsoluteScale(),r=e.width()*i.x,s=e.height()*i.y,n=e.getAbsoluteRotation(),a=n*Math.PI/180,l={...t,width:r,height:s,rotation:a},{x:h,y:c}=(0,o.$D)(l,-a,{x:0,y:0});return{x:h,y:c,width:r,height:s,scale:i,rotation:n}}}a.Name="imageContainerCutOut"},97701:(e,t,i)=>{i.d(t,{Z:()=>h});var r=i(41575),s=i(72918),n=i(7063),o=i(11005),a=i(63345),l=i(50477);class h extends r.Z{constructor(){super(...arguments),this.openReplace=e=>{var t;if(this._isOpen)return;this._isOpen=!0;const{id:i,index:r}=e;this._id=i,this._index=r;const s=this.canvas.getRenderer().findByID(i);if(!s)return;this._imageContainer=s;const n=null===(t=s.children)||void 0===t?void 0:t[r+1];n&&(this._replaceItem=n,this._setOriginImageVisible(!1),this._create(e),this._imageContainer.fire(o.qB.replacestart))},this.closeReplace=()=>{var e,t;this._isOpen&&(this._isOpen=!1,this._setOriginImageVisible(!0),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this),null===(t=this._imageContainer)||void 0===t||t.fire(o.qB.replaceend))}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._replaceContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}addActivedEvents(){}removeActivedEvents(){}getImageSrc(e,t){var i,r,s,n;let o=this._imageContainer;(null===(i=this._imageContainer)||void 0===i?void 0:i.id())!==e&&(o=this.canvas.getRenderer().findByID(e));const a=null===(r=o)||void 0===r||null===(r=r.children)||void 0===r?void 0:r[t],l=null==a||null===(s=a.children)||void 0===s?void 0:s[0];return null==l||null===(n=l.attrs.image)||void 0===n?void 0:n.src}_calculateDropImageConfig(e){const{width:t,height:i}=e.size(),{x:r,y:s}=e.getAbsolutePosition(),{x:n,y:o}=e.getAbsoluteScale();return{x:r,y:s,width:t,height:i,scale:{x:n,y:o},rotation:e.getAbsoluteRotation()}}_createDropImageContainer(e,t){const i=this._calculateDropImageConfig(e.parent),r=e.clone();null==r||r.setAttrs({isReplace:!0,visible:!0,draggable:!1});const s=n.Z.container(t);return null==s||s.setAttrs({...i,visible:!0}),n.Z.rect(s,{...null==r?void 0:r.getAttrs(),id:"",type:"",stroke:a.Jc,strokeWidth:2,strokeScaleEnabled:!1}),s.add(r),()=>{const t=this._calculateDropImageConfig(e.parent);s.setAttrs({...t})}}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage;n.Z.rect(e,{fill:(0,s.G)()?a.PY:a.AI,x:0,y:0,width:i,height:r}).on("click",t)}async _create(e){const{onClickMask:t}=e,i=this._replaceItem;if(!i)return;const r=this.canvas.getLayer(),s=n.Z.container(r);this._createMask(s,t);const o=await this._createDropImageContainer(i,s);this._disposeReplaceContainer=()=>{s.destroy(),delete this._disposeReplaceContainer,delete this._replaceContainerUpdaterHelper},this._replaceContainerUpdaterHelper=()=>{o()}}_setOriginImageVisible(e){var t,i;const r=null===(t=this._imageContainer)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._replaceItem)||void 0===i||i.visible(e);const s=(0,l.b)(r);if(!s)return;const n=this.canvas.findByID(s);null==n||n.visible(e)}}h.Name="imageConatinerReplace"},53971:(e,t,i)=>{i.d(t,{q:()=>L,Z:()=>E});var r=i(41575),s=i(43382),n=i(6884),o=i(48607),a=i(72918),l=i(7063),h=i(48917),c=i(73178),d=i(48737),u=i(96497),g=i(8757),_=i(46436);const p=1e-4,f=[8,8],m=[g.nh,g.EK,g.ng,g.Z0];class v extends d.A4{constructor(e){super(e),this.keepRatio(!1),e.mode!==L.free&&(this.enabledAnchors(m),this.keepRatio(!0)),this.setAttrs({...u.JM,borderDash:f});const{limitBoundBox:t,resizeLimits:{minHeight:i=0,minWidth:r=0}={},mode:s}=e;this._limitBoundBox=t,this.boundBoxFunc(((e,t)=>{const{rotation:s}=this._limitBoundBox,n=(0,_.qg)(this._limitBoundBox),o=(0,_.$D)(t,-s,n),a=(0,_.$D)(e,-s,n),l=(0,_.$D)(this._limitBoundBox,-s,n),{x:h,y:c,width:d,height:u}=l,{x:g,y:f}=this.getPageScale(),m=this._getNodeRect(),v=m.width/g,y=m.height/f;let x=Math.min(r,v)*g,b=Math.min(i,y)*f;const w=this.sin/this.cos;this.keepRatio()&&(w<1?x=b/w:b=x*w);const C=this.getActiveAnchor()||"";return o.x<h&&(o.width-=h-o.x,o.x=h),o.y<c&&(o.height-=c-o.y,o.y=c),o.x+o.width>h+d&&(o.width=h+d-o.x),o.y+o.height>c+u&&(o.height=c+u-o.y),o.height<b&&(C.indexOf("top")>=0&&(o.y-=b-o.height),C.indexOf("bottom")>=0&&(o.y=a.y),o.height=b),o.width<x&&(C.indexOf("left")>=0&&(o.x-=x-o.width),C.indexOf("right")>=0&&(o.x=a.x),o.width=x),o.x>h+d-x&&(o.x=h+d-x),o.y>c+u-b&&(o.y=c+u-b),this.keepRatio()?(Math.abs(o.width-a.width)<p&&(C.indexOf("top")>=0&&(o.y-=o.width*w-o.height),C.indexOf("bottom")>=0&&(o.y=a.y),o.height=o.width*w),Math.abs(o.height-a.height)<p&&(C.indexOf("left")>=0&&(o.x-=o.height/w-o.width),C.indexOf("right")>=0&&(o.x=a.x),o.width=o.height/w),(0,_.$D)(o,s,n)):(0,_.$D)(o,s,n)}))}setLimitBoundBox(e){this._limitBoundBox={...this._limitBoundBox,...e}}select(e){const{disableDraggable:t}=this.attrs;e.setDraggable(!t),this.nodes([e]),this.setDragBoundFunc(e)}unselect(){super.unselect(),this.nodes([])}setDragBoundFunc(e){e.dragBoundFunc((e=>{const{rotation:t}=this._limitBoundBox,i=(0,_.qg)(this._limitBoundBox),r=(0,_.$D)(this._limitBoundBox,-t,i),{x:s,y:n,width:o,height:a}=r,l=(0,_._1)(e,-t,i),h={x:s,y:n,width:o-this.width(),height:a-this.height()},c={...l};l.x<h.x&&(c.x=h.x),l.y<h.y&&(c.y=h.y);const d=h.x+h.width;l.x>d&&(c.x=d);const u=h.y+h.height;return l.y>u&&(c.y=u),(0,_._1)(c,t,i)}))}}var y=i(50477),x=i(71946),b=i(35429),w=i(11005),C=i(63345),I=i(25629);var L;!function(e){e[e.free=0]="free",e[e.original=1]="original",e[e.oneToOneRatio=2]="oneToOneRatio",e[e.nineToSixteenRatio=3]="nineToSixteenRatio",e[e.sixteenToNineRatio=4]="sixteenToNineRatio",e[e.fourToThreeRatio=5]="fourToThreeRatio",e[e.threeToOneRatio=6]="threeToOneRatio"}(L||(L={}));const R={[L.oneToOneRatio]:1,[L.nineToSixteenRatio]:9/16,[L.sixteenToNineRatio]:16/9,[L.fourToThreeRatio]:4/3,[L.threeToOneRatio]:3};class E extends r.Z{constructor(){super(...arguments),this._serverAutoCropLayerIds=new Set,this._disposeStore=new s.S,this.openCrop=async e=>{if(this._isOpen)return;this._isOpen=!0;const{id:t}=e,i=this.canvas.getRenderer().findByID(t);if(!i)return;this._cropImage=i;const r=this._calculateCropConfig(i);r&&(this._setOriginImageVisible(!1),await this._createCropContainer(i,r,e)),this._anchorsPosCutOverlapHandler();const{onCropAdjustEnd:s,onCropAdjustStart:n}=e;s&&this._onAdjustEnd(s),n&&this._onAdjustStart(n),this._cropImage.fire(w.qB.cropstart)},this.localAutoCrop=e=>{if(!this._cropImage)return;const t=this._cropImage.image(),i=this._calculateCropConfig(this._cropImage);if(i&&t instanceof HTMLImageElement){const r=(0,n.n)(t),{imageOriginWidth:s,imageOriginHeight:o}=i,a=s/t.width,l=o/t.height,h={x:r.x*a,y:r.y*l,width:r.width*a,height:r.height*l};this._doCropWithCropAABB(h,e)}},this.serverAutoCrop=async(e,t,i,r)=>{const s=this.canvas.getRenderer().findByID(t);if(!s)return;const n=this._calculateCropConfig(s);if(!n)return;const o=s.image();if(o){this._setServerAutoCropLoading(t,i);try{const i=await e;if(!i)return;const{originWidth:s,originHeight:a,...l}=i,h=s/o.width,c=a/o.height,d={x:l.x/h,y:l.y/c,width:l.width/h,height:l.height/c};this._hideServerAutoCropLoading(t);const u=Math.max(d.x,0),g=Math.max(d.y,0),_=u+d.width>o.width?o.width-u:d.width,p={x:u,y:g,width:_,height:g+d.height>o.height?o.height-g:d.height},{imageOriginWidth:f,imageOriginHeight:m}=n,v=f/o.width,y=m/o.height,x={x:p.x*v,y:p.y*y,width:p.width*v,height:p.height*y};this._doCropWithCropAABB(x,r)}catch(a){this._hideServerAutoCropLoading(t)}}},this.closeCrop=()=>{var e,t;this._isOpen&&(this._isOpen=!1,this._setOriginImageVisible(!0),null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this),null===(t=this._cropImage)||void 0===t||t.fire(w.qB.cropend))},this.confirmCrop=e=>{var t;if(!this._cropImage||!this._cropRectContainer||!this._interCropImage)return;const i=this._getBox(this._cropRectContainer),r=this._getBox(this._interCropImage),s=this._interCropImage.x(),n=this._interCropImage.y(),o=this._interCropImage.width(),a=this._interCropImage.height(),l=this._interCropImage.scaleX(),h=this._interCropImage.scaleY(),c=this._interCropImage.getAbsoluteScale(),d=this._interCropImage.rotation(),u=i.width/r.width*o,g=i.height/r.height*a,p=(null===(t=this._interCropImage.parent)||void 0===t?void 0:t.getAbsoluteScale())||{x:1,y:1},f=i.x-r.x,m=i.y-r.y,v=f/p.x,y=m/p.y,x={...(0,_.Di)(s,n,v,y,d),width:u,height:g,rotation:d,scale:{x:l,y:h}},w={x:-f/c.x,y:-m/c.y,width:o,height:a},{isFlipX:C,isFlipY:I}=this._cropImage.attrs;C&&(w.x=-(w.width+w.x-x.width)),I&&(w.y=-(w.height+w.y-x.height)),e({...x,...(0,b.W)({x:x.x,y:x.y,rotation:x.rotation,width:x.width,height:x.height,scale:x.scale}),clipRect:w}),this._setOriginImageVisible(!0),this.closeCrop()},this._setServerAutoCropLoading=(e,t)=>{var i;this._serverAutoCropLayerIds.add(e),this.canvas.getRenderer().accessors.image.showLoading(e,t);const r=this._getTransformerByLayerId(e);r&&r.hideAnchor(),this._interCropImage&&this._interCropImage.setAttrs({loading:!0,loadingText:t}),this._isOpen&&(this._posTransformer&&(this._posTransformer.hideAnchor(),this._posTransformer.disableDrag()),null===(i=this._cutTransformer)||void 0===i||i.hideAnchor())},this._hideServerAutoCropLoading=e=>{var t;this._serverAutoCropLayerIds.delete(e),this.canvas.getRenderer().accessors.image.hideLoading(e);const i=this._getTransformerByLayerId(e);i&&i.showAnchor(),this._interCropImage&&this._interCropImage.setAttrs({loading:!1}),this._isOpen&&(this._posTransformer&&(this._posTransformer.showAnchor(),this._posTransformer.enableDrag()),null===(t=this._cutTransformer)||void 0===t||t.showAnchor())},this._handleSelect=()=>{this._serverAutoCropLayerIds.forEach((e=>{const t=this._getTransformerByLayerId(e);t&&t.hideAnchor()}))},this._getTransformerByLayerId=e=>{const t=(0,y.b)(e);if(!t)return;return this.canvas.findByID(t)},this._createImgContainer=(e,t,i)=>{var r,s,n,o,a;const{imageOriginX:h,imageOriginY:c,imageOriginHeight:d,imageOriginWidth:u}=t,g=this.canvas.getLayer(),_=this._getCropContainerLayout(e),p=l.Z.container(null,_);g.add(p);const f=null===(r=this._cropImage)||void 0===r?void 0:r.attrs.isFlipX,m=null===(s=this._cropImage)||void 0===s?void 0:s.attrs.isFlipY,v=e.image(),{image:y}=l.Z.image(p,v,{id:e.id(),x:h,y:c,width:u,height:d,scale:e.scale(),rotation:e.rotation(),isFlipX:f,isFlipY:m});if(this._interCropImage=y,!this._cropRectContainer)throw new Error("image cut out, this._cropRectContainer not exist");const x=null===(n=this._cropRectContainer)||void 0===n?void 0:n.getAbsolutePosition(),b=null===(o=this._cropRectContainer)||void 0===o?void 0:o.getAbsoluteScale(),{width:w,height:C}=this._cropRectContainer.size(),I=this._cropRectContainer.getAbsoluteRotation(),L={x:null==x?void 0:x.x,y:null==x?void 0:x.y,rotation:I*Math.PI/180,width:w*b.x,height:C*b.y};return this._posTransformer=this._createPosTransformer(L,this._interCropImage),this._posTransformer&&i.add(this._posTransformer),null===(a=this._posTransformer)||void 0===a||a.moveDown(),{destroy:()=>{var e,t;null===(e=this._posTransformer)||void 0===e||e.unselect(),null===(t=this._posTransformer)||void 0===t||t.destroy(),p.destroy(),this._interCropImage=void 0},update:()=>{const e=this._cropImage;if(!e||!this._cropRectContainer)return;const t=this._getCropContainerLayout(e);t&&p.setAttrs(t)}}},this._updateTransformer=()=>{var e;if(this._cropRectContainer){var t;const e=this._cropRectContainer.getAbsolutePosition(),i=this._cropRectContainer.getAbsoluteScale(),{width:r,height:s}=this._cropRectContainer.size();null===(t=this._posTransformer)||void 0===t||t.setCropBox({...e,width:r*i.x,height:s*i.y})}const i=this._cropImage,r=this._interCropImage;if(!i||!r)return;const s=r.getAbsolutePosition(),n=r.getAbsoluteScale();null===(e=this._cutTransformer)||void 0===e||e.setLimitBoundBox({...s,width:r.width()*n.x,height:r.height()*n.y}),this._anchorsPosCutOverlapHandler()},this._createCropLayer=(e,t,i)=>{const{imageOriginX:r,imageOriginY:s,imageOriginWidth:n,imageOriginHeight:a}=t,{mode:h,onClickMask:c}=i,d=l.Z.layer(null);d.getNativeCanvasElement().style.zIndex=String(o.SA+1),this._createMask(d,c);const u=this._getCropContainerLayout(e),g=l.Z.container(d,{...u}),p=l.Z.container(g,{x:r,y:s,width:n,height:a,rotation:e.rotation(),scale:e.scale()}),f=this._getModeRect(h,t,e);this._cropRectContainer=l.Z.container(p,{x:f.x,y:f.y,width:f.width,height:f.height,listening:!1}),l.Z.rect(this._cropRectContainer,{x:0,y:0,width:f.width,height:f.height,fill:"rgba(255, 255, 255, 1)",globalCompositeOperation:"destination-out",listening:!1}),this._ticTacToeGrid=this._createTicTacToeGrid(this._cropRectContainer,f.width,f.height);const m={...(0,_.Di)(u.x,u.y,r*u.scale.x,s*u.scale.y,u.rotation),rotation:(u.rotation+e.rotation())*Math.PI/180,width:n*e.scaleX()*u.scale.x,height:a*e.scaleY()*u.scale.y};return this._cutTransformer=this._createCutTransformer(h,m,this._cropRectContainer),g.add(this._cutTransformer),d&&this.canvas.getRenderer().stage.container.add(d),{destroy:()=>{var e,t;null===(e=this._cutTransformer)||void 0===e||e.unselect(),null===(t=this._cutTransformer)||void 0===t||t.destroy(),d.destroy(),this._cropRectContainer=void 0},update:()=>{const e=this._cropImage,t=this._interCropImage;if(!e||!t||!this._cropRectContainer)return;const i=this._getCropContainerLayout(e);i&&g.setAttrs(i)},cropLayer:d}},this._createCropContainer=(e,t,i)=>{const{destroy:r,update:s,cropLayer:n}=this._createCropLayer(e,t,i),{destroy:o,update:a}=this._createImgContainer(e,t,n);this._disposeCutOutContainer=()=>{o(),r(),delete this._cutOutContainerUpdaterHelper,delete this._disposeCutOutContainer},this._cutOutContainerUpdaterHelper=()=>{s(),a(),this._updateTransformer()}},this._anchorsPosCutOverlapHandler=()=>{const e=this._posTransformer,t=this._cutTransformer;if(!e||!t)return;const i=["top-left","top-right","bottom-left","bottom-right"],r=t.getAnchorNode(i),s=e.getAnchorNode(i);i.forEach(((e,t)=>{((e,t)=>{const{x:i,y:r}=e.getAbsolutePosition(),{x:s,y:n}=t.getAbsolutePosition();Math.abs(s-i)<2&&Math.abs(n-r)<2?e.opacity(0):e.opacity(1)})(s[t],r[t])}))},this._getCropContainerLayout=e=>{const{parent:t}=e;if(!t)return{x:0,y:0,rotation:0,scale:{x:1,y:1}};return{...t.getAbsolutePosition(),rotation:t.getAbsoluteRotation(),scale:t.getAbsoluteScale()}}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._cutOutContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeCutOutContainer)||void 0===e||e.call(this)}addActivedEvents(){this._disposeStore.add(I.Z.interact.onMaterialSelect.event((()=>this._handleSelect())))}removeActivedEvents(){this._disposeStore.clear()}getCropRect(){var e;return null===(e=this._cropRectContainer)||void 0===e?void 0:e.getClientRect()}_doCropWithCropAABB(e,t,i){const r=i?this.canvas.getRenderer().findByID(i):this._cropImage;if(!r)return;const s=r.image();if(!s)return;const n=s.width,o=s.height;if(!o||!n)return;const a=r.width()/r.cropWidth(),l=r.height()/r.cropHeight(),h=r.attrs.clipRect||{x:0,y:0,width:n*a,height:o*l},c=e.x+h.x,d=e.y+h.y,u=r.scaleX(),g=r.scaleY(),p=r.x(),f=r.y(),m=r.rotation(),v={...(0,_.Di)(p,f,c*u,d*g,m),width:e.width,height:e.height,rotation:m,scale:{x:u,y:g}},y={x:-e.x,y:-e.y,width:h.width,height:h.height};r.setAttrs({x:v.x,y:v.y,rotation:v.rotation,width:v.width,height:v.height,scale:v.scale,clipRect:y});const w=x.Z.clipRectToImageCrop(r,y);w&&r.crop(w),t({...v,...(0,b.W)({x:v.x,y:v.y,rotation:v.rotation,width:v.width,height:v.height,scale:v.scale}),clipRect:y}),this._setOriginImageVisible(!0),this.closeCrop()}_onAdjustStart(e){var t,i;null===(t=this._cropRectContainer)||void 0===t||t.on("transformstart dragstart",e),null===(i=this._interCropImage)||void 0===i||i.on("transformstart dragstart",e)}_onAdjustEnd(e){var t,i;null===(t=this._cropRectContainer)||void 0===t||t.on("transformend dragend",e),null===(i=this._interCropImage)||void 0===i||i.on("transformend dragend",e)}_setOriginImageVisible(e){var t,i;const r=null===(t=this._cropImage)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._cropImage)||void 0===i||i.visible(e);if(!(0,y.b)(r))return;const s=this._getTransformerByLayerId(r);null==s||s.visible(e)}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage,s=l.Z.rect(e,{fill:(0,a.G)()?C.PY:C.AI,x:0,y:0,width:i,height:r});return s.on("click",t),s}_createTicTacToeGrid(e,t,i){const r=t/3,s=i/3,n={strokeWidth:1,stroke:"white",strokeScaleEnabled:!1},o={...n,y:0,height:i},a={...n,x:0,width:t},h=[l.Z.rect(e,{...o,x:r}),l.Z.rect(e,{...o,x:2*r}),l.Z.rect(e,{...a,y:s}),l.Z.rect(e,{...a,y:2*s})],c={show:()=>h.forEach((e=>e.show())),hide:()=>h.forEach((e=>e.hide()))};return c.hide(),c}_createPosTransformer(e,t){if(!t)return;const i=new c.x({cropBox:e,disableDraggable:!1,flipEnabled:!1,enableRotater:!1,renderSDK:this.canvas.getRenderer()});return i.select(t),i.on("dragstart transformstart",(()=>{var e,t;null===(e=this._cutTransformer)||void 0===e||e.hideAnchor(),null===(t=this._ticTacToeGrid)||void 0===t||t.show()})),i.on("dragend transformend",(()=>{var e,t,i;null===(e=this._cutTransformer)||void 0===e||e.showAnchor(),null===(t=this._cutOutContainerUpdaterHelper)||void 0===t||t.call(this),null===(i=this._ticTacToeGrid)||void 0===i||i.hide()})),i}_createCutTransformer(e,t,i){const r=new v({mode:e,limitBoundBox:t,resizeLimits:{minHeight:g.DW.MIN_HEIGHT,minWidth:g.DW.MIN_WIDTH},disableDraggable:!1,flipEnabled:!1,enableRotater:!1,renderSDK:this.canvas.getRenderer(),createCornerAnchor:e=>{const t=-4,i=-4;let r=0;switch(e){case g.nh:r=0;break;case g.EK:r=90;break;case g.ng:r=-90;break;case g.Z0:r=180}return new h.pK({...d.YB,name:e,rotation:r,sceneFunc(e){e.beginPath(),e.moveTo(t,10),e.arc(-.5,9,3.5,Math.PI,0,!0),e.lineTo(3,3),e.lineTo(10,3),e.arc(9,-.5,3.5,Math.PI/2,1.5*Math.PI,!0),e.lineTo(3,i),e.arc(3,3,7,1.5*Math.PI,Math.PI,!0),e.lineTo(t,3),e.lineTo(t,10),e.fillStrokeShape(this)}})}});return r.select(i),r.on("dragstart transformstart",(()=>{var e,t;null===(e=this._posTransformer)||void 0===e||e.hideAnchor(),null===(t=this._ticTacToeGrid)||void 0===t||t.show()})),r.on("dragend transformend",(()=>{var e,t,i;null===(e=this._posTransformer)||void 0===e||e.showAnchor(),null===(t=this._cutOutContainerUpdaterHelper)||void 0===t||t.call(this),null===(i=this._ticTacToeGrid)||void 0===i||i.hide()})),r}_calculateCropConfig(e){var t,i;const r=null===(t=e.image())||void 0===t?void 0:t.width,s=null===(i=e.image())||void 0===i?void 0:i.height;if("number"!=typeof r||"number"!=typeof s)return;const n=e.scaleX(),o=e.scaleY(),a=x.Z.clipRectToImageCrop(e,e.attrs.clipRect)||{x:0,y:0,width:r,height:s},l=e.width()/a.width,h=e.height()/a.height,c=(0,_.Di)(e.x(),e.y(),-a.x*l*n,-a.y*h*o,e.rotation());return{imageOriginX:c.x,imageOriginY:c.y,imageOriginWidth:r*l,imageOriginHeight:s*h,cropX:a.x*l,cropY:a.y*h}}_getModeRect(e,t,i){const{cropX:r,cropY:s,imageOriginWidth:n,imageOriginHeight:o}=t,a=i.width(),l=i.height();let h=r,c=s,d=a,u=l;if(e===L.free)return{x:h,y:c,width:d,height:u};const g=a/l,_=e===L.original?n/o:R[e];return g<_?(u=d/_,c+=(l-u)/2):(d=u*_,h+=(a-d)/2),{x:h,y:c,width:d,height:u}}_getBox(e,t={x:0,y:0}){const i=e.getAbsolutePosition(),r=e.getAbsoluteScale(),s=e.width()*r.x,n=e.height()*r.y,o=e.getAbsoluteRotation();return{...(0,_._1)({...i},-o*Math.PI/180,t),width:s,height:n}}}E.Name="imageCutOut"},73178:(e,t,i)=>{i.d(t,{x:()=>h});var r=i(46436),s=i(48737),n=i(8757);const o=1e-4,a=["top-left","top-right","bottom-left","bottom-right"];var l;!function(e){e[e.width=0]="width",e[e.height=1]="height"}(l||(l={}));class h extends s.A4{constructor(e){super(e),this._dragBoundFunc=e=>{if(!this.nodes()[0])return e;const{width:t,height:i}=this._getNodeRect(),{rotation:s}=this._cropBox,n=(0,r.qg)(this._cropBox),o=(0,r.$D)(this._cropBox,-s,n),{x:a,y:l,width:h,height:c}=o,d=(0,r._1)(e,-s,n),u=t-h,g=i-c,_={x:a-u,y:l-g,width:u,height:g},p={...d};d.x<_.x&&(p.x=_.x),d.y<_.y&&(p.y=_.y);const f=_.x+_.width;d.x>f&&(p.x=f);const m=_.y+_.height;return d.y>m&&(p.y=m),(0,r._1)(p,s,n)},this.enabledAnchors(a),this.keepRatio(!0),this.shouldOverdrawWholeArea(!0),this._cropBox=e.cropBox,this.boundBoxFunc(((e,t)=>{const{rotation:i}=this._cropBox,s=(0,r.qg)(this._cropBox),a=(0,r.$D)(t,-i,s),h=(0,r.$D)(this._cropBox,-i,s),c=(0,r.$D)(this._getNodeRect(),-i,s),{x:d,y:u,width:g,height:_}=h,{x:p,y:f,width:m,height:v}=c,y=this.sin/this.cos,x=this.getActiveAnchor()||"";let b=0,w=0;const C=u-f,I=d-p,L=v-C-_,R=m-I-g;x.indexOf("top")>=0&&(w=v-C),x.indexOf("left")>=0&&(b=m-I),x.indexOf("bottom")>=0&&(w=C+_),x.indexOf("right")>=0&&(b=I+g);let E=l.width;return x===n.nh&&(E=C<I?l.height:l.width),x===n.EK&&(E=C<R?l.height:l.width),x===n.ng&&(E=L<I?l.height:l.width),x===n.Z0&&(E=L<R?l.height:l.width),Math.abs(a.y-u)>o&&a.y>u&&(a.y=u),Math.abs(a.x-d)>o&&a.x>d&&(a.x=d),E===l.width&&a.width<b&&(a.width=b,a.height=b*y,x===n.nh&&(a.y=f+I*y),x===n.EK&&(a.y=f+R*y)),E===l.height&&a.height<w&&(a.height=w,a.width=w/y,x===n.nh&&(a.x=p+C/y),x===n.ng&&(a.x=p+L/y)),(0,r.$D)(a,i,s)}))}setCropBox(e){this._cropBox={...this._cropBox,...e}}select(e){const{disableDraggable:t}=this.attrs;e.setDraggable(!t),this.nodes([e]),this.setDragBoundFunc(e)}unselect(){super.unselect(),this.nodes([])}setDragBoundFunc(e){this.findOne(`.${n.d7}`).dragBoundFunc(this._dragBoundFunc),e.dragBoundFunc(this._dragBoundFunc)}}},76970:(e,t,i)=>{i.d(t,{Z:()=>h});var r=i(41575),s=i(72918),n=i(7063),o=i(11005),a=i(63345),l=i(50477);class h extends r.Z{constructor(){super(...arguments),this.openReplace=e=>{if(this._isOpen)return;this._isOpen=!0;const{id:t}=e,i=this.canvas.getRenderer().findByID(t);i&&(this._image=i,this._setOriginImageVisible(!1),this._create(e),this._image.fire(o.qB.replacestart))},this.closeReplace=()=>{var e,t;this._isOpen&&(this._isOpen=!1,this._setOriginImageVisible(!0),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this),null===(t=this._image)||void 0===t||t.fire(o.qB.replaceend))}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._replaceContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}addActivedEvents(){}removeActivedEvents(){}getImageSrc(e){var t,i,r;if((null===(t=this._image)||void 0===t?void 0:t.id())===e)return null===(r=this._image.attrs)||void 0===r||null===(r=r.image)||void 0===r?void 0:r.src;const s=this.canvas.getRenderer().findByID(e);return null==s||null===(i=s.attrs)||void 0===i||null===(i=i.image)||void 0===i?void 0:i.src}_calculateDropImageConfig(e){const{width:t,height:i}=e.size(),{x:r,y:s}=e.getAbsolutePosition(),{x:n,y:o}=e.getAbsoluteScale();return{x:r,y:s,width:t,height:i,scale:{x:n,y:o},rotation:e.getAbsoluteRotation()}}_createDropImage(e,t){const i=this._calculateDropImageConfig(e.parent),r=e.clone();null==r||r.setAttrs({visible:!0,draggable:!1});const s=n.Z.container(t);return null==s||s.setAttrs({...i,visible:!0}),s.add(r),n.Z.rect(s,{...null==r?void 0:r.getAttrs(),id:"",type:"",stroke:a.Jc,strokeWidth:2,strokeScaleEnabled:!1,listening:!1}),()=>{const t=this._calculateDropImageConfig(e.parent);null==s||s.setAttrs({...t})}}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage;n.Z.rect(e,{fill:(0,s.G)()?a.PY:a.AI,x:0,y:0,width:i,height:r}).on("click",t)}async _create(e){const{onClickMask:t}=e,i=this._image;if(!i)return;const r=this.canvas.getLayer(),s=n.Z.container(r);this._createMask(s,t);const o=await this._createDropImage(i,s);this._disposeReplaceContainer=()=>{s.destroy(),delete this._disposeReplaceContainer,delete this._replaceContainerUpdaterHelper},this._replaceContainerUpdaterHelper=()=>{o()}}_setOriginImageVisible(e){var t,i;const r=null===(t=this._image)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._image)||void 0===i||i.visible(e);const s=(0,l.b)(r);if(!s)return;const n=this.canvas.findByID(s);null==n||n.visible(e)}}h.Name="imageReplace"},5434:(e,t,i)=>{i.d(t,{Z:()=>pe});var r=i(7063),s=i(61077),n=i(53971),o=i(76970),a=i(24380),l=i(48607),h=i(67986),c=i(25629),d=i(43382),u=i(71946),g=i(48917),_=i(52169),p=i(63345),f=i(14764),m=i(8757),v=i(28161),y=i(22231);const x=y.t.MacOS?"metaKey":"ctrlKey",b=y.t.MacOS?"command":"ctrl";var w=i(47747);class C{constructor(e){this.getMainLayer=()=>this._renderer.getRenderer().getMainRenderer().getLayer(),this.isMatchMainLayer=e=>e===this.getMainLayer(),this._renderer=e}_getNode(e){return e?this._renderer.getRenderer().findByID(e):void 0}_isPressMacCMDOrWinCtrl(e){return Boolean(e[x])}_isGroupMaterialSingleSelected(e){var t;const i=u.Z.getMaterialGroupId(e),r=null===(t=this._renderer.getInteractive().selection)||void 0===t?void 0:t.selectedIds;return!(1!==(null==r?void 0:r.length)||!i)&&r.includes(i)}_isSubMaterialSingleSelected(e){var t;const i=u.Z.getMaterialGroupId(e),r=null===(t=this._renderer.getInteractive().selection)||void 0===t?void 0:t.selectedIds;return 1===(null==r?void 0:r.length)&&r.find((e=>{const t=this._getNode(e);return t&&u.Z.getMaterialGroupId(t)===i}))}_isGroupMaterialMultiSelected(e){var t;const i=u.Z.getMaterialGroupId(e),r=null===(t=this._renderer.getInteractive().selection)||void 0===t?void 0:t.selectedIds;return r&&r.length>1&&i&&r.includes(i)}_isThroughGroup(e,t){return this._isSubMaterialSingleSelected(e)||this._isGroupMaterialSingleSelected(e)||this._isPressMacCMDOrWinCtrl(t)&&!this._isGroupMaterialMultiSelected(e)}_filterOperateMaterial(e,t){var i;const r=null===(i=this._renderer.getInteractive().selection)||void 0===i?void 0:i.selectedIds;if(1===(null==r?void 0:r.length)&&r.includes(e.id()))return e;const s=u.Z.getMaterialGroup(e),n=this._isThroughGroup(e,t);return s&&!n?s:e}_getHitLayerData(e){const t=(0,w.h1)(e,this._renderer.getRenderer().accessors,!0).reverse(),[i,r]=t,s=this._getNode(i),n=this._getNode(r);if(!s)return{};const o=n&&!u.Z.isEqual(n,m.Wq.PAGE)&&u.Z.getMaterialGroupId(n)!==i&&u.Z.isEqual(s,m.Wq.GROUP_LAYER);return{hitNode:o?n:s,hitLayerIds:t,isHitGroupLayerEmptyArea:o}}isPage(e){return u.Z.isEqual(e,m.Wq.PAGE)}isGroup(e){return u.Z.isEqual(e,m.Wq.GROUP_LAYER)}isMaterialsLocked(e){return this._renderer.getRenderer().accessors.layer.isLocked(e.map((e=>e.id())))}isMaterialsLockedByIds(e){return this._renderer.getRenderer().accessors.layer.isLocked(e)}}class I extends C{constructor(e,t){super(e),this._disposeStore=new d.S,this._isEnable=!0,this._pageLayoutChange=()=>{this._highlight.clear()},this._mouseMove=e=>{const{evt:t}=e,{currentTarget:i}=e,{pointerPos:r}=i;if(!r)return;const{hitNode:s}=this._getHitLayerData(e);if(!s)return delete this._currentHoverLayerId,void(this._enableHighlightNode&&this._highlight.remove(this._enableHighlightNode));this._currentHoverLayerId=s.id(),this._handleMaterialHighlight(s,t)},this._mouseUp=e=>{requestAnimationFrame((()=>this._mouseMove(e)))},this._onHotKeys=e=>{const t=this._getNode(this._currentHoverLayerId);t&&(this._childMaterialHoverHotKeysHandle(t,e),this._pageHoverHotKeysHandle(t,e))},this._container=t,this._highlight=new _.Z(e.getRenderer(),{stroke:p.hm,container:t}),this._initEventListener()}get transform(){return this._renderer.getInteractive().transform}enable(){this._highlight.show(),this._isEnable=!0}disable(){this._highlight.hide(),this._isEnable=!1}destroy(){this._removeEventListener()}reset(){this._highlight.clear()}update(){}hover(e){const t=this._renderer.getRenderer().findByID(e);t&&(this._enableHighlightNode&&this._highlight.remove(this._enableHighlightNode),this._enableHighlightNode=t,this._handleHighlight(this._enableHighlightNode))}unHover(e){const t=this._renderer.getRenderer().findByID(e);t&&this._enableHighlightNode===t&&this._highlight.remove(this._enableHighlightNode)}_initEventListener(){(0,v.Z)("*",{scope:m.IB.Default,keyup:!0},this._onHotKeys),this._disposeStore.add(c.Z.interact.onPageLayoutChange.event(this._pageLayoutChange)),this._disposeStore.add(c.Z.canvas.mouseup.event(this._mouseUp)),this._disposeStore.add(c.Z.canvas.mousemove.event(this._mouseMove)),this.transform&&(this._disposeStore.add(this.transform.onMaterialDragStart((()=>this.disable()))),this._disposeStore.add(this.transform.onMaterialDragEnd((()=>this.enable()))),this._disposeStore.add(this.transform.onMaterialTransformStart((()=>this.disable()))),this._disposeStore.add(this.transform.onMaterialTransformEnd((()=>this.enable()))))}_removeEventListener(){v.Z.unbind("*",this._onHotKeys),this._disposeStore.clear(),this._highlight.clear()}_handleMaterialHighlight(e,t){var i;const r=this._getEnableHighlightNode(e,t);if(this._enableHighlightNode&&this._enableHighlightNode!==r&&this._highlight.remove(this._enableHighlightNode),this._enableHighlightNode=r,!this._enableHighlightNode)return;const{transform:s,selection:n}=this._renderer.getInteractive(),o=null==s||null===(i=s.currentTransform)||void 0===i||null===(i=i.currentTransformer)||void 0===i?void 0:i.nodes();if(o&&o.indexOf(this._enableHighlightNode)>=0||null!=n&&n.selecting)return;const{shiftKey:a}=t;if(a&&this.isPage(this._enableHighlightNode))return;const l=this._handleHighlight(this._enableHighlightNode);l&&this._createMouseOutDispose(this._enableHighlightNode,l)}_childMaterialHoverHotKeysHandle(e,t){v.Z[b]&&this._handleMaterialHighlight(e,t)}_pageHoverHotKeysHandle(e,t){v.Z.shift&&("keydown"===t.type&&this._enableHighlightNode&&this.isPage(this._enableHighlightNode)?this._highlight.remove(this._enableHighlightNode):"keyup"===t.type&&this.isPage(e)&&this._handleMaterialHighlight(e,t))}_createMouseOutDispose(e,t){e.off("mouseout.hover"),e.on("mouseout.hover",t)}_getEnableHighlightNode(e,t){const i=u.Z.getMaterialGroup(e),r=this._isThroughGroup(e,t);return i&&!r?i:e}_handleHighlight(e){const[t,i]=this._checkTopChildIsTransformer();if(this._highlight.has(e))return;const r=this.isPage(e),s=r?this._renderer.getRenderer().getActivePageRect():e,n=this._highlight.add(s,{padding:r?f.Qe:f.uL,stroke:this.isMaterialsLocked([e])?p.zL:void 0});return this._isEnable||this._highlight.hide(),t&&(null==i||i.moveToTop()),n}_checkTopChildIsTransformer(){const{children:e}=this._container,t=null==e?void 0:e[(null==e?void 0:e.length)-1];return t instanceof g.$T?[!0,t]:[!1,void 0]}}var L=i(5317);const R="__select_range_id__";class E{constructor(e,t){this._config=e;const{document:i}=L.Z.getGlobalVars();let r=i.getElementById(R);r||(r=i.createElement("div"),r.id=R,(t||i.body).appendChild(r)),this._rect=r,this._initStyle()}getClientRect(){const{width:e=0,height:t=0,x:i=0,y:r=0}=this._config;return{width:e,height:t,x:i,y:r}}getCorners(e){const t=this.getClientRect(),{x:i,y:r,width:s,height:n}=t,o=[{x:i,y:r},{x:i+s,y:r},{x:i+s,y:r+n},{x:i,y:r+n}],{x:a,y:l}=e;return o.map((e=>({x:e.x-a,y:e.y-l})))}width(e){if(void 0===e)return this._config.width;this._config.width=e,this._update()}height(e){if(void 0===e)return this._config.height;this._config.height=e,this._update()}setAttrs(e){this._config={...this._config,...e},this._update()}remove(){this._rect.remove()}_initStyle(){const{fill:e,stroke:t,strokeWidth:i}=this._config;[{attr:"backgroundColor",value:e},{attr:"border",value:`${i}px solid ${t}`},{attr:"position",value:"fixed"}].forEach((e=>{this._rect.style[e.attr]=e.value}))}_update(){const{x:e=0,y:t=0,width:i,height:r}=this._config;[{attr:"width",value:`${i}px`},{attr:"height",value:`${r}px`},{attr:"left",value:`${e}px`},{attr:"top",value:`${t}px`}].forEach((e=>{this._rect.style[e.attr]=e.value}))}}var M=i(46436),S=i(43696),A=i(22169),P=i(67830);class T{constructor(e){this._disposableStore=new d.S,this._careMutationType=[m.x1.ADD_LAYER,m.x1.GROUP_LAYER,m.x1.UNGROUP_LAYER,m.x1.REMOVE_LAYER],this._initPreviewModeChange=()=>c.Z.action.onPreviewModeChange.event((()=>{this._onSelectChange([])})),this._initModelChangeListener=()=>c.Z.action.onModelChange.event((e=>{var t;const i=new Set,r=e.mutations.filter((e=>this._careMutationType.indexOf(e.type)>=0)).map((e=>({type:e.type,id:e.getMutationSideEffect().layerId,childIds:e.getMutationSideEffect().childLayerIds,layout:e.getMutationSideEffect().layout})));if([m.Us.ApplyTemplateAction].includes(e.actionType))return void this._onSelectChange([],{emitType:m.YM.ModelChange,mutations:e.mutations});if(Boolean(e.mutations.find((e=>[m.x1.ADD_PAGE,m.x1.REMOVE_PAGE].includes(e.type)))))return void this._onSelectChange([],{emitType:m.YM.ModelChange,mutations:e.mutations});let s;r.forEach(((e,t)=>{switch(e.type){case m.x1.ADD_LAYER:i.add(e.id);break;case m.x1.REMOVE_LAYER:i.delete(e.id);break;case m.x1.UNGROUP_LAYER:i.delete(e.id),e.childIds.forEach((e=>i.add(e))),r.length-1===t&&(s=e.layout);break;case m.x1.GROUP_LAYER:i.add(e.id),e.childIds.forEach((e=>i.delete(e)))}}));const n=Array.from(i).map((e=>this._renderer.getRenderer().findByID(e))).filter((e=>e));if(n.length>0){var o;const t=null===(o=s)||void 0===o?void 0:o.rotation,i=t&&t*Math.PI/180,r={source:m.xx.init,emitType:m.YM.ModelChange,mutations:e.mutations};return i&&(r.initRotation=(0,P.B)(i)),void this._onSelectChange(n.map((e=>e.id())),r)}const{selectedIds:a=[]}=null!==(t=this.selection)&&void 0!==t?t:{},l=this._renderer.getRenderer().findByIDList(a);this._onSelectChange(l.map((e=>e.id())),{emitType:m.YM.ModelChange,mutations:e.mutations})})),this._renderer=e,this._initEventListener()}get selection(){return this._renderer.getInteractive().selection}update(){}destroy(){this._removeEventListener()}reset(){}on(e){this._onSelectChange=e}_initEventListener(){this._disposableStore.add(this._initPreviewModeChange()),this._disposableStore.add(this._initModelChangeListener())}_removeEventListener(){this._disposableStore.clear()}}var D=i(35429);function k(e,t){return t.layer.onDragEnd(e.map((e=>e.id())),(()=>{if((()=>{const t=1===e.length,[i]=e;if(t&&i)return Boolean(u.Z.getMaterialGroupId(i))})())return;const i=t.page;e.filter((e=>!i.isNodeIntersectPage(e))).length===e.length&&c.Z.interact.onDeleteOutsideLayer.fire(e.map((e=>e.id())))}))}function O(e,t){const i=new d.S;if(e.some((e=>u.Z.getMaterialGroupId(e))))return()=>{i.clear()};let r=!1;const s=new g.ZA;let n=[],o=[];return i.add(t.layer.onDragStart(e.map((e=>e.id())),(e=>{r=null==e?void 0:e.altKey,r&&t.page.mainRenderer.getRenderer().getActivePage().add(s)}))),i.add(t.layer.onDragMove(e.map((e=>e.id())),(e=>{!0===r&&!1===(null==e?void 0:e.altKey)&&(r=!1,null==s||s.destroy())}))),i.add(t.layer.onDragEnd(e.map((e=>e.id())),(t=>{r&&null!=t&&t.altKey&&(o=e.map((e=>(0,D.W)({x:e.x(),y:e.y(),rotation:e.rotation(),width:e.width(),height:e.height(),scale:{x:e.scaleX(),y:e.scaleY()}}))),c.Z.appLayer.onDragCopyEvent.fire({startPosition:n,endPosition:o})),r=!1}))),i.add(null!=e&&e.length?(Promise.all(e.map((e=>{var i;return null===(i=t.page.mainRenderer.getMaterialWidget(e.id()))||void 0===i?void 0:i.onReady()}))).then((()=>{const t=e.map((e=>e.clone()));s.add(...t)})),n=e.map((e=>(0,D.W)({x:e.x(),y:e.y(),rotation:e.rotation(),width:e.width(),height:e.height(),scale:{x:e.scaleX(),y:e.scaleY()}}))),()=>{null==s||s.destroy()}):()=>null==s?void 0:s.destroy()),()=>{i.clear()}}function B(e,t){const i=new d.S;return i.add(function(e,t){var i;const{id:r}=e.attrs;if(!r)return d.G;const s=t.layer.getLayerById(r);if([m.lJ.Sticker,m.lJ.YkSicker].indexOf(null==s||null===(i=s.src)||void 0===i?void 0:i.type)>=0)return d.G;const n=()=>{g.Core.hitOnDragEnabled=!0,e.listening(!1),e.off("mouseout.hover"),t.page.getCursor().useMoveCursor()},o=()=>{t.page.getCursor().useMoveCursor()},a=()=>{g.Core.hitOnDragEnabled=!1,e.listening(!0),t.page.getCursor().useDefaultCursor()};return e.on("dragstart",n),e.on("dragmove",o),e.on("dragend",a),()=>{e.off("dragstart",n),e.off("dragmove",o),e.off("dragend",a)}}(e,t),O([e],t),k([e],t)),()=>{i.clear()}}class N{constructor(e){this._selectedNodeDisposeStore=new d.S,this._renderer=e}get renderSDK(){return this._renderer.getRenderer()}get transform(){return this._renderer.getInteractive().transform}handle(e,t,i){var r;this._onBeforeHandle(e,t,i)&&(null===(r=this.transform)||void 0===r||r.createTransform(e,i),this._selectedNodeHandler(e),this._handleEventFire(e,i))}_onBeforeHandleLayer(e,t){if(1!==t.length)return;const{accessors:i}=this.renderSDK,[r]=t,s=r.id(),n=u.Z.isEqual(r,m.Wq.GRID),o=u.Z.isEqual(r,m.Wq.IMAGE_CONTAINER);if(!n&&!o)return;const a=(e,t)=>{t?i.imageContainer.clearSelectIndex(e):i.grid.clearSelectedAreaIndex(e)};if(1!==e.length)return void a(s,o);const[l]=e;l.id()===s||a(s,o)}_onBeforeHandle(e,t,i){var r;return this._selectedNodeDisposeStore.clear(),this._onBeforeHandleLayer(e,t),!(e.length<=0)||(c.Z.interact.onMaterialSelect.fire({selectedList:[],emitType:null==i?void 0:i.emitType,mutations:null==i?void 0:i.mutations,e:null==i?void 0:i.e}),null===(r=this.transform)||void 0===r||r.reset(),!1)}_handleEventFire(e,t){if(e.length>1)return void c.Z.interact.onMaterialSelect.fire({selectedList:e.map((e=>({type:e.attrs.type,id:e.id()}))),emitType:null==t?void 0:t.emitType,mutations:null==t?void 0:t.mutations,e:null==t?void 0:t.e});const i=e[0],{type:r}=i.attrs,s=[];let n;r===m.Wq.IMAGE_CONTAINER?n=this._renderer.getRenderer().accessors.imageContainer.getSelectIndex(i.id()):r===m.Wq.GRID&&(n=this._renderer.getRenderer().accessors.grid.getSelectedAreaIndex(i.id()));const o={type:i.attrs.type,id:i.id(),selectIndex:n},a=u.Z.getMaterialGroupId(i);a?s.push({type:m.Wq.GROUP_LAYER,id:a,subMaterial:o}):s.push(o),c.Z.interact.onMaterialSelect.fire({selectedList:s,emitType:null==t?void 0:t.emitType,mutations:null==t?void 0:t.mutations,e:null==t?void 0:t.e})}_selectedNodeHandler(e){const{accessors:t}=this.renderSDK;if(e.length>1)return void this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O(e,t),k(e,t)),()=>{i.clear()}}(e,t));const i=e[0];switch(i.attrs.type){case m.Wq.IMAGE:this._selectedNodeDisposeStore.add(B(i,t));break;case m.Wq.IMAGE_CONTAINER:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t));break;case m.Wq.LINE:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t));break;case m.Wq.SHAPE:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t));break;case m.Wq.TEXT:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t));break;case m.Wq.GROUP_LAYER:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t));break;case m.Wq.SVG_IMAGE:this._selectedNodeDisposeStore.add(function(e,t){const i=new d.S;return i.add(O([e],t),k([e],t)),()=>{i.clear()}}(i,t))}}}class Z extends C{constructor(e){super(e),this._disposableStore=new d.S,this._isEnable=!0,this._contextmenu=e=>{var t,i;if(!this._isEnable)return;const{target:r,currentTarget:s,evt:n}=e,{x:o,y:a}=n;n.preventDefault();const{type:l,result:d}=(0,w._5)(r);if([w.xV.material,w.xV.page].includes(l)&&!this.isMatchMainLayer(r.getLayer()))return;const g=[];switch(l){case w.xV.material:const i=null===(t=this.selection)||void 0===t?void 0:t.useClickGeometricHit(e),r=this._filterOperateMaterial(null!=i?i:d,n),s=(0,w.h1)(e,this._renderer.getRenderer().accessors,!0),o=this._isSelectedOneLayerWithoutPageLayer(),a=u.Z.getMaterialGroupId(r),l=a?s.indexOf(a):-1;l>=0&&s.splice(l,1),o&&s.indexOf(o)>=0?g.push(o):g.push(r.id());break;case w.xV.multiMaterials:g.push(...d.map((e=>e.id())));break;case w.xV.page:g.push(d.id())}if(g.length<=0)return;this._onContextmenu(g,n);const _=this._renderer.getRenderer().getPagePosition();s.pointerPos||h.t.error("contextmenu: pointerPos not exist");const p=null!==(i=s.pointerPos)&&void 0!==i?i:{x:o,y:a},f={x:p.x-_.x,y:p.y-_.y},v={type:m.bM.Contextmenu,position:f};c.Z.interact.onContextMenu.fire(v)},this._initEventListener()}get selection(){return this._renderer.getInteractive().selection}disable(){this._isEnable=!1}enable(){this._isEnable=!0}update(){}destroy(){this._disposableStore.clear()}reset(){}on(e){this._onContextmenu=e}_isThroughGroup(e,t){return this._isSubMaterialSingleSelected(e)||this._isPressMacCMDOrWinCtrl(t)&&!this._isGroupMaterialMultiSelected(e)}_initEventListener(){this._disposableStore.add(c.Z.canvas.contextmenu.event(this._contextmenu))}_isSelectedOneLayerWithoutPageLayer(){const{selectedIds:e}=this.selection||{};if(1!==(null==e?void 0:e.length))return;const[t]=e,i=this._getNode(t);return i&&!u.Z.isEqual(i,m.Wq.PAGE)?t:void 0}}class G extends C{constructor(e,t){super(e),this._disposableStore=new d.S,this._selectRect=null,this._selecting=!1,this._materials=[],this._isEnable=!0,this._selectedIds=[],this._unListeningNodes=[],this._geometricClickHitNodes=[],this._isDraggingLayer=!1,this._isPreventClick=!1,this._onContextmenu=(e,t)=>{(0,A.isEqual)(e,this.selectedIds)||this._onSelectChange(e,{e:t})},this._onSelectChange=(e,t)=>{const i=this._renderer.getRenderer().findByIDList(e),r=this._renderer.getRenderer().findByIDList(this.selectedIds);if(!(0,A.isEqual)(e,this.selectedIds)){const e=i.map((e=>({type:e.attrs.type,id:e.id(),node:e})));c.Z.interact.onMaterialSelectChange.fire({selectedList:e,emitType:null==t?void 0:t.emitType})}this._selectedIds=e,this._selectHandler.handle(i,r,t)},this._onLayerDragStart=()=>{this._isDraggingLayer=!0,this._unListeningNodes.forEach((e=>e.listening(!0)))},this._onLayerDragEnd=()=>{this._isDraggingLayer=!1,this._unListeningNodes.forEach((e=>e.listening(!1)))},this._onHotKeys=e=>{},this._mouseDown=e=>{if(!this._isEnable)return;this._isPreventClick=!1;const{target:t,currentTarget:i,evt:r}=e;if(!this.isMatchMainLayer(t.getLayer()))return;const{type:s,result:n}=(0,w._5)(t);switch(s){case w.xV.noMaterialArea:this._handleMouseDownSelectBoxArea(i),this._onSelectChange([],{e:r});break;case w.xV.page:this._handleMouseDownSelectBoxArea(i);break;case w.xV.material:const t=this._filterOperateMaterial(n,e.evt);if(this.isMaterialsLocked([t])){this._handleMouseDownSelectBoxArea(i);break}this._selectHandle(t,r)}},this._onClick=e=>{const{target:t,evt:{button:i,shiftKey:r}}=e;if(!this._isEnable||0!==i||this._isPreventClick)return;if(r){const{hitNode:t}=this._getHitLayerData(e);if(t&&!this.isPage(t)&&this._shiftDecrementSelectHandle(t,e.evt))return}const s=this.useClickGeometricHit(e);if(s){const t=this._filterOperateMaterial(s,e.evt);return this._selectHandle(t,e.evt),null==s||s.fire("click",{...e}),void this._collectGeometricHitNodes(e)}const{type:n,result:o}=(0,w._5)(t);switch(n){case w.xV.page:if(n===w.xV.page&&!r)return void this._selectHandle(o);case w.xV.material:const t=this._filterOperateMaterial(o,e.evt);if(this.isMaterialsLocked([t]))return void this._selectHandle(t)}},this._mouseMove=e=>{this._isEnable&&!this._isDraggingLayer&&this._collectGeometricHitNodes(e)},this._handleMouseMoveSelectBoxArea=e=>{var t;if(!this._isEnable)return;const{x:i=0,y:r=0}=e,{x:s=0,y:n=0}=this._stageRect||{};this._selectArea.endPos.x=s>i?s:i,this._selectArea.endPos.y=n>r?n:r;const{startPos:{x:o,y:a},endPos:{x:l,y:h}}=this._selectArea,c=Math.abs(o-l),d=Math.abs(a-h);if(!c&&!d)return;this._onSelect(),this._isPreventClick=!0,null===(t=this._selectRect)||void 0===t||t.setAttrs({x:Math.min(o,l),y:Math.min(a,h),width:c,height:d});const u=this._getSelectedMaterials(),g=e=>{const t=this._highlight.has(e),i=this.selectedIds.includes(e.id());return t||i};u.forEach((e=>{g(e)||this._highlight.add(e)})),this._highlight.getNodes().forEach((e=>{u.indexOf(e)<0&&this._highlight.remove(e)}))},this._handleMouseUpSelectBoxArea=e=>{var t,i;if(!this._isEnable)return;const r=()=>{var e;const{document:t}=L.Z.getGlobalVars();t.removeEventListener("mousemove",this._handleMouseMoveSelectBoxArea),null===(e=this._selectRect)||void 0===e||e.remove(),this._selectRect=null};if(this._highlight.clear(),this._endSelect(),!(null!==(t=this._selectRect)&&void 0!==t&&t.width()||null!==(i=this._selectRect)&&void 0!==i&&i.height()))return void r();const s=this._getSelectedMaterials();(null==s?void 0:s.length)>=0&&this._onSelectChange(s.map((e=>e.id())),{e}),r()},this._getSelectedMaterials=()=>{var e,t,i;if(!(null!==(e=this._selectRect)&&void 0!==e&&e.width()||null!==(t=this._selectRect)&&void 0!==t&&t.height()))return[];const r=null===(i=this._selectRect)||void 0===i?void 0:i.getCorners(this._stageRect),s=this._materials.filter((e=>{if(this.isPage(e)){const t=this._renderer.getRenderer().accessors.page.getRect(e.id());return(0,M.w3)(r,(0,M.QO)(t))}return(0,M.w3)(r,(0,M.QO)(e))}));if(!(s.findIndex((e=>this.isPage(e)))>=0))return[];const n=s.filter((e=>!this.isPage(e)&&!this.isMaterialsLocked([e])));return n.length>0?n:[]},this._highlight=new _.Z(e.getRenderer(),{container:t}),this._modelAction=new T(this._renderer),this._contextmenu=new Z(this._renderer),this._modelAction.on(this._onSelectChange),this._contextmenu.on(this._onContextmenu),this._selectHandler=new N(this._renderer),this._initListener()}get transform(){return this._renderer.getInteractive().transform}get hover(){return this._renderer.getInteractive().hover}get _stageDom(){return this._renderer.getRenderer().stage.dom}get _stageRect(){return this._renderer.getRenderer().stage.rect}get selecting(){return this._selecting}get selectedIds(){return this._selectedIds}get unListeningNodes(){return this._unListeningNodes}enable(){this._isEnable=!0,this._contextmenu.enable()}disable(e=!0){this._isEnable=!1,e&&this._onSelectChange([]),this._removeDomEvent(),this._contextmenu.disable()}update(){this._modelAction.update(),this._contextmenu.update()}destroy(){this._removeListener(),this._modelAction.destroy(),this._contextmenu.destroy()}reset(){this._modelAction.reset(),this._contextmenu.reset()}select(e,t){var i;null===(i=this.hover)||void 0===i||i.reset(),this._onSelectChange(e,t)}useClickGeometricHit(e){const{hitNode:t}=this._getHitLayerData(e);if(!t)return;const i=this._geometricClickHitNodes.indexOf(t);if(i>=0){const e=this._unListeningNodes.indexOf(t);return e>=0&&(t.listening(!0),this._unListeningNodes.splice(e,1)),this._geometricClickHitNodes.splice(i,1),t}}_initListener(){(0,v.Z)("*",{scope:m.IB.Default,keyup:!0},this._onHotKeys),this._disposableStore.add(c.Z.canvas.mousedown.event(this._mouseDown)),this._disposableStore.add(c.Z.canvas.click.event(this._onClick)),this._disposableStore.add(c.Z.canvas.mousemove.event(this._mouseMove)),this.transform&&(this._disposableStore.add(this.transform.onMaterialDragStart(this._onLayerDragStart)),this._disposableStore.add(this.transform.onMaterialDragEnd(this._onLayerDragEnd)))}_removeDomEvent(){const{document:e}=L.Z.getGlobalVars();e.removeEventListener("mouseup",this._handleMouseUpSelectBoxArea),e.removeEventListener("mousemove",this._handleMouseMoveSelectBoxArea)}_removeListener(){v.Z.unbind("*",this._onHotKeys),this._disposableStore.clear(),this._removeDomEvent()}_onSelect(){var e;this._selecting=!0,null===(e=this.hover)||void 0===e||e.disable()}_endSelect(){var e;this._selecting&&(this._selecting=!1,null===(e=this.hover)||void 0===e||e.enable())}_initSelectRect(){this._selectRect=new E({fill:p.UD,stroke:p.Jc,strokeWidth:1},this._stageDom)}_handleMouseDownSelectBoxArea(e){var t,i;const r=this._stageRect,s=((null===(t=e.getPointerPosition())||void 0===t?void 0:t.x)||0)+((null==r?void 0:r.x)||0),n=((null===(i=e.getPointerPosition())||void 0===i?void 0:i.y)||0)+((null==r?void 0:r.y)||0);this._selectArea={startPos:{x:s,y:n},endPos:{x:s,y:n}},this._initSelectRect(),this._materials=u.Z.findMaterials(this._renderer.getRenderer().getMainRenderer().getLayer());const{document:o}=L.Z.getGlobalVars();o.addEventListener("mousemove",this._handleMouseMoveSelectBoxArea),o.addEventListener("mouseup",this._handleMouseUpSelectBoxArea)}_selectHandle(e,t){const i=null==t?void 0:t.shiftKey;!this.isMaterialsLocked([e])&&i?this.selectedIds.includes(e.id())||this._shiftIncrementSelectHandle(e,t)&&(this._isPreventClick=!0):this._pureSelectHandle(e,t)}_getSelectOrder(e){return this.selectedIds.findIndex((t=>!!this._getNode(t)&&t===e))}_shiftIncrementSelectHandle(e,t){const i=u.Z.getMaterialGroup(e),r=(null!=i?i:e).id();if(this._getSelectOrder(r)<0){const e=this._renderer.getRenderer().findByIDList([...this.selectedIds,r]),i=new Set(e.filter((e=>!this.isPage(e)&&!this.isMaterialsLocked([e]))).map((e=>u.Z.getMaterialGroupId(e)||e.id())));return this._onSelectChange(Array.from(i),{e:t}),!0}return!1}_shiftDecrementSelectHandle(e,t){const i=u.Z.getMaterialGroup(e),r=(null!=i?i:e).id(),s=this._getSelectOrder(r);return s>=0&&(this._onSelectChange(this.selectedIds.filter(((e,t)=>t!==s)),{e:t}),!0)}_pureSelectHandle(e,t){const i=e.id();if(void 0===i)throw new Error("material id is undefined");this.selectedIds.includes(i)||this._onSelectChange([i],{e:t})}_collectGeometricHitNodes(e){const{evt:t}=e;this._unListeningNodes.forEach((e=>e.listening(!0))),this._unListeningNodes=[],this._geometricClickHitNodes=[];const{hitNode:i,hitLayerIds:r=[],isHitGroupLayerEmptyArea:s}=this._getHitLayerData(e),n=this._handleHitSelectedId(r,i);if(!n)return;i&&s&&this._geometricClickHitNodes.push(i);const o=r.indexOf(n),a=this.getMainLayer(),l=this._getNode(n);if(l&&this.isPage(l))return;const h=!!l&&this.isGroup(l);r.slice(0,o).filter((e=>!(this._isPressMacCMDOrWinCtrl(t)&&h&&u.Z.getMaterialGroupIdById(a,e)===n))).forEach((e=>{const t=this._getNode(e);t&&(t.listening(!1),this._unListeningNodes.push(t),this._geometricClickHitNodes.push(t))}))}_handleHitSelectedId(e,t){var i,r;if(1===(null===(i=this.selectedIds)||void 0===i?void 0:i.length)){const[i]=this.selectedIds;if(t&&u.Z.getMaterialGroupId(t)!==i){const e=t.id(),r=this._renderer.getRenderer().accessors.page,[s]=r.getLayersRectCorners([e],!0),n=r.getLayersRectCorners([i],!0);if(s.every((e=>(0,M.z3)(e,n[0]))))return e}return e.includes(i)&&!this.isMaterialsLockedByIds([i])?i:null==t?void 0:t.id()}if(t&&(null===(r=this.selectedIds)||void 0===r?void 0:r.length)>1){var s;const e=null===(s=this.transform)||void 0===s||null===(s=s.currentTransform)||void 0===s?void 0:s.currentTransformer;if(e instanceof S.D){const i=t.id(),r=this._renderer.getRenderer().accessors.page,[s]=r.getLayersRectCorners([i],!0),n=(0,M.QO)(e,!0);s.every((e=>(0,M.z3)(e,n)))&&(e.listening(!1),this._unListeningNodes.push(e))}}return null==t?void 0:t.id()}}var W=i(41575);class H{constructor(){this._disposableStore=new d.S,this._onClick=e=>{const{target:t}=e,{type:i}=(0,w._5)(t);switch(i){case w.xV.noMaterialArea:case w.xV.page:case w.xV.material:c.Z.interact.onDeleteOutsideLayer.fire()}},this._initEventListener()}update(){}destroy(){this._removeEventListener()}reset(){}_initEventListener(){this._disposableStore.add(c.Z.canvas.click.event(this._onClick))}_removeEventListener(){this._disposableStore.clear()}}var z=i(51012),j=i(14368);class F{constructor(e,t){this._shiftKeyEvent=e=>{if(v.Z.shift){var t,i;if(e.preventDefault(),"keydown"===e.type)null===(t=this._currentTransformerOperator.transformer)||void 0===t||t.shouldOverdrawWholeArea(!1),this._lastShouldOverdrawWholeArea=!1;if("keyup"===e.type)null===(i=this._currentTransformerOperator.transformer)||void 0===i||i.shouldOverdrawWholeArea(!0),this._lastShouldOverdrawWholeArea=!0}},this._container=t,this._factory=new z.H2(e.getRenderer()),this._currentTransformerOperator=new j.C(e),(0,v.Z)("*",{scope:m.IB.Default,keyup:!0},this._shiftKeyEvent)}get currentTransformer(){return this._currentTransformerOperator.transformer}readonly(){var e;null===(e=this.currentTransformer)||void 0===e||e.readonly()}lock(){var e;null===(e=this.currentTransformer)||void 0===e||e.lock()}unlock(){var e;null===(e=this.currentTransformer)||void 0===e||e.unlock()}destroy(){v.Z.unbind("*",this._shiftKeyEvent)}resetTransformer(){var e,t;this._lastRotaterDirection=null===(e=this.currentTransformer)||void 0===e?void 0:e.rotaterDirection,this._lastRotation=null===(t=this.currentTransformer)||void 0===t?void 0:t.rotation(),this._currentTransformerOperator.clearTransformer()}createTransformer(e,t){const i=this._factory.createMultiTransformer({rotaterDirection:this._lastRotaterDirection,initRotation:this._lastRotation,shouldOverdrawWholeArea:this._lastShouldOverdrawWholeArea,...t}),r=e.map((e=>{var t;return null!==(t=u.Z.getMaterialGroup(e))&&void 0!==t?t:e}));i&&(this._container.add(i),this._currentTransformerOperator.updateTransformer(i),i.select(...r))}}var $=i(11005);class U{constructor(e,t){this._container=t,this._factory=new z.H2(e.getRenderer()),this._currentTransformerOperator=new j.C(e),this._currentSubTransformerOperator=new j.C(e)}get currentTransformer(){return this._currentTransformerOperator.transformer}get currentSubTransformer(){return this._currentSubTransformerOperator.transformer}readonly(){var e,t;null===(e=this.currentTransformer)||void 0===e||e.readonly(),null===(t=this.currentSubTransformer)||void 0===t||t.readonly()}lock(){var e,t;null===(e=this.currentTransformer)||void 0===e||e.lock(),null===(t=this.currentSubTransformer)||void 0===t||t.lock()}unlock(){var e,t;null===(e=this.currentTransformer)||void 0===e||e.unlock(),null===(t=this.currentSubTransformer)||void 0===t||t.unlock()}destroy(){}resetTransformer(){var e;this._lastRotaterDirection=null===(e=this.currentTransformer)||void 0===e?void 0:e.rotaterDirection,this._currentTransformerOperator.clearTransformer(),this._currentSubTransformerOperator.clearTransformer()}createTransformer(e,t){const i=e[0],[r,s]=this._getGroupMaterials(i),n=this._factory.createGroupTransformer({rotaterDirection:this._lastRotaterDirection,...t});if(!n)return;if(this._container.add(n),this._currentTransformerOperator.updateTransformer(n),n.select(r),!s)return;const o=this._factory.createTransformer(s.attrs.type);o&&(this._container.add(o),this._currentSubTransformerOperator.updateTransformer(o),o.select(s),n.enabledAnchors([]),n.enableRotater=!1,n.borderStroke(p.hm),o.on((0,$.VZ)($.Z2.transformstart,$.Z2.dragstart),(()=>{n.hide()})),o.on((0,$.VZ)($.Z2.transformend,$.Z2.dragend),(()=>{n.show()})),s.on((0,$.VZ)($.qB.cropstart,$.qB.replacestart,$.qB.texteditstart),(()=>{n.hide()})),s.on((0,$.VZ)($.qB.cropend,$.qB.replaceend,$.qB.texteditend),(()=>{n.show()})))}_getGroupMaterials(e){const t=u.Z.getMaterialGroup(e);if(t)return[t,e];if(e.attrs.type===m.Wq.GROUP_LAYER)return[e,void 0];throw new Error("GroupTransform _getGroupMaterials: node is not GROUP_LAYER")}}var q,V=i(26364),K=i(55900);!function(e){e[e.single=0]="single",e[e.multi=1]="multi",e[e.group=2]="group"}(q||(q={}));class Y extends C{constructor(e,t){super(e),this._isReadonly=!1,this._disposableStore=new d.S,this._transformEventDisposeStore=new d.S,this._onMaterialDragStart=new K.j,this._onMaterialDragMove=new K.j,this._onMaterialDragEnd=new K.j,this._onMaterialTransformStart=new K.j,this._onMaterialTransformEnd=new K.j,this._transforms={[q.group]:new U(this._renderer,t),[q.single]:new V.x(this._renderer,t),[q.multi]:new F(this._renderer,t)}}get currentTransform(){return this._currentTransform}get accessors(){return this._renderer.getRenderer().accessors}onMaterialDragStart(e){return this._onMaterialDragStart.event(e)}onMaterialDragMove(e){return this._onMaterialDragMove.event(e)}onMaterialDragEnd(e){return this._onMaterialDragEnd.event(e)}onMaterialTransformStart(e){return this._onMaterialTransformStart.event(e)}onMaterialTransformEnd(e){return this._onMaterialTransformEnd.event(e)}update(){}reset(){var e;null===(e=this._currentTransform)||void 0===e||e.resetTransformer()}destroy(){Object.keys(this._transforms).forEach((e=>this._transforms[e].destroy())),this._disposableStore.clear(),this._transformEventDisposeStore.clear()}switchToReadonly(e){this._isReadonly=e}createTransform(e,t){var i;if(e.length<=0)return;this.reset();switch(this._getType(e)){case q.group:this._currentTransform=this._transforms[q.group];break;case q.multi:this._currentTransform=this._transforms[q.multi];break;case q.single:this._currentTransform=this._transforms[q.single]}var r,s,n;(null===(i=this._currentTransform)||void 0===i||i.createTransformer(e,t),this._isReadonly)&&(null===(r=this._currentTransform)||void 0===r||r.readonly());this._checkLayersLocked(e)&&(null===(s=this._currentTransform)||void 0===s||null===(n=s.lock)||void 0===n||n.call(s));this._bindMaterialTransformEvent(e.map((e=>e.id())))}_checkLayersLocked(e){return this._renderer.getRenderer().accessors.layer.isLocked(e.map((e=>e.id())))}_bindMaterialTransformEvent(e){this._transformEventDisposeStore.clear(),this._transformEventDisposeStore.add(this.accessors.layer.onDragStart(e,(e=>{this._onMaterialDragStart.fire(e)}))),this._transformEventDisposeStore.add(this.accessors.layer.onDragMove(e,(e=>{this._onMaterialDragMove.fire(e)}))),this._transformEventDisposeStore.add(this.accessors.layer.onDragEnd(e,(e=>{this._onMaterialDragEnd.fire(e)}))),this._transformEventDisposeStore.add(this.accessors.layer.onTransformStart(e,(()=>{this._onMaterialTransformStart.fire()}))),this._transformEventDisposeStore.add(this.accessors.layer.onTransformEnd(e,(()=>{this._onMaterialTransformEnd.fire()})))}_getType(e){if(e.length>1)return q.multi;const t=e[0];return u.Z.getMaterialGroupId(t)||this.isGroup(t)?q.group:q.single}}class X extends C{constructor(e){super(e),this._mouseEventDisposeStore=new d.S,this._isEnable=!0,this._isDragging=!1,this._handleHoverGroupChildHotKey=e=>{const t=this._getNode(this._currentHoverLayerId);v.Z[b]&&t&&(this._isDragging||this._enableDraggableNode(t,e))},this._mouseOver=e=>{if(!this._isEnable)return;const{target:t,evt:i}=e,r=this._renderer.getRenderer().getMainRenderer().getLayer();if(t.getLayer()!==r)return;if(!u.Z.isMaterialTarget(t))return;const s=u.Z.getMaterialNodeByTarget(t);s&&this._enableDraggableNode(s,i)},this._mouseMove=e=>{if(!this._isEnable)return;const{currentTarget:t}=e,{pointerPos:i}=t;if(!i)return;const[r]=(0,w.h1)(e,this._renderer.getRenderer().accessors,!0).reverse(),s=this._getNode(r);s?this._currentHoverLayerId=s.id():delete this._currentHoverLayerId},this._initEventListener()}get transform(){return this._renderer.getInteractive().transform}enable(){this._renderer.getRenderer().getEditorMode()!==f.je.readonly&&(this._isEnable=!0)}disable(){this._isEnable=!1;u.Z.findGroupSubMaterials(this._renderer.getRenderer().getMainRenderer().getLayer()).forEach((e=>e.draggable(!1)))}destroy(){this._removeEventListener()}reset(){}update(){}_initEventListener(){(0,v.Z)("*",{scope:m.IB.Default,keyup:!0},this._handleHoverGroupChildHotKey),this._mouseEventDisposeStore.add(c.Z.canvas.mousemove.event(this._mouseMove)),this._mouseEventDisposeStore.add(c.Z.canvas.mouseover.event(this._mouseOver)),this._mouseEventDisposeStore.add(c.Z.canvas.mouseup.event(this._mouseOver)),this.transform&&(this._mouseEventDisposeStore.add(this.transform.onMaterialDragStart((()=>this._isDragging=!0))),this._mouseEventDisposeStore.add(this.transform.onMaterialDragEnd((()=>this._isDragging=!1))))}_removeEventListener(){v.Z.unbind("*",this._handleHoverGroupChildHotKey),this._mouseEventDisposeStore.clear()}_enableDraggableNode(e,t){if(this.isPage(e)||this.isMaterialsLocked([e]))return;const i=u.Z.getMaterialGroup(e),r=this._isThroughGroup(e,t),s=Boolean(i&&!r),n=s?i:e;s?e.draggable(!1):null==i||i.draggable(!1);const{selection:o}=this._renderer.getInteractive();null!=o&&o.selecting||(null==n||n.listening(!0),null==n||n.setDraggable(!0))}}var J=i(54643),Q=i(58571),ee=i(50477);const te="customDistanceContainer",ie="customDistanceLine";class re extends C{constructor(e){super(e),this._isEnable=!1,this._disposableStore=new d.S,this._hasTrigger=!1,this._isPressOption=!1,this._hasHideTransformer=!1,this._handleHotkeyTrigger=e=>{"keydown"===e.type?!e.altKey||e.metaKey||e.ctrlKey?(this._isPressOption=!1,this._handleDisable()):(this._isPressOption=!0,this._handleEnable()):"Alt"===e.key&&(this._isPressOption=!1,this._handleDisable())},this._handleDisable=()=>{this.disabled(),this._destoryContainer(),this._destoryDistanceLine(),this._enableHover(),this._showTransformer(),this._updateHasTrigger(!1),this._triggerMeasureEndEvent()},this._handleMouseMove=e=>{var t;const{currentTarget:i}=e,{pointerPos:r}=i;if(!r)return void this._clearHoverNode();const{hitNode:s}=this._getHitLayerData(e);if(!s)return void this._clearHoverNode();if(s===this._hoverNode)return;const n=null!==(t=u.Z.getMaterialGroup(s))&&void 0!==t?t:s;this._updateHoverNode(n),this._isEnable&&this._doMain()},this._handleDragMove=()=>{this._destoryContainer(),this._destoryDistanceLine(),this.disabled()},this._handleDragEnd=()=>{this._isPressOption&&this.enable()},this._initEventListener()}get transform(){return this._renderer.getInteractive().transform}update(){}reset(){this._handleEnable()}destroy(){this._destoryEventListener()}enable(){this._isEnable=!0}disabled(){this._isEnable=!1}_updateHasTrigger(e){this._hasTrigger=e}_updatePositionType(e){this._positionType=e}_triggerMeasureStartEvent(){var e;if(this._hasTrigger||!this._positionType||!this._hoverNode)return;this._updateHasTrigger(!0);const t={measureType:(null===(e=this._hoverNode)||void 0===e||null===(e=e.attrs)||void 0===e?void 0:e.type)===m.Wq.PAGE?m.CR.Canvas:m.CR.Element,positionType:this._positionType};c.Z.interact.onDistanceMeasureStart.fire(t)}_triggerMeasureEndEvent(){c.Z.interact.onDistanceMeasureEnd.fire()}_initEventListener(){(0,v.Z)("*",{keyup:!0,scope:m.IB.Default},this._handleHotkeyTrigger),this._disposableStore.add(c.Z.canvas.mousemove.event(this._handleMouseMove)),this._disposableStore.add(c.Z.interact.onMaterialSelect.event((()=>this._handleSelect()))),this.transform&&(this._disposableStore.add(this.transform.onMaterialDragMove((()=>this._handleDragMove()))),this._disposableStore.add(this.transform.onMaterialDragEnd((()=>this._handleDragEnd()))))}_destoryEventListener(){v.Z.unbind("*",this._handleHotkeyTrigger),v.Z.unbind("*",this._handleDisable),this._disposableStore.clear()}_handleEnable(){this._isPressOption&&(this.enable(),this._doMain())}_handleSelect(){var e;const t=this._renderer.getRenderer(),i=null===(e=t.getFeatureRenderer().getInteractive().selection)||void 0===e?void 0:e.selectedIds;if(!i)return;const r=(0,ee.b)(i);if(r){const e=t.getFeatureRenderer().findByID(r);e&&(this._updateTransformer(e),this._isPressOption&&this._positionType&&this._transformer.hide())}}_doMain(){var e;if(!this._transformer||0===(null===(e=this._transformer)||void 0===e||null===(e=e.children)||void 0===e?void 0:e.length)||!this._hoverNode)return;const t=this._getLocationItem(this._hoverNode),i=this._getTransformerLocationItem(this._transformer),r=this._renderer.getRenderer().getActivePage(),s=this._getPageLocationItem(r),{xl:n,xr:o,yt:a,yb:l}=i,{xl:h,xr:c,yt:d,yb:u}=t;if(a===d&&l===u&&n===h&&o===c||c===n&&d>=a&&d<=l||c===n&&u>=a&&u<=l||o===h&&d>=a&&d<=l||o===h&&u>=a&&u<=l||u===a&&h>=n&&h<=o||u===a&&c>=n&&c<=o||l===d&&h>=n&&h<=o||l===d&&c>=n&&c<=o||c<s.xl||o<s.xl||h>s.xr||n>s.xr||u<s.yt||l<s.yt||d>s.yb||a>s.yb)return this._destoryContainer(),this._destoryDistanceLine(),this._updatePositionType(),void this._showTransformer();this._destoryContainer(),this._destoryDistanceLine(),this._disableHover(),this._hideTransformer(),this._drawContainer(t),this._drawContainer(i),this._handleDistance(i,t),this._triggerMeasureStartEvent()}_getLocationItem(e){const t=this._getNode(e.id());if(t.attrs.type===m.Wq.PAGE)return this._getPageLocationItem(t);const i=this._getPageContainer(),r=this._renderer.getRenderer().getActivePage(),s=this._getPageLocationItem(r),{x:n,y:o,width:a,height:l}=t.getClientRect({skipShadow:!0,skipStroke:!0,relativeTo:i}),h=n+a,c=o+l,d=Math.max(n,s.xl),u=Math.min(h,s.xr),g=Math.max(o,s.yt),_=Math.min(c,s.yb);return{id:t.id(),type:t.attrs.type,width:u-d,height:_-g,xl:d,xr:u,yt:g,yb:_}}_getPageLocationItem(e){const t=this._getPageContainer(),{x:i,y:r}=e.getAbsolutePosition(t),s=e.width(),n=e.height();return{id:e.id(),type:e.attrs.type,width:s,height:n,xl:i,xr:i+s,yt:r,yb:r+n}}_getTransformerLocationItem(e){const t=e.nodes(),i=this._getPageContainer(),r=[],s=[],n=[],o=[],a=this._renderer.getRenderer().getActivePage(),l=this._getPageLocationItem(a);t.forEach((e=>{const{x:t,y:a,width:l,height:h}=e.getClientRect({skipShadow:!0,skipStroke:!0,relativeTo:i});r.push(t),s.push(t+l),n.push(a),o.push(a+h)}));const h=Math.min(...r),c=Math.max(...s),d=Math.min(...n),u=Math.max(...o),g=Math.max(h,l.xl),_=Math.min(c,l.xr),p=Math.max(d,l.yt),f=Math.min(u,l.yb);return{id:e.id(),type:e.attrs.type,width:_-g,height:f-p,xl:g,xr:_,yt:p,yb:f}}_disableHover(){var e;null===(e=this._renderer.getRenderer().getFeatureRenderer().getInteractive().hover)||void 0===e||e.disable()}_enableHover(){var e;null===(e=this._renderer.getRenderer().getFeatureRenderer().getInteractive().hover)||void 0===e||e.enable()}_hideTransformer(){var e;if(!this._hasHideTransformer){var t;if(null===(e=this._transformer)||void 0===e||e.hide(),this._transformer instanceof S.D)null===(t=this._transformer)||void 0===t||t.clearHighlight();this._hasHideTransformer=!0}}_showTransformer(){var e;if(this._hasHideTransformer){var t;if(null===(e=this._transformer)||void 0===e||e.show(),this._transformer instanceof S.D)null===(t=this._transformer)||void 0===t||t.highlightAll();this._hasHideTransformer=!1}}_handleDistance(e,t){const{xl:i,xr:r,yt:s,yb:n}=e,{xl:o,xr:a,yt:l,yb:h}=t;if(s<=l&&n>=h&&i<=o&&r>=a){const e=[(o+a)/2,s],t=[(o+a)/2,l],c=[(o+a)/2,n],d=[(o+a)/2,h],u=[i,(l+h)/2],g=[o,(l+h)/2],_=[r,(l+h)/2],p=[a,(l+h)/2];return this._drawDistanceLine(e,t),this._drawDistanceLine(c,d),this._drawDistanceLine(u,g),this._drawDistanceLine(_,p),void this._updatePositionType(m.d.Include)}if(l<=s&&h>=n&&o<=i&&a>=r){const e=[(i+r)/2,s],t=[(i+r)/2,l],c=[(i+r)/2,n],d=[(i+r)/2,h],u=[i,(s+n)/2],g=[o,(s+n)/2],_=[r,(s+n)/2],p=[a,(s+n)/2];return this._drawDistanceLine(e,t),this._drawDistanceLine(c,d),this._drawDistanceLine(u,g),this._drawDistanceLine(_,p),void this._updatePositionType(m.d.Include)}if(h<s&&a<i){const e=[(i+r)/2,s],t=[a,h],o=[i,(s+n)/2],l=[a,h];return this._drawDistanceLine(e,t,"y"),this._drawDistanceLine(o,l,"x"),void this._updatePositionType(m.d.Opposite)}if(h<s&&r<o){const e=[(i+r)/2,s],t=[o,h],a=[r,(s+n)/2],l=[o,h];return this._drawDistanceLine(e,t,"y"),this._drawDistanceLine(a,l,"x"),void this._updatePositionType(m.d.Opposite)}if(n<l&&a<i){const e=[(i+r)/2,n],t=[a,l],o=[i,(s+n)/2],h=[a,l];return this._drawDistanceLine(e,t,"y"),this._drawDistanceLine(o,h,"x"),void this._updatePositionType(m.d.Opposite)}if(n<l&&r<o){const e=[(i+r)/2,n],t=[o,l],a=[r,(s+n)/2],h=[o,l];return this._drawDistanceLine(e,t,"y"),this._drawDistanceLine(a,h,"x"),void this._updatePositionType(m.d.Opposite)}const c=l<=s&&h>=s||h>=n&&l<=n||l>=s&&h<=n;if(a<i&&c||o>r&&c){let e,t;a<i?(e=i,t=a):(e=r,t=o);const c=[s,l,n,h];c.sort(((e,t)=>e-t));const d=(c[1]+c[2])/2,u=[e,d],g=[t,d];return this._drawDistanceLine(u,g),void this._updatePositionType(m.d.Horizontal)}const d=o<=i&&a>=i||a>=r&&o<=r||o>=i&&a<=r;if(h<s&&d||l>n&&d){let e,t;h<s?(e=s,t=h):(e=n,t=l);const c=[i,o,r,a];c.sort(((e,t)=>e-t));const d=(c[1]+c[2])/2,u=[d,e],g=[d,t];return this._drawDistanceLine(u,g),void this._updatePositionType(m.d.Vertical)}const u=[i,o,r,a],g=[s,l,n,h];u.sort(((e,t)=>e-t)),g.sort(((e,t)=>e-t));const _=(u[1]+u[2])/2,p=(g[1]+g[2])/2,f=[_,s],v=[_,l],y=[_,n],x=[_,h],b=[i,p],w=[o,p],C=[r,p],I=[a,p];this._drawDistanceLine(f,v),this._drawDistanceLine(y,x),this._drawDistanceLine(b,w),this._drawDistanceLine(C,I),this._updatePositionType(m.d.Overlap)}_drawDistanceLine(e,t,i){const r=this._getPageContainer(),[s,n]=e,[o,a]=t;if(s===o||n===a){const i=new g.x1({points:[...e,...t],name:ie,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1});null==r||r.add(i),s===o?this._drawDistanceValue(this._getDistanceValue(Math.abs(n-a)),[s,(n+a)/2],"y"):this._drawDistanceValue(this._getDistanceValue(Math.abs(s-o)),[(s+o)/2,n],"x")}else{const l=[4,4];let h,c,d,u,_;"x"===i?(h=new g.x1({points:[o,n,...t],name:ie,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",dash:l,listening:!1}),c=new g.x1({points:[...e,o,n],name:ie,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),d=this._getDistanceValue(Math.abs(s-o)),u=[(s+o)/2,n],_="x"):(h=new g.x1({points:[s,a,...t],name:ie,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",dash:l,listening:!1}),c=new g.x1({points:[...e,s,a],name:ie,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),d=this._getDistanceValue(Math.abs(n-a)),u=[s,(n+a)/2],_="y"),null==r||r.add(h,c),this._drawDistanceValue(d,u,_)}}_getDistanceValue(e){var t;return(null===(t=this._renderer.getRenderer().getMainRenderer().getDimension())||void 0===t?void 0:t.unit)===m.fb.CM?Number((0,J.$S)(e).toFixed(2)):Number(e.toFixed(0))}_getLineWidth(){return 1/this._renderer.getRenderer().getMainRenderer().getZoom().x}_drawDistanceValue(e,t,i){if(0===e)return;const r=this._getPageContainer(),s=this._renderer.getRenderer().getMainRenderer().getZoom().x,n=t[0],o=t[1],a="#fff";if("x"===i){const t=new Q.x({name:ie,x:n,y:o-15/s,text:`${e}`,fontSize:10/s,fill:a,listening:!1}),i=n-t.width()/2,l=new g.UL({name:ie,x:i-7/s,y:o-18/s,width:t.width()+14/s,height:14/s,fill:p.q,cornerRadius:7/s,listening:!1});t.x(i),null==r||r.add(l,t)}else{const t=new Q.x({name:ie,x:n+11/s,y:o-4.5/s,text:`${e}`,fontSize:10/s,fill:a,listening:!1}),i=new g.UL({name:ie,x:n+4/s,y:o-7/s,width:t.width()+14/s,height:14/s,fill:p.q,cornerRadius:7/s,listening:!1});null==r||r.add(i,t)}}_destoryDistanceLine(){const e=this._getPageContainer();null==e||e.find(`.${ie}`).forEach((e=>e.destroy()))}_drawContainer(e){const{xl:t,xr:i,yt:r,yb:s}=e,n=this._getPageContainer(),o=new g.UL({name:te,x:t,y:r,width:i-t,height:s-r,strokeWidth:this._getLineWidth(),stroke:p.q,listening:!1});null==n||n.add(o)}_destoryContainer(){const e=this._getPageContainer();null==e||e.find(`.${te}`).forEach((e=>e.destroy()))}_getPageContainer(){return this._renderer.getRenderer().getMainRenderer().getPageContainer()}_updateTransformer(e){this._transformer=e}_updateHoverNode(e){this._hoverNode=e}_clearHoverNode(){this._hoverNode=void 0,this._destoryContainer(),this._destoryDistanceLine(),this._showTransformer()}}class se extends W.Z{constructor(){super(...arguments),this._container=r.Z.container(null)}get transform(){return this._transform}get hover(){return this._hover}get selection(){return this._selection}get draggable(){return this._draggable}get distance(){return this._distance}bootstrap(){this.toActived(),this._initContainer(),this._transform=new Y(this.canvas,this._container),this._hover=new I(this.canvas,this._container),this._draggable=new X(this.canvas),this._selection=new G(this.canvas,this._container),this._recycle=new H,c.Z.appLayer.onEditorModeChange.event((e=>{var t,i,r,s;e===f.je.editable?(null===(t=this._draggable)||void 0===t||t.enable(),null===(i=this._transform)||void 0===i||i.switchToReadonly(!1)):(null===(r=this._draggable)||void 0===r||r.disable(),null===(s=this._transform)||void 0===s||s.switchToReadonly(!0))})),this._distance=new re(this.canvas)}updated(){var e,t,i,r,s,n;null===(e=this._transform)||void 0===e||e.update(),null===(t=this._hover)||void 0===t||t.update(),null===(i=this._draggable)||void 0===i||i.update(),null===(r=this._selection)||void 0===r||r.update(),null===(s=this._recycle)||void 0===s||s.update(),null===(n=this._distance)||void 0===n||n.update()}destroy(){var e,t,i,r,s,n;this.toDeactivated(),null===(e=this._transform)||void 0===e||e.destroy(),null===(t=this._hover)||void 0===t||t.destroy(),null===(i=this._draggable)||void 0===i||i.destroy(),null===(r=this._selection)||void 0===r||r.destroy(),null===(s=this._recycle)||void 0===s||s.destroy(),null===(n=this._distance)||void 0===n||n.destroy()}reset(){var e,t,i,r,s;null===(e=this._hover)||void 0===e||e.reset(),null===(t=this._draggable)||void 0===t||t.reset(),null===(i=this._selection)||void 0===i||i.reset(),null===(r=this._recycle)||void 0===r||r.reset(),null===(s=this._distance)||void 0===s||s.reset()}resetTransformer(){var e;null===(e=this.transform)||void 0===e||e.reset()}addActivedEvents(){}removeActivedEvents(){}_initContainer(){this.canvas.getLayer().add(this._container)}}se.Name="Interactive";var ne=i(97701),oe=i(35962),ae=i(79399),le=i(49036),he=i(70986),ce=i(27482),de=i(52579),ue=i(33839),ge=i(42476);const _e=[[n.Z,{isDisabled:!1}],[oe.Z,{isDisabled:!1}],[o.Z,{isDisabled:!1}],[ne.Z,{isDisabled:!1}],[ae.Z,{isDisabled:!1}],[ge.Z,{isDisabled:!1}],[s.Z,{isDisabled:!1}],[le.Z,{isDisabled:!1}],[he.Z,{isDisabled:!1}],[de.Z,{isDisabled:!1}],[ue.Z,{isDisabled:!1}],[se,{isDisabled:!1}],[ce.Z,{isDisabled:!1}]];class pe{constructor(e){this._layer=r.Z.layer(null,{id:f.Ui}),this._features={},this._initAwaitLocker=new a.G,this._renderer=e,e.stage.container.add(this._layer),this._initLayer(),this._installFeatures()}async onReady(){await this._initAwaitLocker.awaitForInit()}bootstrap(){Object.keys(this._features).forEach((e=>{this._features[e].bootstrap()})),!this._initAwaitLocker.hasBeenDone&&this._initAwaitLocker.initDone()}updated(){Object.values(this._features).forEach((e=>null==e?void 0:e.updated()))}destroy(){this._destroyFeatures()}getLayer(){return this._layer}getRenderer(){return this._renderer}getFeature(e){return this._features[e]}getInteractive(){return this.getFeature(se.Name)}getPageAbsoluteRect(){return this.getRenderer().getMainRenderer().getPageAbsoluteRect()}getPageAbsoluteRectWithBleedArea(){return this.getRenderer().getMainRenderer().getPageAbsoluteRectWithBleedArea()}reset(){Object.values(this._features).forEach((e=>null==e?void 0:e.reset()))}findByID(e){return u.Z.findByID(this.getLayer(),e)}resetSelection(){var e;null===(e=this.getInteractive().selection)||void 0===e||e.select([])}_initLayer(){this._layer.getNativeCanvasElement().style.zIndex=String(l.SA),this._layer.getNativeCanvasElement().style.pointerEvents="none"}_installFeatures(){_e.forEach((e=>{const[t,i]=e,{isDisabled:r=!1}=i;if(r)return;const s=t.Name;if(!s)return void h.t.error("\u8be5 Feature \u6ca1\u6709\u6307\u5b9a Name: ",t.name);if(this._features[s])return void h.t.error("\u8be5 Feature Name \u5df2\u7ecf\u5b58\u5728: ",s,t);const n=new t(this);this._features[s]=n}))}_destroyFeatures(){Object.values(this._features).forEach((e=>null==e?void 0:e.destroy())),this._features={}}}},47747:(e,t,i)=>{i.d(t,{_5:()=>a,dJ:()=>c,h1:()=>l,xV:()=>r});var r,s=i(71946),n=i(8757),o=i(67986);function a(e){if(s.Z.isTargetEqual(e,n.Wq.KONVA_STAGE)||s.Z.isTargetEqual(e,n.Wq.KONVA_LAYER))return{type:r.noMaterialArea,result:e};if(s.Z.isMaterialTarget(e)){const t=s.Z.getMaterialNodeByTarget(e);return t?(s.Z.handelMaterialNodeByTarget(t.attrs.type,t,e),{type:s.Z.isEqual(t,n.Wq.PAGE)?r.page:r.material,result:t}):{type:r.other,result:e}}const t=s.Z.getMultiMaterialsNodeByTarget(e);return null!=t&&t.length?{type:r.multiMaterials,result:t}:{type:r.other,result:e}}function l(e,t,i){const{currentTarget:r}=e,s=t.page.getPagePosition(),{pointerPos:n}=r;if(!n)return o.t.error("getHitLayers: pointerPos not exist"),[];const a={x:n.x-s.x,y:n.y-s.y};return t.page.getPointerIntersectLayers(a,i).map((e=>e.id))}!function(e){e[e.material=0]="material",e[e.noMaterialArea=1]="noMaterialArea",e[e.multiMaterials=2]="multiMaterials",e[e.page=3]="page",e[e.other=4]="other"}(r||(r={}));const h=[function(e,t){return s.Z.isEqual(e,n.Wq.IMAGE_CONTAINER)&&t.imageContainer.getLoading(e.id())},function(e,t){return s.Z.isEqual(e,n.Wq.IMAGE)&&t.image.getLoading(e.id())},function(e,t){return s.Z.isEqual(e,n.Wq.GRID)&&t.grid.getLoading(e.id())}];function c(e,t){return Boolean(h.find((i=>i(e,t))))}},26364:(e,t,i)=>{i.d(t,{x:()=>n});var r=i(51012),s=i(14368);class n{constructor(e,t){this._container=t,this._factory=new r.H2(e.getRenderer()),this._currentTransformerOperator=new s.C(e)}get currentTransformer(){return this._currentTransformerOperator.transformer}readonly(){var e;null===(e=this.currentTransformer)||void 0===e||e.readonly()}lock(){var e;null===(e=this.currentTransformer)||void 0===e||e.lock()}unlock(){var e;null===(e=this.currentTransformer)||void 0===e||e.unlock()}destroy(){}resetTransformer(){var e;this._lastRotaterDirection=null===(e=this.currentTransformer)||void 0===e?void 0:e.rotaterDirection,this._currentTransformerOperator.clearTransformer()}createTransformer(e,t){const i=e[0],{type:r}=i.attrs,s=this._factory.createTransformer(r,{rotaterDirection:this._lastRotaterDirection,...t});s&&(this._container.add(s),this._currentTransformerOperator.updateTransformer(s),s.select(i))}}},14368:(e,t,i)=>{i.d(t,{C:()=>r});class r{constructor(e){this._render=e}get transformer(){return this._transformer}clearTransformer(){this.transformer&&(this.transformer.unselect(),this.transformer.destroy(),delete this._transformer)}updateTransformer(e){this.clearTransformer(),this._transformer=e}}},49036:(e,t,i)=>{i.d(t,{Z:()=>a});var r=i(8757),s=i(34618),n=i(11005),o=i(6899);class a extends o.Z{constructor(){super(...arguments),this.openCrop=async e=>{if(this._isOpen)return;this._isOpen=!0;const{id:t}=e,i=this.canvas.getRenderer().findByID(t);if(!i)return;this._id=t,this._cropItem=i;const o=this.canvas.getRenderer().findByID((0,s.Vf)(t,r.Wq.PAGE).id);if(!o)return;this._cropImage=o;const a=this._calculateCutOutConfig(i),l=this._calculateCutOutConfig(o);l&&a&&(this.setOriginImageVisible(!1),await this._createCutOutContainer(l,a,e));const{onCropAdjustEnd:h,onCropAdjustStart:c}=e;h&&this.onAdjustEnd(h),c&&this.onAdjustStart(c),this._cropItem.fire(n.qB.cropstart)},this.confirmCrop=e=>{if(!(this._cropItem&&this._cropLimitBox&&this._interCropImage&&this._cropImage))return;const t=this._getBox(this._interCropImage),i=this._getBox(this._cropItem),r={x:(t.x-i.x)/i.scale.x,y:(t.y-i.y)/i.scale.y,width:t.width/i.scale.x,height:t.height/i.scale.y};this._cropImage.setAttrs({...r}),e({...r}),this.setOriginImageVisible(!0),this.closeCrop()},this._createCutOutContainer=async(e,t,i)=>{const{destroy:r,update:s,cropLayer:n}=this._createCropLayer(t,i.onClickMask),{destroy:o,update:a}=this._createLimitBox(n),l=this.canvas.getRenderer().accessors.page.getBackgroundImage(this._id||"");if(!l)throw new Error("image container cut out, imageData not exist");const{destroy:h,update:c}=await this._createImage(e,n,l);this._disposeCutOutContainer=()=>{h(),r(),o(),delete this._cutOutContainerUpdaterHelper,delete this._disposeCutOutContainer},this._cutOutContainerUpdaterHelper=()=>{a(),s(),c()}}}closeCrop(){var e;super.closeCrop(),null===(e=this._cropItem)||void 0===e||e.fire(n.qB.cropend)}getClipPathData(){if(!this._cropItem)return;const{id:e}=this._cropItem.attrs;if(!e)return;const t=this.canvas.getRenderer().model.getPageById(e);if(!t)return;const{width:i,height:r}=t.dimension;return`M0,0L${i},0L${i},${r}L0,${r}L0,0`}}a.Name="pageBgImageCutOut"},70986:(e,t,i)=>{i.d(t,{Z:()=>g});var r=i(41575),s=i(15516),n=i(60110),o=i(72918),a=i(8757),l=i(7063),h=i(11005),c=i(34618),d=i(63345),u=i(50477);class g extends r.Z{constructor(){super(...arguments),this.openReplace=e=>{if(this._isOpen)return;this._isOpen=!0;const{id:t}=e,i=this.canvas.getRenderer().findByID(t);i&&(this._page=i,this._setOriginPageVisible(!1),this._create(e),this._page.fire(h.qB.replacestart))},this.closeReplace=()=>{var e,t;this._isOpen&&(this._isOpen=!1,this._setOriginPageVisible(!0),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this),null===(t=this._page)||void 0===t||t.fire(h.qB.replaceend))}}bootstrap(){this.toActived()}updated(){var e;null===(e=this._replaceContainerUpdaterHelper)||void 0===e||e.call(this)}destroy(){var e;this.toDeactivated(),null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}reset(){var e;null===(e=this._disposeReplaceContainer)||void 0===e||e.call(this)}addActivedEvents(){}removeActivedEvents(){}_calculateDropPageConfig(e){const{width:t,height:i}=e.size(),{x:r,y:s}=e.getAbsolutePosition(),{x:n,y:o}=e.getAbsoluteScale();return{x:r,y:s,width:t,height:i,scale:{x:n,y:o},rotation:e.getAbsoluteRotation()}}_createDropPageContainer(e,t){const i=this._calculateDropPageConfig(e.parent),r=e.clone();null==r||r.setAttrs({isReplace:!0,visible:!0,draggable:!1});[...r.getChildren()].forEach((t=>{const{type:i}=(0,c.Vf)(e.id(),a.Wq.PAGE),{type:r}=(0,c.Qb)(e.id(),a.Wq.PAGE),{type:n,id:o}=t.attrs;o!==s.zZ&&n!==i&&n!==r&&t.destroy()}));const o=l.Z.container(t);return null==o||o.setAttrs({...i,visible:!0}),l.Z.rect(o,{...null==r?void 0:r.getAttrs(),fill:n.oe,id:"",type:"",stroke:d.Jc,strokeWidth:2,strokeScaleEnabled:!1}),o.add(r),()=>{const t=this._calculateDropPageConfig(e.parent);o.setAttrs({...t})}}_createMask(e,t){const{width:i,height:r}=this.canvas.getRenderer().stage;l.Z.rect(e,{fill:(0,o.G)()?d.PY:d.AI,x:0,y:0,width:i,height:r}).on("click",t)}async _create(e){const{onClickMask:t}=e,i=this._page;if(!i)return;const r=this.canvas.getLayer(),s=l.Z.container(r);this._createMask(s,t);const n=await this._createDropPageContainer(i,s);this._disposeReplaceContainer=()=>{s.destroy(),delete this._disposeReplaceContainer,delete this._replaceContainerUpdaterHelper},this._replaceContainerUpdaterHelper=()=>{n()}}_setOriginPageVisible(e){var t,i;const r=null===(t=this._page)||void 0===t?void 0:t.id();if(!r)return;null===(i=this._page)||void 0===i||i.visible(e);const s=(0,u.b)(r);if(!s)return;const n=this.canvas.findByID(s);null==n||n.visible(e)}}g.Name="pageBgImageReplace"},33839:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(41575),s=i(16179);const n=["rgba(0, 0, 0, 0.40)","#fff"];var o=i(24638),a=i(26364),l=i(71946),h=i(8757);class c extends r.Z{constructor(){super(...arguments),this.show=()=>{this._bleedLine.show();const e=this._getActivePageWidget();this.canvas.getRenderer().stateManager.setBleedArea(12),null==e||e.renderBleedArea(12),this._checkPageTransformerUpdate(),o.s.update()},this.hide=()=>{this._bleedLine.hide();const e=this._getActivePageWidget();this.canvas.getRenderer().stateManager.clearBleedArea(),null==e||e.removeBleedArea(),this._checkPageTransformerUpdate(),o.s.update()},this._checkPageTransformerUpdate=()=>{var e,t;const i=null===(e=this.canvas.getInteractive().selection)||void 0===e?void 0:e.selectedIds;if(1!==(null==i?void 0:i.length))return;const r=null===(t=this.canvas.getInteractive().transform)||void 0===t?void 0:t.currentTransform;if(!(r instanceof a.x))return;const[s]=i,n=this._getNode(s),o=r.currentTransformer;n&&o&&l.Z.isEqual(n,h.Wq.PAGE)&&o.forceUpdate()}}bootstrap(){this.toActived(),this._createBleedLine()}updated(){this._updateBleedLine()}destroy(){this.toDeactivated()}reset(){}addActivedEvents(){}removeActivedEvents(){}_getNode(e){return e?this.canvas.getRenderer().findByID(e):void 0}_getActivePageWidget(){return this.canvas.getRenderer().getMainRenderer().getActivePageWidget()}_createBleedLine(){this._bleedLine=new s.s({x:0,y:0,strokeWidth:1,strokeColor:n,isLocked:!0,listening:!1},this.canvas.getRenderer()),this.canvas.getLayer().add(this._bleedLine),this._bleedLine.hide()}_updateBleedLine(){const e=this.canvas.getPageAbsoluteRect();if(!e)return;const{x:t,y:i,width:r,height:s}=e;this._bleedLine.setAttrs({x:t,y:i,width:r,height:s})}}c.Name="pageBleed"},52579:(e,t,i)=>{i.d(t,{Z:()=>d});var r=i(15095),s=i(41575);const n=["#fff","rgba(17, 26, 44, 0.70)"],o=[3,3];var a=i(60748),l=i(7063),h=i(63345),c=i(8757);class d extends s.Z{constructor(){super(...arguments),this._container=l.Z.container(null),this.show=()=>{this._marginLine.show()},this.hide=()=>{this._marginLine.hide()}}bootstrap(){this.toActived(),this._createMarginLine()}updated(){this._updateMarginLine()}destroy(){this.toDeactivated(),this._container.destroy()}reset(){}addActivedEvents(){}removeActivedEvents(){}drawGuideLine(){this.removeGuideLine();const{xl:e,xr:t,yt:i,yb:r}=this._marginLine.getGuideLineData(),s=this.canvas.getRenderer().getMainRenderer().getPageContainer(),n=s.getAbsoluteScale(),o=s.getAbsolutePosition(),a={x:e*n.x+o.x,y:i*n.y+o.y,width:(t-e)*n.x,height:(r-i)*n.y};this._marginGuideLine=l.Z.rect(this._container,{x:a.x,y:a.y,width:a.width,height:a.height,strokeWidth:1,stroke:h.q,listening:!1})}removeGuideLine(){var e;null===(e=this._marginGuideLine)||void 0===e||e.destroy()}getHorizontalGuideLineInfo(e,t){const i=[e.yt,e.ym,e.yb],r=[a.wb.Y_TOP,a.wb.Y_MIDDLE,a.wb.Y_BOTTOM],s=this._marginLine.getGuideLineData(),n=[s.yt,s.yb],o=this._getMinDistanceInfo(i,n,t);if(o){return{scene:c.ul.PAGE_MARGIN_LINE,source:e,target:[],guideLinePosition:o.position,direction:r[o.sourcePositionIndex],offset:o.offset}}}getVerticalGuideLineInfo(e,t){const i=[e.xl,e.xm,e.xr],r=[a.wb.X_LEFT,a.wb.X_MIDDLE,a.wb.X_RIGHT],s=this._marginLine.getGuideLineData(),n=[s.xl,s.xr],o=this._getMinDistanceInfo(i,n,t);if(o){return{scene:c.ul.PAGE_MARGIN_LINE,source:e,target:[],guideLinePosition:o.position,direction:r[o.sourcePositionIndex],offset:o.offset}}}_getMinDistanceInfo(e,t,i){let r;return e.forEach(((e,s)=>{t.forEach((t=>{if(!e)return;const n=t-e;Math.abs(n)<i&&(!r||Math.abs(n)<Math.abs(r.offset))&&(r={position:t,offset:n,sourcePositionIndex:s})}))})),r}_createMarginLine(){this.canvas.getLayer().add(this._container),this._marginLine=new r.O({x:0,y:0,dash:o,dashColor:n,dashOffset:1.5,strokeWidth:.5,isLocked:!0,listening:!1},this.canvas.getRenderer()),this._container.add(this._marginLine),this._marginLine.hide()}_updateMarginLine(){const e=this.canvas.getPageAbsoluteRect();if(!e)return;const{x:t,y:i,width:r,height:s}=e,n=this._getPageMargin(e);this._marginLine.setAttrs({x:t+n,y:i+n,width:r-2*n,height:s-2*n})}_getPageMargin(e){return.1*Math.min(e.width,e.height)}}d.Name="pageMargin"},27482:(e,t,i)=>{i.d(t,{Z:()=>B});var r=i(41575),s=i(43382),n=i(3549),o=i(54643),a=i(7063),l=i(8757),h=i(25629);const c="rgba(255, 255, 255, 1)",d="rgba(0, 0, 0, 1)",u="rgba(7, 50, 71, 0.12)",g="rgba(248, 205, 184, 0.12)",_="rgba(24, 51, 78, 0.4)",p="rgba(255, 255, 255, 0.6)",f=l.cM+16,m=l.cM+20,v=l.cM+4;const y=[0,.14,.18,.27,.45,.68,.91,1.36,5],x=[(0,o.BE)(10),(0,o.BE)(10),(0,o.BE)(5),(0,o.BE)(5),(0,o.BE)(2),(0,o.BE)(2),(0,o.BE)(1),(0,o.BE)(1)],b=[4,10,4,10,4,10,4,10];const w="#DE5085",C=[4,4],I="#fff";var L=i(31091),R=i(60748),E=i(55900),M=i(54845),S=i(5317);const A={position:"fixed",padding:"4px",borderRadius:"4px",whiteSpace:"pre",zIndex:"10",fontWeight:"500",lineHeight:"16px",fontSize:"14px",opacity:"0.9",transform:"translate(0, 0)",backgroundColor:w,color:I},P={position:"fixed",padding:"4px 12px",borderRadius:"6px",whiteSpace:"nowrap",lineHeight:"20px",zIndex:"10",fontSize:"14px",opacity:"0.9",transform:"translate(5px, 5px)",backgroundColor:"#000",color:I};class T{constructor(){this._getPosition=e=>{const{x:t}=e,{y:i}=e,r=window.innerWidth-this._infoElement.offsetWidth,s=window.innerHeight-this._infoElement.offsetHeight;return{x:Math.max(0,Math.min(r,t)),y:Math.max(0,Math.min(s,i))}},this._createElement()}get element(){return this._infoElement}showRulerLineInfoTip(e,t){Object.assign(this._infoElement.style,A),this._show(e,t)}showRulerDragInfoTip(e,t){Object.assign(this._infoElement.style,P),this._show(e,t)}hide(){this._infoElement.style.display="none"}remove(){this._infoElement.remove()}_show(e,t){const{x:i,y:r}=this._getPosition(t);this._infoElement.textContent=e,this._infoElement.style.display="block",i&&(this._infoElement.style.left=`${i}px`),r&&(this._infoElement.style.top=`${r}px`)}_createElement(){const{document:e}=S.Z.getGlobalVars();this._infoElement=e.createElement("div"),e.body.appendChild(this._infoElement),this.hide()}}class D{constructor(e,t){this._rulerLineContainer=a.Z.container(null),this._rulerLineRecordList=[],this._lockAllStatus=!1,this._disableRulerInfo=!1,this._isVisible=!0,this._onRulerLineHoverActive=new E.j,this._onRulerLineUnHoverActive=new E.j,this._onRulerLineAdd=new E.j,this._onRulerLineDelete=new E.j,this._onRulerLineUpdate=new E.j,this.onRulerLineHoverActive=e=>this._onRulerLineHoverActive.event(e),this.onRulerLineUnHoverActive=e=>this._onRulerLineUnHoverActive.event(e),this.onRulerLineAdd=e=>this._onRulerLineAdd.event(e),this.onRulerLineDelete=e=>this._onRulerLineDelete.event(e),this.onRulerLineUpdate=e=>this._onRulerLineUpdate.event(e),this._container=e,this._canvas=t,this._verticalRulerInfo=new T,this._horizontalRulerInfo=new T}get rulerLineLength(){return this._rulerLineRecordList.length}get cursor(){return this._canvas.getRenderer().cursor}get verticalRulerInfo(){return this._verticalRulerInfo}get horizontalRulerInfo(){return this._horizontalRulerInfo}get rulerLineContainer(){return this._rulerLineContainer}switchStatus(e){e===l.nx.readonly?this._rulerLineContainer.listening(!1):this._rulerLineContainer.listening(!0)}moveToTop(){this._rulerLineContainer.moveToTop()}setRulerInfoDisable(e){this._disableRulerInfo=e,e&&this._hideRulerInfoTooltip()}init(){this._container.add(this._rulerLineContainer)}update(){this._rulerLineRecordList.forEach((e=>{const{position:t,rulerLine:i}=e,{direction:r}=i,s=this._getAbsolutePosition(t,r),n=i.getAbsolutePosition();r===l.$I.vertical?i.setAbsolutePosition({...n,x:s}):i.setAbsolutePosition({...n,y:s}),i.isOutsidePageContainer()||!this._isVisible?i.hide():i.show()}))}setVisible(e){this._isVisible=e,e?this.show():this.hide()}hoverActive(e){e.forEach((e=>e.hoverActive()))}unHoverActive(){this._rulerLineRecordList.forEach((e=>e.rulerLine.unHoverActive()))}show(){this._rulerLineRecordList.forEach((e=>{const{rulerLine:t}=e;t.isOutsidePageContainer()||t.show()}))}hide(){this._rulerLineRecordList.forEach((e=>{const{rulerLine:t}=e;t.hide()}))}remove(e){const t=this._rulerLineRecordList.find((t=>t.id===e));t&&(this._rulerLineRecordList=this._rulerLineRecordList.filter((t=>t.id!==e)),t.rulerLine.destroy())}async reset(e,t){const i=this._canvas.getRenderer().getMainRenderer().getActivePageWidget(),r=()=>{this.removeAll(),this.setLockAllStatus(e),this._hideRulerInfoTooltip(),t.forEach((e=>{e.direction===l.wb.HORIZONTAL&&this.addHorizontal(e.id,e.position),e.direction===l.wb.VERTICAL&&this.addVertical(e.id,e.position);const t=this._rulerLineRecordList.find((t=>t.id===e.id));if(!t)return;const{rulerLine:i}=t;i.isOutsidePageContainer()||!this._isVisible?i.hide():i.show()}))};await(null==i?void 0:i.onReady().then((()=>{r()})))}setLockAllStatus(e){this._lockAllStatus=e}getRulerLineIds(e){return this._rulerLineRecordList.filter((t=>{const{rulerLine:i}=t;return void 0===e||i.direction===e})).map((e=>e.id))}removeAll(e){this._rulerLineRecordList.forEach((t=>{const{rulerLine:i}=t;void 0!==e&&i.direction!==e||i.destroy()})),this._rulerLineRecordList=void 0!==e?this._rulerLineRecordList.filter((t=>t.rulerLine.direction!==e)):[]}lockAll(){this._rulerLineRecordList.forEach((e=>{const{rulerLine:t}=e;t.lock()})),this._hideRulerInfoTooltip()}unlockAll(){this._rulerLineRecordList.forEach((e=>{const{rulerLine:t}=e;t.unlock()}))}isAllLocked(){return this._rulerLineRecordList.every((e=>{const{rulerLine:t}=e;return t.isLocked}))}addVertical(e,t,i){this.newCreatingRuleLine(t,l.$I.vertical,i),this.addCreatingRuleLineToContainer(e),this._currentDragCreatingRuleLine=void 0}addHorizontal(e,t,i){this.newCreatingRuleLine(t,l.$I.horizontal,i),this.addCreatingRuleLineToContainer(e),this._currentDragCreatingRuleLine=void 0}newCreatingRuleLine(e,t,i){const r=i?e:this._getAbsolutePosition(e,t),{width:s,height:n}=this._canvas.getRenderer().stage.rect,o=t===l.$I.vertical?{x:r,y:0,height:n}:{x:0,y:r,width:s};this._currentDragCreatingRuleLine=new L.E({direction:t,strokeWidth:1,hoverColor:w,strokeColor:["rgba(222, 80, 133, 0.5)"],outsidePageDash:C,...o},this._canvas.getRenderer()),this._startPosition=r}moveCreatingRuleLine(e){var t,i;const{clientX:r,clientY:s}=e;if(!this._currentDragCreatingRuleLine)return;const{direction:n}=this._currentDragCreatingRuleLine,o=this._canvas.getRenderer().stage.rect,a=r-o.x,h=s-o.y,c={[l.$I.vertical]:{value:a,attrs:{x:a}},[l.$I.horizontal]:{value:h,attrs:{y:h}}}[n];null===(t=this._currentDragCreatingRuleLine)||void 0===t||t.setAttrs(c.attrs);let d=!1;Math.abs(this._startPosition-c.value)>3&&(d=Boolean(this.addCreatingRuleLineToContainer())),null===(i=this._currentDragCreatingRuleLine)||void 0===i||i.fire(d?"dragstart":"dragmove",{evt:e,target:this._currentDragCreatingRuleLine})}moveCreatingRuleLineEnd(e){var t;this._currentDragCreatingRuleLine&&(null===(t=this._currentDragCreatingRuleLine)||void 0===t||t.fire("dragend",{evt:e,target:this._currentDragCreatingRuleLine}),this._currentDragCreatingRuleLine=void 0,this._isCurrentDragCreatingRuleLineByOption=void 0)}addCreatingRuleLineToContainer(e){var t;if(!this._currentDragCreatingRuleLine)return;if((null!==(t=this._rulerLineContainer.children)&&void 0!==t?t:[]).includes(this._currentDragCreatingRuleLine))return;const i=this._currentDragCreatingRuleLine;this._lockAllStatus&&i.lock(),this._rulerLineContainer.add(i);const r=null!=e?e:(0,n.V)();return i.id(r),this._rulerLineRecordList.push({id:r,rulerLine:i,position:this._getPageContainerPositionByRulerLine(i)}),i.on("dragstart",(e=>this._onDragStart(i,e))),i.on("dragend",(e=>this._onDragEnd(i,e))),i.on("dragmove",(e=>this._onDragMove(i,e))),i.on("hoverActive",(e=>this._onHoverActive(i,e))),i.on("unHoverActive",(e=>this._onUnHoverActive(i,e))),i.on("contextmenu",(e=>this._onContextmenu(i,e))),i}getHorizontalGuideLineInfo(e,t){const i=[e.yt,e.ym,e.yb],r=[R.wb.Y_TOP,R.wb.Y_MIDDLE,R.wb.Y_BOTTOM],s=this._rulerLineRecordList.filter((e=>e.rulerLine.direction===l.$I.horizontal)).map((e=>({id:e.id,position:e.rulerLine.getGuideLineData().yt}))).sort(((e,t)=>e.position-t.position)),n=this._getMinDistanceInfo(i,s,t);if(n){const{rulerLine:t}=this._rulerLineRecordList.find((e=>e.id===n.id));return{scene:l.ul.RULER_LINE,source:e,target:[{id:n.id,width:t.width(),height:t.height(),node:t,type:l.Wq.RULER_LINE,xl:0,xm:0,xr:0,yt:n.position,ym:n.position,yb:n.position}],guideLinePosition:n.position,direction:r[n.sourcePositionIndex],offset:n.offset}}}getVerticalGuideLineInfo(e,t){const i=[e.xl,e.xm,e.xr],r=[R.wb.X_LEFT,R.wb.X_MIDDLE,R.wb.X_RIGHT],s=this._rulerLineRecordList.filter((e=>e.rulerLine.direction===l.$I.vertical)).map((e=>({id:e.id,position:e.rulerLine.getGuideLineData().xl}))).sort(((e,t)=>e.position-t.position)),n=this._getMinDistanceInfo(i,s,t);if(n){const{rulerLine:t}=this._rulerLineRecordList.find((e=>e.id===n.id));return{scene:l.ul.RULER_LINE,source:e,target:[{id:n.id,width:t.width(),height:t.height(),node:t,type:l.Wq.RULER_LINE,xl:n.position,xm:n.position,xr:n.position,yt:0,ym:0,yb:0}],guideLinePosition:n.position,direction:r[n.sourcePositionIndex],offset:n.offset}}}_getMinDistanceInfo(e,t,i){let r;return e.forEach(((e,s)=>{t.forEach((t=>{if(!e)return;const n=t.position-e;Math.abs(n)<i&&(!r||Math.abs(n)<Math.abs(r.offset))&&(r={id:t.id,position:t.position,offset:n,sourcePositionIndex:s})}))})),r}_getPageContainerPositionByRulerLine(e){const t=e.getAbsolutePosition(),{direction:i}=e,r=i===l.$I.horizontal?t.y:t.x;return this._getPageContainerPosition(r,i)}_getPageContainerPosition(e,t){const i=this._canvas.getRenderer().getMainRenderer().getPageContainer(),r=i.getAbsoluteScale(),s=i.getAbsolutePosition(),n=(e-s.x)/r.x,o=(e-s.y)/r.y;return t===l.$I.vertical?n:o}_getAbsolutePosition(e,t){const i=this._canvas.getRenderer().getMainRenderer().getPageContainer(),r=i.getAbsoluteScale(),s=i.getAbsolutePosition();return t===l.$I.vertical?e*r.x+s.x:e*r.y+s.y}_handleDragCopyStart(e,t){const i=this._getRulerLineRecord(e);if(e.isOutsidePageContainer()||!i)return;const{evt:r}=t;if(r.metaKey||r.altKey){const{direction:t}=e;this.newCreatingRuleLine(i.position,t),this._isCurrentDragCreatingRuleLineByOption=!0,this.addCreatingRuleLineToContainer()}}_destroyRulerLine(e){this._rulerLineRecordList=this._rulerLineRecordList.filter((t=>t.rulerLine!==e)),e.destroy()}_updateRulerLinePosition(e,t){const i=this._getRulerLineRecord(e);i&&(i.position=t)}_getGuideDirection(e){return e===l.$I.horizontal?l.wb.HORIZONTAL:l.wb.VERTICAL}_getRulerLineRecord(e){return this._rulerLineRecordList.find((t=>t.rulerLine===e))}_handleDragCopyEnd(e){const{evt:t}=e;if(!this._currentDragCreatingRuleLine||!this._isCurrentDragCreatingRuleLineByOption)return;let i=!0;return t.metaKey||t.altKey||(this._destroyRulerLine(this._currentDragCreatingRuleLine),i=!1),this._currentDragCreatingRuleLine=void 0,this._isCurrentDragCreatingRuleLineByOption=!1,i}_onDragStart(e,t){this._handleDragCopyStart(e,t)}_onDragEnd(e,t){const i=e===this._currentDragCreatingRuleLine,r=this._getRulerLineRecord(e);if(!r)return;const s=this._handleDragCopyEnd(t),o=this._getPageContainerPositionByRulerLine(e);e.isOutsidePageContainer()?(this._destroyRulerLine(e),this._hideRulerInfoTooltip(),i||this._onRulerLineDelete.fire({id:r.id,position:o,direction:this._getGuideDirection(e.direction)})):(this._updateRulerLinePosition(e,o),i?(this._onRulerLineAdd.fire({line:{id:r.id,position:o,direction:this._getGuideDirection(e.direction)}}),this._lockAllStatus&&this._hideRulerInfoTooltip()):s?this._onRulerLineAdd.fire({line:{id:(0,n.V)(),position:o,direction:this._getGuideDirection(e.direction)},isCopy:!0}):this._onRulerLineUpdate.fire({id:r.id,position:o}))}_onHoverActive(e,t){this._onRulerLineHoverActive.fire(e),this._showRulerInfoTooltip(e,t.evt)}_onUnHoverActive(e,t){this._onRulerLineUnHoverActive.fire(e),this._hideRulerInfoTooltip()}_onDragMove(e,t){this._showRulerInfoTooltip(e,t.evt),e.isOutsidePageContainer()&&(e.direction===l.$I.horizontal?this.cursor.useVerticalDragDeleteCursor():this.cursor.useHorizontalDragDeleteCursor())}_getRulerInfo(e){const t=this._canvas.getRenderer().getMainRenderer().getDimension();if(!t)return;const{unit:i}=t,{width:r,height:s}=t,{direction:n}=e,a=n===l.$I.horizontal?"y":"x",h=e.getGuideLineData();let c=n===l.$I.horizontal?h.yt:h.xl;if(void 0===c)return;i===l.fb.CM&&(c=(0,o.$S)(c));const d=c/(n===l.$I.horizontal?s:r)*100,u=i===l.fb.CM?"mm":"px";return i===l.fb.CM&&(c*=10),`${a}: ${(0,M.v)(c)} ${u}  ${(0,M.v)(d,1)}%`}_showRulerInfoTooltip(e,t){const i=this._getRulerInfo(e),{x:r,y:s}=this._canvas.getRenderer().stage.rect;if(i&&!this._disableRulerInfo){const t=e.getAbsolutePosition(),n={x:e.direction===l.$I.horizontal?r+l.d0:r+t.x,y:e.direction===l.$I.vertical?s+l.cM+l.d0:s+t.y};e.direction===l.$I.horizontal?this._horizontalRulerInfo.showRulerLineInfoTip(i,n):this._verticalRulerInfo.showRulerLineInfoTip(i,n)}}_hideRulerInfoTooltip(){this._horizontalRulerInfo.hide(),this._verticalRulerInfo.hide()}_onContextmenu(e,t){const i=this._getRulerLineRecord(e);i&&!this._lockAllStatus&&h.Z.interact.onContextMenu.fire({type:l.bM.RulerLineMenu,position:{x:t.evt.clientX,y:t.evt.clientY},extInfo:{rulerLine:{id:null==i?void 0:i.id,position:null==i?void 0:i.position,direction:this._getGuideDirection(i.rulerLine.direction)}}})}}var k=i(71946);const O="__render_sdk_ruler_feature_local_key__";class B extends r.Z{constructor(){super(...arguments),this._disposableStore=new s.S,this._rulerContainer=a.Z.container(null),this._verticalRulerMarks=[],this._horizontalRulerMarks=[],this._visible=!1,this._localRecord={},this._dragCopyTip="",this._mappingRects=[],this._pageMoved=!1,this._theme=l.hY.Dark,this.updateTheme=e=>{var t,i,r,s;this._theme=e;const n=e===l.hY.Light,o=n?c:d,a=n?u:g;this._cornerRect.setAttrs({fill:o,stroke:a}),null===(t=this._horizontalRuler)||void 0===t||null===(i=t.setAttrs)||void 0===i||i.call(t,{fill:o,stroke:a}),null===(r=this._verticalRuler)||void 0===r||null===(s=r.setAttrs)||void 0===s||s.call(r,{fill:o,stroke:a}),this._updatedRulerMarkTheme(this._horizontalRulerMarks,n),this._updatedRulerMarkTheme(this._verticalRulerMarks,n)},this.updated=()=>{var e;if(!this._visible)return;this._updateGuideLineInfo(),this._resetRulerLineManager();this.canvas.getRenderer().getActivePage()&&(this._updatedRulerRect(),this._updateRulerMark(),this._updateRulerMapRect(),null===(e=this._rulerLineManager)||void 0===e||e.update())},this.addActivedEvents=()=>null,this.toActived=()=>null,this.toDeactivated=()=>{this._disposableStore.clear()},this.removeActivedEvents=()=>{this._disposableStore.clear()},this.setRulerVisible=e=>{var t;this._visible=e,e?(this._rulerContainer.show(),this.updated()):this._rulerContainer.hide(),null===(t=this._rulerLineManager)||void 0===t||t.setVisible(e),this._pageMoved||this.canvas.getRenderer().stage.fitToWindow()},this.addHorizontalRulerLine=(e,t)=>{var i;null===(i=this._rulerLineManager)||void 0===i||i.addHorizontal((0,n.V)(),e,t)},this.addVerticalRulerLine=(e,t)=>{var i;null===(i=this._rulerLineManager)||void 0===i||i.addVertical((0,n.V)(),e,t)},this.removeAllRulerLine=e=>{var t,i,r,s;switch(e){case l.ii.horizontal:null===(t=this._rulerLineManager)||void 0===t||t.removeAll(l.$I.horizontal);break;case l.ii.vertical:null===(i=this._rulerLineManager)||void 0===i||i.removeAll(l.$I.vertical);break;default:null===(r=this._rulerLineManager)||void 0===r||r.removeAll()}null!==(s=this._rulerLineManager)&&void 0!==s&&s.rulerLineLength||this.unlockAllRulerLine()},this.removeRulerLine=e=>{var t;null===(t=this._rulerLineManager)||void 0===t||t.remove(e)},this.isAllRulerLineLocked=()=>{var e;return null===(e=this._rulerLineManager)||void 0===e?void 0:e.isAllLocked()},this.lockAllRulerLine=()=>{var e,t;null===(e=this._rulerLineManager)||void 0===e||e.lockAll(),null===(t=this._rulerLineManager)||void 0===t||t.setLockAllStatus(!0)},this.unlockAllRulerLine=()=>{var e,t;null===(e=this._rulerLineManager)||void 0===e||e.unlockAll(),null===(t=this._rulerLineManager)||void 0===t||t.setLockAllStatus(!1)},this.toggleVisible=()=>{this.setRulerVisible(!this._visible)},this._bindContextEvent=()=>(this._rulerContainer.on("contextmenu",(e=>{e.evt.preventDefault();const{hitHorizontalArea:t,hitVerticalArea:i}=this._getHitRulerArea(e.evt);let r=l.ii.all;i&&(r=l.ii.vertical),t&&(r=l.ii.horizontal),h.Z.interact.onContextMenu.fire({type:l.bM.RulerMenu,position:{x:e.evt.clientX,y:e.evt.clientY},extInfo:{area:r}})})),()=>this._rulerContainer.off("contextmenu")),this._bindHoverEvent=()=>(this._rulerContainer.on("mouseleave",(()=>{this.canvas.getRenderer().cursor.useDefaultCursor(),this._rulerInfo.hide()})),this._rulerContainer.on("mousemove",(e=>{const{hitHorizontalArea:t,hitVerticalArea:i}=this._getHitRulerArea(e.evt);this._localRecord.hasShowDragCopyTip||!t&&!i?this._rulerInfo.hide():this._rulerInfo.showRulerDragInfoTip(this._dragCopyTip,{x:e.evt.clientX,y:e.evt.clientY}),i&&this.canvas.getRenderer().cursor.useEwResizeCursor(),t&&this.canvas.getRenderer().cursor.useNsResizeCursor()})),()=>{this._rulerContainer.off("mouseover mouseleave mousemove")}),this._bindDragEvent=()=>{const e=e=>{var t;null===(t=this._rulerLineManager)||void 0===t||t.moveCreatingRuleLine(e)},{document:t}=S.Z.getGlobalVars(),i=r=>{var s;null===(s=this._rulerLineManager)||void 0===s||s.moveCreatingRuleLineEnd(r),t.removeEventListener("mouseup",i),t.removeEventListener("mousemove",e)},r=r=>{const{hitHorizontalArea:s,hitVerticalArea:n}=this._getHitRulerArea(r.evt);if(s||n){var o,a;if(t.addEventListener("mouseup",i),t.addEventListener("mousemove",e),n)null===(o=this._rulerLineManager)||void 0===o||o.newCreatingRuleLine(r.evt.layerX,l.$I.vertical,!0);if(s)null===(a=this._rulerLineManager)||void 0===a||a.newCreatingRuleLine(r.evt.layerY,l.$I.horizontal,!0);this._localRecord.hasShowDragCopyTip||(this._localRecord.hasShowDragCopyTip=!0,this._saveLocalRecord())}};return this._rulerContainer.on("mousedown",r),this._rulerContainer.on("mouseup",i),()=>{t.removeEventListener("mouseup",i),t.removeEventListener("mousemove",e),this._rulerContainer.off("mousedown",r),this._rulerContainer.off("mouseup",i)}},this._onPageLayoutChange=e=>{e===l.$l.Move&&(this._pageMoved=!0)},this._onMaterialSelect=({selectedList:e=[]})=>{if(this._rulerContainer.moveToTop(),e.some((e=>(null==e?void 0:e.type)===l.F5.PAGE)))return void this._mappingRects.forEach((e=>e.hide()));const t=this.canvas.getRenderer().accessors.stage.getClientRectRelativeToStage(...e.map((e=>e.id)));this._mappingRects[0].setAttrs({width:null==t?void 0:t.width,height:l.d0,x:null==t?void 0:t.x,y:l.cM,visible:!0}),this._mappingRects[1].setAttrs({width:l.d0,height:null==t?void 0:t.height,x:0,y:null==t?void 0:t.y,visible:!0})},this._getAbsoluteRectFromDimension=()=>{const{model:e}=this.canvas.getRenderer(),t=this.canvas.getRenderer().getActivePageIndex();return(0,o.Ln)(e.pages[t].dimension)},this._getPageUnit=()=>{const{model:e}=this.canvas.getRenderer(),t=this.canvas.getRenderer().getActivePageIndex();return e.pages[t].dimension.unit},this._resetRulerLineManager=()=>{if(!this._rulerLineManager)return;const{isLocked:e,lines:t}=this._guideLineInfo;this._rulerLineManager.reset(e,t)},this._onDocMouseOver=e=>{const t=this.canvas.getRenderer().getMainRenderer().getLayer().getNativeCanvasElement();if(!this._rulerLineManager)return;const{verticalRulerInfo:i,horizontalRulerInfo:r}=this._rulerLineManager;var s,n;t!==e.target&&i.element!==e.target&&r.element!==e.target?null===(s=this._rulerLineManager)||void 0===s||s.setRulerInfoDisable(!0):null===(n=this._rulerLineManager)||void 0===n||n.setRulerInfoDisable(!1)},this._buildRulerLineManager=()=>{const{document:e}=S.Z.getGlobalVars();this._rulerLineManager=new D(this.canvas.getLayer(),this.canvas),this._disposableStore.add(this._rulerLineManager.onRulerLineHoverActive((e=>{e.moveTo(this.canvas.getLayer())}))),this._disposableStore.add(this._rulerLineManager.onRulerLineUnHoverActive((e=>{this._rulerLineManager&&e.moveTo(this._rulerLineManager.rulerLineContainer)}))),e.addEventListener("mouseover",this._onDocMouseOver),this._disposableStore.add((()=>e.removeEventListener("mouseover",this._onDocMouseOver))),this._rulerLineManager.init(),this._resetRulerLineManager()},this._buildRuler=()=>{const{stage:e}=this.canvas.getRenderer(),t=e.rect;this.canvas.getLayer().add(this._rulerContainer),this.setRulerVisible(this._visible);const i=this._theme===l.hY.Light?c:d,r=this._theme===l.hY.Light?u:g;this._horizontalRuler=a.Z.rect(this._rulerContainer,{x:l.d0,y:l.cM,width:t.width,height:l.d0,fill:i,stroke:r,strokeWidth:1}),this._verticalRuler=a.Z.rect(this._rulerContainer,{x:0,y:l.cM+l.d0,width:l.d0,height:t.height-l.cM,fill:i,stroke:r,strokeWidth:1}),this._cornerRect=a.Z.rect(this._rulerContainer,{x:0,y:l.cM,width:l.d0,height:l.d0,fill:i,stroke:r,strokeWidth:1});const s={x:0,y:0,width:0,height:0,fill:"rgba(0, 202, 224, 0.12)",visible:!1};this._mappingRects[0]=a.Z.rect(this._rulerContainer,s),this._mappingRects[1]=a.Z.rect(this._rulerContainer,s)},this._kickOutExcessive=(e,t,i,r)=>{const s=Math.ceil(t/i);if(e.length>s+1){e.splice(s,e.length-(s+1)).forEach((e=>{e.mark.destroy(),e.text.destroy(),e.children.forEach((e=>{var t;return null==e||null===(t=e.destroy)||void 0===t?void 0:t.call(e)}))}))}if(e.length<s+1)for(let n=e.length;n<s+1;n++){const t={mark:a.Z.line(this._rulerContainer,{points:[],stroke:this._theme===l.hY.Light?_:p,strokeWidth:1}),text:a.Z.text(this._rulerContainer,{fill:this._theme===l.hY.Light?_:p,fontSize:10,lineHeight:1.2,textAnchor:"middle"}),children:[]};e.push(t)}e.forEach((e=>{if(e.children.length+1>r){e.children.splice(r-1,e.children.length).forEach((e=>{var t;return null==e||null===(t=e.destroy)||void 0===t?void 0:t.call(e)}))}else if(e.children.length+1<r){const t=Array.from({length:r-1-e.children.length}).map((e=>a.Z.line(this._rulerContainer,{points:[],stroke:this._theme===l.hY.Light?_:p,strokeWidth:1})));e.children.push(...t)}}))},this._destroyBurdenMark=e=>{const t=e[e.length-1];t.children.splice(0,t.children.length).forEach((e=>{var t;return null==e||null===(t=e.destroy)||void 0===t?void 0:t.call(e)}))},this._updateRulerMark=()=>{const{width:e,height:t}=this._getAbsoluteRectFromDimension(),i=this._getPageUnit(),r=this.canvas.getRenderer().getActivePage().getAbsolutePosition(),{spacing:s,baseUnit:n,gridCount:a}=this._getRulerConfig(i);this._kickOutExcessive(this._horizontalRulerMarks,e,n,a),this._kickOutExcessive(this._verticalRulerMarks,t,n,a),this._horizontalRulerMarks.forEach(((e,t)=>{var h;const c=s*t+r.x;e.mark.setAttrs({points:[c,f,c,f+6]}),e.text.setAttrs({text:i===l.fb.PX?String(n*t):String(Math.round((0,o.$S)(n*t))),x:c-e.text.width()/2,y:v}),null===(h=e.children)||void 0===h||h.forEach(((t,i)=>{const r=i===Math.floor(e.children.length/2);t.setAttrs({points:[c+(i+1)*(s/a),r?m-2:m,c+(i+1)*(s/a),m+2]})}))})),this._verticalRulerMarks.forEach(((e,t)=>{var h;const c=s*t+r.y;e.mark.setAttrs({points:[l.d0-6,c,l.d0,c]}),e.text.setAttrs({text:i===l.fb.PX?String(n*t):String(Math.round((0,o.$S)(n*t))),x:4,y:c+e.text.width()/2,rotation:-90}),null===(h=e.children)||void 0===h||h.forEach(((t,i)=>{const r=i===Math.floor(e.children.length/2);t.setAttrs({points:[r?l.d0-2-2:l.d0-2,c+(i+1)*(s/a),l.d0,c+(i+1)*(s/a)]})}))})),this._destroyBurdenMark(this._horizontalRulerMarks),this._destroyBurdenMark(this._verticalRulerMarks),this._cornerRect.moveToTop()},this._updatedRulerRect=()=>{const{stage:e}=this.canvas.getRenderer(),t=e.rect;this._horizontalRuler.setAttrs({width:t.width}),this._verticalRuler.setAttrs({height:t.height})},this._updatedRulerMarkTheme=(e,t)=>{e.forEach((e=>{e.text.setAttrs({fill:t?_:p}),e.mark.setAttrs({stroke:t?_:p}),e.children.forEach((e=>{e.setAttrs({stroke:t?_:p})}))}))},this._updateRulerMapRect=()=>{const e=this.canvas.getRenderer().accessors.selection.getSelectedMaterials().filter((e=>{const t=this.canvas.getRenderer().findByID(e);return t&&!k.Z.isEqual(t,l.Wq.PAGE)})).map((e=>({id:e})));this._onMaterialSelect({selectedList:e})}}get scale(){return this.canvas.getRenderer().accessors.page.getZoom().x}get transform(){return this.canvas.getInteractive().transform}onRulerLineAdd(e){var t,i;return null!==(t=null===(i=this._rulerLineManager)||void 0===i?void 0:i.onRulerLineAdd(e))&&void 0!==t?t:s.G}onRulerLineDelete(e){var t,i;return null!==(t=null===(i=this._rulerLineManager)||void 0===i?void 0:i.onRulerLineDelete(e))&&void 0!==t?t:s.G}onRulerLineUpdate(e){var t,i;return null!==(t=null===(i=this._rulerLineManager)||void 0===i?void 0:i.onRulerLineUpdate(e))&&void 0!==t?t:s.G}bootstrap(){this._initData(),this._rulerInfo=new T,this._buildRulerLineManager(),this._buildRuler(),this._disposableStore.add(h.Z.interact.onMaterialSelect.event(this._onMaterialSelect)),this._disposableStore.add(h.Z.interact.onPageLayoutChange.event(this._onPageLayoutChange)),this._disposableStore.add(this.transform.onMaterialDragMove((()=>this._updateRulerMapRect()))),this._disposableStore.add(this._bindContextEvent()),this._disposableStore.add(this._bindDragEvent()),this._disposableStore.add(this._bindHoverEvent()),this._disposableStore.add(h.Z.interact.onPageZoomChange.event((({scale:e,oldScale:t})=>{e===t&&this.updated()})))}destroy(){this.removeActivedEvents()}reset(){}drawGuideLine(e){var t;const{target:i}=e,r=i.map((e=>e.node)).filter((e=>k.Z.isEqual(e,l.Wq.RULER_LINE)));null===(t=this._rulerLineManager)||void 0===t||t.hoverActive(r)}removeGuideLine(){var e;null===(e=this._rulerLineManager)||void 0===e||e.unHoverActive()}switchStatus(e){var t;e===l.nx.readonly?this._rulerContainer.listening(!1):this._rulerContainer.listening(!0),null===(t=this._rulerLineManager)||void 0===t||t.switchStatus(e)}getRulerLineIds(e){var t,i,r;switch(e){case l.ii.horizontal:return null===(t=this._rulerLineManager)||void 0===t?void 0:t.getRulerLineIds(l.$I.horizontal);case l.ii.vertical:return null===(i=this._rulerLineManager)||void 0===i?void 0:i.getRulerLineIds(l.$I.vertical);default:return null===(r=this._rulerLineManager)||void 0===r?void 0:r.getRulerLineIds()}}getRulerRect(){return{vertical:this._verticalRuler.getClientRect,horizontal:this._horizontalRuler.getClientRect}}getVisible(){return this._visible}setRulerLineInfoDisable(e){var t;null===(t=this._rulerLineManager)||void 0===t||t.setRulerInfoDisable(e)}setDragCopyTip(e){this._dragCopyTip=e}getVerticalGuideLineInfo(e,t){var i;if(this._visible)return null===(i=this._rulerLineManager)||void 0===i?void 0:i.getVerticalGuideLineInfo(e,t)}getHorizontalGuideLineInfo(e,t){var i;if(this._visible)return null===(i=this._rulerLineManager)||void 0===i?void 0:i.getHorizontalGuideLineInfo(e,t)}_initData(){this._readLocalRecord(),this._updateGuideLineInfo()}_updateGuideLineInfo(){this._guideLineInfo=this.canvas.getRenderer().model.guideLine}_readLocalRecord(){const{localStorage:e}=S.Z.getGlobalVars(),t=e.getItem(O);try{t&&(this._localRecord=JSON.parse(t))}catch(i){}}_saveLocalRecord(){const{localStorage:e}=S.Z.getGlobalVars();e.setItem(O,JSON.stringify(this._localRecord))}_getHitRulerArea(e){return{hitVerticalArea:e.layerY>l.d0+l.cM,hitHorizontalArea:e.layerX>l.d0}}_getRulerConfig(e){return e===l.fb.PX?function(e){const t=[0,.17,.34,.67,1.7,3.4,5],i=[500,200,100,50,25,10],r=[10,10,10,10,10,4];let s=50,n=4;for(let o=0;o<t.length-1;o++)if(e>=t[o]&&e<t[o+1]){s=i[o],n=r[o];break}return e>=l.Qf.MAX&&(s=10,n=4),{baseUnit:s,gridCount:n,spacing:s*e}}(this.scale):function(e){let t=10,i=4;for(let r=0;r<y.length-1;r++)if(e>=y[r]&&e<y[r+1]){t=x[r],i=b[r];break}return e>=l.Qf.MAX&&(t=(0,o.BE)(1),i=10),{baseUnit:t,gridCount:i,spacing:t*e}}(this.scale)}}B.Name="ruler"},61077:(e,t,i)=>{i.d(t,{Z:()=>_});var r=i(41575),s=i(43382),n=i(25629),o=i(7063),a=i(8757),l=i(71230),h=i.n(l),c=i(41064),d=i.n(c);const u={[a.hY.Dark]:"rgba(239, 227, 224, 0.2)",[a.hY.Light]:"rgba(16, 28, 31, 0.2)"},g={[a.hY.Dark]:"rgba(239, 227, 224, 0.4)",[a.hY.Light]:"rgba(16, 28, 31, 0.4)"};class _ extends r.Z{constructor(){super(...arguments),this._disposableStore=new s.S,this._delta={deltaX:0,deltaY:0},this._scrollContainer=o.Z.container(null),this._debounceUpdated=h()((()=>{this._onUpdateBarHandler({opacity:1})}),350),this.updated=()=>null,this.updateDebounce=()=>{this._onUpdateBarHandler({opacity:0}),this._debounceUpdated()},this.addActivedEvents=()=>null,this.toActived=()=>null,this.toDeactivated=()=>null,this.getScrollPosition=()=>this.canvas.getRenderer().stage.getScrollPosition(),this.setScrollByOffset=(e,t)=>{this._pageMoveByOffset(e,t),this._onUpdateBarHandler()},this._pageMoveByOffset=(e,t)=>{if(!e&&!t)return;const{width:i,height:r}=this._getViewPortReact(),s=this.canvas.getRenderer().stage.getPageContainer(),n=this.canvas.getRenderer().getActivePage(),o=n.getAbsolutePosition(),l=s.scaleX(),h=d()(o.x,2),c=d()(o.y,2),u=d()(n.width()*l+o.x,2),g=d()(n.height()*l+o.y,2);let _=e,p=t;h+e>i&&(_=i-h),c+t>r&&(p=r-c),u+e<a.O4&&(_=a.O4-u),g+t<a.O4+a.cM&&(p=a.O4+a.cM-g),this.canvas.getRenderer().stage.setPositionByOffset({offsetX:_,offsetY:p})},this._getTheme=()=>this.canvas.getRenderer().stage.theme||a.hY.Light,this._getBarColor=()=>u[this._getTheme()],this._getBarActiveColor=()=>g[this._getTheme()],this._getViewPortReact=()=>{const{clientHeight:e,clientWidth:t}=this.getScrollPosition();return{width:t-a.O4,height:e-a.O4}},this._onUpdateBarHandler=e=>{this._horizontalBar&&this._updateHorizontalBar(e),this._verticalBar&&this._updateVerticalBar(e)}}bootstrap(){}destroy(){this.removeActivedEvents()}reset(){}removeActivedEvents(){this._verticalBar.removeEventListener("dragmove"),this._verticalBar.removeEventListener("mouseenter"),this._verticalBar.removeEventListener("mouseleave"),this._horizontalBar.removeEventListener("dragmove"),this._horizontalBar.removeEventListener("mouseenter"),this._horizontalBar.removeEventListener("mouseleave"),this._disposableStore.clear()}_initListener(){this._disposableStore.add(n.Z.interact.onModelInitFinish.event((()=>this._onUpdateBarHandler()))),this._verticalBar.on("mouseenter",(()=>{this._verticalBar.setAttrs({fill:this._getBarActiveColor()})})),this._verticalBar.on("mouseleave",(()=>{this._verticalBar.setAttrs({fill:this._getBarColor()})})),this._verticalBar.on("dragmove",(()=>{const{deltaY:e}=this._delta;e&&(this._pageMoveByOffset(0,-Math.round(e)),this._updateVerticalBar())})),this._horizontalBar.on("mouseenter",(()=>{this._horizontalBar.setAttrs({fill:this._getBarActiveColor()})})),this._horizontalBar.on("mouseleave",(()=>{this._horizontalBar.setAttrs({fill:this._getBarColor()})})),this._horizontalBar.on("dragmove",(()=>{const{deltaX:e}=this._delta;e&&(this._pageMoveByOffset(-Math.round(null!=e?e:0),0),this._updateVerticalBar())}))}_buildScroller(e){const{stage:t}=this.canvas.getRenderer(),i=t.rect;this.canvas.getLayer().add(this._scrollContainer),this._verticalBar=o.Z.rect(this._scrollContainer,{width:6,fill:this._getBarColor(),opacity:1,cornerRadius:3,x:i.width-6,y:0,draggable:!0,dragBoundFunc(i){const{clientHeight:r,scrollHeight:s}=e.getScrollPosition();i.x=t.rect.width-6,i.y=Math.max(Math.min(i.y,r-this.height()),0);const n=r-e._verticalBar.height(),o=(i.y-e._verticalBar.y())/n*(s-r);return e._delta.deltaY=o,i}}),this._horizontalBar=o.Z.rect(this._scrollContainer,{height:6,fill:this._getBarColor(),opacity:1,cornerRadius:3,x:0,y:i.height-6,draggable:!0,dragBoundFunc(i){const{clientWidth:r,scrollWidth:s}=e.getScrollPosition();i.x=Math.max(Math.min(i.x,r-this.width()),0),i.y=t.rect.height-6;const n=r-e._horizontalBar.width(),o=(i.x-e._horizontalBar.x())/n*(s-r);return e._delta.deltaX=o,i}})}_updateHorizontalBar(e){var t;const{scrollLeft:i,scrollWidth:r,clientWidth:s,clientHeight:n}=this.getScrollPosition(),o=s/r*s,a=i/r*s;s&&n&&this._horizontalBar.setAttrs({fill:this._getBarColor(),width:o,x:a,y:n-6,opacity:null!==(t=null==e?void 0:e.opacity)&&void 0!==t?t:1})}_updateVerticalBar(e){var t;const{scrollTop:i,scrollHeight:r,clientWidth:s,clientHeight:n}=this.getScrollPosition(),o=n/r*n,a=i/r*n;s&&n&&this._verticalBar.setAttrs({fill:this._getBarColor(),height:o,y:a,x:s-6,opacity:null!==(t=null==e?void 0:e.opacity)&&void 0!==t?t:1})}}_.Name="scroller"},22049:(e,t,i)=>{i.d(t,{JJ:()=>g,EC:()=>v,r6:()=>c,tU:()=>x,X_:()=>y,N9:()=>f,si:()=>u,Mw:()=>d,MB:()=>m,yO:()=>p,id:()=>_});const r=[],s=new class{constructor(e){const t=new URL(e,window.location.href).toString(),i=`\tconst urlString = ${JSON.stringify(t)}\n\tconst originURL = new URL(urlString)\n\tconst originalImportScripts = self.importScripts\n\tself.importScripts = (url) => originalImportScripts.call(self, new URL(url, originURL).toString())\n\timportScripts(urlString);\n\t`,r=new Blob([i],{type:"application/javascript"}),s=URL.createObjectURL(r);this._worker=new Worker(s),URL.revokeObjectURL(s)}getWorker(){return this._worker}}(new URL(i.p+i.u(268),i.b)).getWorker(),n=document.createElement("canvas"),o=n.getContext("2d",{willReadFrequently:!0}),a=1e3;function l(e){let{width:t}=e,{height:i}=e;if(t<=0||i<=0)return;var r;if(e instanceof HTMLCanvasElement&&t*i<1e6)return null===(r=e.getContext("2d",{willReadFrequently:!0}))||void 0===r?void 0:r.getImageData(0,0,t,i);t>a?(t=a,i=a/e.width*e.height):i>a&&(i=a,t=a/e.height*e.width),n.width=t,n.height=i,o.drawImage(e,0,0,e.width,e.height,0,0,t,i);return o.getImageData(0,0,t,i)}function h(e){return(299*e[0]+587*e[1]+114*e[2])/1e3}function c(e){return h(e)>125?[0,0,0,1]:[255,255,255,1]}function d(e){return e.length<4?[...e,1]:e}function u(e,t,i=9){const r=h(e),s=h(t),n=Math.floor(256/i);return Math.abs(r-s)>n}function g(e){return d(e[0])}function _(e,t){const i=function(e,t){let i=-1,r=0,s=0;for(const n of t){const[t,o,a]=n;let l=Number.MAX_SAFE_INTEGER;for(const i of e){const[e,r,s]=i,n=Math.sqrt(Math.pow(t-e,2)+Math.pow(o-r,2)+Math.pow(a-s,2));n<l&&(l=n)}l>i&&(i=l,s=r),r++}return s}(e,t);return d(t[i])}function p(e,t,i=[255,255,255,1],r=9){const s={resultColor:[0,0,0,1],maxDiffColor:[0,0,0,1]};if(e.length<1||t.length<1)return s;const n=e.map((e=>h(e))),o=t.map((e=>h(e))),a=h(i),l=Math.floor(256/r),c=[];let u=-1,g=l/2.5,_=0;for(const h of o){let e=!0;for(const t of n){const i=Math.abs(t-h);if(i>g&&(g=i,u=_),i<l){e=!1;break}}e&&c.push(_),_++}return c.length>0&&(1===c.length||c.sort(((e,t)=>Math.abs(o[e]-a)-Math.abs(o[t]-a))),s.resultColor=d(t[c[0]])),-1!==u&&(s.maxDiffColor=d(t[u])),s}function f(e){return 0===e[0]&&0===e[1]&&0===e[2]}function m(e,t,i=[255,255,255,1],r=9){const{resultColor:s,maxDiffColor:n}=p(e,t,i,r);return f(s)?n:s}function v(e,t=5){return new Promise(((i,n)=>{const o=e instanceof ImageData?e:l(e);s.postMessage({imageData:o,colorCount:t,type:0}),r.push({resolve:i,reject:n})}))}function y(e,t=6){return new Promise(((i,n)=>{const o=e instanceof ImageData?e:l(e);s.postMessage({imageData:o,colorCount:t,type:1}),r.push({resolve:i,reject:n})}))}function x(e,t=.01){return new Promise(((i,n)=>{const o=e instanceof ImageData?e:l(e);s.postMessage({imageData:o,type:3,minRatio:t}),r.push({resolve:i,reject:n})}))}s.onerror=function(e){var t;const i=null===(t=r.shift())||void 0===t?void 0:t.reject;i&&i(e)},s.onmessage=function(e){var t;const i=null===(t=r.shift())||void 0===t?void 0:t.resolve;i&&i(e.data)}},67162:(e,t,i)=>{i.d(t,{Z:()=>O});var r=i(22049),s=i(2322),n=i(13995),o=i(37145),a=i(4114),l=i(23659),h=i(26684),c=i(58992),d=i(57860),u=i(79876),g=i(8757),_=i(48917),p=i(13578),f=i(34618),m=i(67986),v=i(54643),y=i(91372),x=i(61887),b=i(50650),w=i(82440),C=i(20484);Math.pow(6/29,3);function I(e,t){const[i,r,s]=e,[n,o,a]=t;return Math.sqrt(Math.pow(i-n,2)+Math.pow(r-o,2)+Math.pow(s-a,2))}function L(e){let[t,i,r]=e;t/=255,i/=255,r/=255;const s=Math.max(t,i,r),n=Math.min(t,i,r);let o=0,a=0;const l=s,h=s-n;if(a=0===s?0:h/s,s===n)o=0;else{switch(s){case t:o=(i-r)/h+(i<r?6:0);break;case i:o=(r-t)/h+2;break;case r:o=(t-i)/h+4}o/=6}return[Math.round(360*o),Math.round(100*a),Math.round(100*l)]}function R(e){let[t,i,r]=e;t/=360,i/=100,r/=100;let s=0,n=0,o=0;if(0===i)o=r,n=o,s=n;else{const e=Math.floor(6*t),a=6*t-e,l=r*(1-i),h=r*(1-a*i),c=r*(1-(1-a)*i);switch(e%6){case 0:s=r,n=c,o=l;break;case 1:s=h,n=r,o=l;break;case 2:s=l,n=r,o=c;break;case 3:s=l,n=h,o=r;break;case 4:s=c,n=l,o=r;break;case 5:s=r,n=l,o=h}}return[Math.round(255*s),Math.round(255*n),Math.round(255*o)]}const E=[[345,375],[15,35],[35,70],[70,160],[160,190],[190,255],[255,295],[295,345]],M=e=>e<15?e+360:e,S=(e,t)=>{const i=(e=>{const t=M(e),i=E.findIndex((e=>((e,t)=>e>=t[0]&&e<t[1])(t,e))),r=0===i?E.length-1:i-1,s=i===E.length-1?0:i+1;return[E[r][0],E[s][1]]})(e),r=M(e+t),s=(n=r,o=i[0],a=i[1],Math.min(Math.max(n,o),a));var n,o,a;return s>360?s-360:s};function A(e,t,i){const r=i[0]-t[0];return[S(e[0],r),i[1],i[2]]}function P(e){const{stops:t}=e,i=function(e){const t=[{color:e[0].color,offset:0},...e,{color:e[e.length-1].color,offset:1}];let i=0;const r=[0,0,0];for(let s=0,n=t.length;s<n-1;s++){const e=t[s].color,n=t[s+1].color,o=t[s].offset,a=t[s+1].offset-o;i+=a,r[0]+=(e[0]+n[0])*a/2,r[1]+=(e[1]+n[1])*a/2,r[2]+=(e[2]+n[2])*a/2}return r[0]/=i,r[1]/=i,r[2]/=i,r}(t);let r=1/0,s=0;for(let n=0,o=t.length;n<o;n++){const e=t[n].color,o=Math.floor(I(e,i));o<r&&(r=o,s=n)}return{color:t[s].color,index:s}}function T(e,t,i){if(Array.isArray(t))return e;const{color:r,index:s}=null!=i?i:P(t),n=(0,C.Sw)(t),o=L(e),a=L(r);n.stops.length;return n.stops.forEach(((t,i)=>{if(i===s)t.color=[e[0],e[1],e[2],t.color[3]];else{const e=t.color[3],i=L(t.color),r=A(o,a,i),[s,n,l]=R(r),h=[s,n,l,e];h&&(t.color=h)}})),n}function D(e){const{solid:t,linearGradient:i,radialGradient:r}=(0,y.tB)(e);return t?{color:t,index:0}:i?P(i):r?P(r):{color:[0,0,0,1],index:0}}var k=i(44264);class O{constructor(e){this._layer=new _.mh({listening:!1}),this._root=new s.G({}),this._showDebugLog=!1,this._paletteCache={},this._colorCache={},this._imageDiffCache={},this._backgroundColorUsed=!1,this._textColors=[],this._shapeColors=[],this._imageColors=[],this._renderSDK=e,e.stage.container.add(this._layer);const t=this._layer.canvas._canvas;t.style.top="80px",t.remove(),this._context=t.getContext("2d",{willReadFrequently:!0})}async getPaletteByElement(e){const t=e.toCanvas();let i=await(0,r.X_)(t),s=[];return i.length>0&&(i=i.map(((e,t)=>this._sortColors(e,t))),s=[],i.forEach((e=>{const t=e.map((e=>[...e,1]));s.push(t)}))),[{id:"",imageData:"",palette:s}]}async recommendPalette(e){const t=[];for(const i of e.layers){if(!i.isMainImage){m.t.info("[color]",`layer(${i.id})\u4e3a\u4e0d\u53ef\u53d6\u8272\u56fe\u5c42\uff0c\u5ffd\u7565\u53d6\u8272`);continue}const e=i.layout[2],r=i.layout[3];e<=10||e<=10||e*r<600?m.t.info("[color]",`layer(${i.id})\u56fe\u7247\u592a\u5c0f\uff0c\u5ffd\u7565\u53d6\u8272`):(m.t.info("[color]",`\u5f00\u59cb\u83b7\u53d6\u56fe\u5c42(${i.id})\u63a8\u8350\u8272`),await this._createPaletteByLayer(i,t))}return t}matchSvgImageColor(e,t,i){const r=this._renderSDK.getMainRenderer();for(const s of e.layers)if(s.type===g.F5.SVG_IMAGE){const e=r.getMaterialWidget(s.id),n=this._processSvgColor(e,t,i);s.color||(s.color={}),s.color.colorMap=n}return e}async _createPaletteByLayer(e,t,i=10){var s,o,a;const l=this._renderSDK.getMainRenderer(),{id:h}=e;let c;var d;"page"===e.type?c=null===(d=l.getActivePageWidget())||void 0===d?void 0:d.getBackgroundImage():c=l.getMaterialWidget(h);if(!c)return;const u=(null===(s=c.props.src)||void 0===s?void 0:s.resourceId)||(null===(o=c.props.src)||void 0===o?void 0:o.path),{layout:_}=c.props,{clipRect:p}=_,f=e.type===g.F5.IMAGE&&(!p||Math.abs(p.width-_.width)<10&&Math.abs(p.height-_.height)<10)&&void 0!==u&&(!c.props.aiTool||c.props.aiTool.pipelines.length<1);if(f&&this._paletteCache[u]){const i=this._paletteCache[u];if("empty"!==i){const e={...i,id:h};m.t.info("[color]","\u83b7\u53d6\u5230\u63a8\u8350\u989c\u8272(from cache)",e),t.push(e)}else m.t.info("[color]",`\u83b7\u53d6\u5230layer(${e.id})\u989c\u8272\u592a\u63a5\u8fd1\u4e22\u5f03(from cache)`);return}await c.onReady();const v=null===(a=c)||void 0===a?void 0:a.getElement();if(c&&v&&(c instanceof n.v||c instanceof x.l||v.attrs.image)&&!c.waitingState){const i=[];if(c instanceof n.v){const e=c;for(let t=0;t<e.props.items.length;t++){const r=e.props.items[t];if(r.fill.fillType===g.lm.IMAGE&&r.fill.image&&r.fill.canUpdate){const r=e.getItemCanvasByIndex(t);r&&i.push(r)}}}else if(c instanceof x.l){const e=c;for(let t=0;t<e.props.areas.length;t++){if(e.props.areas[t].fill.fillType===g.kl.IMAGE){const r=e.getItemCanvasByIndex(t);r&&i.push(r)}}}else{const e=v.getClientRect(),t=Math.max(200/e.width,200/e.height);i.push(v.toCanvas({pixelRatio:t}))}for(const s of i){let i,n=await(0,r.X_)(s);if(n.length>0){var y;n=n.map(((e,t)=>this._sortColors(e,t)));const r=[];n.forEach((e=>{const t=e.map((e=>[...e,1]));r.push(t)}));const o=(f?null===(y=v.attrs.image)||void 0===y?void 0:y.src:"")||s.toDataURL();i={id:e.id,imageData:o,palette:r},t.push(i),m.t.info("[color]","\u83b7\u53d6\u5230\u63a8\u8350\u989c\u8272",i)}else i="empty",m.t.info("[color]",`\u83b7\u53d6\u5230layer(${e.id})\u989c\u8272\u592a\u63a5\u8fd1(\u6bd4\u5982\u7eaf\u8272)\u4e22\u5f03`);f&&(this._paletteCache[u]="empty"!==i?{...i}:"empty")}}else if(i>0){const r=11-i;m.t.info("[color]",`layer(${e.id})\u83b7\u53d6\u989c\u8272\u5931\u8d25\uff0c\u5f00\u59cb\u8fdb\u884c\u91cd\u8bd5 ${r}`),await this.wait(400*r),await this._createPaletteByLayer(e,t,i-1)}else m.t.info("[color]",`layer(${e.id})\u91cd\u8bd510\u6b21\u4f9d\u7136\u5931\u8d25\uff0c\u653e\u5f03\u91cd\u8bd5`)}async wait(e){await new Promise((t=>{setTimeout((()=>{t(0)}),e)}))}waitRequestAnimationFrame(){return new Promise((e=>requestAnimationFrame((()=>e()))))}async autoColor(){const e=this._renderSDK.getMainRenderer().getLayer().canvas._canvas;let t=await(0,r.X_)(e);if(0===t.length){const e=[[255,190,190],[255,193,218],[255,235,190],[186,248,182],[173,200,255],[220,195,255]];e.sort(((e,t)=>Math.random()-.5)),t=[e]}const i=t[Math.floor(t.length*Math.random())],s=await this.applyPalettes(i);return s.palette=i,s}async applyStyle(e,t,i){const r=await this.applyPalettes(e,i);let s;try{if(s=await this.applyFonts(t,i),r.layers.length&&s.layers.length){for(const e of r.layers)for(const t of s.layers)if(e.id===t.id){e.font=t.font,e.layout=t.layout,e.richText=t.richText,e.textOuterRect=t.textOuterRect;break}return r}}catch(n){m.t.error(`applyStyle failure, cause:${null==n?void 0:n.message}`)}return r.layers.length?r:s}async applyFonts(e,t){if(!e||e.length<1)return{layers:[]};await this._renderSDK.waitRenderReady();const i=Date.now(),r=[];e.forEach((e=>{if(!w.fc.getDependency(e.resourceId)){const t=w.fc.getInstance().parser.text.fetchData({id:e.id,resourceId:e.resourceId,type:g.xP.SalesFont,fileUrl:{url:e.url,md5:e.md5}});r.push(t)}})),await Promise.all(r);const s=this._renderSDK.getActivePageIndex(),n=t?this._renderSDK.getPageIndexById(t):s,o=this._renderSDK.model.pages[n];if(n!==s){const e=this._createAIPageWidget(o);await this._renderWidget(e,this._layer,[],[])}const a=[];for(const g of o.layers)this._searchText(g,a);let l=0,h=1e4;a.sort(((e,t)=>(l=Math.max(l,e.size,t.size),h=Math.min(h,e.size,t.size),t.size-e.size)));let c=h+(l-h);if(2===a.length)c=h,h=-1e3;else if(a.length>2){c=a[Math.floor(a.length/2)].size}const d=[],u={};for(let g=0;g<2;g++){d.length=0;for(const t of a){const i=Math.abs(l-t.size),r=Math.abs(c-t.size),s=Math.abs(h-t.size);i<=r&&i<=s?await this._changeFont(t,e[0],d,u,0===g):r<=i&&r<=s?await this._changeFont(t,e[1],d,u,0===g):await this._changeFont(t,e[2],d,u,0===g)}}return m.t.info("[color]","\u914d\u7f6e\u5b57\u4f53\u8017\u65f6",Date.now()-i),{layers:d}}async _changeFont(e,t,i,r,s){var n,o;const{accessors:a}=this._renderSDK,l={...t,fallbackTextInfoList:[]},h=k.f.cache.get(`${e.id}-AI`),c=await a.text.revalidateTextLayerRenderHeight(e.id,{autoWrap:!1,defaultEffectTextNode:h});let d=!1;if(c&&c.innerBoundWidth-2>e.layout.width&&(d=!0),d&&s)return;const u=JSON.parse(null!==(n=null===(o=a.text.getNodeLayer(e.id))||void 0===o?void 0:o.richText)&&void 0!==n?n:"");null==u||u.styles.forEach((e=>{var i,r;e.font={id:t.resourceId,path:null!==(i=null===(r=w.fO.resource.get(t.resourceId))||void 0===r?void 0:r.fsPath)&&void 0!==i?i:""};const{bold:s,italic:n,underline:o}=t.attributes||{};"boolean"==typeof s&&(e.bold=s),"boolean"==typeof n&&(e.italic=n),"boolean"==typeof o&&(e.underline=o)}));let _=await a.text.revalidateTextLayerRenderHeight(e.id,{autoWrap:d,params:{richText:JSON.stringify(u)},defaultEffectTextNode:h});if(_)if(d){const t={height:_.innerBoundHeight},r={width:e.layout.width+(_.outerBoundWidth-_.innerBoundWidth),height:t.height+(_.outerBoundHeight-_.innerBoundHeight)};i.push({id:e.id,type:g.F5.TEXT,font:l,richText:u,layout:t,textOuterRect:r})}else{var p;const{innerBoundWidth:t}=_,n=t>e.layout.width;if(!n&&s)return;const o=t+10,c=e.layout.width/o;u.styles.forEach((e=>{var t;const i=`${e.font.id}-${e.size}`,s=r[i],o=null!==(t=e.size)&&void 0!==t?t:12,a=null!=s?s:n?o*c:o;!s&&n&&(r[i]=a),e.size=a})),_=null!==(p=await a.text.revalidateTextLayerRenderHeight(e.id,{defaultEffectTextNode:h,autoWrap:d,width:e.layout.width,params:{richText:JSON.stringify(u)}}))&&void 0!==p?p:_;const f={y:e.layout.y-(_.innerBoundHeight-e.layout.height)*e.layout.scale.y/2,height:_.innerBoundHeight},m={width:e.layout.width+(_.outerBoundWidth-_.innerBoundWidth),height:f.height+(_.outerBoundHeight-_.innerBoundHeight)};i.push({id:e.id,type:g.F5.TEXT,font:l,richText:u,layout:f,textOuterRect:m})}}_searchText(e,t){if(e.type!==g.F5.TEXT||e.isLocked){if(e.type===g.F5.GROUP_LAYER){const i=e;for(const e of i.children)this._searchText(e,t)}}else{const i=e,r=(0,b.Of)(i);t.push({id:i.id,fontSize:null!=r?r:7,size:(null!=r?r:7)*i.layout.scale.x,layout:i.layout})}}async applyPalettes(e,t){if(!e||e.length<1)return{layers:[]};await this._renderSDK.waitRenderReady();const i=Date.now(),r=t?this._renderSDK.getPageIndexById(t):this._renderSDK.getActivePageIndex(),s=this._renderSDK.model.pages[r],n=(0,v.Ln)(s.dimension);this._resizeCanvas(n.width,n.height),this._layer.destroyChildren(),this._colorCache={},this._backgroundColorUsed=!1,this._textColors=e.slice(e.length-1),this._shapeColors=this._getCenterColors(e.concat()),this._imageColors=this._getCenterColors(e.concat());const o=[],a=this._createAIPageWidget(s);return await this._renderWidget(a,this._layer,e,o),m.t.info("[color]","\u667a\u80fd\u914d\u8272\u5e94\u7528\u989c\u8272\u8017\u65f6",Date.now()-i),{layers:o}}_createAIPageWidget(e){this._isAIPageWidgetExist(e)&&this._removeAIPageWidget(e);const t=this._renderSDK.getMainRenderer().getPixel(),i=this._renderSDK.getMainRenderer().getZoom(),r=new o.C({...e,pixels:t,zoom:i,id:(0,f.QJ)(e.id)});return this._root.addChild(r),e.layers.forEach((e=>this._createWidget(r,e,t,i))),r}_isAIPageWidgetExist(e){const t=this._root.getChildren().find((t=>t.getId()===(0,f.QJ)(e.id)));return Boolean(t)}_removeAIPageWidget(e){const t=this._root.getChildren().find((t=>t.getId()===(0,f.QJ)(e.id)));null==t||t.remove()}_createWidget(e,t,i,r){const{type:s}=t,n={...t,pixels:i,zoom:r,id:(0,f.QJ)(t.id)},o=this._createWidgetByLayer(n);if(e.addChild(o),s===g.F5.GROUP_LAYER){n.children.forEach((e=>{this._createWidget(o,{...e,groupId:t.id},i,r)}))}}_createWidgetByLayer(e){const{type:t}=e;if(t===g.F5.GROUP_LAYER)return new a.f(e);return new((0,p.j)(t))(e)}_renderWidgetWithTimeout(e,t,i){return new Promise((async r=>{const s=setTimeout((()=>{r(void 0)}),i),n=await e.render(t,!0);clearTimeout(s),r(n)}))}async _renderWidget(e,t,i,s){const p=await this._renderWidgetWithTimeout(e,t,500);if(!p)return void m.t.info("[color]","\u5e94\u7528\u989c\u8272\u65f6\uff0c\u90e8\u5206\u56fe\u7247\u52a0\u8f7d\u8d85\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u53d6\u8272\u4e0d\u51c6\u786e");const v=(0,f.Mz)(e.getId());if(!this._renderSDK.accessors.layer.isLocked([v])){if(await this.waitRequestAnimationFrame(),i.length>0)if(e instanceof o.C){const t=(0,r.JJ)(i),n=T(t,e.getFillColor());e.setBgColor(n),this._debugColor("\u9875\u9762\u80cc\u666f",t),s.push({id:v,type:g.F5.PAGE,color:{background:n}})}else if(e instanceof l.y){var x;const t=e.props,n=(0,b.Pk)(t),o=n.fill,a=await this._findTextColor(e,i,o);let l,h,c,d=a;null!==(x=t.background)&&void 0!==x&&x.enable&&t.background.color&&(0,y.aj)(t.background.color,a)&&(l=a,d=(0,r.id)([a],i),this._debugColor("\u6587\u672c\u80cc\u666f",a));const{glow:u}=t;if(null!=u&&u.enable){const e=this._generateColor(d,o,u.color);u.color=e}this._debugColor("\u6587\u672c\u989c\u8272",d),n.stroke&&(h=this._generateColor(d,o,n.stroke),this._debugColor("\u6587\u672c\u63cf\u8fb9",h)),n.shadow&&(c=this._generateColor(d,o,n.shadow),this._debugColor("\u6587\u672c\u9634\u5f71",c));const g=[d[0],d[1],d[2],o[3]];s.push({id:v,type:e.type,color:{fill:g,background:l,stroke:h,shadow:c,glow:u}}),e.setColors(g,l,h,c)}else if(e instanceof h.t){const t=await this._findShapeColor(e,i),r=e.getFillColor();if(r){const i=D(r);let n;this._debugColor("\u5f62\u72b6\u989c\u8272",t);const o=e.getStrokeColor();if(o){const e=D(o),r=this._generateColor(t,i.color,e.color);n=T(r,o,e),this._debugColor("\u5f62\u72b6\u63cf\u8fb9",r)}const a=T(t,r,i);await e.setColors(a,n),s.push({id:v,type:e.type,color:{fill:a,stroke:n}})}else{const i=T(t,e.getStrokeColor());await e.setColors(void 0,i),s.push({id:v,type:e.type,color:{stroke:i}})}}else if(e instanceof c.b){const t=await this._findSingleImageColor(e,i);if(t){const{color:i,diffNum:r}=t,n=[i[0],i[1],i[2],1===r?1:.5];e.setFilterColor(n),s.push({id:v,type:e.type,color:{colorFilter:n}})}}else if(e instanceof d.z){const t=T(await this._findShapeColor(e,i),e.getStrokeColor());e.setColor(t)&&s.push({id:v,type:e.type,color:{stroke:t}})}else if(e instanceof n.v){const{colorInfo:t,info:r}=await this._findImageContainerColor(e,i);await e.setColors(t),s.push({id:v,type:e.type,color:{colorInfo:t}})}else if(e instanceof u.N){const t=await this._findSvgColor(e,i);e.setColorMap(t),s.push({id:v,type:e.type,color:{colorMap:t}})}if((e instanceof o.C||e instanceof a.f)&&p instanceof _.W2){const t=e.getChildren();for(const e of t)await this._renderWidget(e,p,i,s)}}}async _findShapeColor(e,t,i=!1){const s=e instanceof d.z?e.getStrokeColor():e.getFillColor(),{solid:n}=(0,y.tB)(s),o=`shape-${(0,y.GG)(n)}-${(0,y.GG)(e.getStrokeColor())}`;var a;if(this._colorCache[o])return null===(a=this._colorCache[o])||void 0===a?void 0:a[0];const l=e.getElement(),h=l.getClientRect();l.visible(!1),this._forceDraw();const c=Math.max(1,h.width),u=Math.max(1,h.height),g=this._context.getImageData(Math.ceil(h.x),Math.ceil(h.y),Math.floor(c),Math.floor(u));l.visible(!0);const _=await(0,r.EC)(g,2);if(0===_.length)return[255,255,255];const{color:p,needCache:f,cacheColors:m}=this._searchFitColor(n,_,this._getFirstAndLastColors(t),this._getCenterColors(t),this._shapeColors);return this._shapeColors=m,!this._colorCache[o]&&f&&(this._colorCache[o]=[p]),i&&this._debugColorBounds(h,_),p}async _findImageContainerColor(e,t){let i=t.concat();const s={},n=e.getElement(),o=n.getClientRect();n.visible(!1),this._forceDraw();const a=Math.max(1,o.width),l=Math.max(1,o.height),h=this._context.getImageData(Math.ceil(o.x),Math.ceil(o.y),Math.floor(a),Math.floor(l));n.visible(!0);const c=await(0,r.EC)(h,2),d=e.getImageContainerInfo(),u=[];return d.forEach(((e,t)=>{const{fill:n}=e,{color:o}=n;if(n.fillType===g.lm.COLOR&&o){var a;let e=null===(a=this._colorCache[o.toString()])||void 0===a?void 0:a[0];e||(e=(0,r.MB)(c,i,o,9),s[e.toString()]=o,i=this._filterCurrentColor(i,e),this._colorCache[o.toString()]=[e]),u.push({position:t,color:e})}})),{colorInfo:u,info:d}}_processSvgColor(e,t,i){let s=t.concat();const n={},o=e.getColorMap(),a=[];return o.forEach((e=>{const{origin:o,replace:l}=e,h=null!=l?l:o,c=D(h),d=c.color;let u;const g=(0,r.MB)(i,s,d,9);if((0,r.N9)(g)){const e=(0,r.MB)(i,t,d,9);if(!(0,r.N9)(e)){const t=n[e.toString()];u=T(function(e,t,i){const r=A(L(e),L(t),L(i)),[s,n,o]=R(r);return void 0===i[3]?[s,n,o]:[s,n,o,i[3]]}(e,t,d),h,c)}}else n[g.toString()]=d,u=T(g,h,c),s=this._filterCurrentColor(s,g);a.push({origin:o,replace:u})})),a}async _findSvgColor(e,t){const i=e.getColorMap(),s=e.getElement(),n=s.getClientRect();s.visible(!1),this._forceDraw();const o=Math.max(1,n.width),a=Math.max(1,n.height),l=this._context.getImageData(Math.ceil(n.x),Math.ceil(n.y),Math.floor(o),Math.floor(a));s.visible(!0);const h=await(0,r.EC)(l,2);return 0===h.length?i:this._processSvgColor(e,t,h)}async _findSingleImageColor(e,t){if(!e.props.replaceable){var i,s;const o=e.getElement(),a=o.getClientRect(),l=o.image(),h=`image-${(null===(i=e.props.src)||void 0===i?void 0:i.id)||(null===(s=e.props.src)||void 0===s?void 0:s.path)}`;let c;this._imageDiffCache[h]?c=this._imageDiffCache[h]:(c=await(0,r.tU)(l,.01),this._imageDiffCache[h]=c);const d=c.length;if(1===d||2===d){var n;const i=c[0],s=`image-${i.toString()}`;let l=null===(n=this._colorCache[s])||void 0===n?void 0:n[0];if(l)return{color:l,diffNum:d};const h=this._getSimilarImageColor(i);if(h)return{color:h,diffNum:d};const u=(0,v.Ln)(this._renderSDK.getMainRenderer().getDimension());if(!this._backgroundColorUsed&&e.props.layout.width*e.props.layout.scale.x*e.props.layout.height*e.props.layout.scale.y>(u.width-100)*(u.height-100))l=(0,r.JJ)(t),this._backgroundColorUsed=!0;else{o.visible(!1),this._forceDraw();const e=Math.max(1,a.width),n=Math.max(1,a.height),h=this._context.getImageData(a.x,a.y,e,n);o.visible(!0);const c=await(0,r.EC)(h,2);if(0===c.length)return;const{color:d,needCache:u,cacheColors:g}=this._searchFitColor(i,c,this._getFirstAndLastColors(t),this._getCenterColors(t),this._imageColors);l=d,this._imageColors=g,!this._colorCache[s]&&u&&(this._colorCache[s]=[l])}return{color:l,diffNum:d}}}}_searchFitColor(e,t,i,s,n,o=9){let a,l=!0;return n.length>=1?(a=(0,r.MB)(t,n,e,o),(0,r.N9)(a)?(l=!1,a=this._searchColor(e,t,i,s,o)):n=this._filterCurrentColor(n,a)):(l=!1,a=this._searchColor(e,t,i,s,o)),{color:a,needCache:l,cacheColors:n}}_searchColor(e,t,i,s,n){let o=(0,r.MB)(t,i,e,n);return(0,r.N9)(o)&&(o=(0,r.MB)(t,s,e,n),(0,r.N9)(o)&&(o=(0,r.r6)(t[0]))),o}_getSimilarImageColor(e,t=10){const i=this._colorCache;let r;return Object.keys(i).forEach((s=>{var n;const o=null===(n=s.split("image-"))||void 0===n?void 0:n[1];if(o){const n=o.split(",").map((e=>parseInt(e,10)));var a;if(Math.abs(e[0]-n[0])+Math.abs(e[1]-n[1])+Math.abs(e[2]-n[2])<=t)r=null===(a=i[s])||void 0===a?void 0:a[0]}})),r}async _findTextColor(e,t,i,s=!1){var n;const{props:o}=e,a=`text-${null===(n=(0,b.Pk)(o).fill)||void 0===n?void 0:n.join(",")}`;let l;this._colorCache[a]&&(l=this._colorCache[a]);const h=e.getElement(),c=h.getClientRect(),d=Math.max(1,c.width),u=Math.max(1,c.height);h.visible(!1),this._forceDraw();const g=this._context.getImageData(Math.ceil(c.x),Math.ceil(c.y),Math.floor(d),Math.floor(u));h.visible(!0);const _=this._textColors;let p=await(0,r.EC)(g,2);p.length<2&&(p=[[255,255,255],[255,255,255]]);const f=this._getContrastColors(p,l,6);let m=[0,0,0,1],v=[0,0,0,1];if(f)m=(0,r.Mw)(f);else{let e=this._textColors.length<1,s=!0;if(this._textColors.length>=1){const{resultColor:t,maxDiffColor:s}=(0,r.yO)(p,_,i,6);m=t,(0,r.N9)(m)?(e=!0,v=s):this._textColors=this._filterCurrentColor(this._textColors,m)}if(e){const{resultColor:e,maxDiffColor:n}=(0,r.yO)(p,t.slice(0,3),i,6);if(m=e,(0,r.N9)(m)){const{resultColor:e,maxDiffColor:o}=(0,r.yO)(p,t.slice(t.length-2),i,6);m=e,(0,r.N9)(m)&&(s=!1,m=this._searchRecommendColor([v,n,o],p[0]))}}s&&(this._colorCache[a]?this._colorCache[a].length<=2&&this._colorCache[a].push(m):this._colorCache[a]=[m])}return s&&(this._debugImageData(g),this._debugColorBounds(c,p)),m}_searchRecommendColor(e,t){let i=0;const s=e.length;for(;i<s;){const t=e[i];if(i++,!(0,r.N9)(t))return t}return(0,r.r6)(t)}_sortColors(e,t){return this._sortColorsByBrightness(e,t%2==0)}_sortColorsByBrightness(e,t){return e.sort(((e,i)=>{const[r,s,n]=e,[o,a,l]=i,h=.34*r+.5*s+.16*n,c=.34*o+.5*a+.16*l;return t?c-h:h-c}))}_forceDraw(){this._layer.draw()}_getContrastColors(e,t,i=9){if(t&&!((null==t?void 0:t.length)<=0))for(let s=0,n=t.length;s<n;s++){const n=t[s];let o=!0;for(let t=0,s=e.length;t<s;t++){const s=e[t];if(!(0,r.si)(s,n,i)){o=!1;break}}if(o)return n}}_resizeCanvas(e,t){const{canvas:i}=this._layer,r=Math.round(.5*e),s=Math.round(.5*t);i._canvas.width=r,i._canvas.height=s,i._canvas.style.width=`${r}px`,i._canvas.style.height=`${s}px`,this._layer.position({x:0,y:0}),this._layer.scale({x:.5,y:.5})}_generateColor(e,t,i){const r=e[0]+i[0]-t[0],s=e[1]+i[1]-t[1],n=e[2]+i[2]-t[2];return[this._format(r),this._format(s),this._format(n),i[3]]}_format(e){return e<0?0:e>255?255:e}_getFirstAndLastColors(e){return e.length>2?e.filter(((t,i)=>0===i&&i===e.length-1)):e}_getCenterColors(e){return e.length>2?e.filter(((t,i)=>0!==i&&i!==e.length-1)):e}_filterCurrentColor(e,t){return e.filter((e=>t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]))}_debugColor(e,t){this._showDebugLog&&m.t.info(`[Color]changedColor %c${e}${this._color2String(t)}`,`color:${this._color2String(t)}`)}_color2String(e){return`rgb(${e[0]},${e[1]},${e[2]})`}_debugColorBounds(e,t){setTimeout((()=>{const i=this._context;i.strokeStyle="#ff0000",i.rect(e.x,e.y,e.width,e.height),i.stroke();for(let r=0;r<t.length;r++){const s=t[r];i.fillStyle=this._color2String(s),i.fillRect(e.x+e.width-1,e.y+20*r,20,20)}}),1e3)}_debugImageData(e){let t;if(e instanceof HTMLCanvasElement){var i;null===(i=document.getElementById("debugCanvas"))||void 0===i||i.remove(),t=e,t.id="debugCanvas"}else{t=document.getElementById("debugCanvas")||document.createElement("canvas"),t.id="debugCanvas",t.width=e.width,t.height=e.height;const i=t.getContext("2d");null==i||i.putImageData(e,0,0)}t.style.cssText="position: absolute; top: 800px; left: 0px;z-index:100; display: block;",document.body.appendChild(t)}}},35263:(e,t,i)=>{i.d(t,{e:()=>l});var r,s=i(7063),n=i(8757),o=i(14415),a=i(2970);class l{static render(e,t){const{url:i="",...r}=t;return s.Z.image(e,i,{type:n.Wq.IMAGE,...r})}}(r=l).replace=async(e,t)=>{const{src:i}=t,s=(0,a.J)(i,t.pixels,{materialPixels:e.getWidth()*t.zoom.x*e.getHeight()*t.zoom.y}),{content:n}=s;if(n)return r._replace(e,{url:n});const o=(await s.ready).content;o&&o!==n&&await r._replace(e,{url:o})},r._replace=async(e,t)=>{const i=await(0,o.p)(t.url),r=e.image();!i||!e||i instanceof SVGImageElement||i===r||e.image(i)}},31538:(e,t,i)=>{i.d(t,{X:()=>n});var r=i(56378),s=i(67986);class n{constructor(e){this.element=null,this.dirty=!1,this._children=[],this._parent=null,this.props=e,this._id=e.id}getId(){return this._id}getElement(){return this.element}updateProps(e){this.props=Object.assign({},this.props,e)}replaceProps(e){this.props=e}getState(){return Object.freeze({...this.state})}setState(e){this.state=Object.assign({},this.state,e),this.onStateChange(e,this.state)}onStateChange(e,t){}setParent(e){this._parent=e}getParent(){return this._parent}getChildren(){return this._children}renderChildren(e){this.getChildren().forEach((t=>{const i=this.getCacheWidget(t.getId()),r=null==i?void 0:i.getElement();!r||null!=i&&i.dirty?(t.render(e),null!=i&&i.dirty||t.onMount(),t.dirty=!1):null==e||e.add(r)}))}async renderChildrenAsync(e){const t=this.getChildren();await Promise.all(t.map((async t=>{const i=this.getCacheWidget(t.getId()),r=(e,t)=>{const i=null==e?void 0:e.getElement();i&&(null==t||t.add(i),null!=e&&e.hasChildren()&&(null==e||e.getChildren().forEach((e=>{r(e,i)}))))};if((null==i?void 0:i.getElement())&&(null==i||!i.dirty))return void r(i,e);const s=t.render(e);null!=i&&i.dirty||t.onMount(),await s,t.dirty=!1})))}addChild(e){this._children.push(e),e.setParent(this)}removeChild(e){const t=this._children.findIndex((t=>t===e));if(t<0)return;const i=this._children[t];this._children.splice(t,1),i.setParent(null)}hasChildren(){return this._children.length>0}remove(){var e,t;null===(e=this._parent)||void 0===e||e.removeChild(this),this._parent=null,null===(t=this.element)||void 0===t||t.remove()}removeAllChildren(){this._children.forEach((e=>this.removeChild(e)))}onMount(){}destroy(){var e,t;null===(e=this._parent)||void 0===e||e.removeChild(this),this._parent=null,this._children.forEach((e=>e.destroy())),this._children=[],null===(t=this.element)||void 0===t||t.destroy(),this.element=null}onReady(){return Promise.resolve()}getCacheWidget(e){const t=r.Z.getCacheWidget(e);return t&&s.t.debug("LayerRender.hitCacheLayer",e,t),t}cacheWidget(e,t,i=!1){t&&(r.Z.cacheWidget(e,t),!i&&s.t.debug("widgetCacheManager.addCache",e,t))}getCacheElement(e,t){const i=this.getCacheWidget(t.id),r=null==i?void 0:i.getElement();return!r||null!=i&&i.dirty?null:(null==e||e.add(r),r)}}},61887:(e,t,i)=>{i.d(t,{l:()=>b});var r,s=i(31538),n=i(8757),o=i(67926),a=i(74129),l=i(7063),h=i(34618),c=i(63345),d=i(48917),u=i(10224),g=i(33146),_=i(58992),p=i(6430),f=i(21204),m=i(5317),v=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},y=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const x={x:0,y:0,width:3600,height:1200,scale:{x:1,y:1},rotation:0};class b extends s.X{constructor(e){super(e),this.type=n.Wq.GRID,this._widgetChildren=new Map,this._areaLayout=new Map,this._selectedAreaIndex=n.q6,this.state={loadingMap:{}}}get waitingState(){return Object.keys(this.state.loadingMap).some((e=>{var t;return null===(t=this.state.loadingMap[e])||void 0===t?void 0:t.loading}))}async render(e){this._areaLayout.clear(),await this._paintGridContainer(e);const{layout:{width:t,height:i},points:r,spacing:s,areas:n}=this.props,o=u.U.calGridLimit({width:t,height:i,areas:n,spacing:s,points:r});return this.setGridLimit(o),null}showLoading(e,t){var i;const r=null===(i=this._widgetChildren.get(e))||void 0===i?void 0:i.widget;if(!r)return;const s=this.state.loadingMap[e],n=t||s.text||"Loading...";this.setState({loadingMap:{...this.state.loadingMap,[e]:{loading:!0,text:n}}}),r.showLoading(n)}hideLoading(e){var t;const i=null===(t=this._widgetChildren.get(e))||void 0===t?void 0:t.widget;if(!i)return;const r=this.state.loadingMap[e];return this.setState({loadingMap:{...this.state.loadingMap,[e]:{...r,loading:!1}}}),i.hideLoading()}updateNode(e,t){var i;const r=null===(i=this._widgetChildren.get(e))||void 0===i?void 0:i.widget;if(!r)return;const s={...t};if(t.src){const{src:e,aiTool:i}=t;Object.assign(s,{src:(0,f.pg)({src:e,type:n.F5.IMAGE,aiTool:i})})}"src"in t&&void 0===t.src&&Object.assign(s,{src:{path:p,type:n.lJ.CloudImageSticker},cutout:void 0,replacePalette:void 0,filter:void 0,effectFilters:void 0}),r.updateNode(s)}getAreaLayoutById(e){return this._areaLayout.get(e)}setSelectedAreaIndex(e){this._selectedAreaIndex=e}getSelectedAreaIndex(){return this._selectedAreaIndex}setGridLimit(e){this._limit=e}getGridLimit(){return this._limit}changeSpace(){var e;null===(e=this.element)||void 0===e||e.fire("spacing")}getItemCanvasByIndex(e){const t=this.element.children[e+1];if(t){const{width:i,height:r}=this._areaLayout.get(e).layout,s=Math.max(200/i,200/r);return t.toClipCanvas({width:i,height:r,pixelRatio:s})}}async _paintGridContainer(e){const{devicePixelRatio:t}=m.Z.getGlobalVars(),{id:i,layout:r,points:s,spacing:o,areas:d,radius:g}=this.props,_=(0,a.U)(this.props);this.element=l.Z.container(null,{..._,id:i,type:n.Wq.GRID,backgroundConfig:{...(0,h.Qb)(i,n.Wq.GRID),width:_.width,height:_.height,x:0,y:0,fill:c.Fs}}),null==e||e.add(this.element);const p=u.U.calGridAreaLayouts({areas:d,points:s,spacing:o,width:r.width,height:r.height,radius:g*t});return await Promise.all(p.map((async(e,t)=>{this._areaLayout.set(e.id,e),await this._paintGridAreaContainer(this.element,e,i,t)}))),this.element}async _paintGridAreaContainer(e,t,i,r){const{id:s,fill:n,layout:o,path:a}=t,c={areaId:s,index:r,fillType:n.fillType},d={id:i,fill:n,clipLayout:{...o}},u=l.Z.containerWithClipPath(e,{clipPath:new Path2D(a),...c,...o,...(0,h.jA)(i,s)});return await this._drawContent(u,c,d,a),u}async _drawContent(e,t,i,r){const{fill:s}=i;switch(s.fillType){case n.kl.COLOR:return this._drawColor(e,s.color?(0,g.NH)(s.color):c.fV,t,i);case n.kl.IMAGE:const{image:o}=s;return o?await this._drawImage(e,o,t,i):await this._drawDefaultImage(e,t,i,r);case n.kl.NONE:default:return await this._drawDefaultImage(e,t,i,r)}}_drawColor(e,t,i,r){const{areaId:s}=i,{id:n,clipLayout:o}=r,a={x:0,y:0,width:o.width,height:o.height,...(0,h.ku)(n,s)};return l.Z.rect(e,{...i,...a,fill:t})}async _drawDefaultImage(e,t,i,r){const{clipLayout:s}=i,o=u.U.calImageLayoutToFillContainer({width:s.width,height:s.height,path:r},{...x}),a={id:"",type:n.Wq.IMAGE,src:{path:p,type:n.lJ.CloudImageSticker},layout:{...o},filter:void 0,effectFilters:void 0,aiTool:void 0,replacePalette:void 0};return await this._drawImage(e,a,t,i)}async _drawImage(e,t,i,r){var s,n;const{id:o}=r,{areaId:a,index:l}=i,{pixels:c,zoom:d}=this.props,u={...t,...(0,h.ku)(o,a),pixels:c,zoom:d};let g=null===(s=this._widgetChildren.get(a))||void 0===s?void 0:s.widget;g?g.replaceProps(u):g=new _.b(u),this._widgetChildren.set(a,{index:l,widget:g});const p=g.render(e);return null===(n=g.element)||void 0===n||n.setAttrs({...i}),await p,g}}v([(0,o.C)(),y("design:type",Function),y("design:paramtypes",["function"==typeof(r=void 0!==d.ZA&&d.ZA)?r:Object]),y("design:returntype",Promise)],b.prototype,"render",null)},4114:(e,t,i)=>{i.d(t,{f:()=>g});var r,s=i(7063),n=i(34618),o=i(8757),a=i(48917),l=i(4221),h=i(74129),c=i(67926),d=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},u=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class g extends l.u{constructor(){super(...arguments),this.type=o.Wq.GROUP_LAYER}async render(e,t=!1){var i;this.element=s.Z.container(null!=e?e:null,{id:this.props.id,type:o.Wq.GROUP_LAYER,...(0,h.U)(this.props)});const r=s.Z.rect(this.element,{...(0,n.Qb)(null!==(i=this.props.id)&&void 0!==i?i:"",o.Wq.GROUP_LAYER),width:this.props.layout.width,height:this.props.layout.height});return this.element.add(r),null==e||e.add(this.element),t||await this.renderElementWithPreview(this.element),this.element}renderElement(e){return this.renderChildrenAsync(e)}}d([(0,c.C)(),u("design:type",Function),u("design:paramtypes",["function"==typeof(r=void 0!==a.ZA&&a.ZA)?r:Object,Object]),u("design:returntype",Promise)],g.prototype,"render",null)},13995:(e,t,i)=>{i.d(t,{v:()=>b});var r,s=i(7063),n=i(48917),o=i(8757),a=i(34618),l=i(63345),h=i(33146),c=i(6430),d=i(48763),u=i(31538),g=i(74129),_=i(67926),p=i(58992),f=i(10224),m=i(21204),v=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},y=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const x={x:0,y:0,width:3600,height:1200,scale:{x:1,y:1},rotation:0};class b extends u.X{constructor(e){var t;super(e),this.type=o.Wq.IMAGE_CONTAINER,this._widgetChildren=[],this._checkIsSingleFillIamge=()=>{let e=o.ch;return 1===this.props.items.filter(((t,i)=>!(!t.fill.canUpdate||t.fill.fillType!==o.lm.IMAGE)&&(e=i,!0))).length?{isSingle:!0,index:e}:{isSingle:!1}},this.state={loadingMap:{}};const i=this._checkIsSingleFillIamge();this._selectIndex=null!==(t=i.index)&&void 0!==t?t:o.ch}get isSingle(){return 1===this.props.items.length}get isSingleFillIamge(){return this._checkIsSingleFillIamge().isSingle}get waitingState(){return Object.keys(this.state.loadingMap).some((e=>{var t;return null===(t=this.state.loadingMap[e])||void 0===t?void 0:t.loading}))}getSelectIndex(){return this._selectIndex}setSelectIndex(e){const t=this._checkIsSingleFillIamge();this._selectIndex=t.isSingle&&void 0!==t.index?t.index:e}async render(e){var t;return null!==(t=this.props)&&void 0!==t&&null!==(t=t.items)&&void 0!==t&&t.length?(await this._paintImageContainer(e),this.element):null}updateNode(e,t){const i=this._widgetChildren[e];if(!i)return;const r={...t};if(t.src){const{src:e,aiTool:i}=t;Object.assign(r,{src:(0,m.pg)({src:e,type:o.F5.IMAGE,aiTool:i})})}"src"in t&&void 0===t.src&&Object.assign(r,{src:{path:c,type:o.lJ.CloudImageSticker},cutout:void 0,replacePalette:void 0,filter:void 0,effectFilters:void 0,postProcessEffects:void 0}),i.updateNode(r)}showLoading(e=0,t){const i=this._widgetChildren[e];if(!i)return;const r=this.state.loadingMap[e],s=t||r.text||"Loading...";this.setState({loadingMap:{...this.state.loadingMap,[e]:{loading:!0,text:s}}}),i.showLoading(s)}hideLoading(e=0){const t=this._widgetChildren[e];if(!t)return;const i=this.state.loadingMap[e];return this.setState({loadingMap:{...this.state.loadingMap,[e]:{...i,loading:!1}}}),t.hideLoading()}getItemCanvasByIndex(e){const t=this._getImageContainer(e),i=this.props.items[e];if(t&&i){const{width:e,height:r}=i.layout,s=Math.max(200/e,200/r);return t.toClipCanvas({width:e,height:r,pixelRatio:s})}}getImageContainerInfo(){return this.props.items}async setImageContainerInfo(e){this.props.items=e;const{id:t}=this.props;await Promise.all(this.props.items.map(((e,i)=>this._drawPath(this.element,i,{...e,id:t}))))}async setColors(e){const{id:t}=this.props;await Promise.all(e.map((e=>{const{position:i,color:r}=e,s=this.props.items[i];if(s){const e={fill:{...s.fill,color:r,fillType:o.lm.COLOR}};return this._drawPath(this.element,i,{...s,id:t,...e})}})))}async _paintImageContainer(e){const{id:t}=this.props,i=(0,g.U)(this.props);return this.element=s.Z.container(null,{...i,id:t,type:o.Wq.IMAGE_CONTAINER,backgroundConfig:{...(0,a.Qb)(t,o.Wq.IMAGE_CONTAINER),width:i.width,height:i.height,x:0,y:0,fill:l.Fs}}),null==e||e.add(this.element),await Promise.all(this.props.items.map(((e,i)=>this._drawPath(this.element,i,{...e,id:t})))),this.element}async _drawPath(e,t,i){const{fill:r,layout:n,id:l}=i,h={index:t,fillInfo:{canUpdate:r.canUpdate,fillType:r.fillType,validFillType:r.validFillType}},{width:c,height:d}=n,u=f.U.scalePath({width:c,height:d,path:null==i?void 0:i.path}),g=s.Z.containerWithClipPath(e,{clipPath:new Path2D(u),...n,...(0,a._m)(l,o.Wq.IMAGE_CONTAINER,t),...h});return await this._drawContent(g,r,{id:l,clipLayout:{...n}},h,u,t),g}async _drawContent(e,t,i,r,s,n){const{clipLayout:a}=i,{fillType:d}=t;switch(d){case o.lm.COLOR:return this._drawColor(e,t.color?(0,h.NH)(t.color):l.fV,i,r,n);case o.lm.IMAGE:{const{image:l,originImage:h}=t;if(l)return this._drawImage(e,l,i,r,n);if(h)return this._drawImage(e,h,i,r,n);const d=f.U.calImageLayoutToFillContainer({width:a.width,height:a.height,path:s},{...x}),u={id:"",type:o.Wq.IMAGE,src:{path:c,type:o.lJ.CloudImageSticker},layout:{...d},filter:void 0,effectFilters:void 0,aiTool:void 0,replacePalette:void 0,postProcessEffects:void 0};return await this._drawImage(e,u,i,r,n)}default:return this._drawColor(e,l.fV,i,r,n)}}async _drawImage(e,t,i,r,s){var n;const{id:l}=i,{pixels:h,zoom:c}=this.props,d={...t,...(0,a.o7)(l,o.Wq.IMAGE_CONTAINER,s),pixels:h,zoom:c};let u=this._widgetChildren[s];u?u.replaceProps(d):u=new p.b(d),this._widgetChildren[s]=u;const g=u.render(e);return null===(n=u.element)||void 0===n||n.setAttrs({...r}),await g,u}_drawColor(e,t,i,r,n){const{id:l,clipLayout:h}=i,c={x:0,y:0,width:h.width,height:h.height,...(0,a.o7)(l,o.Wq.IMAGE_CONTAINER,n)};return s.Z.rect(e,{...r,...c,fill:t})}_getImageContainer(e=0){var t;return null===(t=this.element.getChildren().filter((e=>e instanceof n.ZA)))||void 0===t?void 0:t[e]}_getChildByIndex(e=0){var t;return null===(t=this._getImageContainer(e).children)||void 0===t?void 0:t.find((e=>e instanceof d.Z))}}v([(0,_.C)(),y("design:type",Function),y("design:paramtypes",["function"==typeof(r=void 0!==n.ZA&&n.ZA)?r:Object]),y("design:returntype",Promise)],b.prototype,"render",null)},58992:(e,t,i)=>{i.d(t,{b:()=>w});var r,s,n=i(48917),o=i(2970),a=i(31538),l=i(74129),h=i(35263),c=i(8757),d=i(67926),u=i(21204),g=i(22169),_=i(43382),p=i(14415),f=i(54643),m=i(15516),v=i(25629),y=i(39589),x=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},b=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.INIT=0]="INIT",e[e.PREVIEW=1]="PREVIEW",e[e.LOADED=2]="LOADED"}(s||(s={}));class w extends a.X{constructor(e){super(e),this.type=c.Wq.IMAGE,this._disposableStore=new _.S,this._pendingTask=[],this._dirtyKeys=new Set,this._srcState=s.INIT,this._addTask=(e,t)=>{const{cancellable:i=!0}=null!=t?t:{};let r,s;const n=new Promise(((e,t)=>{r=e,s=t})),o={fn:e,promise:n,resolve:r,reject:s,executing:!1,cancellable:i},a=this._pendingTask.findIndex((e=>!e.executing&&e.cancellable));return a>=0&&this._pendingTask.splice(a),this._pendingTask.push(o),this._execTask(),n},this._execTask=async()=>{const e=this._pendingTask[0];if(e&&!e.executing){e.executing=!0;try{await e.fn(),e.resolve()}catch(t){e.reject(t)}this._pendingTask.shift(),this._pendingTask.length&&this._execTask()}},this._scheduleContentUpdate=e=>{const t=null!=e?e:this.state.imageContent;if(!this.element||!t||this._srcState&s.LOADED)return;const i=async e=>{const t=this.element;if(!t)return;const i=await(0,p.p)(e),r=t.image();i&&r!==i&&t.image(i)};return this._addTask((async()=>{const e=this._srcState&s.PREVIEW,r=this._srcState&s.LOADED;if(t.content)return this._srcState|=s.LOADED,i(t.content);if(!e&&t.isPreview&&t.previewUrl&&(this._srcState|=s.PREVIEW,await i(t.previewUrl)),!r&&void 0!==t.ready){this._srcState|=s.LOADED;const{content:e}=await t.ready;e&&await i(e)}}))},this.state={loading:!1},this._props=new Proxy({},{set:(e,t,i)=>(!(0,g.isEqual)(i,e[t])&&("filter"===t&&this._dirtyKeys.add("editParams"),"effectFilters"===t&&this._dirtyKeys.add("colorScheme"),this._dirtyKeys.add(t)),Reflect.set(e,t,i)),get:(e,t)=>Reflect.get(e,t)}),this.setProps(e)}get waitingState(){return this.state.loading}onMount(){const e=(0,g.debounce)((e=>{const t={x:e.scale,y:e.scale},i=(0,f.Ln)(this.props.dimension),r={zoom:t,pixels:i.height*t.y*i.width*t.x};this.setProps(r),this._scheduleContentUpdate()}),50);this._disposableStore.add(v.Z.interact.onPageZoomChange.event(e))}destroy(){super.destroy(),y.ZP.removeGraphic(this.props.id),this._disposableStore.clear()}async render(e){var t,i;const r=Array.from(this._dirtyKeys);this._dirtyKeys.clear();const n=this._props,o={id:null!==(t=n.id)&&void 0!==t?t:"",type:n.type,loading:this.state.loading,lastAttrs:void 0,...(0,l.U)(n)},a=this._parseExtraParams(n);if(!this.element||this.element.attrs.lastAttrs?Object.assign(o,a):r.length&&r.forEach((e=>{e in a&&Object.assign(o,{[e]:a[e]})})),this.element)this.element.setAttrs(o),null==e||e.add(this.element);else{var c;const{image:t}=null!==(c=h.e.render(null!=e?e:null,o))&&void 0!==c?c:null;if(this.element=t,this._srcState=s.INIT,!this.element)return this.element}await this._scheduleContentUpdate();const d=null===(i=this.element)||void 0===i?void 0:i.taskQueue;return(null==d?void 0:d.length)&&await Promise.all(d.map((e=>e.promise))).catch((()=>{})),this.element}setFilterColor(e){this.element&&(this.element.cache(),this.element.filters([n.jZ]),this.element.red(e[0]),this.element.green(e[1]),this.element.blue(e[2]),this.element.alpha(void 0===(null==e?void 0:e[3])?1:e[3]))}setProps(e){var t;Object.assign(this._props,e);const i=null!==(t=this._tempImageContent)&&void 0!==t?t:this.state.imageContent,r=this._getImageContent();this._tempImageContent=void 0,this.setState({imageContent:r}),(0,g.isEqual)(i,r)||(this._srcState=s.INIT)}replaceProps(e){this.props=e,this.setProps(e)}showLoading(e="loading"){var t;this.element&&(this.setState({loading:!0}),null===(t=this.element)||void 0===t||t.setAttrs({loading:!0,loadingText:e}))}hideLoading(){return this._addTask((()=>{var e;this.setState({loading:!1}),null===(e=this.element)||void 0===e||e.setAttrs({loading:!1})}),{cancellable:!1}).catch((()=>{}))}updateNode(e){const t=this.element;if(!t||!e)return;const i={},r={filter:{editParams:e.filter},effectFilters:{effectFilters:null==e?void 0:e.effectFilters},layout:{...null==e?void 0:e.layout},postProcessEffects:{postProcessEffects:null==e?void 0:e.postProcessEffects},isFlipHorizontal:{isFlipX:null==e?void 0:e.isFlipHorizontal},isFlipVertical:{isFlipY:null==e?void 0:e.isFlipVertical}};if(Object.keys(r).forEach((t=>{t in e&&Object.assign(i,{...r[t]})})),["src","cutout","aiTool","replacePalette"].some((t=>t in e))){const t=this._getImageContent(e);this._tempImageContent=t,this._srcState=s.INIT,this._scheduleContentUpdate(t)}Object.keys(i).length&&t.setAttrs(i)}_parseExtraParams(e){var t;let i;const r=null===(t=e.effectFilters)||void 0===t?void 0:t.reduce(((e,t)=>{if(t.resourceId===m.internalEffectResource.colorScheme.resourceId){const{Internal_Size:r=0,Internal_Number:s=0,Internal_Rotate:n=0,Internal_Alpha:o=1}=t.params;return i=[r,s,n,o],e}return e.concat(t)}),[]);return{placeholder:e.placeholder,objectFit:e.objectFit,blur:e.blur,effectFilters:r,editParams:e.filter,colorScheme:i,postProcessEffects:e.postProcessEffects}}_getImageContent(e){const t=(0,u.pg)({...this.props,...e,type:c.F5.IMAGE});return(0,o.J)(t,this._props.pixels,{materialPixels:this._props.layout.width*this._props.zoom.x*this._props.layout.height*this._props.zoom.y})}}x([(0,d.C)(),b("design:type",Function),b("design:paramtypes",["function"==typeof(r=void 0!==n.ZA&&n.ZA)?r:Object]),b("design:returntype",Promise)],w.prototype,"render",null)},57860:(e,t,i)=>{i.d(t,{z:()=>v});var r,s=i(7063),n=i(48917),o=i(8757),a=i(43382),l=i(56537),h=i(91372),c=i(31538),d=i(74129),u=i(67926),g=i(22169),_=i(25629),p=i(5317),f=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},m=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class v extends c.X{constructor(){super(...arguments),this.type=o.Wq.LINE,this._disposableStore=new a.S}async render(e){var t;const{source:i,attr:r}=this.props;if(!i||!r)return null;const n={id:this.props.id,type:o.Wq.LINE,svgInfo:{source:i,attr:r},canvasWidth:this.props.layerWidth,canvasHeight:this.props.layerHeight,...(0,d.U)(this.props)},a=l.F.composeLineByAttrs(i,r),{image:h,onImageRendered:c}=null!==(t=s.Z.svgLine(null!=e?e:null,a,n,this.props.zoom))&&void 0!==t?t:null;return this.element=h,null==e||e.add(this.element),c&&await c,this.element}onMount(){const e=(0,g.debounce)((e=>{this.updateNodeForZoom(e.scale)}),50);this._disposableStore.add(_.Z.interact.onPageZoomChange.event(e))}destroy(){super.destroy(),this._disposableStore.clear()}async updateNodeForZoom(e){var t;const{source:i,attr:r,layout:s}=this.props;if(!i||!r||!s)return;const{width:n,height:o}=s,a=l.F.composeLineByAttrs(i,r),{devicePixelRatio:h}=p.Z.getGlobalVars(),c=await l.F.svgToImage({data:a,width:n*e,height:o*e,dpr:h});c&&(null===(t=this.element)||void 0===t||t.image(c))}setColor(e){var t;return!!(0,h.aj)(this.props.attr.stroke,e)&&(this.props.attr={...this.props.attr,stroke:e},this.render(null===(t=this.element)||void 0===t?void 0:t.parent),!0)}getFillColor(){}getStrokeColor(){return this.props.attr.stroke}}f([(0,u.C)(),m("design:type",Function),m("design:paramtypes",["function"==typeof(r=void 0!==n.ZA&&n.ZA)?r:Object]),m("design:returntype",Promise)],v.prototype,"render",null)},37145:(e,t,i)=>{i.d(t,{C:()=>I});var r,s=i(63345),n=i(34618),o=i(8757),a=i(7063),l=i(33146),h=i(48917),c=i(91372),d=i(43382),u=i(54643),g=i(15516),_=i(60110),p=i(14415),f=i(31538),m=i(67926),v=i(58992),y=i(55160),x=i(25629),b=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},w=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const C=(e,t,i)=>{const r={fill:void 0,fillLinearGradientStartPoint:void 0,fillLinearGradientEndPoint:void 0,fillLinearGradientColorStops:void 0,fillRadialGradientStartPoint:void 0,fillRadialGradientEndPoint:void 0,fillRadialGradientStartRadius:void 0,fillRadialGradientEndRadius:void 0,fillRadialGradientColorStops:void 0},{solid:n,gradient:a}=(0,c.tB)(i.color);if(a){const i=Math.max(e,t);if(a.type===o.cF.LinearGradient){const i=a,s=(0,y.y)(e,t,i.rotation);r.fillLinearGradientStartPoint={x:s.x0,y:s.y0},r.fillLinearGradientEndPoint={x:s.x1,y:s.y1},r.fillLinearGradientColorStops=i.stops.map((e=>[e.offset,(0,c.xc)(e.color)])).flat()}else if(a.type===o.cF.RadialGradient){const s=a;r.fillRadialGradientStartPoint={x:s.center[0]*e,y:s.center[1]*t},r.fillRadialGradientEndPoint={x:s.center[0]*e,y:s.center[1]*t},r.fillRadialGradientStartRadius=0,r.fillRadialGradientEndRadius=i*s.radius[0],r.fillRadialGradientColorStops=s.stops.map((e=>[e.offset,(0,c.xc)(e.color)])).flat()}}else{var h;r.fill=null!==(h=(0,l.QN)(n))&&void 0!==h?h:s.BF}return r};class I extends f.X{constructor(){super(...arguments),this.type=o.Wq.PAGE,this._disposableStore=new d.S,this._zoom=1,this.correctGridSize=e=>{var t;this._zoom=e;const i=1/e,{width:r,height:s}=this._getPageSize();null===(t=this._backgroundDefaultTransparentGrid)||void 0===t||t.setAttrs({scale:{x:i,y:i},width:r/i,height:s/i})}}get bleedArea(){var e;return null===(e=this.props.stateManager)||void 0===e?void 0:e.getBleedArea()}onMount(){this._disposableStore.add(x.Z.interact.onPageZoomChange.event((({scale:e})=>{this.correctGridSize(e)})))}async render(e,t=!1){var i,r;const{width:s,height:l}=(0,u.Ln)(this.props.dimension);this._zoom=this.props.zoom.x,this.element=a.Z.container(null,{...this.props,type:o.Wq.PAGE,backgroundConfig:{...(0,n.Qb)(null!==(i=this.props.id)&&void 0!==i?i:"",o.Wq.PAGE),x:0,y:0,width:s,height:l,groupId:this.props.id,...C(s,l,this.props.background),name:g.ID},clipFunc:e=>{e.rect(0,0,s,l)}});const{image:h}=this.props.background;this._backgroundColor=null===(r=this.element.children)||void 0===r?void 0:r[0];const c=[];return h?c.push(this.renderBackgroundImage(h)):c.push(this._updateBackgroundDefaultTransparentGrid()),void 0!==this.bleedArea?this.renderBleedArea(this.bleedArea):this.removeBleedArea(),null==e||e.add(this.element),this.element.moveToBottom(),c.push(this._preRenderPreviewImage(this.props,this.element)),t||c.push(this.renderChildrenAsync(this.element)),await Promise.all(c),this.element}getBackgroundImage(){return this._backgroundImage}getFillColor(){return this.props.background.color}setBgColor(e){this.updateProps({background:{...this.props.background,color:e}});const{width:t,height:i}=(0,u.Ln)(this.props.dimension);this._backgroundColor.setAttrs(C(t,i,this.props.background)),this._updateBackgroundDefaultTransparentGrid()}renderBleedArea(e){var t,i;const{width:r,height:s}=this._getPageSize();null===(t=this.element)||void 0===t||t.clipFunc((t=>{t.rect(-e,-e,r,s)})),this._backgroundColor.setAttrs({x:-e,y:-e,width:r,height:s}),this.correctGridSize(this._zoom),null===(i=this._backgroundDefaultTransparentGrid)||void 0===i||i.setAttrs({x:-e,y:-e})}removeBleedArea(){var e,t;const{width:i,height:r}=(0,u.Ln)(this.props.dimension);null===(e=this.element)||void 0===e||e.clipFunc((e=>{e.rect(0,0,i,r)})),this._backgroundColor.setAttrs({x:0,y:0,width:i,height:r}),this.correctGridSize(this._zoom),null===(t=this._backgroundDefaultTransparentGrid)||void 0===t||t.setAttrs({x:0,y:0})}async renderBackgroundImage(e,t){const{type:i}=e;i===o.F5.IMAGE&&await this._renderBgImageByImage(e,t)}updateBackgroundImage(e){this._backgroundImage instanceof v.b&&this._backgroundImage.updateNode(e)}removeHoverBgImage(){this._backgroundImage&&(this._backgroundImage.destroy(),this._backgroundImage=void 0)}showLoading(e="loading"){const{children:t}=this.element,i=null==t?void 0:t.find((e=>"PAGE-BackgroundImage"===e.attrs.type));i&&(this.setState({loading:!0}),null==i||i.setAttrs({loading:!0,loadingText:e}))}hideLoading(){const{children:e}=this.element,t=null==e?void 0:e.find((e=>"PAGE-BackgroundImage"===e.attrs.type));t&&(this.setState({loading:!1}),null==t||t.setAttrs({loading:!1}))}async _renderBgImageByImage(e,t){var i;if(!this.element)return;const{pixels:r,zoom:s}=this.props,a={...e,...(0,n.Vf)(null!==(i=this.props.id)&&void 0!==i?i:"",o.Wq.PAGE),pixels:r,zoom:s};let l;this._backgroundImage?(l=this._backgroundImage,l.replaceProps(a)):l=new v.b(a);const h=l.render(this.element);var c;t&&(null===(c=l.element)||void 0===c||c.setZIndex(1));this._backgroundImage=l,this._backgroundColor.setAttr("color",_.GL),await h}async _preRenderPreviewImage(e,t){if(e.background.previewUrl){const{onImageRendered:i}=a.Z.image(t,e.background.previewUrl,{blur:8,x:0,y:0,width:t.width(),height:t.height(),objectFit:o.ms.ASPECT_FIT});await i}}async _updateBackgroundDefaultTransparentGrid(){const{solid:e,gradient:t}=(0,c.tB)(this.props.background.color),i=this.element;var r;if(!(Boolean(0===(null==e?void 0:e[3]))||Boolean(t)))return null===(r=this._backgroundDefaultTransparentGrid)||void 0===r||r.destroy(),void(this._backgroundDefaultTransparentGrid=void 0);if(this._backgroundDefaultTransparentGrid)return i.add(this._backgroundDefaultTransparentGrid),void this._backgroundDefaultTransparentGrid.moveToBottom();const{width:s,height:n}=(0,u.Ln)(this.props.dimension);this._backgroundDefaultTransparentGrid=a.Z.rect(i,{id:g.zZ,x:0,y:0,width:s,height:n,fillPatternRepeat:"repeat",listening:!1}),this._backgroundDefaultTransparentGrid.moveToBottom();const o=await(0,p.p)(g.s);o&&(this._backgroundDefaultTransparentGrid.setAttr("fillPatternImage",o),this.correctGridSize(this._zoom))}_getPageSize(){var e;const t=null===(e=this.props.stateManager)||void 0===e?void 0:e.getBleedArea(),{width:i,height:r}=(0,u.Ln)(this.props.dimension);return t?{width:i+2*t,height:r+2*t}:{width:i,height:r}}}b([(0,m.C)(),w("design:type",Function),w("design:paramtypes",["function"==typeof(r=void 0!==h.ZA&&h.ZA)?r:Object,Object]),w("design:returntype",Promise)],I.prototype,"render",null)},4221:(e,t,i)=>{i.d(t,{u:()=>l});var r=i(82440),s=i(74129),n=i(31538),o=i(8757),a=i(58992);class l extends n.X{constructor(){super(...arguments),this.renderElementWithPreview=async e=>{var t,i,n;if((0,s.j)(this.props))return;const o=r.fc.getDependency(null!==(t=null===(i=this.props)||void 0===i||null===(i=i.extra)||void 0===i?void 0:i.resourceId)&&void 0!==t?t:""),a=o&&!o.fullfilled&&!o.isPreview;!o||o.fullfilled||a?await this.renderElement(e):(!o.isPreview||!o.previewUrl||null!==(n=e.children)&&void 0!==n&&n.some((e=>e.attrs.placeholder))||this._paintPlaceHolderNode(e,o.previewUrl),o.ready&&await o.ready.then((async()=>{o.fullfilled=!0,await this.renderElement(e),this._removePlaceHolderElements(e)})))},this._paintPlaceHolderNode=async(e,t)=>{var i,n;if((0,s.j)(this.props))return;const l={...this.props,id:`placeholder_img_${this.props.id}`,type:void 0,layout:{...this.props.layout,x:0,y:0,scale:{x:1,y:1},rotation:0},objectFit:o.ms.ASPECT_FILL,placeholder:!0,src:{path:t},pixels:this.props.pixels},h=new a.b(l),c=await h.render(),d=r.fc.getDependency(null!==(i=null===(n=this.props)||void 0===n||null===(n=n.extra)||void 0===n?void 0:n.resourceId)&&void 0!==i?i:"");!d||null!=d&&d.fullfilled||!c||e.add(c)}}renderElement(e){}_removePlaceHolderElements(e){var t;null===(t=e.children)||void 0===t||t.forEach((e=>{e.attrs.placeholder&&e.destroy()}))}}},2322:(e,t,i)=>{i.d(t,{G:()=>c});var r,s=i(48917),n=i(31538),o=i(67926),a=i(39589),l=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},h=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class c extends n.X{async render(e){return await this.renderChildrenAsync(e),null}iterateChild(e){const t=i=>{i.getChildren().forEach((i=>{e(i),t(i)}))};t(this)}destroy(){this.iterateChild((e=>{a.ZP.removeText(e.getId())})),super.destroy()}}l([(0,o.C)(),h("design:type",Function),h("design:paramtypes",["function"==typeof(r=void 0!==s.W2&&s.W2)?r:Object]),h("design:returntype",Promise)],c.prototype,"render",null)},26684:(e,t,i)=>{i.d(t,{t:()=>p});var r,s=i(48917),n=i(8757),o=i(43382),a=i(56537),l=i(31538),h=i(74129),c=i(67926),d=i(99624),u=i(71946),g=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},_=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class p extends l.X{constructor(){super(...arguments),this.type=n.Wq.SHAPE,this._svgSource="",this._config={},this._disposableStore=new o.S}render(e){var t,i,r,s,o,l,c,g,_,p;if(null===(t=this.props)||void 0===t||null===(t=t.paths)||void 0===t||!t.length)return null;const{source:f,radius:m,attr:v,fixedAreas:y}=this.props.paths[0];if(!f||!v)return null;const x={id:this.props.id,type:n.Wq.SHAPE,svgInfo:{source:f,radius:m,attr:v,fixedAreas:y},canvasWidth:this.props.layerWidth,canvasHeight:this.props.layerHeight,...(0,h.U)(this.props)},b=a.F.updatePolygonPath(v,m,{width:x.width,height:x.height,scale:{x:1,y:1}},y);this._config=x;const w=u.Z.getRenderLayerUtil(n.Wq.SHAPE),C=w.getStrokeWidth(b.strokeWidth)/((null===(i=x.scale)||void 0===i?void 0:i.x)||1),I=w.getStrokeDash(b.strokeDasharray),L=w.getStrokeColor(null!==(r=x.width)&&void 0!==r?r:0,null!==(s=x.height)&&void 0!==s?s:0,b),R=w.getFillColor(null!==(o=x.width)&&void 0!==o?o:0,null!==(l=x.height)&&void 0!==l?l:0,b);return this.element=new d.Z({...x,...L,...R,...I,viewBox:b.viewBox,scaleX:null!==(c=null===(g=x.scale)||void 0===g?void 0:g.x)&&void 0!==c?c:1,scaleY:null!==(_=null===(p=x.scale)||void 0===p?void 0:p.y)&&void 0!==_?_:1,data:b.d,strokeWidth:C}),this.element&&(null==e||e.add(this.element)),this.element}onMount(){}destroy(){super.destroy()}async setColors(e,t){var i;const{attr:r}=this.props.paths[0],s={...this.props.paths[0],attr:{...r,fill:e}};t&&(s.attr.stroke=t);const n=[s,...this.props.paths.slice(1)];this.updateProps({paths:n}),await this.render(null===(i=this.element)||void 0===i?void 0:i.parent)}getFillColor(){return this.props.paths[0].attr.fill}getStrokeColor(){if(!(this.props.paths[0].attr.strokeWidth<=0))return this.props.paths[0].attr.stroke}getShapeLayout(){return this.props.layout}getFixedAreas(){return this.props.paths[0].fixedAreas}}g([(0,c.C)(),_("design:type",Function),_("design:paramtypes",["function"==typeof(r=void 0!==s.ZA&&s.ZA)?r:Object]),_("design:returntype",void 0)],p.prototype,"render",null)},79876:(e,t,i)=>{i.d(t,{N:()=>y});var r,s,n=i(31538),o=i(8757),a=i(67926),l=i(48917),h=i(82440),c=i(7063),d=i(74129),u=i(43382),g=i(91372),_=i(15516),p=i(25629),f=i(22169),m=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},v=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};!function(e){e[e.INIT=0]="INIT",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY"}(s||(s={}));class y extends n.X{constructor(e){super(e),this.type=o.Wq.SVG_IMAGE,this._svgStr="",this._resultSvgStr="",this._config={},this._disposableStore=new u.S,this._colorMap=[],this.state={loading:s.INIT},this.updateProps(e)}render(e){const t=this.props,i=this._parseExtraParams(t),r={id:t.id,type:t.type,...(0,d.U)(t),...i};if(this._config=r,this.element){null==e||e.add(this.element),this.element.setAttrs(r);const i=null==t?void 0:t.colors;i&&this.setColorMap(i)}else this._init(e,r,null==t?void 0:t.colors);return this.element}onMount(){const e=(0,f.debounce)((e=>{const t=this.element,i={x:e.scale,y:e.scale};t&&this._resultSvgStr&&c.Z.svgImage(null,t,this.props.id,this._resultSvgStr,this._config,!0,i)}),50);this._disposableStore.add(p.Z.interact.onPageZoomChange.event(e))}destroy(){super.destroy(),this._disposableStore.clear()}setColorMap(e,t=!0){let i=this._svgStr;return e.length?(e.forEach((e=>{const{origin:t,replace:r}=e;if(Array.isArray(t)&&Array.isArray(r)&&(i=this._setColor(t,r,i)),(0,g.nr)(t)&&(0,g.nr)(r)){const e=r.stops;t.stops.forEach(((t,r)=>{var s;t.color&&null!==(s=e[r])&&void 0!==s&&s.color&&(i=this._setColor(t.color,e[r].color,i,"stop-color:"))}))}})),t&&this._replace(i),this._colorMap=e,i):i}getColorMap(){return this._colorMap}updateNode(e){const t=this.element;if(!t||!e)return;const i={},r={filter:{editParams:e.filter},effectFilters:{effectFilters:null==e?void 0:e.effectFilters},postProcessEffects:{postProcessEffects:null==e?void 0:e.postProcessEffects},isFlipHorizontal:{isFlipX:null==e?void 0:e.isFlipHorizontal},isFlipVertical:{isFlipY:null==e?void 0:e.isFlipVertical}};Object.keys(r).forEach((t=>{t in e&&Object.assign(i,{...r[t]})})),Object.keys(i).length&&t.setAttrs(i)}_parseExtraParams(e){var t;let i;const r=null===(t=e.effectFilters)||void 0===t?void 0:t.reduce(((e,t)=>{if(t.resourceId===_.internalEffectResource.colorScheme.resourceId){const{Internal_Size:r=0,Internal_Number:s=0,Internal_Rotate:n=0,Internal_Alpha:o=1}=t.params;return i=[r,s,n,o],e}return e.concat(t)}),[]);return{placeholder:e.placeholder,objectFit:e.objectFit,blur:e.blur,effectFilters:r,editParams:e.filter,colorScheme:i,postProcessEffects:e.postProcessEffects}}_setColor(e,t,i,r=""){const s=new g.Il(e).hex().slice(0,-2),n=new g.Il(t).hex().slice(0,-2),o=new RegExp(r+s,"gi");return i.replace(o,r+n)}_init(e,t,i){var r,s;const n=this.props,o=h.fc.getDependency(null!==(r=null==n||null===(s=n.src)||void 0===s?void 0:s.resourceId)&&void 0!==r?r:"");if(!o)return;const a=null==o?void 0:o.content;if(a){this._svgStr=a;const r=i?this.setColorMap(i,!1):a,{image:s}=c.Z.svgImage(e,null,t.id,r,{...t},!1,this.props.zoom);this.element=s}else{const{image:r}=c.Z.image(e,o.previewUrl,{...t});this.element=r,this._executeTask(o.ready,i)}}async _executeTask(e,t){this.setState({loading:s.LOADING});const i=await e;this._svgStr=null==i?void 0:i.content;const r=t?this.setColorMap(t,!1):this._svgStr;this._replace(r),this.setState({loading:s.READY})}_replace(e){const t=this.element;t&&(this._resultSvgStr=e,c.Z.svgImage(null,t,this.props.id,e,this._config,!0,this.props.zoom))}}m([(0,a.C)(),v("design:type",Function),v("design:paramtypes",["function"==typeof(r=void 0!==l.ZA&&l.ZA)?r:Object]),v("design:returntype",void 0)],y.prototype,"render",null)},23659:(e,t,i)=>{i.d(t,{y:()=>E});var r,s=i(82440),n=i(48917),o=i(32598),a=i(39589),l=i(8757),h=i(43382),c=i(67986),d=i(41658),u=i(49171),g=i(36919),_=i(38530),p=i(35429),f=i(22169),m=i(4221),v=i(74129),y=i(25629),x=i(67926),b=i(11005),w=i(44264),C=i(93123),I=function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},L=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const R=i(57123).EY.effect;class E extends m.u{constructor(){super(...arguments),this.type=l.Wq.TEXT,this._disposableStore=new h.S,this._effectEditHelper=new o.g,this._isEditing=!1,this._paintByEffect=async(e,t)=>{var i,r,n,o;if(!this.element)return;const a=(0,_.U)(this.element,t);await Promise.all([...t.fontDependResources.map((e=>{var t;return null===(t=s.fc.getDependency(e.resourceId))||void 0===t?void 0:t.ready})),(null==t||null===(i=t.glow)||void 0===i?void 0:i.enable)&&(null==t||null===(r=t.glow)||void 0===r?void 0:r.resourceId)&&(null===(n=s.fc.getDependency(null==t||null===(o=t.glow)||void 0===o?void 0:o.resourceId))||void 0===n?void 0:n.ready)]);const l=(0,_.m)(a,!this._isEditing);try{const i=await this.runEffectAction(a.id,l),r=this._fontRenderHasFail(t),s=await this._getOffsetY({params:a,textData:l,canvasRect:null==i?void 0:i.canvasRect,hasfontRenderFail:r});await this._drawEffectOffscreenCanvas(i,null!=s?s:0),r&&await this._repaintFallbackFont(e,a)}catch(h){return c.t.log(null==h?void 0:h.message),null}}}async render(e){var t,i,r,s;return this.element=new C.V({...(0,v.U)(this.props),type:l.Wq.TEXT,id:this.props.id,extendBuffer:{x:(null!==(t=null===(i=this.props.extra.textOuterRect)||void 0===i?void 0:i.width)&&void 0!==t?t:this.props.layout.width)-this.props.layout.width,y:(null!==(r=null===(s=this.props.extra.textOuterRect)||void 0===s?void 0:s.height)&&void 0!==r?r:this.props.layout.height)-this.props.layout.height},align:this.props.align===l.PH.LEFT?"left":this.props.align===l.PH.RIGHT?"right":"center"}),null==e||e.add(this.element),e&&await this._paintByEffect(e,this.props),this.element}onMount(){const e=(0,f.debounce)((async()=>{if(this._isEditing){const{richJson:e}=await this._effectEditHelper.getTextEditInfo(this.getId());if(!e.text)return}this.updateNode({})}),50);this._disposableStore.add(y.Z.interact.onPageZoomChange.event(e))}enterTextEdit(){this._isEditing=!0}exitTextEdit(){this._isEditing=!1}destroy(){super.destroy(),this._disposableStore.clear()}rerender(e){var t;return this.updateProps(e),this.render(null===(t=this.element)||void 0===t?void 0:t.getParent())}updateHeight(){}parse(){return{}}async setColors(e,t,i,r){var s;const n=JSON.parse(this.props.richText),o={color:R.solidColor(e),backgroundColor:t?R.solidColor(t):void 0,outLineColor:i?R.solidColor(i):void 0,shadowColor:r?R.solidColor(r):void 0};n.styles.forEach((e=>{var t,i,r;(e.fill&&"gradient"!==(null===(t=e.fill)||void 0===t?void 0:t.content.render_type)&&(e.fill.content.solid=o.color.solid),o.shadowColor)&&(null===(i=e.shadows)||void 0===i||i.forEach((e=>{"gradient"!==e.content.render_type&&(e.content.solid=o.shadowColor.solid)})));o.outLineColor&&(null===(r=e.strokes)||void 0===r||r.forEach((e=>{"gradient"!==e.content.render_type&&(e.content.solid=o.outLineColor.solid)})))})),this.props.richText=JSON.stringify(n),t&&null!==(s=this.props.background)&&void 0!==s&&s.color&&(this.props.background={...this.props.background,color:t}),await this.updateNode()}async updateNode(e){if(!this.element)return;const t=(0,f.merge)({},this.props,e),i=w.f.cache.get(t.id);if(!i)return;await i.firstCanvasReady;const r=(0,_.U)(this.element,t),s=(0,_.m)(r,!this._isEditing),n=await this.runEffectAction(r.id,s);if(null==n||!n.canvas)return null;await this.updateTextFrame(n),this.updateNodeAttr(e,t)}updateNodeAttr(e,t){if(!this.element)return;let i=null;if(null!=e&&e.layout){var r,s,n,o;const e=(0,p.p)(t.layout);a={...e,extendBuffer:{x:(null!==(r=null===(s=t.extra.textOuterRect)||void 0===s?void 0:s.width)&&void 0!==r?r:e.width)-e.width,y:(null!==(n=null===(o=t.extra.textOuterRect)||void 0===o?void 0:o.height)&&void 0!==n?n:e.height)-e.height}},Object.assign(null!==(l=i)&&void 0!==l?l:i={},a)}var a,l;if(i){var h;const e=this.element.attrs;null===(h=this.element)||void 0===h||h.setAttrs(i);(0,d.d)(e,i,["width","height","scale","rotation"])&&this.element.fire(b.Z2.layoutupdate)}}async updateTextFrame(e){await(0,u.Rt)(s.Bm.webUpdateSeekFrame,(()=>{this._drawEffectOffscreenCanvas(e,0)}))}async runEffectAction(e,t){if(!w.f.cache.get(e))return a.ZP.addEffectText(e,t);if(this._isEditing){return await this._effectEditHelper.updateEditText(e,t)}return a.ZP.updateEffectText(e,t)}_drawEffectOffscreenCanvas(e,t=0){var i;const{canvas:r,canvasRect:s,scale:n}=e;r&&(null===(i=this.element)||void 0===i||i.setAttrs({content:{offsetY:t,texture:r,scale:n,buffer:{x:(r.width-s.width)/2,y:(r.height-s.height)/2}}}))}async _getOffsetY({params:e,textData:t,canvasRect:i,hasfontRenderFail:r}){if(!i||r)return;const{layout:s,id:n}=e,o=t.scale[1],l=s.height*o,h=i.height,c=w.f.cache.get(n);if(!c)return 0;const d=c.hasFixHeight;if(!(Math.abs(h-l)>.2)||d)return d||(c.hasFixHeight=!0),0;const u=await a.ZP.getFontAscentMaxDis(n),g=i.height/o;requestAnimationFrame((()=>{c.hasFixHeight=!0,y.Z.textLayer.onNeedLayoutChange.fire({id:n,height:g,offsetY:u})}));return(g-s.height)/2-u}_fontRenderHasFail(e){const t=a.ZP.getErrorInfos();if(0===t.length)return!1;const i=(0,_.m)(e,!this._isEditing);return 0!==t.filter((e=>e.error_code===s.XD.ERROR_CODE_FONT_FAIL_RENDER&&e.resource_path===i.fontPath)).length}async _repaintFallbackFont(e,t){(0,_.m)(t,!this._isEditing).fallbackFontPathList.length!==s.Kt.length&&(await Promise.all(s.Kt.map((async e=>{await(0,g.Gk)(e.resourceId)}))),await this._paintByEffect(e,t))}}I([(0,x.C)(),L("design:type",Function),L("design:paramtypes",["function"==typeof(r=void 0!==n.W2&&n.W2)?r:Object]),L("design:returntype",Promise)],E.prototype,"render",null)},84969:(e,t,i)=>{i.d(t,{Z:()=>b});var r=i(25629),s=i(43382),n=i(90200),o=i(22231);const a=[.8,20];var l=i(8757),h=i(10966),c=i(22169);class d{constructor(e){this._disposableStore=new s.S,this._dragEnable=!1,this._cumulatedTouch=[0,0],this._distance=0,this._useGrabCursor=()=>{this.cursor.useGrabCursor()},this._useGrabbingCursor=()=>{this.cursor.useGrabbingCursor()},this._getZoomScaleFactor=e=>{const t=l.Qf.MIN,i=l.Qf.MAX,[r,s]=a,n=r+(s-r)*Math.pow((e-t)/(i-t),1.8);return(0,c.round)(n,2)},this._onModelChange=e=>{switch(e.actionType){case l.Us.AddLayerAction:r.Z.interact.onMoveModeChange.fire(l.Ll.Mouse);break;case l.Us.ResizePageAction:this._getAccessors().page.fitToWindow()}},this._mouseOver=()=>{this._dragEnable&&this.cursor.useGrabCursor()},this._mouseOut=()=>{this.cursor.useDefaultCursor()},this._moveModeChange=e=>{this._dragEnable=e===l.Ll.Hand;const{layer:t}=this._stage,{draggable:i}=this._renderer.getRenderer().getFeatureRenderer().getInteractive();this._dragEnable?(null==i||i.disable(),this._useGrabCursor(),t.on("mousedown",this._handleLayerMouseDown)):(null==i||i.enable(),this.cursor.useDefaultCursor(),t.fire("mouseup"),t.off("mousedown",this._handleLayerMouseDown))},this._handleLayerMouseDown=e=>{if(0===e.evt.button){this._startDragPos={x:0,y:0};const t=this._getLayer();this._startDragPos.x=e.evt.clientX,this._startDragPos.y=e.evt.clientY,t.on("mousemove",this._handleLayerMouseMove),t.on("mouseup",this._handleLayerMouseUp)}},this._handleLayerMouseUp=()=>{this._useGrabCursor();const e=this._getLayer();e.off("mousemove",this._handleLayerMouseMove),e.off("mouseup",this._handleLayerMouseUp)},this._handleLayerMouseMove=e=>{this._useGrabbingCursor();const t=e.evt.clientX-this._startDragPos.x,i=e.evt.clientY-this._startDragPos.y;this._startDragPos.x=e.evt.clientX,this._startDragPos.y=e.evt.clientY,this._moveHandle(-t,-i)},this._specialException=(e,t)=>{const i=(0,n.Qg)(e);return i===n.Ib.Inside&&t<0||i===n.Ib.Outside&&t>0?-t:t},this._wheel=e=>{this._stage.setFitState(!1);const t=(0,n.Qg)(e.evt);if(e.evt.preventDefault(),[n.Ib.Inside,n.Ib.Outside].includes(t))return void this._zoomHandle(e);let{deltaX:i,deltaY:r}=e.evt;(o.t.Windows||navigator.platform.startsWith("Win"))&&e.evt.shiftKey&&(i=r,r=0),this._moveHandle(i,r)},this._scaleHandle=(e,t)=>{const i=this._getPageContainer(),s=(0,c.round)(i.scaleX(),2),n=this._stage.container.getPointerPosition(),o={x:(n.x-i.x())/s,y:(n.y-i.y())/s},a=this._specialException(t,e),h=this._getZoomScaleFactor(s),d=Math.max(16,Math.abs(t.deltaY/16));let u=Math.round(100*s-a/d*h)/100;u=Math.max(u,l.Qf.MIN),u=Math.min(u,l.Qf.MAX),this._getAccessors().page.setZoomByPointer(n,o,u),r.Z.interact.onPageZoomChange.fire({scale:u,oldScale:s}),u!==s&&r.Z.interact.onPageLayoutChange.fire(l.$l.Zoom)},this._moveHandle=(e,t)=>{this._getAccessors().page.getScrollerFeature().setScrollByOffset(-e,-t)},this._renderer=e,this._disposableStore.add(r.Z.action.onModelChange.event(this._onModelChange)),this._disposableStore.add(r.Z.interact.onMoveModeChange.event(this._moveModeChange)),this._disposableStore.add(r.Z.canvas.wheel.event(this._wheel)),this._disposableStore.add(r.Z.canvas.mouseover.event(this._mouseOver)),this._disposableStore.add(r.Z.canvas.mouseout.event(this._mouseOut))}get cursor(){return this._renderer.getRenderer().cursor}get isDragEnable(){return this._dragEnable}get _stage(){return this._renderer.getRenderer().stage}updated(){}destroy(){this._disposableStore.clear()}_getAccessors(){return this._renderer.getRenderer().accessors}_getPageContainer(){return this._stage.getPageContainer()}_getLayer(){return this._stage.layer}_zoomHandle(e){const t=e.evt;if((0,h.G3)(t))return this._distance+=t.deltaY,void(Math.abs(this._distance)>=10&&(this._scaleHandle(this._distance,t),this._distance=0));if((0,h.To)(t)){this._cumulatedTouch[0]+=t.deltaX,this._cumulatedTouch[1]+=t.deltaY;let e=1;this._cumulatedTouch[0]*this._cumulatedTouch[1]>0?e=1:this._cumulatedTouch[0]*this._cumulatedTouch[1]<0?e=-1:0===this._cumulatedTouch[0]?e=this._cumulatedTouch[1]<0?-1:1:0===this._cumulatedTouch[1]&&(e=this._cumulatedTouch[0]<0?-1:1);const i=e*Math.sqrt(Math.pow(this._cumulatedTouch[0],2)+Math.pow(this._cumulatedTouch[1],2))*5;Math.abs(i)>=10&&(this._scaleHandle(i,t),this._cumulatedTouch=[0,0])}}}var u=i(60748);class g{constructor(e){this._moveAction=new d(e),this._guideLine=new u.ZP(e)}get moveAction(){return this._moveAction}get guideLine(){return this._guideLine}updated(){this._moveAction.updated(),this._guideLine.updated()}destroy(){this._moveAction.destroy(),this._guideLine.destroy()}}var _=i(2322),p=i(37145),f=i(4114),m=i(13578),v=i(56378),y=i(54643);class x{constructor(e){this._mainRender=e}get _renderSDK(){return this._mainRender.getRenderer()}update(){this.buildWidgetTree()}destroy(){var e;null===(e=this._rootWidget)||void 0===e||e.destroy()}setRootWidget(e){this._rootWidget=e}getRootWidget(){return this._rootWidget}getPageWidget(e){var t;const i=null===(t=this._rootWidget)||void 0===t?void 0:t.getChildren();if(!i)return null;return i.find((t=>t.getId()===e))}getMaterialWidget(e,t){const i=this.getPageWidget(e);let r=null;const s=e=>{null==e||e.getChildren().forEach((e=>{if(e.getId()!==t)return e.type===l.Wq.GROUP_LAYER?s(e):void 0;r=e}))};return s(i),r}render(e,t){this._rootWidget=this.buildWidgetTree(t),this.renderWidgetTree(this._rootWidget,e),this.cacheWidgets(this._rootWidget)}buildWidgetTree(e=this._getWidgetTreeOptions()){const t=new _.G({}),i=this._mainRender.getRenderer().getActivePageId(),r=Math.max(0,e.pages.findIndex((e=>e.id===i))),s=e.pages[r],{width:n,height:o}=(0,y.Ln)(s.dimension),a={x:0,y:0,width:n,height:o},{pixels:l,zoom:h}=e;return t.addChild(this.buildPage({page:s,rect:a,pixels:l,zoom:null!=h?h:this._mainRender.getZoom()})),t}buildPage(e){const{page:t,rect:i,pixels:r,zoom:s}=e,n={...t,...i,pixels:r,dimension:t.dimension,zoom:s,id:t.id,stateManager:this._renderSDK.stateManager};let o;const a=v.Z.getCacheWidget(t.id);return a?(a.replaceProps(n),o=a,o.removeAllChildren()):o=new p.C(n),t.layers.forEach((e=>this.buildMaterial({parent:o,layer:e,pixels:r,zoom:s,dimension:t.dimension}))),o}buildMaterial(e){const{parent:t,layer:i,pixels:r,zoom:s,dimension:n}=e,{type:o}=i,a={...i,pixels:r,zoom:s,dimension:n},h=v.Z.getCacheWidget(a.id);if(o===l.F5.GROUP_LAYER){let e;return h?(e=h,e.replaceProps(a)):e=new f.f(a),t.addChild(e),void a.children.forEach((t=>{this.buildMaterial({parent:e,layer:{...t,groupId:i.id},pixels:r,zoom:s,dimension:n})}))}if(h)return h.replaceProps(a),void t.addChild(h);const c=new((0,m.j)(o))(a);t.addChild(c)}renderWidgetTree(e,t){null==e||e.render(t)}onWidgetRenderReady(){return new Promise((async e=>{var t;await(null===(t=this._rootWidget)||void 0===t?void 0:t.onReady()),this._renderSDK.nextTick(e)}))}cacheWidgets(e){e.getChildren().forEach((e=>{e.getId()&&v.Z.cacheWidget(e.getId(),e),this.cacheWidgets(e)}))}_getWidgetTreeOptions(){return{pages:this._renderSDK.model.pages,pixels:this._mainRender.getPixel()}}}class b{constructor(e){this.getPixel=(e=this.getZoom())=>{const t=this.getDimension();if(!t)return 0;const i=(0,y.Ln)(t);let r=0;return i&&(r=i.height*e.y*i.width*e.x),r},this._renderSDK=e,this._renderCore=new x(this),this._interactive=new g(this)}get _stage(){return this._renderSDK.stage}get _pageContainer(){return this._stage.pageContainer}getLayer(){return this._stage.layer}getPageContainer(){return this._pageContainer}getRenderer(){return this._renderSDK}getRenderCore(){return this._renderCore}getInteractive(){return this._interactive}getActivePageWidget(){const e=this._renderCore.getRootWidget(),t=this._renderSDK.getActivePageId();return null==e?void 0:e.getChildren().find((e=>e.getId()===t))}getMaterialWidget(e){return this._renderCore.getMaterialWidget(this._renderSDK.getActivePageId(),e)}renderInit(){0!==this._renderSDK.model.pageCount&&this._renderCore.render(this._pageContainer)}renderForce(){this.renderInit()}reset(e){this._stage.destroyDirtyWidgets(e)}destroy(){this._interactive.destroy()}updated(){this._interactive.updated()}getDimension(e){const t=null!=e?e:this._renderSDK.getActivePageId(),i=this._renderSDK.model.pages.find((e=>e.id===t));if(!i)return null;const{width:r,height:s,unit:n}=i.dimension;return{width:r,height:s,unit:n}}getZoom(){const e=this.getPageContainer().scale();return{x:(null==e?void 0:e.x)||1,y:(null==e?void 0:e.y)||1}}getPage(e){const t=this._renderCore.getPageWidget(e);return null==t?void 0:t.getElement()}getPageWidget(e){var t;const i=null===(t=this._renderSDK.model.pages)||void 0===t?void 0:t[e];if(i)return this._renderCore.getPageWidget(i.id)}getPageWidgetById(e){return this._renderCore.getPageWidget(e)}getMultiPages(e){return e.map((e=>{const{id:t}=this._renderSDK.model.pages[e];return this.getPage(t)}))}getAllPages(){var e;const t=null===(e=this._renderCore.getRootWidget())||void 0===e?void 0:e.getChildren();return null==t?void 0:t.map((e=>e.element))}getWidgetTree(){return this._renderCore.getRootWidget()}removePage(e){const t=this.getPageWidgetById(e);null==t||t.remove()}getPageAbsoluteRect(){const e=this.getPageAbsoluteRectWithBleedArea();if(!e)return;const t=this.getActivePageWidget();if(null==t||!t.bleedArea)return e;const i=this.getZoom(),r=(null==t?void 0:t.bleedArea)*i.x,s=(null==t?void 0:t.bleedArea)*i.y;return{x:e.x+r,y:e.y+s,width:e.width-2*r,height:e.height-2*s}}getPageAbsoluteRectWithBleedArea(){const e=this._renderSDK.getActivePageRect();if(!e)return;const t=e.width(),i=e.height(),r=e.getAbsoluteScale();return{...e.getAbsolutePosition(),width:t*r.x,height:i*r.y}}}},60748:(e,t,i)=>{i.d(t,{ZP:()=>x,wb:()=>r});var r,s=i(25629),n=i(43382),o=i(22231),a=i(30920),l=i(54643),h=i(71946),c=i(48737),d=i(50477),u=i(8757),g=i(28161),_=i(62378),p=i(63345),f=i(7063),m=i(52579),v=i(27482);!function(e){e.X_LEFT="xl",e.X_MIDDLE="xm",e.X_RIGHT="xr",e.Y_TOP="yt",e.Y_MIDDLE="ym",e.Y_BOTTOM="yb"}(r||(r={}));const y="customGuideLine";class x{constructor(e){this._disposableStore=new n.S,this._allLocationList=[],this._locationList=[],this._locationXSortList=[],this._locationYSortList=[],this._isometricLocationXLeftSortList=[],this._isometricLocationXRightSortList=[],this._isometricLocationYTopSortList=[],this._isometricLocationYBottomSortList=[],this._isEnable=!0,this.updated=()=>{},this._onLayerDragEnd=()=>{this.removeGuideLine()},this._onLayerTransformEnd=()=>{this.removeGuideLine()},this._handleKeyBoardEvent=e=>{const{metaKey:t,ctrlKey:i,altKey:r,shiftKey:s}=e;(o.t.MacOS?t:i)&&!r&&!s?this.disabled():this.enable()},this._handleDrag=()=>{this._isEnable?(this._updateAction("drag"),this._updateLocationList(),this._doMain()):this.removeGuideLine()},this._handleTransform=()=>{this._updateAction("transform"),this._updateLocationList()},this._mainRenderer=e,this._disposableStore.add(s.Z.interact.onMaterialSelect.event((()=>this._handleSelect()))),(0,g.Z)("*",{keydown:!0,keyup:!0,scope:u.IB.Default},this._handleKeyBoardEvent)}drawLine(e){const t=this._mainRenderer.getPageContainer();f.Z.line(t,{points:e,stroke:"red",strokeWidth:2,lineJoin:"round",dash:[10,10],listening:!1})}getMainRenderer(){return this._mainRenderer}enable(){this._isEnable=!0}disabled(){this._isEnable=!1}destroy(){this._destroyTransformerEvents(),this._disposableStore.clear(),g.Z.unbind("*",this._handleKeyBoardEvent)}getThreshold(){return this._threshold}removeGuideLine(){const e=this._mainRenderer.getPageContainer();null==e||e.find(`.${y}`).forEach((e=>e.destroy()));const t=this.getPageMargin();null==t||t.removeGuideLine();const i=this.getRuler();null==i||i.removeGuideLine(),this._updateThreshold()}getFeatureCanvas(){return this._mainRenderer.getRenderer().getFeatureRenderer()}getPageMargin(){return this.getFeatureCanvas().getFeature(m.Z.Name)}getRuler(){return this.getFeatureCanvas().getFeature(v.Z.Name)}doGuideLineMeasure(e,t){this._updateThreshold(),this._updateAllLocationList(),this._updateLocationList();return this._getGuideLineInfoList(e,t)}drawGuideLine(e,t){this._updateLocationList(),this.removeGuideLine(),this._updateThreshold(t),this._updateIsometricLocationList();const i=this._getTransformerLocationItem(this._transformer),r=this._getGuideLineInfoList(i,e);return r.forEach((e=>{switch(e.scene){case u.ul.PAGE_MARGIN_LINE:const t=this.getPageMargin();null==t||t.drawGuideLine();break;case u.ul.HORIZONTAL_ISOMETRIC_LINE:this._drawHorizontalIsometricGuideLine(e);break;case u.ul.VERTICAL_ISOMETRIC_LINE:this._drawVerticalIsometricGuideLine(e);break;case u.ul.RULER_LINE:const i=this.getRuler();null==i||i.drawGuideLine(e);break;default:this._drawGuideLine(e)}})),r.length>0}async initFeatureCanvasEvent(){const e=this._mainRenderer.getRenderer().getFeatureRenderer();await e.onReady();const{transform:t}=e.getInteractive();t&&(this._disposableStore.add(t.onMaterialDragEnd(this._onLayerDragEnd)),this._disposableStore.add(t.onMaterialTransformEnd(this._onLayerTransformEnd)))}_updateThreshold(e){const t=this._mainRenderer.getZoom().x,i=null!=e?e:5;this._threshold=i/t}_updateTransformer(e){this._destroyTransformerEvents(),this._transformer=e}_updateAction(e){this._currentAction=e}_updateAllLocationList(e){var t;const i=h.Z.findMaterials(this._mainRenderer.getPageContainer()),r=(null==e||null===(t=e.nodes())||void 0===t?void 0:t.map((e=>e.id())))||[],s=[];for(const n of i)if(!r.includes(n.id())){const e=this._getLocationItem(n);s.push(e)}this._allLocationList=s}_updateLocationList(){const e=this._mainRenderer.getLayer().height(),t=this._mainRenderer.getLayer().width(),i=[],r=[],s=[];for(const n of this._allLocationList){const o=this._getStagePosFromPagePos(n.xl,"x"),a=this._getStagePosFromPagePos(n.xr,"x"),l=this._getStagePosFromPagePos(n.yt,"y"),h=this._getStagePosFromPagePos(n.yb,"y");o>t||a<0||h<0||l>e||(i.push(n),r.push({locationItem:n,position:n.xl,type:"X"},{locationItem:n,position:n.xm,type:"X"},{locationItem:n,position:n.xr,type:"X"}),s.push({locationItem:n,position:n.yt,type:"Y"},{locationItem:n,position:n.ym,type:"Y"},{locationItem:n,position:n.yb,type:"Y"})),this._locationList=i,this._locationXSortList=r.sort(((e,t)=>e.position-t.position)),this._locationYSortList=s.sort(((e,t)=>e.position-t.position))}}_updateIsometricLocationList(){const e=this._getTransformerLocationItem(this._transformer),t=[],i=[],r=[],s=[];for(const n of this._locationList){const o=n.yt>=e.yt&&n.yt<=e.yb||n.yb>=e.yt&&n.yb<=e.yb||n.yt<=e.yt&&n.yb>=e.yb,a=n.xl>=e.xl&&n.xl<=e.xr||n.xr>=e.xl&&n.xr<=e.xr||n.xl<=e.xl&&n.xr>=e.xr;n.xr<e.xl&&o?t.push(n):n.xl>e.xr&&o?i.push(n):n.yb<e.yt&&a?r.push(n):n.yt>e.yb&&a&&s.push(n)}this._isometricLocationXLeftSortList=t.sort(((e,t)=>e.xl-t.xl)),this._isometricLocationXRightSortList=i.sort(((e,t)=>e.xl-t.xl)),this._isometricLocationYTopSortList=r.sort(((e,t)=>e.yt-t.yt)),this._isometricLocationYBottomSortList=s.sort(((e,t)=>e.yt-t.yt))}_doMain(){this.removeGuideLine(),this._updateIsometricLocationList();const e=this._getTransformerLocationItem(this._transformer);this._getGuideLineInfoList(e).forEach((e=>{switch(e.scene){case u.ul.PAGE_MARGIN_LINE:const t=this.getPageMargin();null==t||t.drawGuideLine();break;case u.ul.HORIZONTAL_ISOMETRIC_LINE:this._drawHorizontalIsometricGuideLine(e);break;case u.ul.VERTICAL_ISOMETRIC_LINE:this._drawVerticalIsometricGuideLine(e);break;case u.ul.RULER_LINE:const i=this.getRuler();null==i||i.drawGuideLine(e);break;default:this._drawGuideLine(e)}this._changeMaterial(e)}))}_getGuideLineInfoList(e,t=[u.ul.HORIZONTAL_LINE,u.ul.VERTICAL_LINE,u.ul.HORIZONTAL_ISOMETRIC_LINE,u.ul.VERTICAL_ISOMETRIC_LINE,u.ul.PAGE_MARGIN_LINE,u.ul.RULER_LINE]){let i,r,s,n,o,a,l,h;const c=this.getPageMargin();t.includes(u.ul.PAGE_MARGIN_LINE)&&c&&(o=c.getVerticalGuideLineInfo(e,this._threshold),a=c.getHorizontalGuideLineInfo(e,this._threshold));const d=this.getRuler();t.includes(u.ul.RULER_LINE)&&d&&(l=d.getVerticalGuideLineInfo(e,this._threshold),h=d.getHorizontalGuideLineInfo(e,this._threshold)),t.includes(u.ul.HORIZONTAL_LINE)&&(i=this._getHorizontalGuideLineInfo(e)),t.includes(u.ul.VERTICAL_LINE)&&(r=this._getVerticalGuideLineInfo(e)),t.includes(u.ul.HORIZONTAL_ISOMETRIC_LINE)&&(s=this._getHorizontalIsometricGuideLineInfo()),t.includes(u.ul.VERTICAL_ISOMETRIC_LINE)&&(n=this._getVerticalIsometricGuideLineInfo());const g=[i,n,a,h].filter((e=>Boolean(e))).sort(((e,t)=>Math.abs(e.offset)-Math.abs(t.offset))),_=[r,s,o,l].filter((e=>Boolean(e))).sort(((e,t)=>Math.abs(e.offset)-Math.abs(t.offset)));return[g[0],_[0]].filter((e=>e))}_matchIsoGuideLineCondition(e,t,i){var r,s;return Boolean(!e||Math.abs(e.offset)>Math.abs(t-i)||Math.abs(e.offset)===Math.abs(t-i)&&(null==e||null===(r=e.extInfo)||void 0===r?void 0:r.distance)&&t<(null==e||null===(s=e.extInfo)||void 0===s?void 0:s.distance))}_getHorizontalIsometricGuideLineInfo(){const e=this._getTransformerLocationItem(this._transformer);let t;return this._isometricLocationXLeftSortList.forEach(((i,s)=>{const n=e.xl-i.xr;for(let o=s-1;o>=0;o--){const s=this._isometricLocationXLeftSortList[o];if(!s)break;const a=i.xl-s.xr;if(s.xr<i.xl&&Math.abs(a-n)<=this._threshold&&this._matchIsoGuideLineCondition(t,a,n)){const s=i.xr+a-e.xl;t={offset:s,scene:u.ul.HORIZONTAL_ISOMETRIC_LINE,source:e,target:[i],guideLinePosition:i.xr+a,direction:r.X_LEFT,extInfo:{fixedSourceLocation:{...e,xl:e.xl+s,xm:e.xl+s,xr:e.xr+s},distance:a}}}}})),this._isometricLocationXRightSortList.forEach(((i,s)=>{const n=i.xl-e.xr;for(let d=s;d<this._isometricLocationXRightSortList.length;d++){const s=this._isometricLocationXRightSortList[d];if(!s)break;const o=s.xl-i.xr;if(s.xl>i.xr&&Math.abs(o-n)<=this._threshold&&this._matchIsoGuideLineCondition(t,o,n)){const s=i.xl-o-e.xr;t={offset:s,scene:u.ul.HORIZONTAL_ISOMETRIC_LINE,source:e,target:[i],guideLinePosition:i.xl-o,direction:r.X_RIGHT,extInfo:{fixedSourceLocation:{...e,xl:e.xl+s,xm:e.xm+s,xr:e.xr+s},distance:o}}}}for(const d of this._isometricLocationXLeftSortList){var o,a,l,h,c;const s=(d.xr+i.xl)/2,n=s-e.xm,g=(i.xl-d.xr-e.width)/2;(!t&&Math.abs(n)<=this._threshold||null!==(o=t)&&void 0!==o&&o.offset&&Math.abs(t.offset)>Math.abs(n)||null!==(a=t)&&void 0!==a&&a.offset&&Math.abs(null===(l=t)||void 0===l?void 0:l.offset)===Math.abs(n)&&null!==(h=t)&&void 0!==h&&null!==(h=h.extInfo)&&void 0!==h&&h.distance&&g<(null===(c=t)||void 0===c||null===(c=c.extInfo)||void 0===c?void 0:c.distance))&&(t={offset:n,scene:u.ul.HORIZONTAL_ISOMETRIC_LINE,source:e,target:[d,i],guideLinePosition:s,direction:r.X_MIDDLE,extInfo:{fixedSourceLocation:{...e,xm:s,xl:e.xl+n,xr:e.xr+n},distance:g}})}})),t}_isDistanceEqual(e,t){return Math.abs(e-t)<.1}_getVerticalIsometricGuideLineInfo(){const e=this._getTransformerLocationItem(this._transformer);let t;return this._isometricLocationYTopSortList.forEach(((i,s)=>{const n=e.yt-i.yb;for(let o=s-1;o>=0;o--){const s=this._isometricLocationYTopSortList[o];if(!s)break;const a=i.yt-s.yb;if(s.yb<i.yt&&Math.abs(a-n)<=this._threshold&&this._matchIsoGuideLineCondition(t,a,n)){const s=i.yb+a-e.yt;t={offset:s,scene:u.ul.VERTICAL_ISOMETRIC_LINE,source:e,target:[i],guideLinePosition:i.yb+a,direction:r.Y_TOP,extInfo:{fixedSourceLocation:{...e,yt:e.yt+s,ym:e.ym+s,yb:e.yb+s},distance:a}}}}})),this._isometricLocationYBottomSortList.forEach(((i,s)=>{const n=i.yt-e.yb;for(let g=s;g<this._isometricLocationYBottomSortList.length;g++){const s=this._isometricLocationYBottomSortList[g];if(!s)break;const o=s.yt-i.yb;if(s.yt>i.yb&&Math.abs(o-n)<=this._threshold&&this._matchIsoGuideLineCondition(t,o,n)){const s=i.yt-o-e.yb;t={offset:s,scene:u.ul.VERTICAL_ISOMETRIC_LINE,source:e,target:[i],guideLinePosition:i.yt-o,direction:r.Y_BOTTOM,extInfo:{fixedSourceLocation:{...e,yt:e.yt+s,ym:e.ym+s,yb:e.yb+s},distance:o}}}}for(const g of this._isometricLocationYTopSortList){var o,a,l,h,c,d;const s=(g.yb+i.yt)/2,n=s-e.ym,_=(i.yt-g.yb-e.height)/2;(!t&&Math.abs(n)<=this._threshold||null!==(o=t)&&void 0!==o&&o.offset&&Math.abs(null===(a=t)||void 0===a?void 0:a.offset)>Math.abs(n)||null!==(l=t)&&void 0!==l&&l.offset&&Math.abs(null===(h=t)||void 0===h?void 0:h.offset)===Math.abs(n)&&null!==(c=t)&&void 0!==c&&null!==(c=c.extInfo)&&void 0!==c&&c.distance&&_<(null===(d=t)||void 0===d||null===(d=d.extInfo)||void 0===d?void 0:d.distance))&&(t={offset:n,scene:u.ul.VERTICAL_ISOMETRIC_LINE,source:e,target:[g,i],guideLinePosition:s,direction:r.Y_MIDDLE,extInfo:{fixedSourceLocation:{...e,ym:s,yt:e.yt+n,yb:e.yb+n},distance:_}})}})),t}_getHorizontalGuideLineInfo(e){const t=[e.yt,e.ym,e.yb],i=[r.Y_TOP,r.Y_MIDDLE,r.Y_BOTTOM],s=this._getMinDistanceInfo(t,this._locationYSortList);if(s){return{scene:u.ul.HORIZONTAL_LINE,source:e,target:[s.locationItem],guideLinePosition:s.position,direction:i[s.sourcePositionIndex],offset:s.offset}}}_getVerticalGuideLineInfo(e){const t=[e.xl,e.xm,e.xr],i=[r.X_LEFT,r.X_MIDDLE,r.X_RIGHT],s=this._getMinDistanceInfo(t,this._locationXSortList);if(s){return{scene:u.ul.VERTICAL_LINE,source:e,target:[s.locationItem],guideLinePosition:s.position,direction:i[s.sourcePositionIndex],offset:s.offset}}}_getMinDistanceInfo(e,t){let i;return e.forEach(((e,r)=>{t.forEach((t=>{if(void 0===e)return;const s=t.position-e;Math.abs(s)<this._threshold&&(!i||Math.abs(s)<Math.abs(i.offset))&&(i={locationItem:t.locationItem,position:t.position,offset:s,sourcePositionIndex:r})}))})),i}_getLinePoints(e){const{targetItem:t,targetPosition:i,direction:s}=e,n=this._getTransformerLocationItem(this._transformer);if([r.X_LEFT,r.X_MIDDLE,r.X_RIGHT].includes(s)){const e=[n.yt,n.yb,t.yt,t.yb].filter((e=>void 0!==e));return[i,Math.min(...e),i,Math.max(...e)]}const o=[n.xl,n.xr,t.xl,t.xr].filter((e=>void 0!==e));return[Math.min(...o),i,Math.max(...o),i]}_drawGuideLine(e){const t=e.target[0],i=[];if(e.scene===u.ul.HORIZONTAL_LINE&&t.type===u.Wq.PAGE&&[t.yt,t.yb].includes(e.guideLinePosition)&&i.push([t.xl,e.guideLinePosition,t.xr,e.guideLinePosition]),e.scene===u.ul.VERTICAL_LINE&&t.type===u.Wq.PAGE&&[t.xl,t.xr].includes(e.guideLinePosition)&&i.push([e.guideLinePosition,t.yt,e.guideLinePosition,t.yb]),e.scene===u.ul.VERTICAL_LINE&&t.type===u.Wq.PAGE&&e.guideLinePosition===t.xm)i.push([t.xm,t.yt,t.xm,t.yb]);else if(e.scene===u.ul.HORIZONTAL_LINE&&t.type===u.Wq.PAGE&&e.guideLinePosition===t.ym)i.push([t.xl,t.ym,t.xr,t.ym]);else{const s=[r.Y_TOP,r.Y_MIDDLE,r.Y_BOTTOM],n=[r.X_LEFT,r.X_MIDDLE,r.X_RIGHT],{source:o,direction:l,guideLinePosition:h,scene:c}=e,d=()=>{i.push(this._getLinePoints({targetItem:t,targetPosition:h,direction:l}))},g=()=>{const e=e=>{i.push(this._getLinePoints({targetItem:t,targetPosition:t[e],direction:l}))},{width:r,height:h}=o,{width:g,height:_}=t;switch(c){case u.ul.VERTICAL_LINE:r&&Math.abs(r-g)<a.H?n.forEach(e):d();break;case u.ul.HORIZONTAL_LINE:h&&Math.abs(h-_)<a.H?s.forEach(e):d()}};t[l]===h?g():d()}const s=this._mainRenderer.getPageContainer();i.forEach((e=>{f.Z.line(s,{points:e,name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1})}))}_drawHorizontalIsometricGuideLine(e){var t,i;const r=null===(t=e.extInfo)||void 0===t?void 0:t.distance,s=null===(i=e.extInfo)||void 0===i?void 0:i.fixedSourceLocation;if(!r||!s)return;[[...this._isometricLocationXLeftSortList,s],[s,...this._isometricLocationXRightSortList]].forEach((e=>{for(let t=0;t<e.length-1;t++){const i=e[t];for(let s=t+1;s<e.length;s++){const t=e[s],n=t.xl-i.xr;if(n>0&&this._isDistanceEqual(n,r)){const e=[i.yt,i.yb,t.yt,t.yb];let r;e.sort(((e,t)=>e-t)),r=i.node instanceof c.A4?t.ym:t.node instanceof c.A4?i.ym:(e[1]+e[2])/2;const s=[i.xr,r],n=[t.xl,r];this._drawDistanceLine(s,n)}}}}))}_drawVerticalIsometricGuideLine(e){var t,i;const r=null===(t=e.extInfo)||void 0===t?void 0:t.distance,s=null===(i=e.extInfo)||void 0===i?void 0:i.fixedSourceLocation;if(!r||!s)return;[[...this._isometricLocationYTopSortList,s],[s,...this._isometricLocationYBottomSortList]].forEach((e=>{for(let t=0;t<e.length-1;t++){const i=e[t];for(let s=t+1;s<e.length;s++){const t=e[s],n=t.yt-i.yb;if(n>0&&this._isDistanceEqual(n,r)){const e=[i.xl,i.xr,t.xl,t.xr];let r;e.sort(((e,t)=>e-t)),r=i.node instanceof c.A4?t.xm:t.node instanceof c.A4?i.xm:(e[1]+e[2])/2;const s=[r,i.yb],n=[r,t.yt];this._drawDistanceLine(s,n)}}}}))}_drawDistanceLine(e,t){const i=this._mainRenderer.getPageContainer(),r=2/this._mainRenderer.getZoom().x,[s,n]=e,[o,a]=t;f.Z.line(i,{points:[...e,...t],name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),s===o?(f.Z.line(i,{points:[s-r,n,s+r,n],name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),f.Z.line(i,{points:[o-r,a,o+r,a],name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),this._drawDistanceValue(this._getDistanceValue(Math.abs(n-a)),[s,(n+a)/2],"y")):(f.Z.line(i,{points:[s,n-r,s,n+r],name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),f.Z.line(i,{points:[o,a-r,o,a+r],name:y,stroke:p.q,strokeWidth:this._getLineWidth(),lineJoin:"round",listening:!1}),this._drawDistanceValue(this._getDistanceValue(Math.abs(s-o)),[(s+o)/2,n],"x"))}_getDistanceValue(e){var t;return(null===(t=this._mainRenderer.getDimension())||void 0===t?void 0:t.unit)===u.fb.CM?Number((0,l.$S)(e).toFixed(2)):Number(e.toFixed(0))}_drawDistanceValue(e,t,i){if(0===e)return;const r=this._mainRenderer.getPageContainer(),s=this._mainRenderer.getZoom().x,n=t[0],o=t[1],a="#fff";if("x"===i){const t=f.Z.text(null,{name:y,x:n,y:o-15/s,text:`${e}`,fontSize:10/s,fill:a,listening:!1}),i=n-t.width()/2,l=f.Z.rect(null,{name:y,x:i-7/s,y:o-18/s,width:t.width()+14/s,height:14/s,fill:p.q,cornerRadius:7/s,listening:!1});t.x(i),null==r||r.add(l,t)}else{const t=f.Z.text(null,{name:y,x:n+11/s,y:o-4.5/s,text:`${e}`,fontSize:10/s,fill:a,listening:!1}),i=f.Z.rect(null,{name:y,x:n+4/s,y:o-7/s,width:t.width()+14/s,height:14/s,fill:p.q,cornerRadius:7/s,listening:!1});null==r||r.add(i,t)}}_getLineWidth(){return 1/this._mainRenderer.getZoom().x}_changeMaterial(e){0!==e.offset&&"drag"===this._currentAction&&this._changeMaterialInDrag(e)}_changeMaterialInDrag(e){this._transformer.nodes().forEach((t=>{if([r.X_LEFT,r.X_MIDDLE,r.X_RIGHT].includes(e.direction)){const i=t.x();t.x(i+e.offset)}else{const i=t.y();t.y(i+e.offset)}t.fire("dragmove")}))}_pickLocationItem(e){const t=this._getTransformerLocationItem(this._transformer),i={id:t.id,width:t.width,height:t.height,type:t.type};return e.forEach((e=>{i[e]=t[e]})),i}_getSingleLineLocationItemInTransform(e){const t=this._transformer.getActiveAnchor(),i=this._transformer.findOne(`.${_.QM}`),r=this._transformer.findOne(`.${_.lB}`),s=[],n=[],o=[],a=[];let l;l=t===_.QM?r:i;const h=l.getAbsolutePosition();s.push(e.x,h.x),n.push(e.x,h.x),o.push(e.y,h.y),a.push(e.y,h.y);const c=Math.min(...s),d=Math.max(...n),u=Math.min(...o),g=Math.max(...a),p={id:this._transformer.id(),type:this._transformer.attrs.type,width:d-c,height:g-u},f={xl:this._getPagePosFromStagePos(c,"x"),xm:this._getPagePosFromStagePos((c+d)/2,"x"),xr:this._getPagePosFromStagePos(d,"x"),yt:this._getPagePosFromStagePos(u,"y"),ym:this._getPagePosFromStagePos((u+g)/2,"y"),yb:this._getPagePosFromStagePos(g,"y")},m=[];return e.x>h.x?m.push("xr"):e.x<h.x&&m.push("xl"),e.y>h.y?m.push("yb"):e.y<h.y&&m.push("yt"),m.forEach((e=>{p[e]=f[e]})),p}_getLocationItemInTransform(){const e=this._transformer.getActiveAnchor(),t=[u.Py,u.EK,u.Wk,u.Z0,u.DA,u.ng,u.XE,u.nh],i=this._transformer.rotation(),r=i<0?i+360:i,s=2*Math.floor(r/90),n=(()=>{const i=(t.indexOf(e)+s)%t.length;return t[i]})();return n===u.nh?this._pickLocationItem(["xl","yt"]):n===u.Py?this._pickLocationItem(["yt"]):n===u.EK?this._pickLocationItem(["xr","yt"]):n===u.Wk?this._pickLocationItem(["xr"]):n===u.Z0?this._pickLocationItem(["xr","yb"]):n===u.DA?this._pickLocationItem(["yb"]):n===u.ng?this._pickLocationItem(["xl","yb"]):this._pickLocationItem(["xl"])}_getFixedTransformNewPos(e,t){const i=this._transformer,r=i.getActiveAnchor(),s=i.findOne(`.${u.nh}`),n=i.findOne(`.${u.ng}`),o=i.findOne(`.${u.EK}`),a=i.findOne(`.${u.Z0}`),l=i.findOne(`.${r}`);if(l.setAbsolutePosition(e),i.keepRatio()){if(r===u.nh){const e={x:a.x(),y:a.y()},t=Math.sqrt(Math.pow(e.x-l.x(),2)+Math.pow(e.y-l.y(),2)),r=s.x()>e.x?-1:1,n=s.y()>e.y?-1:1,o=t*i.cos*r,h=t*i.sin*n;l.x(e.x-o),l.y(e.y-h);return l.getAbsolutePosition()}if(r===u.EK){const e={x:n.x(),y:n.y()},t=Math.sqrt(Math.pow(l.x()-e.x,2)+Math.pow(e.y-l.y(),2)),r=o.x()<e.x?-1:1,s=o.y()>e.y?-1:1,a=t*i.cos*r,h=t*i.sin*s;l.x(e.x+a),l.y(e.y-h);return l.getAbsolutePosition()}if(r===u.ng){const e={x:o.x(),y:o.y()},t=Math.sqrt(Math.pow(e.x-l.x(),2)+Math.pow(l.y()-e.y,2)),r=e.x<l.x()?-1:1,s=l.y()<e.y?-1:1,n=t*i.cos*r,a=t*i.sin*s;l.x(e.x-n),l.y(e.y+a);return l.getAbsolutePosition()}if(r===u.Z0){const e={x:s.x(),y:s.y()},t=Math.sqrt(Math.pow(l.x()-e.x,2)+Math.pow(l.y()-e.y,2)),r=a.x()<e.x?-1:1,n=a.y()<e.y?-1:1,o=t*i.cos*r,h=t*i.sin*n;l.x(e.x+o),l.y(e.y+h);return l.getAbsolutePosition()}}return[u.Py,u.DA].includes(r)?{x:t.x,y:e.y}:[u.XE,u.Wk].includes(r)?{x:e.x,y:t.y}:e}_bindchangeMaterialInTransform(){const e=this._transformer.anchorDragBoundFunc();this._transformer.anchorDragBoundFunc(((t,i,s)=>{if(e(t,i,s),!this._isEnable)return this.removeGuideLine(),i;const n=this._mainRenderer.getZoom().x,o=Math.min(30,30*n),a=Math.min(12,12*n);let l=2*this._threshold;l>o?l=o:l<a&&(l=a);const h=this._transformer.getActiveAnchor(),c=[_.QM,_.lB];let d,g,p;this.removeGuideLine(),d=c.includes(h)?this._getSingleLineLocationItemInTransform(i):this._getLocationItemInTransform();const f=this._getGuideLineInfoList(d,[u.ul.PAGE_MARGIN_LINE,u.ul.HORIZONTAL_LINE,u.ul.VERTICAL_LINE,u.ul.RULER_LINE]),m=this._getFixedTransformNewPos(i,t);if(0===f.length||Math.sqrt(Math.pow(t.x-m.x,2)+Math.pow(t.y-m.y,2))>l||h===u.h_)return i;f.forEach((e=>{switch(e.scene){case u.ul.PAGE_MARGIN_LINE:const t=this.getPageMargin();null==t||t.drawGuideLine();break;case u.ul.RULER_LINE:const i=this.getRuler();null==i||i.drawGuideLine(e);break;default:this._drawGuideLine(e)}})),f.forEach((e=>{[r.Y_TOP,r.Y_MIDDLE,r.Y_BOTTOM].includes(e.direction)?g=e:p=e}));let{x:v,y}=t;return c.includes(h)?p&&g?{x:this._getStagePosFromPagePos(p.guideLinePosition,"x"),y:this._getStagePosFromPagePos(g.guideLinePosition,"y")}:p?{x:this._getStagePosFromPagePos(p.guideLinePosition,"x"),y:i.y}:g?{x:i.x,y:this._getStagePosFromPagePos(g.guideLinePosition,"y")}:i:(p&&(v=0===(null===(x=this._transformer)||void 0===x||null===(x=x.attrs)||void 0===x?void 0:x.rotation)?this._getStagePosFromPagePos(p.guideLinePosition,"x"):t.x+p.offset*n),g&&(y=0===(null===(b=this._transformer)||void 0===b||null===(b=b.attrs)||void 0===b?void 0:b.rotation)?this._getStagePosFromPagePos(g.guideLinePosition,"y"):t.y+g.offset*n),{x:v,y});var x,b}))}_getStagePosFromPagePos(e,t){return e*this._mainRenderer.getZoom().x+this._mainRenderer.getPageContainer().getAbsolutePosition()[t]}_getPagePosFromStagePos(e,t){const i=this._mainRenderer.getZoom().x;return(e-this._mainRenderer.getPageContainer().getAbsolutePosition()[t])/i}_getLocationItem(e){if(e.attrs.type===u.Wq.PAGE)return this._getPageLocationItem(e);const t=this._mainRenderer.getPageContainer(),{x:i,y:r,width:s,height:n}=e.getClientRect({skipShadow:!0,skipStroke:!0,relativeTo:t});return{node:e,id:e.id(),type:e.attrs.type,width:s,height:n,xl:i,xm:i+s/2,xr:i+s,yt:r,ym:r+n/2,yb:r+n}}_getPageLocationItem(e){const t=this._mainRenderer.getPageContainer(),{x:i,y:r}=e.getAbsolutePosition(t),s=e.width(),n=e.height();return{node:e,id:e.id(),type:e.attrs.type,width:s,height:n,xl:i,xm:i+s/2,xr:i+s,yt:r,ym:r+n/2,yb:r+n}}_getTransformerLocationItem(e){const t=e.nodes(),i=this._mainRenderer.getPageContainer(),r=[],s=[],n=[],o=[];t.forEach((e=>{const{x:t,y:a,width:l,height:h}=e.getClientRect({skipShadow:!0,skipStroke:!0,relativeTo:i});r.push(t),s.push(t+l),n.push(a),o.push(a+h)}));const a=Math.min(...r),l=Math.max(...s),h=Math.min(...n),c=Math.max(...o);return{node:e,id:e.id(),type:e.attrs.type,width:l-a,height:c-h,xl:a,xm:(a+l)/2,xr:l,yt:h,ym:(h+c)/2,yb:c}}_bindTransformerEvents(){this._transformer.on("dragmove",this._handleDrag),this._transformer.on("transform",this._handleTransform)}_destroyTransformerEvents(){var e,t;null===(e=this._transformer)||void 0===e||e.off("dragmove",this._handleDrag),null===(t=this._transformer)||void 0===t||t.off("transform",this._handleTransform)}_handleSelect(){var e;const t=null===(e=this._mainRenderer.getRenderer().getFeatureRenderer().getInteractive().selection)||void 0===e?void 0:e.selectedIds;if(!t)return;const i=(0,d.b)(t),r=this._mainRenderer.getRenderer();if(i){const e=r.getFeatureRenderer().findByID(i);e&&(this._updateThreshold(),this._updateTransformer(e),this._updateAllLocationList(e),this._bindchangeMaterialInTransform(),this._bindTransformerEvents())}}}},75510:(e,t,i)=>{i.d(t,{Z:()=>f});var r=i(8757),s=i(7063),n=i(48917),o=i(87004),a=i(34618),l=i(14764),h=i(75107),c=i(25629),d=i(41064),u=i.n(d),g=i(5317),_=i(54643);function p(e,t){const i=t.includes(e.getId());if(e.hasChildren()){const i=[...e.getChildren()];for(const e of i)p(e,t)}i?e.remove():e.destroy()}class f{constructor(e,t){if(this.workspace={ratio:1,autoResize:!0,fixedCenter:!0},this.getPageContainer=()=>this.pageContainer,this.register=()=>{this._mouseOperator.register(),this._resizeObserver.observe(this.dom)},this.destroy=()=>{this._mouseOperator.destroy(),this._resizeObserver.unobserve(this.dom)},this.reset=()=>{this.layer.destroyChildren()},this.resize=e=>{this.container.setAttrs({...e});this.layer.findOne(`#${(0,a.Qb)(l.$U,r.Wq.KONVA_LAYER).id}`).setAttrs({...e}),this._updateBackground({...e}),e.width&&(this.width=e.width),e.height&&(this.height=e.height)},this.scrollBy=({x:e,y:t})=>null,this.getFitScale=e=>{const t=this._renderSDK.model.pages.find((e=>e.id===this._renderSDK.getActivePageId()));if(!t)return;const i=this._renderSDK.accessors.page.getRulerFeature().getVisible()?r.d0:0,s=r.cM+i,{ratioWidth:n,ratioHeight:o}=(()=>{let{width:i,height:r}=(0,_.Ln)(t.dimension);const s=e&&this._renderSDK.findByID(e);if(s){const e=s.getClientRect(),t=this._renderSDK.accessors.page.getZoom();i=e.width/t.x,r=e.height/t.y}return{ratioWidth:i,ratioHeight:r}})(),a=n/o,l=this._renderSDK.stage.rect,h=l.width,c=l.height-s;let d=0,u=0,g=0,p=0;h/c>=a&&(u=c-2*r.O4,d=u*a,p=r.O4+s,g=(h-d)/2),h/c<a&&(d=h-2*r.O4,u=d/a,g=r.O4,p=(c-u)/2+s);let f=d/n;return f=f<r.Qf.MIN?r.Qf.MIN:f,f=f>r.Qf.MAX?r.Qf.MAX:f,{scale:f,viewPortWidth:h,viewPortHeight:c,ratioWidth:n,ratioHeight:o,constantGap:s}},this.preventDefaultEvent=()=>{var e;null===(e=this.dom)||void 0===e||e.addEventListener("contextmenu",(e=>{e.preventDefault()}))},this.setScrollByOffset=(e,t)=>{this._pageMoveByOffset(e,t)},this._updateBackground=e=>null,this._onViewportSizeChange=e=>{for(const t of e){const{contentRect:e}=t,{width:i,height:s}=e;this.resize({width:i,height:s}),this.fitState&&(this._renderSDK.stage.updated(),this._renderSDK.stage.fitToWindow()),c.Z.stage.viewportSizeChange.fire(),c.Z.interact.onPageLayoutChange.fire(r.$l.Resize)}},this._getViewPortReact=()=>{const{clientHeight:e,clientWidth:t}=this.getScrollPosition();return{width:t-r.O4,height:e-r.O4}},this._pageMoveByOffset=(e,t)=>{if(!e&&!t)return;const{width:i,height:s}=this._getViewPortReact(),n=this.getPageContainer(),o=this._renderSDK.getActivePage(),a=o.getAbsolutePosition(),l=n.scaleX(),h=u()(a.x,2),c=u()(a.y,2),d=u()(o.width()*l+a.x,2),g=u()(o.height()*l+a.y,2);let _=e,p=t;h+e>i&&(_=i-h),c+t>s&&(p=s-c),d+e<r.O4&&(_=r.O4-d),g+t<r.O4+r.cM&&(p=r.O4+r.cM-g),this.setPositionByOffset({offsetX:_,offsetY:p})},this._renderSDK=e,this._elemId=t.container,!this.dom)throw new Error("Invalid Stage Container Element");const{width:i,height:d}=this.rect;this.width=i,this.height=d,this.container=new n.Hf({width:i,height:d,type:r.Wq.KONVA_STAGE,...t}),this.container.content.className="render-root",this._mouseOperator=new o.Z(this.container),this.layer=s.Z.layer(this.container,{id:l.fy}),s.Z.rect(this.layer,{...(0,a.Qb)(l.$U,r.Wq.KONVA_LAYER),x:0,y:0,width:i,height:d}),this.pageContainer=s.Z.container(null,{type:r.Wq.PAGE_CONTAINER,x:0,y:0,width:i,height:d}),this.layer.add(this.pageContainer),this._resizeObserver=new h.Z(this._onViewportSizeChange),this.register()}get dom(){const{document:e}=g.Z.getGlobalVars();return e.querySelector(`#${this._elemId}`)}get rect(){if(!this.dom)throw new Error;return this.dom.getBoundingClientRect()}get renderRoot(){return this.container.content}get theme(){return this._themeMode}get fitState(){return this._fitState}updated(){const e=this._renderSDK.getActivePageId(),t=this._renderSDK.model.getPageById(e);if(!t)return;const{width:i,height:r}=(0,_.Ln)(t.dimension);this.pageContainer.size({width:i,height:r})}setTheme(e){this._themeMode=e}setFitState(e){this._fitState=e}destroyDirtyWidgets(e){const t=this._getNewestRoot();if(!t)return;const i=this._renderSDK.getMainRenderer().getActivePageWidget();i?p(i,e):t.destroy()}setPositionByOffset(e){const{offsetX:t,offsetY:i}=e,s=this.pageContainer.getAbsolutePosition();this.pageContainer.position({x:s.x+t,y:s.y+i}),(t||i)&&c.Z.interact.onPageLayoutChange.fire(r.$l.Move)}setPositionByPoint({x:e,y:t}){const i=this.pageContainer.getAbsolutePosition();i.x===e&&i.y===t||c.Z.interact.onPageLayoutChange.fire(r.$l.Move),this.pageContainer.position({x:e,y:t})}getScrollPosition(){const e=this._renderSDK.getActivePage(),t={scrollTop:0,scrollLeft:0,scrollWidth:0,scrollHeight:0,clientWidth:0,clientHeight:0};if(!e)return t;const{x:i,y:s}=e.getAbsolutePosition(),{width:n,height:o}=this.rect,a=this.getPageContainer(),l=e.height()*a.scaleX(),h=e.width()*a.scaleX(),c=o-r.O4,d=n-r.O4;return t.scrollTop=u()(c-s,2),t.scrollLeft=u()(d-i,2),t.scrollWidth=u()(2*(n-(n-h)/2-r.O4)+n,2),t.scrollHeight=u()(2*(o-(o-l)/2-r.O4)+o,2),t.clientWidth=u()(n,2),t.clientHeight=u()(o,2),t}fitToWindow(e){const t=this.getFitScale(e);if(!t)return;const{scale:i,viewPortWidth:s,viewPortHeight:n,ratioWidth:o,ratioHeight:a,constantGap:l}=t,{pageContainer:h}=this._renderSDK.stage,d=h.scaleX(),u=h.position(),g={x:(s-o*i)/2,y:(n-a*i)/2+l},_=(()=>{const t=e&&this._renderSDK.findByID(e);if(t){const e=t.getClientRect({relativeTo:h});return{x:g.x-e.x*i,y:g.y-e.y*i}}return g})();h.scale({x:i,y:i}),h.position(_),c.Z.interact.onPageZoomChange.fire({scale:i,oldScale:d}),i===d&&u.x===_.x&&u.y===_.y||c.Z.interact.onPageLayoutChange.fire(r.$l.Fit),this.setFitState(!0)}getZoom(){return this._renderSDK.getMainRenderer().getZoom()}setZoom({scale:e=100,isFit:t=!1,layerId:i}){if(t)return void this.fitToWindow(i);const s=this._renderSDK.getActivePage();if(!s)return;const{stage:n}=this._renderSDK,o=n.getPageContainer(),a=o.scaleX(),l=e/100,h=(()=>{const e=o.scaleX(),t=s.getAbsolutePosition(),i=t.x,r=t.y;return{x:(t.x+s.width()*e-i)/2+i,y:(t.y+s.height()*e-r)/2+r}})(),d={x:(h.x-o.x())/a,y:(h.y-o.y())/a};this.setZoomByPointer(h,d,l),c.Z.interact.onPageZoomChange.fire({scale:l,oldScale:a}),l!==a&&c.Z.interact.onPageLayoutChange.fire(r.$l.Zoom)}setZoomByPointer(e,t,i){const r=this._renderSDK.stage.getPageContainer(),s=r.getAbsolutePosition(),n=e.x-t.x*i,o=e.y-t.y*i;r.scale({x:i,y:i}),this.setScrollByOffset(n-s.x,o-s.y)}setCenter(){if(!this._renderSDK.getActivePage())return;const e=this._renderSDK.stage.rect,t=this._renderSDK.stage.getPageContainer(),i=t.scaleX(),s={x:(e.width-t.width()*i)/2,y:(e.height-t.height()*i)/2+r.cM/2};this._renderSDK.stage.setPositionByPoint(s)}_getNewestRoot(){return this._renderSDK.getMainRenderer().getRenderCore().getRootWidget()}}},94074:(e,t,i)=>{i.d(t,{I:()=>h,Y:()=>c});var r=i(37237);const s=(0,r.Z)(),n={chrome:"80.0.0",firefox:"115.0.0",safari:"16.2.0"};const o=e=>{const{userAgent:t,platform:i,maxTouchPoints:r}=e;return void 0!==t&&"MacIntel"===i&&"number"==typeof r&&r>1},a=()=>{var e;const t=(null===(e=navigator)||void 0===e?void 0:e.userAgent)||"",i=(0,r.Z)(t);let{mobile:s}=i;const{os:n=""}=i,a=t.toLowerCase(),l=/crios/.test(a);let h="other";return/android/.test(a)&&(h="android",s=!0),(/ios/.test(n)||/ipad|iphone|ipod|mac os x/i.test(a))&&(h="apple"),{isMobile:Boolean(s)||o(navigator)||l,mobileType:h}};let l;function h(){if(void 0!==l)return l;try{const e=new OffscreenCanvas(1,1);l=Boolean(window.WebGL2RenderingContext)&&Boolean(e.getContext("webgl2"))}catch(e){l=!1}return l}function c(){const e=function(){var e;const t=null===(e=s.version)||void 0===e?void 0:e.split(".")[0];return t?parseInt(t):0}(),t=[],{isMobile:i}=a();return(null==s?void 0:s.name)&&Object.keys(n).includes(s.name)||t.push("BrowserType"),function(){const e=n[s.name];return!!e&&Number((null==s?void 0:s.version).split(".").join(""))>=Number(e.split(".").join(""))}()||t.push("BrowserVersion"),function(){let e=!1;return e=void 0!==window.WebAssembly,e}()||t.push("WebAssembly"),Boolean(window.OffscreenCanvas)&&Boolean(window.WebGL2RenderingContext)||t.push("OffscreenCanvas"),function(){try{const e=document.createElement("canvas");return Boolean(e.getContext("webgl2"))}catch(e){return!1}}()||t.push("WebGL2"),"undefined"!=typeof SharedArrayBuffer||t.push("SharedArrayBuffer"),i&&t.push("Mobile"),{unSupported:t,browserVersion:e}}},66265:(e,t,i)=>{function r(e){let t="";const i=new Uint8Array(e),r=i.byteLength;for(let s=0;s<r;s++)t+=String.fromCharCode(i[s]);return window.btoa(t)}i.d(t,{m:()=>r})},15862:(e,t,i)=>{function r(e,t){const i=window.atob(e),r=new Array(i.length);for(let n=0;n<i.length;n++)r[n]=i.charCodeAt(n);const s=new Uint8Array(r);return new Blob([s],{type:t})}i.d(t,{u:()=>r})},26069:(e,t,i)=>{function r(e){const t=window.atob(e),i=t.length,r=new Uint8Array(i);for(let s=0;s<i;s++)r[s]=t.charCodeAt(s);return(new TextDecoder).decode(r)}i.d(t,{g:()=>r})},36461:(e,t,i)=>{async function r(e){return await fetch(e).then((e=>e.blob()))}i.d(t,{n:()=>r})},33004:(e,t,i)=>{i.d(t,{n:()=>s});class r{constructor(e,t,i,r){this._node=e,this._type=t,this._handler=i,this._options=null!=r&&r,this._node.addEventListener(this._type,this._handler,this._options)}dispose(){this._handler&&(this._node.removeEventListener(this._type,this._handler,this._options),this._node=null,this._handler=null)}}function s(e,t,i,s){return new r(e,t,i,s)}},2983:(e,t,i)=>{i.d(t,{G:()=>o});var r=i(42058),s=i(85441),n=i(18571);const o=e=>{const t=(0,n.useContext)(s._y);(0,r.ZB)(t,"react components need service context.");return t.invokeFunction((t=>t.get(e)))}},85441:(e,t,i)=>{i.d(t,{$U:()=>o,_y:()=>n});var r=i(18571),s=i(72322);const n=r.createContext(null),o=e=>(0,s.jsx)(n.Provider,{value:e.instantiationService,children:e.children})},26007:(e,t,i)=>{function r(e,t){let i=0;for(;i<e.length&&t(e[i]);)i++;return e.slice(i)}function s(e,t){const{length:i}=e;return e[i-1][t]}i.d(t,{$g:()=>s,R5:()=>r})},42058:(e,t,i)=>{function r(e){throw new Error(`lvAssert(${e})`)}function s(e,t){e||r(null!=t?t:"#expr is false")}function n(e){r(null!=e?e:"unreachable code flow")}function o(e,t="Illegal value:"){r(`${t}: ${e}`)}function a(e,t){null==e&&r(null!=t?t:"#val is nil")}i.d(t,{Y2:()=>s,ZB:()=>a,bP:()=>o,ss:()=>n})},93361:(e,t,i)=>{i.d(t,{A:()=>h});const r=Object.freeze({dispose(){}});var s,n=i(77685);const o=Object.freeze((function(e,t){const i=setTimeout(e.bind(t),0);return{dispose(){clearTimeout(i)}}}));class a{constructor(){this._isCancelled=!1,this._emitter=null}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?o:(this._emitter||(this._emitter=new n.Q),this._emitter.event)}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(),this.dispose()))}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=null)}}class l{}(s=l).None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:()=>r}),s.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:o});class h{constructor(e){this._token=void 0,this._parentListener=void 0,this._parentListener=null==e?void 0:e.onCancellationRequested(this.cancel,this)}get token(){return this._token||(this._token=new a),this._token}cancel(){this._token?this._token instanceof a&&this._token.cancel():this._token=l.Cancelled}dispose(e=!1){var t;e&&this.cancel(),null===(t=this._parentListener)||void 0===t||t.dispose(),this._token?this._token instanceof a&&this._token.dispose():this._token=l.None}}},98720:(e,t,i)=>{i.d(t,{PQ:()=>c,Hp:()=>h});var r,s=i(19003);!function(e){e[e.Ok=0]="Ok",e[e.Cancelled=1]="Cancelled",e[e.TimedOut=2]="TimedOut",e[e.PermissionDenied=3]="PermissionDenied",e[e.AlreadyExists=4]="AlreadyExists",e[e.NotSupported=5]="NotSupported",e[e.ResourceUnavailable=6]="ResourceUnavailable",e[e.OutOfRange=7]="OutOfRange",e[e.InvalidArgument=8]="InvalidArgument",e[e.NetworkFailed=9]="NetworkFailed",e[e.Interrupted=10]="Interrupted"}(r||(r={}));const n=(0,s.i)(r.Cancelled,"operation(s) cancelled."),o=(0,s.i)(r.TimedOut,"operation(s) timed out.");(0,s.i)(r.PermissionDenied,"permission denied."),(0,s.i)(r.AlreadyExists,"already exists."),(0,s.i)(r.NotSupported,"operation(s) not supported."),(0,s.i)(r.ResourceUnavailable,"resource is unavailable."),(0,s.i)(r.OutOfRange,"out of range."),(0,s.i)(r.InvalidArgument,"invalid arguments."),(0,s.i)(r.NetworkFailed,"network failed."),(0,s.i)(r.Interrupted,"interrupted.");var a=i(13659),l=i(93361);function h(e,t,i){const s=function(e){const t=new l.A,i=e(t.token),r=new Promise(((e,r)=>{const s=t.token.onCancellationRequested((()=>{s.dispose(),t.dispose(),e(n())}));Promise.resolve(i).then((i=>{s.dispose(),t.dispose(),e((0,a.oW)(i))}),(e=>{s.dispose(),t.dispose(),r(e)}))}));return new class{cancel(){t.cancel()}then(e,t){return r.then(e,t)}catch(e){return this.then(void 0,e)}finally(e){return r.finally(e)}}}(e),h=setTimeout((()=>{s.cancel()}),t);return s.then((e=>(clearTimeout(h),e.ok?e:e.code===r.Cancelled?void 0!==i?(0,a.oW)(i):o():e)))}function c(){let e,t;const i=new Promise(((i,r)=>{e=i,t=r}));return{resolve:e,reject:t,promise:i}}},18781:(e,t,i)=>{function r(e){return new Promise((t=>setTimeout(t,e)))}i.d(t,{D:()=>r})},10323:(e,t,i)=>{i.d(t,{z:()=>r});class r{constructor(e){this._capacity=e,this._cache=new Map}get(e){const t=this._cache.get(e);return t&&(this._cache.delete(e),this._cache.set(e,t)),t}put(e,t){if(this._cache.has(e))this._cache.delete(e);else if(this._cache.size>=this._capacity){const e=this._cache.keys().next().value;this._cache.delete(e)}this._cache.set(e,t)}remove(e){this._cache.get(e)&&this._cache.delete(e)}size(){return this._cache.size}clear(){this._cache.clear()}}},86059:(e,t,i)=>{var r;i.d(t,{_y:()=>s,fC:()=>n,zO:()=>r}),function(e){e[e.Entry=0]="Entry",e[e.Event=1]="Event",e[e.UserInput=2]="UserInput",e[e.Task=3]="Task"}(r||(r={}));class s{constructor(e=r.Task){this.type=e,this._store=new Map}background(){return new s(this.type)}setValue(e,t){this._store.set(e,t)}getValue(e){return this._store.get(e)}}function n(){return new s}},67126:(e,t,i)=>{i.d(t,{LO:()=>l,Lq:()=>o,yh:()=>a});const r=new Map,s="$di$target",n="$di$dependencies";function o(e){return e[n]||[]}function a(e){if(r.has(e))return r.get(e);const t=function(e,i,r){if(3!==arguments.length)throw new Error("@IServiceName-decorator can only be used to decorate a parameter");!function(e,t,i){t[s]===t?t[n].push({id:e,index:i}):(t[n]=[{id:e,index:i}],t[s]=t)}(t,e,r)};return t.toString=()=>e,r.set(e,t),t}function l(e){return e}},2897:(e,t,i)=>{i.d(t,{M:()=>r});class r{constructor(e,t=[],i=!0){this.ctor=e,this.staticArguments=t,this.supportsDelayedInstantiation=i}}},82552:(e,t,i)=>{i.d(t,{T:()=>r});const r=(0,i(67126).yh)("instantiation")},46251:(e,t,i)=>{i.d(t,{F:()=>_});class r{constructor(e,t){this._didRun=!1,this._executor=()=>{try{this._value=e()}catch(t){this._error=t}finally{this._didRun=!0}},this._handle=t((()=>this._executor()))}get value(){if(this._didRun||(this._handle.dispose(),this._executor()),this._error)throw this._error;return this._value}get isInitialized(){return this._didRun}dispose(){this._handle.dispose()}}var s=i(2897);class n{constructor(e,t){this.key=e,this.data=t,this.incoming=new Map,this.outgoing=new Map}}class o{constructor(e){this._hashFn=e,this._nodes=new Map}leafs(){const e=[];for(const t of this._nodes.values())0===t.outgoing.size&&e.push(t);return e}insertEdge(e,t){const i=this.lookupOrInsertNode(e),r=this.lookupOrInsertNode(t);i.outgoing.set(r.key,r),r.incoming.set(i.key,i)}removeNode(e){const t=this._hashFn(e);this._nodes.delete(t);for(const i of this._nodes.values())i.outgoing.delete(t),i.incoming.delete(t)}lookup(e){return this._nodes.get(this._hashFn(e))}lookupOrInsertNode(e){const t=this._hashFn(e);let i=this._nodes.get(t);return i||(i=new n(t,e),this._nodes.set(t,i)),i}isEmpty(){return 0===this._nodes.size}toString(){const e=[];for(const[t,i]of this._nodes)e.push(`${t}\n\t(-> incoming)[${[...i.incoming.keys()].join(", ")}]\n\t(outgoing ->)[${[...i.outgoing.keys()].join(",")}]\n`);return e.join("\n")}findCycleSlow(){for(const[e,t]of this._nodes){const i=new Set([e]),r=this._findCycle(t,i);if(r)return r}}_findCycle(e,t){for(const[i,r]of e.outgoing){if(t.has(i))return[...t,i].join(" -> ");t.add(i);const e=this._findCycle(r,t);if(e)return e;t.delete(i)}}}var a=i(84434);var l,h,c=i(67126),d=i(82552);!function(e){e[e.None=0]="None",e[e.Creation=1]="Creation",e[e.Invocation=2]="Invocation",e[e.Branch=3]="Branch"}(h||(h={}));class u{static traceInvocation(e,t){return e?new u(h.Invocation,t.name||(new Error).stack.split("\n").slice(3,4).join("\n")):u._None}static traceCreation(e,t){return e?new u(h.Creation,t.name):u._None}constructor(e,t){this._start=Date.now(),this._dep=[],this._type=e,this._name=t}branch(e,t){const i=new u(h.Branch,e.toString());return this._dep.push([e,t,i]),i}stop(){const e=Date.now()-this._start;u._totals+=e;let t=!1;const i=[`${this._type===h.Creation?"CREATE":"CALL"} ${this._name}`,`${function e(i,r){const s=[],n=new Array(i+1).join("\t");for(const[o,a,l]of r._dep)if(a&&l){t=!0,s.push(`${n}CREATES -> ${o}`);const r=e(i+1,l);r&&s.push(r)}else s.push(`${n}uses -> ${o}`);return s.join("\n")}(1,this)}`,`DONE, took ${e.toFixed(2)}ms (grand total ${u._totals.toFixed(2)}ms)`];(e>2||t)&&u.all.add(i.join("\n"))}}(l=u).all=new Set,l._None=new class extends l{constructor(){super(h.None,null)}stop(){}branch(){return this}},l._totals=0;class g extends Error{constructor(e){var t;super("cyclic dependency between services"),this.message=null!==(t=e.findCycleSlow())&&void 0!==t?t:`UNABLE to detect cycle, dumping graph: \n${e.toString()}`}}class _{constructor(e=new a.y,t,i=false){var r;(this._activeInstantiations=new Set,this._services=e,this._parent=t,this._enableTracing=i,this._services.set(d.T,this),i)&&(this._globalGraph=null!==(r=null==t?void 0:t._globalGraph)&&void 0!==r?r:new o((e=>e)))}get services(){return this._services}createChild(e){return new _(e,this,this._enableTracing)}invokeFunction(e,...t){const i=u.traceInvocation(this._enableTracing,e);let r=!1;try{return e({get:e=>{if(r)throw new Error("service accessor is only valid during the invocation of its target method");const t=this._getOrCreateServiceInstance(e,i);if(!t)throw new Error(`[invokeFunction] unknown service '${e}'`);return t}},...t)}finally{r=!0,i.stop()}}createInstance(e,...t){let i,r;return e instanceof s.M?(i=u.traceCreation(this._enableTracing,e.ctor),r=this._createInstance(e.ctor,e.staticArguments.concat(t),i)):(i=u.traceCreation(this._enableTracing,e),r=this._createInstance(e,t,i)),i.stop(),r}_createInstance(e,t=[],i){const r=(0,c.Lq)(e).sort(((e,t)=>e.index-t.index)),s=[];for(const o of r){const t=this._getOrCreateServiceInstance(o.id,i);if(!t)throw new Error(`[createInstance] ${e.name} depends on UNKNOWN service ${o.id}.`);s.push(t)}const n=r.length>0?r[0].index:t.length;if(t.length!==n){console.trace(`[createInstance] First service dependency of ${e.name} at position ${n+1} conflicts with ${t.length} static arguments`);const i=n-t.length;t=i>0?t.concat(new Array(i)):t.slice(0,n)}return Reflect.construct(e,t.concat(s))}_setServiceInstance(e,t){if(this._services.get(e)instanceof s.M)this._services.set(e,t);else{if(!this._parent)throw new Error("illegalState - setting UNKNOWN service instance");this._parent._setServiceInstance(e,t)}}_getServiceInstanceOrDescriptor(e){const t=this._services.get(e);return!t&&this._parent?this._parent._getServiceInstanceOrDescriptor(e):t}_getOrCreateServiceInstance(e,t){this._globalGraph&&this._globalGraphImplicitDependency&&this._globalGraph.insertEdge(this._globalGraphImplicitDependency,String(e));const i=this._getServiceInstanceOrDescriptor(e);return i instanceof s.M?this._safeCreateAndCacheServiceInstance(e,i,t.branch(e,!0)):(t.branch(e,!1),i)}_safeCreateAndCacheServiceInstance(e,t,i){if(this._activeInstantiations.has(e))throw new Error(`illegal state - RECURSIVELY instantiating service '${e}'`);this._activeInstantiations.add(e);try{return this._createAndCacheServiceInstance(e,t,i)}finally{this._activeInstantiations.delete(e)}}_createAndCacheServiceInstance(e,t,i){const r=new o((e=>e.id.toString()));let n=0;const a=[{id:e,desc:t,_trace:i}];for(;a.length;){const t=a.pop();if(r.lookupOrInsertNode(t),n++>1e3)throw new g(r);for(const i of(0,c.Lq)(t.desc.ctor)){var l;const n=this._getServiceInstanceOrDescriptor(i.id);if(!n)throw new Error(`[createInstance] ${e} depends on ${i.id} which is NOT registered.`);if(null===(l=this._globalGraph)||void 0===l||l.insertEdge(String(t.id),String(i.id)),n instanceof s.M){const e={id:i.id,desc:n,_trace:t._trace.branch(i.id,!0)};r.insertEdge(t,e),a.push(e)}}}for(;;){const e=r.leafs();if(0===e.length){if(!r.isEmpty())throw new g(r);break}for(const{data:t}of e){if(this._getServiceInstanceOrDescriptor(t.id)instanceof s.M){const e=this._createServiceInstanceWithOwner(t.id,t.desc.ctor,t.desc.staticArguments,t.desc.supportsDelayedInstantiation,t._trace);this._setServiceInstance(t.id,e)}r.removeNode(t)}}return this._getServiceInstanceOrDescriptor(e)}_createServiceInstanceWithOwner(e,t,i=[],r,n){if(this._services.get(e)instanceof s.M)return this._createServiceInstance(e,t,i,r,n);if(this._parent)return this._parent._createServiceInstanceWithOwner(e,t,i,r,n);throw new Error(`illegalState - creating UNKNOWN service instance ${t.name}`)}_createServiceInstance(e,t,i=[],s,n){if(!s)return this._createInstance(t,i,n);const o=new _(void 0,this,this._enableTracing);o._globalGraphImplicitDependency=String(e);const a=new r((()=>o._createInstance(t,i,n)),(e=>(e(),{dispose:()=>{}})));return l=a,new Proxy(Object.create(null),{get(e,t){if(t in e)return e[t];const i=l.value;let r=i[t];return"function"!=typeof r||(r=r.bind(i),e[t]=r),r},set:(e,t,i)=>(l.value[t]=i,!0)});var l}}},84434:(e,t,i)=>{i.d(t,{T:()=>o,y:()=>n});var r=i(2897),s=i(21698);class n{constructor(...e){this._entries=new Map;for(const[t,i]of e)this.set(t,i)}get entries(){return this._entries}set(e,t){t instanceof r.M?this._entries.set(e,t):this._entries.set(e,(0,s.bu)(e.toString(),t))}has(e){return this._entries.has(e)}get(e){return this._entries.get(e)}}function o(e){const t=new n;for(const[i,r]of e.registry)t.set(i,r);return t}},12206:(e,t,i)=>{i.d(t,{o:()=>n});var r,s=i(2897);!function(e){e[e.Eager=0]="Eager",e[e.Delayed=1]="Delayed"}(r||(r={}));class n{constructor(){this._registry=[]}get registry(){return this._registry}register(e,t,i){t instanceof s.M||(t=new s.M(t,[],Boolean(i))),this._registry.push([e,t])}registerInstance(e,t){this._registry.push([e,t])}}},35545:(e,t,i)=>{i.d(t,{JT:()=>c,dt:()=>d});let r=null;function s(e,t){var i;null===(i=r)||void 0===i||i.branch(e,t)}let n=null;function o(e){var t;return null===(t=n)||void 0===t||t.trackDisposable(e),e}function a(e){var t;null===(t=n)||void 0===t||t.markAsDisposed(e)}function l(e,t){var i;null===(i=n)||void 0===i||i.setParent(e,t)}class h{constructor(){this._toDispose=new Set,this._isDisposed=!1,o(this)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed?console.warn(new Error("DisposableStore has disposed.").stack):(a(this),this._isDisposed=!0,this.clear())}clear(){if(0!==this._toDispose.size){for(const e of this._toDispose)s(this.constructor.name,e.constructor.name);try{for(const e of this._toDispose)e.dispose()}finally{this._toDispose.clear()}}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself.");return l(e,this),this._isDisposed?h.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}}h.DISABLE_DISPOSED_WARNING=!1;class c{constructor(){this._store=new h,o(this),l(this._store,this)}dispose(){a(this),s(this.constructor.name,this._store.constructor.name),this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}}class d{constructor(e){this._value=null,this._value=e,o(this)}isEmpty(){return null===this._value}dispose(){this._value&&(this._value.dispose(),this._value=null,a(this))}}},19003:(e,t,i)=>{i.d(t,{i:()=>s});var r=i(13659);function s(e,t){return i=>i?"string"==typeof i?(0,r.wf)(e,i):(0,r.Mx)(e,i.message,i):(0,r.wf)(e,t)}},13659:(e,t,i)=>{i.d(t,{Mx:()=>h,ly:()=>s,oW:()=>n,oi:()=>c,wf:()=>o});const r=Symbol("lvErrorRef");function s(){return{ok:!0,value:null,pair:()=>[null,null],code:0,msg:"",[r]:!0}}function n(e){return{ok:!0,value:e,pair:()=>[null,e],code:0,msg:"",[r]:!0}}function o(e,t){return a(e,t)}function a(e,t,i){const s={ok:!1,code:e,msg:t,cause:i,toString:()=>`[${e}]${t}.${i?l(i):""}`,pair:()=>[s,null],[r]:!0};return s}function l(e){return void 0===e?"":e instanceof Error?`\ncaused by [jsError]${e.name}-${e.message}`:`\ncaused by [${e.code}]${e.msg}${e.ok?"":l(e.cause)}`}function h(e,t,i){return a(e,t,i)}function c(e){return"object"==typeof e&&null!==e&&r in e}},77685:(e,t,i)=>{i.d(t,{Q:()=>d});class r{constructor(e){this.value=e,this.next=null,this.prev=null}}class s{constructor(){this._first=null,this._last=null,this._size=0}get size(){return this._size}isEmpty(){return null===this._first}clear(){let e=this._first;for(;null!==e;){const{next:t}=e;e.prev=null,e.next=null,e=t}this._first=null,this._last=null,this._size=0}unshift(e){const t=new r(e);if(null===this._first)this._first=t,this._last=t;else{const e=this._first;this._first=t,t.next=e,e.prev=t}return this._size++,this}push(e){const t=new r(e);if(null===this._last)this._first=t,this._last=t;else{const e=this._last;this._last=t,t.prev=e,e.next=t}return this._size++,this}shift(){if(null===this._first)return null;{const e=this._first.value;return this._remove(this._first),e}}pop(){if(null===this._last)return null;{const e=this._last.value;return this._remove(this._last),e}}toArray(){const e=[];for(const t of this)e.push(t);return e}*[Symbol.iterator](){let e=this._first;for(;null!==e;)yield e.value,e=e.next}_remove(e){if(null!==e.prev&&null!==e.next){const t=e.prev;t.next=e.next,e.next.prev=t}else null===e.prev&&null===e.next?(this._first=null,this._last=null):null===e.next?(this._last=this._last.prev,this._last.next=null):null===e.prev&&(this._first=this._first.next,this._first.prev=null);this._size-=1}}class n extends s{unshiftAndGetDisposableNode(e){this.unshift(e);const t=this._first;let i=!1;return()=>{i||(i=!0,super._remove(t))}}pushAndGetDisposableNode(e){this.push(e);const t=this._last;let i=!1;return()=>{i||(i=!0,super._remove(t))}}}var o=i(35545);function a(e){setTimeout((()=>{throw e}),0)}class l{constructor(e,t){this._callback=e,this._callbackThis=t}invoke(...e){this._callback.call(this._callbackThis,...e)}}class h{constructor(e,t,i){this.emitter=e,this.listener=t,this.event=i}}class c{constructor(e=a){this._onListenerError=e,this._queue=new n}get size(){return this._queue.size}push(e,t,i){this._queue.push(new h(e,t,i))}clear(e){const t=new n;for(const i of this._queue)i.emitter!==e&&t.push(i);this._queue=t}deliver(){for(;this._queue.size>0;){const t=this._queue.shift();try{t.listener.invoke(...t.event)}catch(e){this._onListenerError(e)}}}}class d{constructor(e){this._disposed=!1,this._options=e}get event(){return this._event||(this._event=(e,t)=>{var i;this._listeners||(this._listeners=new n);const r=new l(e,t),s=this._listeners.pushAndGetDisposableNode(r);null!==(i=this._options)&&void 0!==i&&i.onAddListener&&this._options.onAddListener(this,e,t);return a=()=>{var i;this._disposed||(s(),null!==(i=this._options)&&void 0!==i&&i.onRemoveListener&&this._options.onRemoveListener(this,e,t))},new o.dt({dispose:a});var a}),this._event}dispose(){var e,t;this._disposed||(this._disposed=!0,null===(e=this._listeners)||void 0===e||e.clear(),null===(t=this._deliveryQueue)||void 0===t||t.clear(this))}fire(...e){var t,i;if(this._listeners){null!==(t=this._deliveryQueue)&&void 0!==t||(this._deliveryQueue=new c(null===(i=this._options)||void 0===i?void 0:i.onListenerError));for(const t of this._listeners)this._deliveryQueue.push(this,t,e);this._deliveryQueue.deliver()}}}},40673:(e,t,i)=>{function r(e){return(t,i=null)=>{let r,s=!1;return r=e(((...e)=>{if(!s)return r?r.dispose():s=!0,t.call(i,...e)}),null),s&&r.dispose(),r}}i.d(t,{V:()=>r})},48018:(e,t,i)=>{i.d(t,{G:()=>r});class r{constructor(){this._hasBeenDone=!1,this._isIniting=!1,this._initCostTimes=void 0,this._waitingResolvers=new Set,this._waitingResolverMap=new Map}get hasBeenDone(){return this._hasBeenDone}get costTimes(){if(!this._initCostTimes)return;const{start:e,end:t}=this._initCostTimes;return(null!=t?t:Date.now())-e}get initResult(){if(this._hasBeenDone)return{resolve:this._resolveResult,reject:this._rejectResult}}get isIniting(){return this._isIniting}awaitForInit({key:e,timeout:t}={}){if(this._hasBeenDone&&this.initResult){const{resolve:e,reject:t}=this.initResult;return t?Promise.reject(t):Promise.resolve(e)}if(e&&this._waitingResolverMap.has("key"))return this._waitingResolverMap.get("key");if(!t){const t=new Promise(((e,t)=>{this._waitingResolvers.add([e,t])}));return e&&this._waitingResolverMap.set(e,t),t}let i,r;const s=Promise.race([new Promise(((e,t)=>{i=[()=>{clearTimeout(r),e()},t],this._waitingResolvers.add([i,t])})),new Promise(((e,s)=>{r=setTimeout((()=>{this._waitingResolvers.delete(i),s(new Error("Timed out waiting for init"))}),t)}))]);return e&&this._waitingResolverMap.set(e,s),s}startToInit(){return!this._hasBeenDone&&(!this._isIniting&&(this._isIniting=!0,this._initCostTimes={start:Date.now()},!0))}initDone(e){if(this._hasBeenDone)throw new Error("Cannot release an inited locker");this._initCostTimes&&(this._initCostTimes.end=Date.now());let t=!1;null!=e&&e.reject?(t=!0,this._rejectResult=e.reject):this._resolveResult=null==e?void 0:e.resolve;for(const i of this._waitingResolvers)t?i[1](this._rejectResult):i[0](this._resolveResult);this._waitingResolverMap.clear(),this._waitingResolvers.clear(),this._hasBeenDone=!0,this._isIniting=!1}}},29788:(e,t,i)=>{i.d(t,{L:()=>c});var r,s=i(42058),n=i(40673),o=i(77685);!function(e){e[e.Unlocked=0]="Unlocked",e[e.Locked=1]="Locked"}(r||(r={}));class a{constructor(){this._onUnlocked=new o.Q,this._status=r.Unlocked,this.onUnlocked=this._onUnlocked.event}get status(){return this._status}acquire(){(0,s.Y2)(this._status===r.Unlocked),this._status=r.Locked}release(){(0,s.Y2)(this._status===r.Locked),this._status=r.Unlocked,this._onUnlocked.fire()}}class l{constructor(){this._onUnlocked=new o.Q,this._status=r.Unlocked,this._counter=0,this.onUnlocked=this._onUnlocked.event}get status(){return this._status}get counter(){return this._counter}acquire(){this._status===r.Unlocked&&(this._status=r.Locked),this._counter++}release(){(0,s.Y2)(this._counter>0),this._counter--,0===this._counter&&(this._status=r.Unlocked,this._onUnlocked.fire())}}class h{constructor(){this._onActive=new o.Q,this.onActive=this._onActive.event}notify(){this._onActive.fire()}}class c{constructor(){this._waitingWriters=[]}isLocked(){return this._writer||0!==this._readerCount}lock(){return new Promise((e=>{if(this._writer){const t=new h;this._waitingWriters.push(t),t.onActive((()=>{this._writerEnterGate1(e)}))}else this._writerEnterGate1(e)}))}tryLock(){return!(this._writer||this._readerCount>0)&&(this.lock(),!0)}unLock(){(0,s.ZB)(this._writer),this._writer.release()}lockShared(){return new Promise((e=>{this._writer?(this._waitingReader||(this._waitingReader=new h),this._waitingReader.onActive((()=>{this._readerEnterGate1(e)}))):this._readerEnterGate1(e)}))}tryLockShared(){return!this._writer&&(this.lockShared(),!0)}unLockShared(){(0,s.ZB)(this._reader),this._writer&&(0,s.Y2)(this._writer.status===r.Unlocked),this._reader.release()}get _readerCount(){return this._reader?this._reader.counter:0}_writerEnterGate1(e){(0,s.Y2)(!this._writer),this._writer=new a,this._readerCount>0?(0,n.V)(this._reader.onUnlocked)((()=>{this._writerEnterGate2(e)})):this._writerEnterGate2(e)}_writerEnterGate2(e){(0,s.ZB)(this._writer),(0,s.Y2)(0===this._readerCount),this._writer.acquire(),(0,n.V)(this._writer.onUnlocked)((()=>{(0,s.ZB)(this._writer),this._writer=void 0,this._moveForward()})),e()}_readerEnterGate1(e){(0,s.Y2)(!this._writer),this._reader?this._reader.acquire():(this._reader=new l,this._reader.acquire(),(0,n.V)(this._reader.onUnlocked)((()=>{this._moveForward()}))),e()}_moveForward(){if(!this._writer)if(this._waitingWriters.length>0){this._waitingWriters.shift().notify()}else this._waitingReader&&this._waitingReader.notify()}}},83290:(e,t,i)=>{i.d(t,{T:()=>r});const r="custom-host-name-type"},74504:(e,t,i)=>{i.d(t,{eI:()=>s});var r=i(62347);r.default.defaults.transformRequest;function s(e){return r.default.create(e)}},83055:(e,t,i)=>{i.d(t,{V:()=>n});const r="network-client-retry-plugin";function s(e){const t=(null==e?void 0:e[r])||{};return t.retryCount=t.retryCount||0,t}function n(e,t={}){return e.interceptors.request.use((e=>{const t=s(e);return t.lastRequestTime=Date.now(),e[r]=t,e})),e.interceptors.response.use(void 0,(i=>{const{config:n}=i;if(!n)return Promise.reject(i);const{retries:o=1,isRetry:a=(()=>!0),retryDelay:l=200,resetTimeout:h=!0}={...t,...null==n?void 0:n[r]},c=s(n);if((a(i)||c.canRetry)&&c.retryCount<o){c.retryCount+=1;const t="number"==typeof l?l:l(c.retryCount,i);if(function(e,t){e.defaults.agent===t.agent&&delete t.agent,e.defaults.httpAgent===t.httpAgent&&delete t.httpAgent,e.defaults.httpsAgent===t.httpsAgent&&delete t.httpsAgent}(e,n),!h&&n.timeout&&c.lastRequestTime){const e=Date.now()-c.lastRequestTime;n.timeout=Math.max(n.timeout-e-t,1)}return n.transformRequest=[e=>e],new Promise((i=>setTimeout((()=>i(e(n))),t)))}return Promise.reject(i)})),e}},30185:(e,t,i)=>{function r(e){if(!e||"object"!=typeof e)return e;if(e instanceof RegExp)return e;const t=Array.isArray(e)?[]:{};return Object.entries(e).forEach((([e,i])=>{t[e]=i&&"object"==typeof i?r(i):i})),t}i.d(t,{I:()=>r})},19111:(e,t,i)=>{i.d(t,{v:()=>n});var r=i(42058);function s(e,t,i){if(e===t)return!0;if(null==e||null==t)return!1;if(typeof e!=typeof t)return!1;if("object"!=typeof e)return!1;if((0,r.Y2)(!i.has(e),"arguments object has circular."),i.add(e),Array.isArray(e)!==Array.isArray(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!s(e[r],t[r],i))return!1}else{const r=Object.keys(e);r.sort();const n=Object.keys(t);if(n.sort(),!s(r,n,i))return!1;for(let o=0;o<r.length;o++)if(!s(e[r[o]],t[r[o]],i))return!1}return i.delete(e),!0}function n(e,t){return s(e,t,new Set)}},21698:(e,t,i)=>{i.d(t,{bu:()=>B,lI:()=>N});var r,s,n,o=i(86059);function a(){return Math.floor(Math.random()*Math.pow(2,32)).toString(16).padStart(8,"0")}!function(e){e[e.Discard=0]="Discard",e[e.Database=1]="Database",e[e.Report=2]="Report"}(r||(r={})),function(e){e[e.ChildOf=0]="ChildOf",e[e.FollowsFrom=1]="FollowsFrom"}(s||(s={})),function(e){e[e.Master=0]="Master",e[e.Slave=1]="Slave"}(n||(n={}));class l{constructor(e){this.traceId=e,this._spans=[],this._spanIdKeys=new Set,this._processMap=new Map,this._hasError=!1,this._hasClosed=!1,this._duration=-1,this._consumeType=r.Discard}get spans(){return this._spans}get hasError(){return this._hasError}get hasClosed(){return this._hasClosed}get duration(){return this._duration}get consumeType(){return this._consumeType}get processMap(){return this._processMap}findSpanById(e){return this._spans.find((t=>t.spanId===e))}addSpan(e){this._spanIdKeys.add(e.spanId),this._spans.push(e),this._processMap.set(e.process.name,e.process)}commitSpan(e,t){this._spanIdKeys.has(e.spanId)||this.addSpan(e),e.hasError&&(this._hasError=!0),t>this._consumeType&&(this._consumeType=t)}toJSON(){return{spans:JSON.stringify(this._spans),process:JSON.stringify(this._processMap)}}}class h extends l{constructor(e,t){super(e),this._timeout=t,this.type=n.Master,this._startTime=Date.now()}isTimeout(){return Date.now()-this._startTime>this._timeout}dispose(){this._hasClosed||(this._hasError=!0),this._hasError||this._consumeType===r.Report?p.reportTrace(this):this._consumeType===r.Database&&p.saveTrace(this)}commitSpan(e,t){super.commitSpan(e,t),e.root&&(this._hasClosed=!0,this._duration=e.duration,this.isTimeout()&&(this._hasError=!0))}}class c extends l{constructor(){super(...arguments),this.type=n.Slave}dispose(){this._hasError||this._consumeType===r.Report?p.reportTrace(this):this._consumeType===r.Database&&p.saveTrace(this)}}class d{constructor(e){this._capacity=e,this._cache=new Map}get(e){const t=this._cache.get(e);return t&&(this._cache.delete(e),this._cache.set(e,t)),t}put(e,t){if(this._cache.has(e))this._cache.delete(e);else if(this._cache.size>=this._capacity){const e=this._cache.keys().next().value,t=this._cache.get(e);this._cache.delete(e),t.dispose()}this._cache.set(e,t)}remove(e){const t=this._cache.get(e);t&&(this._cache.delete(e),t.dispose())}size(){return this._cache.size}}var u=i(77685);class g{constructor(e=3e4){this._interval=e,this._onTick=new u.Q,this._tick=()=>{this._onTick.fire(),this._timer=setTimeout(this._tick,this._interval)},this.onTick=this._onTick.event}bootstrap(){this._timer=setTimeout(this._tick,this._interval)}stop(){this._timer&&clearTimeout(this._timer)}}class _{constructor(){this._cache=new d(20),this._masters=new Map,this._timer=new g,this._timer.bootstrap(),this._timer.onTick((()=>{this._checkTimeout()}))}add(e){e.type===n.Master?this._masters.set(e.traceId,e):this._cache.put(e.traceId,e)}get(e){return this._masters.has(e)?this._masters.get(e):this._cache.get(e)}remove(e){if(!this._masters.has(e))return;const t=this._masters.get(e);this._masters.delete(e),t.hasError?t.dispose():this._cache.put(e,t)}_checkTimeout(){const e=[];for(const t of this._masters.values())t.isTimeout()&&e.push(t);for(const t of e)this._masters.delete(t.traceId),t.dispose()}}const p=new class{constructor(){this._store=new _}registerReport(e){this._report=e}registerSaveInDatabase(e){this._saveInDatabase=e}newTrace(e,t){const i=new h(e,t);this._store.add(i)}addSpan(e){this._getOrCreateTrace(e).addSpan(e)}commitSpan(e,t){const i=this._getOrCreateTrace(e);i.commitSpan(e,t),i.hasClosed&&this._store.remove(i.traceId)}reportTrace(e){var t;null===(t=this._report)||void 0===t||t.call(this,e)}saveTrace(e){var t;null===(t=this._saveInDatabase)||void 0===t||t.call(this,e)}_createTrace(e){const t=new c(e);return this._store.add(t),t}_getOrCreateTrace(e){const{traceId:t}=e;let i=this._store.get(t);return i||(i=this._createTrace(t)),i}};var f,m=i(42058);function v(e){const t=new Uint8Array(e);let i="";for(const r of t)i+=String.fromCharCode(r);return btoa(i)}!function(e){e[e.String=0]="String",e[e.Boolean=1]="Boolean",e[e.Int64=2]="Int64",e[e.Double=3]="Double",e[e.Buffer=4]="Buffer"}(f||(f={}));class y{constructor(e){this.key=e,this.valueType=f.String,this.vStr="",this.vBool=!1,this.vInt64=0n,this.vDouble=0}static string(e,t){const i=new y(e);return i.vStr=t,i.valueType=f.String,i}static bool(e,t){const i=new y(e);return i.vBool=t,i.valueType=f.Boolean,i}static int64(e,t){const i=new y(e);return i.vInt64=t,i.valueType=f.Int64,i}static double(e,t){const i=new y(e);return i.vDouble=t,i.valueType=f.Double,i}static buffer(e,t){const i=new y(e);return i.vBuffer=t,i.valueType=f.Buffer,i}toJSON(){switch(this.valueType){case f.String:return{[this.key]:this.vStr};case f.Boolean:return{[this.key]:this.vBool};case f.Double:return{[this.key]:this.vDouble};case f.Int64:return{[this.key]:String(this.vInt64)};case f.Buffer:return{[this.key]:v(this.vBuffer)};default:(0,m.ss)()}}}class x{constructor(e,t=[]){this.name=e,this.tags=t}static get(e){if(x._pool.has(e))return x._pool.get(e);const t=new x(e);return x._pool.set(e,t),t}}x._pool=new Map;class b{constructor(e,t,i){this.traceId=e,this.spanId=t,this.refType=i}}var w=i(13659);class C{constructor(e,t,i=!1){this._spanContext=e,this.root=i,this._startTime=Date.now(),this._duration=-1,this._tags=[],this._logs=[],this._operationName="",this._hasError=!1,this._process=x.get(t)}get traceId(){return this._spanContext.traceId}get spanId(){return this._spanContext.spanId}get shouldRecordArgs(){return this._spanContext.recordInOut}get hasError(){return this._hasError}get duration(){return this._duration}get process(){return this._process}get operationName(){return this._operationName}get reference(){return this._reference}linkParent(e,t=s.ChildOf){this._reference=new b(this._spanContext.traceId,e,t)}setReferenceType(e){this._reference&&(this._reference.refType=e)}setOperationName(e){this._operationName=e}addEvent(e){this._tags.push(e)}setSent(e){try{const t=JSON.stringify(e);this._tags.push(y.string("request",t.substring(0,1e3)))}catch(t){return}}setReceive(e){if(e instanceof Error)return this._tags.push(y.double("error_code",-1)),this._tags.push(y.string("error_message",e.message)),void this.markError();if((0,w.oi)(e)&&!e.ok)return this._tags.push(y.double("error_code",e.code)),this._tags.push(y.string("error_message",e.msg)),void this.markError();try{const t=JSON.stringify(e);this._tags.push(y.string("response",t.substring(0,1e3)))}catch(t){return}}addLog(...e){this._logs.push({timestamp:Date.now(),fields:[...e]})}markError(){this._hasError=!0}end(){this._duration=Date.now()-this._startTime,this._spanContext.commit(this)}toJSON(){return{traceId:this._spanContext.traceId,spanId:this._spanContext.spanId,startTime:this._startTime,duration:this._duration,operationName:this._operationName,references:this._reference?[this._reference]:[],processName:this._process.name,tags:this._tags.map((e=>e.toJSON())),logs:this._logs.map((e=>({timestamp:e.timestamp,fields:e.fields.map((e=>e.toJSON()))}))),hasError:this._hasError}}}const I="SPAN_CONTEXT",L="SPAN_CONTEXT_CONSUME_TYPE",R="SPAN_CONTEXT_TRACE_ID",E="SPAN_CONTEXT_SPAN_ID",M="SPAN_CONTEXT_TIMEOUT";class S{constructor(e){this.ctx=e,this.ctx.setValue(E,Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),this.ctx.setValue(I,this)}get recordInOut(){var e;return null!==(e=this.ctx.getValue("SPAN_CONTEXT_RECORD_IN_OUT"))&&void 0!==e&&e}get traceId(){return this.ctx.getValue(R)}get spanId(){return this.ctx.getValue(E)}get consumeType(){return this.ctx.getValue(L)}get timeout(){var e;return null!==(e=this.ctx.getValue(M))&&void 0!==e?e:6e4}newTrace(){p.newTrace(this.traceId,this.timeout)}add(e){p.addSpan(e)}commit(e){p.commitSpan(e,this.consumeType)}}const A={[o.zO.Entry]:r.Report,[o.zO.Event]:r.Discard,[o.zO.UserInput]:r.Discard,[o.zO.Task]:r.Discard};function P(e){let t=A[e.type];return void 0!==e.getValue(L)?t=e.getValue(L):e.setValue(L,t),e.setValue(R,`${a()}${a()}${a()}${a()}`),new S(e)}function T(e,t){const i=e.getValue(I),r=function(e){const t=e.background();return t.setValue(R,e.getValue(R)),t.setValue(L,e.getValue(L)),new S(t)}(e),s=new C(r,t);return s.linkParent(i.spanId),r.add(s),{spanContext:r,span:s}}function D(e,t){(0,w.oi)(t)&&!t.ok&&e.markError(),e.shouldRecordArgs&&e.setReceive(t),e.end()}function k(e,t){e.shouldRecordArgs&&e.setReceive(t),e.markError(),e.end()}function O(e,t,i,r){const n=i.bind(t),a=null!=r?r:i.name;return(...t)=>{const i=t[0];if(!(i instanceof o._y))return n(...t);const r=!i.getValue(I),{span:l,spanContext:h}=r?function(e,t){const i=P(e);i.newTrace();const r=new C(i,t,!0);return i.add(r),{spanContext:i,span:r}}(i,e):T(i,e);l.setOperationName(a),t[0]=h.ctx;try{h.recordInOut&&l.setReceive(t);const e=n(...t);return e instanceof Promise?function(e,t){e.setReferenceType(s.FollowsFrom);const i=new Promise(((i,r)=>{t.then((t=>{D(e,t),i(t)})).catch((t=>{k(e,t),r(t)}))}));return new class{then(t,r){return e.setReferenceType(s.ChildOf),i.then(t,r)}catch(e){return this.then(void 0,e)}finally(e){return i.finally(e)}}}(l,e):(D(l,e),e)}catch(c){throw k(l,c),c}}}function B(e,t){const i=Object.create(null),r=new Proxy(i,{get(i,r){if(r in i)return i[r];const s=t,n=s[r];if("function"!=typeof n)return n;const o=O(e,s,n);return i[r]=o,o},set:(e,i,r)=>(t[i]=r,!0)});return i.__origin__=t,r}function N(e,t,i=[]){return(i,r,s)=>{const n=s.value;return s.value=function(...i){return O(e,this,n,t)(...i)},s}}},91139:(e,t,i)=>{i.d(t,{V5:()=>f,YX:()=>v,gn:()=>m,vU:()=>y});let r,s=!1,n=!1,o=!1,a=!1,l=!1,h=!1,c=!1,d=!1,u=!1,g=!1;var _,p;"object"==typeof navigator&&(r=navigator.userAgent,s=r.indexOf("Windows")>=0,l=(r.indexOf("Macintosh")>=0||r.indexOf("iPad")>=0||r.indexOf("iPhone")>=0)&&Boolean(navigator.maxTouchPoints)&&navigator.maxTouchPoints>0,o=r.indexOf("Linux")>=0,h=(null===(_=r)||void 0===_?void 0:_.indexOf("Mobi"))>=0,c=(null===(p=r)||void 0===p?void 0:p.indexOf("iPad"))>=0,n=!h&&r.indexOf("Macintosh")>=0,d=/firefox/i.test(r),u=/chrome/i.test(r),g=/^((?!chrome|android).)*safari/i.test(r),a=!0);const f=n,m=l,v=c,y=d},71343:(e,t,i)=>{i.d(t,{g:()=>o});var r=i(42058);const s={text:/^[^\x25]+/,modulo:/^\x25\x25/,placeholder:/^\x25([vVbBdDsS])/},n=new Map;function o(e,...t){if(!t.length)return e;try{const i=function(e,...t){let i="",s=0;for(const n of e)if("string"!=typeof n)if(void 0!==t[s])switch(n.placeholder.toLowerCase()){case"s":i+=String(t[s++]);break;case"d":i+=Number(t[s++]);break;case"b":i+=t[s++];break;case"v":i+=JSON.stringify(t[s++]);break;default:(0,r.ss)()}else i+="undefined";else i+=n;return i}(function(e){const t=[];if(n.has(e))return n.get(e);let i=e;for(;i;){let e=s.text.exec(i);e?(t.push(e[0]),i=i.substring(e[0].length)):(e=s.modulo.exec(i),e?(t.push("%"),i=i.substring(e[0].length)):(e=s.placeholder.exec(i),e&&e.length>1?(t.push({placeholder:e[1]}),i=i.substring(e[0].length)):(0,r.ss)()))}return n.set(e,t),t}(e),...t);return i}catch(i){return`[invalid formatted message]${e}`}}},92822:(e,t,i)=>{i.d(t,{j3:()=>v,pu:()=>y});var r=i(82560),s=i(27175),n=i(72322);const o="https://sf16-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_user_agreement_es.html",a="https://sf19-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_user_agreement_br.html",l="https://sf16-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_user_agreement_fr.html",h="https://sf16-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_user_agreement_de.html",c="https://sf21-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_user_agreement_en.html",d="https://sf16-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_privacy_policy_es.html",u="https://sf19-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_privacy_policy_br.html",g="https://sf19-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_privacy_policy_fr.html",_="https://sf16-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_privacy_policy_de.html",p="https://sf21-draftcdn-sg.ibytedtos.com/obj/ies-hotsoon-draft-sg/capcut/via_clause_privacy_policy_en.html",f=e=>{switch(e){case"es-LA":return o;case"pt-BR":return a;case"fr-FR":return l;case"de-DE":return h;default:return c}},m=e=>{switch(e){case"es-LA":return d;case"pt-BR":return u;case"fr-FR":return g;case"de-DE":return _;case"en":return p;default:return c}},v=e=>(0,n.jsx)(r.Z,{href:f(s.ZP.language),target:"_blank",children:e},e),y=e=>(0,n.jsx)(r.Z,{href:m(s.ZP.language),target:"_blank",children:e},e)},10454:(e,t,i)=>{i.d(t,{d:()=>oe});var r,s,n=i(18571),o=i(36702),a=i(27175),l=i(23224),h=i(5789),c=i.n(h),d=i(41308);!function(e){e.CustomSize="custom"}(r||(r={})),function(e){e.CustomSize="customSize",e.Twitter="twitter",e.Snapchat="snapchat",e.LinkedIn="linkedIn",e.TikTok="tikTok",e.Twitch="twitch",e.Youtube="youtube",e.Instagram="instagram",e.Facebook="facebook"}(s||(s={}));const u={customSize:{showCustomSize:!0,listConfig:{listTitleKey:"web_toolsIntergration_button_recommend",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_post.png",titleKey:"web_toolsIntergration_instagram_post",content:"1080*1080px",scenario:"instagram_post",extInfo:{width:1080,height:1080,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_story.png",titleKey:"web_toolsIntergration_instagram_story",content:"1080*1920px",scenario:"instagram_story",extInfo:{width:1080,height:1920,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_facebook_post.png",titleKey:"web_toolsIntergration_facebook_post",content:"940*788px",scenario:"facebook_post",extInfo:{width:940,height:788,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_tiktok.png",titleKey:"web_toolsIntergration_tiktok",content:"1080*1920px",scenario:"tiktok",extInfo:{width:1080,height:1920,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_youtube_thumbnail.png",titleKey:"web_toolsIntergration_youtube_thumbnail",content:"1280*720px",scenario:"youtube_thumbnail",extInfo:{width:1280,height:720,unit:"px"}}]}},twitter:{listConfig:{listTitleKey:"web_toolsIntergration_twitter_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_twitter_header.png",titleKey:"web_toolsIntergration_twitter_header",content:"1500*500px",scenario:"twitter_header",extInfo:{width:1500,height:500,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_twitter_profile.png",titleKey:"web_toolsIntergration_twitter_profile",content:"1080*1080px",scenario:"twitter_profile",extInfo:{width:1080,height:1080,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_twitter_post.png",titleKey:"web_toolsIntergration_twitter_post",content:"1600*900px",scenario:"twitter_post",extInfo:{width:1600,height:900,unit:"px"}}]}},snapchat:{listConfig:{listTitleKey:"web_toolsIntergration_snapchat_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_snapchat_geofilter.png",titleKey:"web_toolsIntergration_snapchat_geofilter",content:"1080*2340px",scenario:"snapchat_geofilter",extInfo:{width:1080,height:2340,unit:"px"}}]}},linkedIn:{listConfig:{listTitleKey:"web_toolsIntergration_linkedin_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_linkedIn_banner.png",titleKey:"web_toolsIntergration_linkedIn_banner",content:"1584*396px",scenario:"linkedIn_banner",extInfo:{width:1584,height:396,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_linkedIn_company_banner.png",titleKey:"web_toolsIntergration_linkedIn_company",content:"1536*768px",scenario:"linkedIn_company_banner",extInfo:{width:1536,height:768,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_linkedIn_post.png",titleKey:"web_toolsIntergration_linkedIn_post",content:"1200*1200px",scenario:"linkedIn_post",extInfo:{width:1200,height:1200,unit:"px"}}]}},tikTok:{listConfig:{listTitleKey:"web_toolsIntergration_tiktok_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_tiktok.png",titleKey:"web_toolsIntergration_tiktok",content:"1080*1920px",scenario:"tiktok",extInfo:{width:1080,height:1920,unit:"px"}}]}},twitch:{listConfig:{listTitleKey:"web_toolsIntergration_twitch_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_twitch_cove.png",titleKey:"web_toolsIntergration_twitch_cove",content:"1200*480px",scenario:"twitch_cove",extInfo:{width:1200,height:480,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_twitch_banner_new.png",titleKey:"web_toolsIntergration_twitch_banner",content:"1920*1080px",scenario:"twitch_banner",extInfo:{width:1920,height:1080,unit:"px"}}]}},youtube:{listConfig:{listTitleKey:"web_toolsIntergration_youtube_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_youtube_thumbnail.png",titleKey:"web_toolsIntergration_youtube_thumbnail",content:"1280*720px",scenario:"youtube_thumbnail",extInfo:{width:1280,height:720,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_youtube_intro.png",titleKey:"web_toolsIntergration_youtube_intro",content:"1920*1080px",scenario:"youtube_intro",extInfo:{width:1920,height:1080,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_youtube_end_screen.png",titleKey:"web_toolsIntergration_youtube_end_screen",content:"1920*1080px",scenario:"youtube_end_screen",extInfo:{width:1920,height:1080,unit:"px"}}]}},instagram:{listConfig:{listTitleKey:"web_toolsIntergration_instagram_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_post.png",titleKey:"web_toolsIntergration_instagram_post",content:"1080*1080px",scenario:"instagram_post",extInfo:{width:1080,height:1080,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_story.png",titleKey:"web_toolsIntergration_instagram_story",content:"1080*1920px",scenario:"instagram_story",extInfo:{width:1080,height:1920,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_profile.png",titleKey:"web_toolsIntergration_instagram_profile",content:"800*800px",scenario:"instagram_profile",extInfo:{width:800,height:800,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_instagram_portrait.png",titleKey:"web_toolsIntergration__instagram_portrait",content:"1080*1350px",scenario:"instagram_portrait",extInfo:{width:1080,height:1350,unit:"px"}}]}},facebook:{listConfig:{listTitleKey:"web_toolsIntergration_facebook_size",list:[{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_facebook_post.png",titleKey:"web_toolsIntergration_facebook_post",content:"940*788px",scenario:"facebook_post",extInfo:{width:940,height:788,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_facebook_cover.png",titleKey:"web_toolsIntergration_facebook_cover",content:"1640*924px",scenario:"facebook_cover",extInfo:{width:1640,height:924,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_facebook_ad.png",titleKey:"web_toolsIntergration_facebook_ad",content:"810*450px",scenario:"facebook_ad",extInfo:{width:810,height:450,unit:"px"}},{image:"https://lf16-web-buz.capcut.com/obj/capcut-web-buz-us/common/images/banner_facebook_app_ad.png",titleKey:"web_toolsIntergration_facebook_app_ad",content:"1200*628px",scenario:"facebook_app_ad",extInfo:{width:1200,height:628,unit:"px"}}]}}},g=[{type:s.CustomSize,titleKey:"web_toolsIntergration_custom_size"},{type:s.Instagram,titleKey:"web_toolsIntergration_instagram_size"},{type:s.Facebook,titleKey:"web_toolsIntergration_facebook_size"},{type:s.Youtube,titleKey:"web_toolsIntergration_youtube_size"},{type:s.TikTok,titleKey:"web_toolsIntergration_tiktok_size"},{type:s.Twitter,titleKey:"web_toolsIntergration_twitter_size"},{type:s.LinkedIn,titleKey:"web_toolsIntergration_linkedin_size"},{type:s.Snapchat,titleKey:"web_toolsIntergration_snapchat_size"},{type:s.Twitch,titleKey:"web_toolsIntergration_twitch_size"}],_="modalContainer-OJw8Ma",p="modalContentContainer-hWKgvu",f="leftOptionListContainer-icfH12",m="leftOptionListItemContainer-yMtcpt",v="leftOptionItem-nmGO4N",y="leftOptionItemIcon-wJCIBo",x="leftOptionItemTitle-oct__P",b="itemIconSelected-RmYukE",w="itemTitleSelected-RIB7dj",C="leftOptionSelected-TKqYam",I="rightContentContainer-SbjGnu",L="rightContentListTitle-DVThJJ",R="customSizeTitle-Zm_w20",E="rightContentListItemContainer-PcbkZP",M="rightContentItem-GPNKKq",S="rightContentItemImageContainer-yGGCjw",A="rightContentItemImage-QIhu1w",P="rightContentItemTitle-zDrsoB",T="rightContentItemContent-Cm8KN7",D="mask-l9ptTa",k="progress-CDRjVI",O="progressText-XAPLRN",B="uploadMessage-axT210",N="uploadImageCover-Tu2w28";var Z=i(72322);const G={[s.Snapchat]:d.wt7,[s.Instagram]:d.HAf,[s.LinkedIn]:d.j2y,[s.Twitter]:d.BRO,[s.TikTok]:d.qQp,[s.Facebook]:d.As_,[s.Youtube]:d.tJY,[s.Twitch]:d.H6_,[s.CustomSize]:d.n7J},W=e=>{const{item:t,isSelected:i}=e,{type:r,titleKey:s}=t,n=G[r];if(!n)return null;const o=a.ZP.t(s);return(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(n,{className:c()(y,{[b]:i})}),(0,Z.jsx)(l.Z,{content:o,position:"right",checkOverflow:!0,children:(0,Z.jsx)("div",{className:c()(x,{[w]:i}),children:o})})]})},H=e=>{const{selectOption:t,onClickOption:i}=e;return(0,Z.jsx)("div",{className:f,children:(0,Z.jsx)("div",{className:m,children:g.map((e=>{const r=e.type===t;return(0,Z.jsx)("div",{className:c()(v,{[C]:r}),onClick:()=>{i(e)},children:(0,Z.jsx)(W,{item:e,isSelected:r})},`left_option_item_${e.type}`)}))})})};var z=i(73842),j=i(41541),F=i(92356),$=i(61269),U=i(44029),q=i(74290);const V=e=>"function"==typeof e;function K(e,t){return V(t)?t(e):t}var Y;!function(e){e.PX="px",e.CM="cm"}(Y||(Y={}));const X=$.default.Item,J="lv-custom-size",Q=96/2.54,ee=5e3,te=Number((60/Q).toFixed(3)),ie=Number((ee/Q).toFixed(3)),re=e=>{const{fixedUnit:t}=e,[i,r]=(0,n.useState)(!0),[s]=$.default.useForm(),o={width:1080,height:1080,unit:Y.PX},h=(0,n.useRef)(1080),u=(0,n.useRef)(1080),g=(0,n.useRef)(60),_=(0,n.useRef)(ee),p=(0,n.useRef)(null),[f,m]=(0,n.useState)(o),[v,y]=(0,n.useState)(!1),[x,b,w]=function(e){const t=K(void 0,e),[i,r]=(0,n.useState)(t),s=(0,n.useRef)(t);return[i,(0,n.useCallback)((e=>{const t=K(s.current,e);s.current=t,r(t)}),[]),(0,n.useCallback)((()=>s.current),[])]}(!1),[C,I]=(0,n.useState)(null),L=e=>{if(!Number.isNaN(e))return e},R=(e,t)=>{let i="60px",r="5000px";s.getFieldValue("unit")===Y.CM&&(i=`${te}cm`,r=`${ie}cm`);const n=a.oc.t("web_graphic_canvas_size_limit_err",{placeholder0:i,placeholder1:r},"Dimensions must be at least {placeholder0} and no more than {placeholder1}");return void 0!==e&&(e<g.current||e>_.current)&&t(n),t()};(0,n.useEffect)((()=>{void 0!==f.width&&void 0!==f.height?y(!1):y(!0)}),[f]);const E=e=>{e.target.select()},M=a.oc.t("web_toolsIntergration_create_a_journey",{},"Create project"),S=e=>e===Y.CM?3:0;return(0,Z.jsxs)("div",{children:[(0,Z.jsx)("div",{className:`${J}-title`,children:a.oc.t("web_toolsIntergration_custom_size",{},"Custom size")}),(0,Z.jsxs)($.default,{form:s,layout:"vertical",className:`${J}-content`,style:{position:"relative",display:"flex",flexDirection:"row"},initialValues:o,autoComplete:"off",onChange:(e,t)=>{let i=(e=>{const t={...e};if(t.unit!==f.unit){let i,r;t.unit===Y.PX?(i=h.current*Q,r=u.current*Q,g.current=60,_.current=ee):(i=h.current/Q,r=u.current/Q,g.current=te,_.current=ie),t.width=L(Number(i.toFixed(S(e.unit)))),t.height=L(Number(r.toFixed(S(e.unit)))),h.current=i,u.current=r}else h.current=e.width,u.current=e.height;return t})(t);i=(e=>{const t=w();return["width","height"].forEach((i=>{var r;if((!e[i]||e[i]!==f[i])&&(e[i]=Number((null!==(r=e[i])&&void 0!==r?r:0).toFixed(S(e.unit))),t&&p.current))if("width"===i){var s;const t=(null!==(s=e[i])&&void 0!==s?s:0)/p.current;e.height=L(Number(t.toFixed(S(e.unit)))),u.current=t}else{var n;const t=(null!==(n=e[i])&&void 0!==n?n:0)*p.current;e.width=L(Number(t.toFixed(S(e.unit)))),h.current=t}})),e})(i),m(i),s.setFieldsValue(i),(async()=>{try{await s.validate(),r(!0),I("")}catch(e){const{errors:t}=e;t&&Object.values(t).forEach((e=>{e.requiredError||I(e.message)})),r(!1)}})()},children:[(0,Z.jsx)(X,{label:a.oc.t("web_graphic_customize_canvas_width",{},"width"),field:"width",className:`${J}-item  ${void 0!==t&&J}-fixedSizeItem`,rules:[{required:!0},{validator:R}],children:(0,Z.jsx)(U.Z,{onFocus:E})}),(0,Z.jsx)(l.Z,{className:`${J}-tooltip`,content:a.oc.t("web_graphic_lock_aspect_ratio",{},"lock aspect ratio"),children:(0,Z.jsx)("div",{className:`${J}-icon-wrapper`,children:x?(0,Z.jsx)(d.vdo,{size:"16",className:`${J}-icon-lock`,onClick:()=>{b(!1),p.current=null}}):(0,Z.jsx)(d.NN2,{size:"16",className:c()(`${J}-icon-unlock`,{disabled:v}),onClick:()=>{v||(b(!0),p.current=h.current/u.current)}})})}),(0,Z.jsx)(X,{label:a.oc.t("web_graphic_customize_canvas_height",{},"height"),field:"height",className:`${J}-item ${J}-width-item ${void 0!==t&&J}-fixedSizeItem`,rules:[{required:!0},{validator:R}],children:(0,Z.jsx)(U.Z,{onFocus:E})}),void 0===t?(0,Z.jsx)(X,{required:!0,field:"unit",className:`${J}-item ${J}-unit-item`,children:(0,Z.jsx)(q.default,{options:Object.entries(Y).map((([e,t])=>({label:t,value:t})))})}):(0,Z.jsx)("div",{className:`${J}-fixedUnit ${J}-unit-item`,children:t}),(0,Z.jsx)("div",{className:c()(`${J}-create-design-button`,{disabled:!i}),onClick:()=>{if(!i)return;const{onSubmit:t}=e;null==t||t(f)},children:(0,Z.jsx)(l.Z,{content:M,disabled:M.length<=15,children:M})})]}),(0,Z.jsx)(l.Z,{content:C,checkOverflow:!0,children:(0,Z.jsx)("div",{className:`${J}-err-msg`,children:C})})]})};var se=i(14906);const ne=({selectOption:e,onClickItem:t,fixedUnit:i,upload:s,onUpload:o,onClose:h})=>{const{showCustomSize:d=!1,listConfig:g}=u[e]||{},{listTitleKey:_="",list:p=[]}=g||{},[f,m]=(0,n.useState)(!1),[v,y]=(0,n.useState)(0),x=a.ZP.t(_),b=(0,n.useCallback)((()=>{z.Z.error({content:a.ZP.t("web_new_image_toast_not_upload",{},"Couldn't upload"),icon:(0,Z.jsx)(se.Mil,{fill:"rgba(255, 48, 61, 1)",size:20}),className:B}),m(!1),y(0)}),[]),w=(0,n.useCallback)((async(e,t)=>{const{status:i}=t;if("error"!==i){if(y(10),t.originFile)try{await(null==s?void 0:s.uploadFile({file:t.originFile,onProgress:e=>{y(.8*e+10)}})),y(100),requestAnimationFrame((()=>{m(!1),y(0),h(!1)}))}catch(r){b()}}else b()}),[h,b,s]),C=(0,n.useCallback)((()=>(m(!0),o(),!0)),[o]),G=(0,n.useMemo)((()=>(0,Z.jsxs)("div",{className:M,children:[f&&(0,Z.jsx)("div",{className:D,children:(0,Z.jsxs)("div",{className:k,children:[(0,Z.jsx)(j.Z,{percent:v,width:"100%",showText:!1,trailColor:"rgba(255, 255, 255, 0.2)"}),(0,Z.jsx)("div",{className:O,children:a.ZP.t("web_new_image_uploading_uploading_image",{},"Uploading...")})]})}),(0,Z.jsx)(F.Z,{multiple:!1,showUploadList:!1,autoUpload:!1,accept:null==s?void 0:s.accept,style:{width:"180px",height:"180px"},onChange:w,beforeUpload:C,children:(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)("div",{className:S,children:(0,Z.jsx)("div",{className:c()(A,N)})}),(0,Z.jsx)(l.Z,{content:a.ZP.t("web_new_image_btn_create_from_media",{},"Create from file"),position:"top",checkOverflow:!0,children:(0,Z.jsx)("div",{className:P,children:a.ZP.t("web_new_image_btn_create_from_media",{},"Create from file")})})]})})]},"uploader")),[f,v,null==s?void 0:s.accept,w,C]);return(0,Z.jsxs)("div",{className:I,children:[d&&(0,Z.jsx)(re,{onSubmit:e=>{const{width:i,height:s,unit:n}=e,o=r.CustomSize;t({scenario:o,width:i,height:s,unit:n,scale:`${i}*${s}${n}`})},fixedUnit:i}),(0,Z.jsx)(l.Z,{content:x,position:"top",checkOverflow:!0,children:(0,Z.jsx)("div",{className:c()(L,{[R]:d}),children:x})}),(0,Z.jsxs)("div",{className:E,children:[(null==s?void 0:s.showUpload)&&G,p.map((e=>{const{titleKey:i,content:r}=e,n=a.ZP.t(i);return(0,Z.jsxs)("div",{className:M,onClick:()=>(e=>{const{scenario:i,extInfo:r}=e,{width:n,height:o,unit:a}=r||{};t({scenario:i,width:n,height:o,unit:a,scale:`${n}*${o}${a}`}),null==s||s.cancelUpload()})(e),children:[(0,Z.jsx)("div",{className:S,children:(0,Z.jsx)("img",{className:A,src:e.image})}),(0,Z.jsx)(l.Z,{content:n,position:"top",checkOverflow:!0,children:(0,Z.jsx)("div",{className:P,children:n})}),(0,Z.jsx)(l.Z,{content:r,position:"top",checkOverflow:!0,children:(0,Z.jsx)("div",{className:T,children:r})})]},e.titleKey)}))]})]})},oe=e=>{const{fixedUnit:t,onConfirm:i,onClose:r,onStatusChange:a,upload:l}=e,[h,c]=(0,n.useState)(!0),[d,u]=(0,n.useState)(s.CustomSize),g=(0,n.useCallback)(((e,t)=>{null==a||a(e,t)}),[a]),f=(e=!0)=>{g("close"),c(!1),r(e)};return(0,Z.jsx)(o.Z,{className:_,style:{width:"836px"},visible:h,footer:null,onCancel:f,children:(0,Z.jsxs)("div",{className:p,children:[(0,Z.jsx)(H,{selectOption:d,onClickOption:e=>{const{type:t}=e;u(t)}}),h&&(0,Z.jsx)(ne,{selectOption:d,onClickItem:e=>{g("click",{scale:e.scale,scenario:e.scenario}),i(e),c(!1)},fixedUnit:t,upload:s.CustomSize===d?l:void 0,onUpload:()=>{g("upload")},onClose:f})]})})}},28387:(e,t,i)=>{i.d(t,{W:()=>n});var r=i(27175),s=i(36702);const n=e=>{const t={title:r.oc.t("confirm_deletion",{},"Confirm to Delete"),content:r.oc.t("please_confirm_whether_to_delete",{},"Please confirm whether to delete"),okText:r.oc.t("web_confirm",{},"Confirm"),cancelText:r.oc.t("web_cancel",{},"Cancel")},i=Object.assign(t,e);return new Promise(((e,t)=>{var r;s.Z.confirm({className:`graphic-custom-modal_container ${null!==(r=i.className)&&void 0!==r?r:""}`,wrapClassName:i.wrapClassName,title:i.title,content:i.content,okText:i.okText,cancelText:i.cancelText,cancelButtonProps:{size:"large"},okButtonProps:{status:"danger",size:"large",style:{marginLeft:16}},onOk:async()=>{i.onBeforeOk&&await i.onBeforeOk(),e()},onCancel:async()=>{i.onBeforeCancel&&await i.onBeforeCancel(),t()}})}))}},74532:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(95291),s=i(73842);const n="ve-message-wrapper-aM0M85";var o,a=i(72322);const l=(e,t,i)=>{var o;const l=null==i||null===(o=i.getContainer)||void 0===o?void 0:o.call(i);var c;if(!l)return null===s.Z||void 0===s.Z||null===(c=s.Z[e])||void 0===c?void 0:c.call(s.Z,t);const d="string"==typeof t?{content:t,type:e}:{...t,type:e};let u="";const g=(e,t)=>{if(!e)return;Array.isArray(t)&&(t=t.join(" "));const{top:i,left:r,width:s}=l.getBoundingClientRect();e.style.width=`${s}px`,e.style.top=`${i+24}px`,e.style.left=`${r}px`,e.className=`${e.className} ${t}`};if(h.instances.has(l)){const e=h.instances.get(l);u=null==e?void 0:e.add(d),g(null==e?void 0:e.__dom,d.className)}else{const e=document.createElement("div");e.classList.add(n),(0,r.render)((0,a.jsx)(s.Z,{ref:t=>{u=(null==t?void 0:t.add(d))||"",t.__dom=e,h.instances.set(l,t)}}),e),g(e,d.className),document.body.appendChild(e)}return()=>{var e;u&&(null===(e=h.instances.get(l))||void 0===e||e.remove(u))}};class h extends s.Z{}(o=h).instances=new Map,o.success=(e,t)=>l("success",e,t),o.info=(e,t)=>l("info",e,t),o.warning=(e,t)=>l("warning",e,t),o.error=(e,t)=>l("error",e,t),o.loading=(e,t)=>l("loading",e,t),o.normal=(e,t)=>l("normal",e,t);const c=h},37918:(e,t,i)=>{i.d(t,{V:()=>n});var r=i(18571);const s=["mousedown","touchstart"],n=(e,t,i=s)=>{const n=(0,r.useRef)(t);(0,r.useEffect)((()=>{n.current=t}),[t]),(0,r.useEffect)((()=>{const t=t=>{const i=null==e?void 0:e.current;i&&!i.contains(t.target)&&n.current(t)};for(const e of i)document.addEventListener(e,t);return()=>{for(const e of i)document.removeEventListener(e,t)}}),[i,e])}},52428:(e,t,i)=>{i.d(t,{k:()=>o});var r=i(18571),s=i(20631);function n(e){const t=(0,s.ZN)(e);if(t instanceof Object)for(const i in t)"object"==typeof t[i]&&(t[i]=n(t[i]));return t instanceof Array&&t.forEach((e=>n(e))),t}function o(e,t,i){var o;const[a,l]=(0,r.useState)(e?n(t(e)):void 0);return(0,r.useEffect)((()=>{var r;if(!e)return;const o=null!==(r=null==i?void 0:i.isEqual)&&void 0!==r?r:(e,t)=>e===t,a=(0,s.EH)((()=>{const i=n(t(e));l((e=>o(e,i)||e===i?e:i))}));return()=>{a()}}),[e,...null!==(o=null==i?void 0:i.deps)&&void 0!==o?o:[]]),a}},36580:(e,t,i)=>{i.d(t,{v:()=>n});var r,s=i(18571);function n(e){const{containerRef:t,currentOffset:i,align:n,isScrollable:o=!0,direction:a,onScroll:l,onScrollChange:h,preventDefault:c=!1}=e,d=(0,s.useRef)(),u={[r.x]:"horizontal",[r.y]:"vertical"};function g(e,t,r){let s=0;s="vertical"===a?i+t:"left"===n?i+e:i-e;d.current=s,null==l||l(s,(()=>{const{touchEvent:e,wheelEvent:t}=r;t&&t.preventDefault(),null!=e&&e.cancelable&&e.preventDefault()}))}const _=(0,s.useRef)(r.x);const p=(0,s.useRef)({clientX:0,clientY:0}),f=(0,s.useRef)({x:0,y:0}),m=e=>{var t;return(null==e||null===(t=e.touches)||void 0===t?void 0:t.length)&&(null==e?void 0:e.touches[0])},v=e=>{const t=m(e);if(!t)return;c&&e.preventDefault();const{clientX:i,clientY:r}=t,{clientX:s,clientY:n}=p.current,o={x:i-f.current.x,y:r-f.current.y};null==h||h(o,e),f.current={x:i,y:r};g(-(i-s),-(r-n),{touchEvent:e})},y=()=>{document.documentElement.removeEventListener("touchmove",v),document.documentElement.removeEventListener("touchend",y)},x=(0,s.useRef)();x.current={onWheel:function(e){if(!o)return;c&&e.preventDefault();const{deltaX:t,deltaY:i}=e;let s=0;const n=Math.abs(t),l=Math.abs(i);if(Math.abs(n-l)<=2)return;if(n===l)return void(_.current=void 0);n>l&&(s=t,_.current=r.x),n<l&&(s=i,_.current=r.y),void 0!==_.current&&u[_.current]===a&&(g(s,s,{wheelEvent:e}),null==h||h({x:t,y:i},e))},onTouchStart:e=>{if(!o)return;const t=m(e);t&&(p.current={clientX:t.clientX,clientY:t.clientY},f.current={x:t.clientX,y:t.clientY},document.documentElement.addEventListener("touchmove",v,{passive:!1}),window.addEventListener("touchend",y,{passive:!1}))}},(0,s.useEffect)((()=>{var e,i;null===(e=t.current)||void 0===e||e.addEventListener("wheel",(e=>{var t;null===(t=x.current)||void 0===t||t.onWheel(e)}),{passive:!1}),null===(i=t.current)||void 0===i||i.addEventListener("touchstart",(e=>{var t;null===(t=x.current)||void 0===t||t.onTouchStart(e)}),{passive:!0})}),[t])}!function(e){e[e.x=0]="x",e[e.y=1]="y"}(r||(r={}))},26166:(e,t,i)=>{i.d(t,{w:()=>s});var r=i(18571);function s(){const[e,t]=(0,r.useState)({width:window.innerWidth,height:window.innerHeight});return(0,r.useEffect)((()=>{const e=()=>{t({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)}),[]),e}},84377:()=>{},79872:(e,t,i)=>{i.d(t,{Z:()=>r});const r={"navigator-bar-size":"56px",navigatorBarSize:"56px","tab-header-size":"76px",tabHeaderSize:"76px","attribute-view-width":"56px",attributeViewWidth:"56px","attribute-view-top-position":"8px",attributeViewTopPosition:"8px","attribute-view-right-position":"8px",attributeViewRightPosition:"8px","attribute-panel-width":"268px",attributePanelWidth:"268px","attribute-panel-header-height":"48px",attributePanelHeaderHeight:"48px","attribute-panel-horizontal-padding":"16px",attributePanelHorizontalPadding:"16px","attribute-panel-vertical-margin":"16px",attributePanelVerticalMargin:"16px","attribute-contextmenu-width":"260px",attributeContextmenuWidth:"260px","attribute-contextmenu-item-height":"36px",attributeContextmenuItemHeight:"36px","attribute-contextmenu-padding":"8px",attributeContextmenuPadding:"8px","attribute-contextmenu-border":"1px",attributeContextmenuBorder:"1px","attribute-sub-contextmenu-width":"279px",attributeSubContextmenuWidth:"279px","page-layers-width":"98px",pageLayersWidth:"98px"}}}]);